<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <meta name="description" content="Field Buddy Pro v4.0 - Modern Premium HVAC Field Service Management">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <title>Field Buddy Pro v4.0 - Premium Edition</title>
  
  <!-- CDN Libraries -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.1.7/dist/signature_pad.umd.min.js"></script>
  
  <style>
    /* ==================== MODERN DESIGN SYSTEM ==================== */
    :root {
      /* Dark Theme Colors */
      --bg-primary: #0B1121;
      --bg-secondary: #151B2D;
      --bg-tertiary: #1E2638;
      --bg-elevated: #242D42;
      
      /* Accent Colors */
      --accent-cyan: #00D9FF;
      --accent-cyan-dark: #00A8CC;
      --accent-orange: #FF6B35;
      --accent-orange-dark: #E85D2F;
      --accent-purple: #A855F7;
      --accent-green: #10B981;
      --accent-yellow: #FCD34D;
      
      /* Status Colors */
      --success: #10B981;
      --success-glow: rgba(16, 185, 129, 0.3);
      --warning: #FCD34D;
      --warning-glow: rgba(252, 211, 77, 0.3);
      --danger: #EF4444;
      --danger-glow: rgba(239, 68, 68, 0.3);
      --info: #3B82F6;
      --info-glow: rgba(59, 130, 246, 0.3);
      
      /* Text Colors */
      --text-primary: #F8FAFC;
      --text-secondary: #CBD5E1;
      --text-tertiary: #94A3B8;
      --text-disabled: #64748B;
      
      /* Glass Effects */
      --glass-bg: rgba(30, 38, 56, 0.7);
      --glass-border: rgba(255, 255, 255, 0.1);
      --glass-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
      
      /* Shadows */
      --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.5);
      --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.4);
      --shadow-md: 0 10px 15px -3px rgba(0, 0, 0, 0.4);
      --shadow-lg: 0 20px 25px -5px rgba(0, 0, 0, 0.5);
      --shadow-xl: 0 25px 50px -12px rgba(0, 0, 0, 0.6);
      
      /* Gradients */
      --gradient-cyan: linear-gradient(135deg, #00D9FF 0%, #00A8CC 100%);
      --gradient-orange: linear-gradient(135deg, #FF6B35 0%, #E85D2F 100%);
      --gradient-purple: linear-gradient(135deg, #A855F7 0%, #7C3AED 100%);
      --gradient-premium: linear-gradient(135deg, #667EEA 0%, #764BA2 100%);
      --gradient-dark: linear-gradient(135deg, #1E2638 0%, #0B1121 100%);
      
      /* Spacing */
      --spacing-xs: 4px;
      --spacing-sm: 8px;
      --spacing-md: 12px;
      --spacing-lg: 16px;
      --spacing-xl: 24px;
      --spacing-2xl: 32px;
      --spacing-3xl: 48px;
      
      /* Transitions */
      --transition-fast: 0.15s cubic-bezier(0.4, 0, 0.2, 1);
      --transition: 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      --transition-slow: 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      
      /* Border Radius */
      --radius-sm: 6px;
      --radius: 12px;
      --radius-lg: 16px;
      --radius-xl: 24px;
    }
    
    /* ==================== RESET & BASE ==================== */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      font-size: 14px;
      line-height: 1.6;
      overflow-x: hidden;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }
    
    /* Custom Scrollbar */
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }
    
    ::-webkit-scrollbar-track {
      background: var(--bg-secondary);
    }
    
    ::-webkit-scrollbar-thumb {
      background: var(--bg-elevated);
      border-radius: 4px;
    }
    
    ::-webkit-scrollbar-thumb:hover {
      background: var(--accent-cyan-dark);
    }
    
    /* ==================== LAYOUT ==================== */
    .app-container {
      display: flex;
      min-height: 100vh;
    }
    
    /* Premium Sidebar */
    .sidebar {
      width: 280px;
      background: var(--bg-secondary);
      border-right: 1px solid var(--glass-border);
      height: 100vh;
      position: fixed;
      left: 0;
      top: 0;
      overflow-y: auto;
      z-index: 100;
      transition: transform var(--transition-slow);
      backdrop-filter: blur(10px);
    }
    
    .sidebar-header {
      padding: var(--spacing-2xl);
      border-bottom: 1px solid var(--glass-border);
      background: var(--gradient-dark);
    }
    
    .sidebar-logo {
      display: flex;
      align-items: center;
      gap: var(--spacing-lg);
    }
    
    .sidebar-logo-icon {
      width: 48px;
      height: 48px;
      background: var(--gradient-cyan);
      border-radius: var(--radius-lg);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      box-shadow: 0 0 20px var(--success-glow);
      animation: pulse-glow 2s ease-in-out infinite;
    }
    
    @keyframes pulse-glow {
      0%, 100% { box-shadow: 0 0 20px var(--success-glow); }
      50% { box-shadow: 0 0 30px var(--success-glow), 0 0 40px var(--success-glow); }
    }
    
    .sidebar-logo-text {
      flex: 1;
    }
    
    .sidebar-title {
      font-size: 18px;
      font-weight: 700;
      background: var(--gradient-cyan);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    
    .sidebar-version {
      font-size: 11px;
      color: var(--text-tertiary);
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    
    .sidebar-nav {
      padding: var(--spacing-xl) 0;
    }
    
    .nav-section {
      margin-bottom: var(--spacing-xl);
    }
    
    .nav-section-title {
      padding: var(--spacing-sm) var(--spacing-xl);
      font-size: 11px;
      font-weight: 700;
      color: var(--text-tertiary);
      text-transform: uppercase;
      letter-spacing: 1.2px;
    }
    
    .nav-item {
      display: flex;
      align-items: center;
      gap: var(--spacing-md);
      padding: var(--spacing-md) var(--spacing-xl);
      color: var(--text-secondary);
      cursor: pointer;
      transition: var(--transition);
      border-left: 3px solid transparent;
      font-size: 14px;
      font-weight: 500;
      position: relative;
      overflow: hidden;
    }
    
    .nav-item::before {
      content: '';
      position: absolute;
      left: 0;
      top: 0;
      height: 100%;
      width: 0;
      background: var(--gradient-cyan);
      opacity: 0.1;
      transition: var(--transition);
    }
    
    .nav-item:hover {
      color: var(--accent-cyan);
      background: rgba(0, 217, 255, 0.05);
    }
    
    .nav-item:hover::before {
      width: 100%;
    }
    
    .nav-item.active {
      color: var(--accent-cyan);
      background: rgba(0, 217, 255, 0.1);
      border-left-color: var(--accent-cyan);
      box-shadow: inset 0 0 20px rgba(0, 217, 255, 0.1);
    }
    
    .nav-icon {
      font-size: 20px;
      width: 28px;
      text-align: center;
      filter: drop-shadow(0 0 8px currentColor);
    }
    
    /* Main Content Area */
    .main-content {
      margin-left: 280px;
      flex: 1;
      min-height: 100vh;
      background: var(--bg-primary);
    }
    
    /* Premium Header */
    .top-header {
      background: var(--glass-bg);
      backdrop-filter: blur(20px);
      border-bottom: 1px solid var(--glass-border);
      padding: 0 var(--spacing-2xl);
      height: 72px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      position: sticky;
      top: 0;
      z-index: 50;
      box-shadow: var(--shadow);
    }
    
    .header-left {
      display: flex;
      align-items: center;
      gap: var(--spacing-lg);
    }
    
    .menu-toggle {
      display: none;
      width: 44px;
      height: 44px;
      background: var(--bg-elevated);
      border: 1px solid var(--glass-border);
      border-radius: var(--radius);
      cursor: pointer;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      color: var(--text-primary);
      transition: var(--transition);
    }
    
    .menu-toggle:hover {
      background: var(--accent-cyan);
      border-color: var(--accent-cyan);
      box-shadow: 0 0 20px var(--success-glow);
    }
    
    .header-title {
      font-size: 24px;
      font-weight: 700;
      background: var(--gradient-cyan);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      text-shadow: 0 0 30px rgba(0, 217, 255, 0.3);
    }
    
    .header-actions {
      display: flex;
      align-items: center;
      gap: var(--spacing-lg);
    }
    
    .header-user {
      display: flex;
      align-items: center;
      gap: var(--spacing-md);
      padding: var(--spacing-sm) var(--spacing-lg);
      background: var(--bg-elevated);
      border: 1px solid var(--glass-border);
      border-radius: var(--radius-lg);
      font-size: 14px;
      font-weight: 500;
      transition: var(--transition);
      cursor: pointer;
    }
    
    .header-user:hover {
      background: var(--bg-tertiary);
      border-color: var(--accent-cyan);
      box-shadow: 0 0 20px rgba(0, 217, 255, 0.2);
    }
    
    .user-avatar {
      width: 40px;
      height: 40px;
      background: var(--gradient-cyan);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 700;
      font-size: 14px;
      box-shadow: 0 0 20px var(--success-glow);
    }
    
    .workspace {
      padding: var(--spacing-2xl);
      max-width: 1600px;
      margin: 0 auto;
    }
    
    /* ==================== DASHBOARD TILES ==================== */
    .dashboard-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
      gap: var(--spacing-xl);
      margin-bottom: var(--spacing-3xl);
    }
    
    .dashboard-tile {
      background: var(--glass-bg);
      backdrop-filter: blur(20px);
      border: 1px solid var(--glass-border);
      border-radius: var(--radius-xl);
      padding: var(--spacing-2xl);
      cursor: pointer;
      transition: var(--transition-slow);
      position: relative;
      overflow: hidden;
      min-height: 200px;
      display: flex;
      flex-direction: column;
      box-shadow: var(--shadow);
    }
    
    .dashboard-tile::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: var(--gradient-cyan);
      opacity: 0;
      transition: var(--transition);
    }
    
    .dashboard-tile:hover {
      transform: translateY(-8px);
      box-shadow: var(--shadow-xl), 0 0 40px rgba(0, 217, 255, 0.3);
      border-color: var(--accent-cyan);
    }
    
    .dashboard-tile:hover::before {
      opacity: 1;
    }
    
    .tile-header {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      margin-bottom: var(--spacing-lg);
    }
    
    .tile-icon {
      width: 56px;
      height: 56px;
      border-radius: var(--radius-lg);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 28px;
      background: var(--gradient-cyan);
      box-shadow: 0 0 20px var(--success-glow);
      animation: float 3s ease-in-out infinite;
    }
    
    @keyframes float {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-10px); }
    }
    
    .tile-icon.orange { background: var(--gradient-orange); box-shadow: 0 0 20px rgba(255, 107, 53, 0.4); }
    .tile-icon.purple { background: var(--gradient-purple); box-shadow: 0 0 20px rgba(168, 85, 247, 0.4); }
    .tile-icon.premium { background: var(--gradient-premium); box-shadow: 0 0 20px rgba(102, 126, 234, 0.4); }
    
    .tile-badge {
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 10px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      background: var(--gradient-cyan);
      color: white;
      box-shadow: 0 0 10px var(--success-glow);
    }
    
    .tile-badge.pro {
      background: var(--gradient-orange);
      box-shadow: 0 0 10px rgba(255, 107, 53, 0.4);
    }
    
    .tile-badge.premium {
      background: var(--gradient-purple);
      box-shadow: 0 0 10px rgba(168, 85, 247, 0.4);
    }
    
    .tile-content {
      flex: 1;
    }
    
    .tile-title {
      font-size: 20px;
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: var(--spacing-sm);
    }
    
    .tile-description {
      font-size: 14px;
      color: var(--text-secondary);
      line-height: 1.6;
    }
    
    .tile-stats {
      display: flex;
      gap: var(--spacing-lg);
      margin-top: var(--spacing-lg);
      padding-top: var(--spacing-lg);
      border-top: 1px solid var(--glass-border);
    }
    
    .tile-stat {
      flex: 1;
    }
    
    .tile-stat-value {
      font-size: 18px;
      font-weight: 700;
      color: var(--accent-cyan);
      display: block;
    }
    
    .tile-stat-label {
      font-size: 11px;
      color: var(--text-tertiary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    /* ==================== CARDS ==================== */
    .card {
      background: var(--glass-bg);
      backdrop-filter: blur(20px);
      border: 1px solid var(--glass-border);
      border-radius: var(--radius-xl);
      margin-bottom: var(--spacing-xl);
      box-shadow: var(--shadow);
      overflow: hidden;
      transition: var(--transition);
    }
    
    .card:hover {
      box-shadow: var(--shadow-lg);
      border-color: rgba(0, 217, 255, 0.3);
    }
    
    .card-header {
      padding: var(--spacing-xl);
      border-bottom: 1px solid var(--glass-border);
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: rgba(0, 0, 0, 0.2);
    }
    
    .card-title {
      font-size: 18px;
      font-weight: 700;
      color: var(--text-primary);
      display: flex;
      align-items: center;
      gap: var(--spacing-sm);
    }
    
    .card-body {
      padding: var(--spacing-xl);
    }
    
    .card-section {
      margin-bottom: var(--spacing-xl);
    }
    
    .card-section:last-child {
      margin-bottom: 0;
    }
    
    .section-title {
      font-size: 14px;
      font-weight: 700;
      color: var(--accent-cyan);
      margin-bottom: var(--spacing-md);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      display: flex;
      align-items: center;
      gap: var(--spacing-sm);
    }
    
    .section-title::before {
      content: '';
      width: 4px;
      height: 16px;
      background: var(--gradient-cyan);
      border-radius: 2px;
    }
    
    /* ==================== FORMS ==================== */
    .form-grid {
      display: grid;
      gap: var(--spacing-lg);
    }
    
    .form-grid-2 { grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); }
    .form-grid-3 { grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); }
    .form-grid-4 { grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); }
    
    .form-group {
      margin-bottom: 0;
      position: relative;
    }
    
    label {
      display: block;
      font-size: 13px;
      font-weight: 600;
      color: var(--text-secondary);
      margin-bottom: var(--spacing-sm);
      letter-spacing: 0.3px;
    }
    
    .help-icon {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 16px;
      height: 16px;
      background: var(--accent-cyan);
      color: var(--bg-primary);
      border-radius: 50%;
      font-size: 10px;
      font-weight: 700;
      cursor: help;
      margin-left: 4px;
      position: relative;
      box-shadow: 0 0 10px var(--success-glow);
    }
    
    .help-icon:hover::after {
      content: attr(data-tooltip);
      position: absolute;
      bottom: 120%;
      left: 50%;
      transform: translateX(-50%);
      background: var(--bg-elevated);
      color: var(--text-primary);
      padding: 8px 12px;
      border-radius: var(--radius);
      font-size: 12px;
      font-weight: normal;
      white-space: nowrap;
      z-index: 1000;
      box-shadow: var(--shadow-lg);
      border: 1px solid var(--glass-border);
      animation: fadeIn 0.2s ease;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateX(-50%) translateY(-5px); }
      to { opacity: 1; transform: translateX(-50%) translateY(0); }
    }
    
    input, select, textarea {
      width: 100%;
      padding: var(--spacing-md) var(--spacing-lg);
      border: 1px solid var(--glass-border);
      border-radius: var(--radius);
      font-size: 14px;
      font-family: inherit;
      background: var(--bg-elevated);
      color: var(--text-primary);
      transition: var(--transition);
    }
    
    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: var(--accent-cyan);
      box-shadow: 0 0 0 3px rgba(0, 217, 255, 0.2), 0 0 20px rgba(0, 217, 255, 0.3);
      background: var(--bg-tertiary);
    }
    
    input[readonly] {
      background: var(--bg-secondary);
      color: var(--text-tertiary);
      border-color: var(--bg-elevated);
    }
    
    input.warning {
      border-color: var(--warning);
      background: rgba(252, 211, 77, 0.05);
    }
    
    input.error {
      border-color: var(--danger);
      background: rgba(239, 68, 68, 0.05);
    }
    
    textarea {
      resize: vertical;
      min-height: 100px;
      line-height: 1.6;
    }
    
    /* ==================== BUTTONS ==================== */
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: var(--spacing-sm);
      padding: var(--spacing-md) var(--spacing-xl);
      border: none;
      border-radius: var(--radius);
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: var(--transition);
      min-height: 44px;
      position: relative;
      overflow: hidden;
    }
    
    .btn::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 0;
      height: 0;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.2);
      transform: translate(-50%, -50%);
      transition: width 0.6s, height 0.6s;
    }
    
    .btn:active::before {
      width: 300px;
      height: 300px;
    }
    
    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    .btn-primary {
      background: var(--gradient-cyan);
      color: white;
      box-shadow: 0 0 20px var(--success-glow);
    }
    
    .btn-primary:hover:not(:disabled) {
      box-shadow: 0 0 30px var(--success-glow), 0 0 40px var(--success-glow);
      transform: translateY(-2px);
    }
    
    .btn-success {
      background: var(--gradient-cyan);
      color: white;
      box-shadow: 0 0 20px var(--success-glow);
    }
    
    .btn-success:hover:not(:disabled) {
      box-shadow: 0 0 30px var(--success-glow);
      transform: translateY(-2px);
    }
    
    .btn-warning {
      background: var(--gradient-orange);
      color: white;
      box-shadow: 0 0 20px rgba(255, 107, 53, 0.4);
    }
    
    .btn-warning:hover:not(:disabled) {
      box-shadow: 0 0 30px rgba(255, 107, 53, 0.4);
      transform: translateY(-2px);
    }
    
    .btn-secondary {
      background: var(--bg-elevated);
      color: var(--text-primary);
      border: 1px solid var(--glass-border);
    }
    
    .btn-secondary:hover:not(:disabled) {
      background: var(--bg-tertiary);
      border-color: var(--accent-cyan);
      box-shadow: 0 0 20px rgba(0, 217, 255, 0.2);
    }
    
    .btn-danger {
      background: linear-gradient(135deg, #EF4444 0%, #DC2626 100%);
      color: white;
      box-shadow: 0 0 20px var(--danger-glow);
    }
    
    .btn-danger:hover:not(:disabled) {
      box-shadow: 0 0 30px var(--danger-glow);
      transform: translateY(-2px);
    }
    
    .btn-group {
      display: flex;
      gap: var(--spacing-sm);
      flex-wrap: wrap;
    }
    
    .btn-sm {
      padding: var(--spacing-sm) var(--spacing-lg);
      font-size: 12px;
      min-height: 36px;
    }
    
    /* ==================== TOGGLE BUTTONS ==================== */
    .toggle-group {
      display: inline-flex;
      background: var(--bg-elevated);
      border: 1px solid var(--glass-border);
      border-radius: var(--radius);
      padding: 4px;
      gap: 4px;
    }
    
    .toggle-btn {
      padding: var(--spacing-sm) var(--spacing-xl);
      border: none;
      background: transparent;
      border-radius: calc(var(--radius) - 2px);
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: var(--transition);
      color: var(--text-secondary);
      min-width: 120px;
    }
    
    .toggle-btn.active {
      background: var(--gradient-cyan);
      color: white;
      box-shadow: 0 0 20px var(--success-glow);
    }
    
    /* ==================== BADGES ==================== */
    .badge {
      display: inline-flex;
      align-items: center;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 11px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      box-shadow: var(--shadow);
    }
    
    .badge-success {
      background: rgba(16, 185, 129, 0.2);
      color: var(--success);
      border: 1px solid var(--success);
      box-shadow: 0 0 10px var(--success-glow);
    }
    
    .badge-warning {
      background: rgba(252, 211, 77, 0.2);
      color: var(--warning);
      border: 1px solid var(--warning);
      box-shadow: 0 0 10px var(--warning-glow);
    }
    
    .badge-danger {
      background: rgba(239, 68, 68, 0.2);
      color: var(--danger);
      border: 1px solid var(--danger);
      box-shadow: 0 0 10px var(--danger-glow);
    }
    
    .badge-info {
      background: rgba(59, 130, 246, 0.2);
      color: var(--info);
      border: 1px solid var(--info);
      box-shadow: 0 0 10px var(--info-glow);
    }
    
    /* ==================== QUALITY DASHBOARD ==================== */
    .quality-dashboard {
      background: var(--gradient-premium);
      border-radius: var(--radius-xl);
      padding: var(--spacing-2xl);
      margin-bottom: var(--spacing-xl);
      color: white;
      box-shadow: var(--shadow-xl), 0 0 40px rgba(102, 126, 234, 0.4);
      position: relative;
      overflow: hidden;
    }
    
    .quality-dashboard::before {
      content: '';
      position: absolute;
      top: -50%;
      right: -50%;
      width: 200%;
      height: 200%;
      background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
      animation: rotate 20s linear infinite;
    }
    
    @keyframes rotate {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }
    
    .quality-header {
      font-size: 20px;
      font-weight: 700;
      margin-bottom: var(--spacing-lg);
      display: flex;
      align-items: center;
      justify-content: space-between;
      position: relative;
      z-index: 1;
    }
    
    .quality-score-large {
      font-size: 64px;
      font-weight: 700;
      text-align: center;
      margin: var(--spacing-xl) 0;
      text-shadow: 0 0 40px rgba(255, 255, 255, 0.5);
      position: relative;
      z-index: 1;
    }
    
    .quality-metrics {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: var(--spacing-lg);
      margin-top: var(--spacing-xl);
      position: relative;
      z-index: 1;
    }
    
    .quality-metric {
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: var(--radius-lg);
      padding: var(--spacing-lg);
      text-align: center;
      transition: var(--transition);
    }
    
    .quality-metric:hover {
      background: rgba(255, 255, 255, 0.15);
      transform: translateY(-4px);
    }
    
    .metric-value {
      font-size: 28px;
      font-weight: 700;
      margin-bottom: 4px;
      text-shadow: 0 0 20px rgba(255, 255, 255, 0.5);
    }
    
    .metric-label {
      font-size: 12px;
      opacity: 0.9;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    /* ==================== DIAGNOSTIC PANEL ==================== */
    .diagnostic-panel {
      background: var(--gradient-dark);
      border: 1px solid var(--glass-border);
      border-radius: var(--radius-xl);
      padding: var(--spacing-xl);
      margin: var(--spacing-xl) 0;
      box-shadow: var(--shadow-lg);
    }
    
    .diagnostic-header {
      font-size: 20px;
      font-weight: 700;
      margin-bottom: var(--spacing-lg);
      display: flex;
      align-items: center;
      gap: var(--spacing-sm);
      color: var(--accent-cyan);
    }
    
    .diagnostic-card {
      background: var(--bg-elevated);
      border: 1px solid var(--glass-border);
      border-radius: var(--radius-lg);
      padding: var(--spacing-lg);
      margin-bottom: var(--spacing-md);
      transition: var(--transition);
    }
    
    .diagnostic-card:hover {
      border-color: var(--accent-cyan);
      box-shadow: 0 0 20px rgba(0, 217, 255, 0.2);
    }
    
    .diagnostic-card:last-child {
      margin-bottom: 0;
    }
    
    .diagnostic-card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: var(--spacing-sm);
    }
    
    .diagnostic-card-title {
      font-weight: 700;
      font-size: 16px;
      color: var(--text-primary);
    }
    
    .diagnostic-recommendations {
      margin-top: var(--spacing-md);
      padding-top: var(--spacing-md);
      border-top: 1px solid var(--glass-border);
    }
    
    .diagnostic-recommendations ul {
      margin: var(--spacing-sm) 0;
      padding-left: var(--spacing-xl);
      font-size: 13px;
    }
    
    .diagnostic-recommendations li {
      margin: var(--spacing-sm) 0;
      color: var(--text-secondary);
    }
    
    /* ==================== PHOTO GALLERY ==================== */
    .photo-gallery {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: var(--spacing-md);
      margin-top: var(--spacing-md);
    }
    
    .photo-item {
      position: relative;
      aspect-ratio: 1;
      border-radius: var(--radius-lg);
      overflow: hidden;
      border: 2px solid var(--glass-border);
      cursor: pointer;
      background: var(--bg-elevated);
      transition: var(--transition);
    }
    
    .photo-item:hover {
      border-color: var(--accent-cyan);
      box-shadow: 0 0 20px rgba(0, 217, 255, 0.3);
      transform: scale(1.05);
    }
    
    .photo-item img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    
    .photo-item-actions {
      position: absolute;
      top: 8px;
      right: 8px;
      display: flex;
      gap: 4px;
      opacity: 0;
      transition: var(--transition);
    }
    
    .photo-item:hover .photo-item-actions {
      opacity: 1;
    }
    
    .photo-btn {
      width: 32px;
      height: 32px;
      border-radius: var(--radius);
      border: none;
      background: rgba(0, 0, 0, 0.8);
      backdrop-filter: blur(10px);
      color: white;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      transition: var(--transition);
    }
    
    .photo-btn:hover {
      background: var(--danger);
      box-shadow: 0 0 10px var(--danger-glow);
    }
    
    .photo-upload {
      aspect-ratio: 1;
      border: 2px dashed var(--glass-border);
      border-radius: var(--radius-lg);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      background: var(--bg-elevated);
      transition: var(--transition);
    }
    
    .photo-upload:hover {
      border-color: var(--accent-cyan);
      background: rgba(0, 217, 255, 0.05);
      box-shadow: 0 0 20px rgba(0, 217, 255, 0.2);
    }
    
    /* ==================== SIGNATURE PAD ==================== */
    .signature-pad {
      width: 100%;
      height: 200px;
      border: 2px solid var(--glass-border);
      border-radius: var(--radius-lg);
      cursor: crosshair;
      background: var(--bg-elevated);
      transition: var(--transition);
    }
    
    .signature-pad:hover {
      border-color: var(--accent-cyan);
      box-shadow: 0 0 20px rgba(0, 217, 255, 0.2);
    }
    
    /* ==================== CHART ==================== */
    .chart-container {
      height: 300px;
      margin: var(--spacing-lg) 0;
      position: relative;
      background: var(--bg-elevated);
      border: 1px solid var(--glass-border);
      border-radius: var(--radius-lg);
      padding: var(--spacing-lg);
    }
    
    /* ==================== CHECKLIST ==================== */
    .checklist-item {
      display: flex;
      align-items: flex-start;
      padding: var(--spacing-md);
      background: var(--bg-elevated);
      border: 1px solid var(--glass-border);
      border-radius: var(--radius);
      margin-bottom: var(--spacing-sm);
      cursor: pointer;
      transition: var(--transition);
    }
    
    .checklist-item:hover {
      border-color: var(--accent-cyan);
      background: var(--bg-tertiary);
      box-shadow: 0 0 20px rgba(0, 217, 255, 0.1);
    }
    
    .checklist-item.checked {
      border-color: var(--success);
      background: rgba(16, 185, 129, 0.1);
    }
    
    input[type="checkbox"] {
      width: 20px;
      height: 20px;
      margin-right: var(--spacing-md);
      accent-color: var(--accent-cyan);
      cursor: pointer;
      flex-shrink: 0;
      margin-top: 2px;
    }
    
    .checklist-item label {
      margin: 0;
      cursor: pointer;
      font-weight: 400;
      font-size: 13px;
      line-height: 1.6;
      color: var(--text-secondary);
    }
    
    /* ==================== MATERIALS CATALOG ==================== */
    .materials-category {
      margin-bottom: var(--spacing-md);
      border: 1px solid var(--glass-border);
      border-radius: var(--radius-lg);
      overflow: hidden;
      background: var(--bg-elevated);
      transition: var(--transition);
    }
    
    .materials-category:hover {
      border-color: var(--accent-cyan);
      box-shadow: 0 0 20px rgba(0, 217, 255, 0.1);
    }
    
    .category-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: var(--spacing-lg);
      background: var(--bg-tertiary);
      cursor: pointer;
      user-select: none;
      transition: var(--transition);
      border-bottom: 1px solid var(--glass-border);
    }
    
    .category-header:hover {
      background: var(--bg-elevated);
    }
    
    .category-title-group {
      display: flex;
      align-items: center;
      gap: var(--spacing-md);
    }
    
    .category-icon {
      font-size: 24px;
      filter: drop-shadow(0 0 8px currentColor);
    }
    
    .category-name {
      font-weight: 700;
      font-size: 16px;
      color: var(--text-primary);
    }
    
    .category-meta {
      display: flex;
      align-items: center;
      gap: var(--spacing-sm);
    }
    
    .category-count {
      font-size: 11px;
      color: var(--text-tertiary);
      background: var(--bg-elevated);
      padding: 4px 10px;
      border-radius: 12px;
      font-weight: 600;
      border: 1px solid var(--glass-border);
    }
    
    .category-selected {
      font-size: 11px;
      color: white;
      background: var(--gradient-cyan);
      padding: 4px 10px;
      border-radius: 12px;
      font-weight: 700;
      box-shadow: 0 0 10px var(--success-glow);
    }
    
    .category-arrow {
      transition: transform 0.3s ease;
      color: var(--text-tertiary);
      font-size: 16px;
    }
    
    .materials-category.expanded .category-arrow {
      transform: rotate(180deg);
    }
    
    .category-items {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease;
    }
    
    .materials-category.expanded .category-items {
      max-height: 10000px;
    }
    
    .material-item {
      display: flex;
      align-items: center;
      padding: var(--spacing-md) var(--spacing-lg);
      border-top: 1px solid var(--glass-border);
      background: var(--bg-secondary);
      transition: var(--transition);
    }
    
    .material-item:hover {
      background: var(--bg-tertiary);
      box-shadow: inset 0 0 20px rgba(0, 217, 255, 0.05);
    }
    
    .material-item:first-child {
      border-top: none;
    }
    
    .material-info {
      flex: 1;
      margin-left: var(--spacing-sm);
    }
    
    .material-name {
      font-weight: 600;
      font-size: 14px;
      color: var(--text-primary);
    }
    
    .material-spec {
      font-size: 12px;
      color: var(--text-tertiary);
      margin-top: 2px;
    }
    
    /* ==================== SELECTED MATERIALS ==================== */
    .selected-material {
      display: flex;
      align-items: center;
      gap: var(--spacing-md);
      padding: var(--spacing-md);
      background: var(--bg-elevated);
      border: 1px solid var(--glass-border);
      border-radius: var(--radius);
      margin-bottom: var(--spacing-sm);
      transition: var(--transition);
    }
    
    .selected-material:hover {
      border-color: var(--accent-cyan);
      box-shadow: 0 0 20px rgba(0, 217, 255, 0.1);
    }
    
    .selected-material-info {
      flex: 1;
    }
    
    .selected-material-controls {
      display: flex;
      align-items: center;
      gap: var(--spacing-sm);
    }
    
    .selected-material-controls select,
    .selected-material-controls input {
      padding: 8px 12px;
      font-size: 13px;
      border: 1px solid var(--glass-border);
    }
    
    .selected-material-controls select {
      width: 140px;
    }
    
    .selected-material-controls input {
      width: 70px;
      text-align: center;
    }
    
    /* ==================== STATUS CARDS ==================== */
    .status-card {
      padding: var(--spacing-lg);
      border-radius: var(--radius-lg);
      border-left: 4px solid;
      font-size: 14px;
      line-height: 1.6;
      margin-bottom: var(--spacing-md);
      backdrop-filter: blur(10px);
    }
    
    .status-card.success {
      background: rgba(16, 185, 129, 0.1);
      border-color: var(--success);
      color: var(--success);
    }
    
    .status-card.warning {
      background: rgba(252, 211, 77, 0.1);
      border-color: var(--warning);
      color: var(--warning);
    }
    
    .status-card.danger {
      background: rgba(239, 68, 68, 0.1);
      border-color: var(--danger);
      color: var(--danger);
    }
    
    .status-card.info {
      background: rgba(59, 130, 246, 0.1);
      border-color: var(--info);
      color: var(--info);
    }
    
    /* ==================== TOAST ==================== */
    .toast {
      position: fixed;
      bottom: 30px;
      right: 30px;
      background: var(--bg-elevated);
      backdrop-filter: blur(20px);
      border: 1px solid var(--glass-border);
      color: white;
      padding: var(--spacing-lg) var(--spacing-xl);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-xl);
      z-index: 9999;
      font-size: 14px;
      font-weight: 600;
      opacity: 0;
      transform: translateY(20px);
      transition: var(--transition);
      min-width: 280px;
      text-align: center;
    }
    
    .toast.show {
      opacity: 1;
      transform: translateY(0);
    }
    
    .toast.success {
      background: var(--gradient-cyan);
      box-shadow: var(--shadow-xl), 0 0 30px var(--success-glow);
    }
    
    .toast.danger {
      background: linear-gradient(135deg, #EF4444 0%, #DC2626 100%);
      box-shadow: var(--shadow-xl), 0 0 30px var(--danger-glow);
    }
    
    .toast.warning {
      background: var(--gradient-orange);
      box-shadow: var(--shadow-xl), 0 0 30px rgba(255, 107, 53, 0.4);
    }
    
    /* ==================== MODAL ==================== */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.8);
      backdrop-filter: blur(10px);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 10000;
      padding: var(--spacing-xl);
      animation: fadeIn 0.3s ease;
    }
    
    .modal-overlay.show {
      display: flex;
    }
    
    .modal {
      background: var(--bg-secondary);
      border: 1px solid var(--glass-border);
      border-radius: var(--radius-xl);
      padding: var(--spacing-2xl);
      max-width: 500px;
      width: 100%;
      box-shadow: var(--shadow-xl);
      animation: slideUp 0.3s ease;
    }
    
    @keyframes slideUp {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .modal-title {
      font-size: 24px;
      font-weight: 700;
      margin-bottom: var(--spacing-md);
      color: var(--text-primary);
    }
    
    .modal-content {
      color: var(--text-secondary);
      margin-bottom: var(--spacing-xl);
      line-height: 1.6;
      font-size: 14px;
    }
    
    .modal-actions {
      display: flex;
      gap: var(--spacing-sm);
      justify-content: flex-end;
    }
    
    /* ==================== DUCT DESIGN TREE ==================== */
    .duct-tree {
      font-family: 'Courier New', monospace;
      font-size: 12px;
      background: var(--bg-elevated);
      padding: var(--spacing-lg);
      border-radius: var(--radius-lg);
      border: 1px solid var(--glass-border);
      line-height: 1.8;
      overflow-x: auto;
      color: var(--text-secondary);
    }
    
    .duct-branch {
      margin-left: 20px;
      padding: 4px 0;
      color: var(--text-tertiary);
    }
    
    .duct-trunk {
      font-weight: 700;
      color: var(--accent-cyan);
      text-shadow: 0 0 10px var(--success-glow);
    }
    
    /* ==================== INFO BOX ==================== */
    .info-box {
      background: var(--bg-elevated);
      border: 1px solid var(--glass-border);
      border-radius: var(--radius-lg);
      padding: var(--spacing-lg);
      margin: var(--spacing-md) 0;
    }
    
    .info-box-title {
      font-weight: 700;
      font-size: 14px;
      color: var(--accent-cyan);
      margin-bottom: var(--spacing-sm);
    }
    
    .info-box-content {
      font-size: 13px;
      color: var(--text-secondary);
      line-height: 1.6;
    }
    
    /* ==================== UTILITIES ==================== */
    .hidden { display: none !important; }
    .mt-lg { margin-top: var(--spacing-lg); }
    .mb-lg { margin-bottom: var(--spacing-lg); }
    
    /* ==================== MOBILE MENU ==================== */
    .mobile-menu-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.8);
      backdrop-filter: blur(10px);
      z-index: 99;
      opacity: 0;
      transition: opacity 0.3s ease;
    }
    
    .mobile-menu-overlay.show {
      display: block;
      opacity: 1;
    }
    
    /* ==================== RESPONSIVE ==================== */
    @media (max-width: 1024px) {
      .sidebar {
        transform: translateX(-100%);
      }
      
      .sidebar.mobile-open {
        transform: translateX(0);
        box-shadow: var(--shadow-xl);
      }
      
      .main-content {
        margin-left: 0;
      }
      
      .menu-toggle {
        display: flex;
      }
      
      .form-grid-2,
      .form-grid-3,
      .form-grid-4 {
        grid-template-columns: 1fr;
      }
      
      .quality-metrics {
        grid-template-columns: repeat(2, 1fr);
      }
      
      .dashboard-grid {
        grid-template-columns: 1fr;
      }
    }
    
    @media (max-width: 768px) {
      .workspace {
        padding: var(--spacing-lg);
      }
      
      .top-header {
        padding: 0 var(--spacing-lg);
        height: 64px;
      }
      
      .header-title {
        font-size: 18px;
      }
      
      .quality-metrics {
        grid-template-columns: 1fr;
      }
      
      .photo-gallery {
        grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
      }
      
      .tile-stats {
        flex-direction: column;
      }
    }
  </style>
</head>

<body>
  <div class="app-container">
    
    <!-- MOBILE MENU OVERLAY -->
    <div class="mobile-menu-overlay" id="mobile-menu-overlay" onclick="toggleMobileMenu()"></div>
    
    <!-- PREMIUM SIDEBAR -->
    <aside class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <div class="sidebar-logo">
          <div class="sidebar-logo-icon">üîß</div>
          <div class="sidebar-logo-text">
            <div class="sidebar-title">Field Buddy Pro</div>
            <div class="sidebar-version">v4.0 Premium</div>
          </div>
        </div>
      </div>
      
      <nav class="sidebar-nav">
        <div class="nav-section">
          <div class="nav-section-title">Navigation</div>
          <div class="nav-item active" onclick="switchPage('dashboard')">
            <span class="nav-icon">üè†</span>
            <span>Dashboard</span>
          </div>
          <div class="nav-item" onclick="switchPage('service')">
            <span class="nav-icon">üìã</span>
            <span>Service Calls</span>
          </div>
          <div class="nav-item" onclick="switchPage('materials')">
            <span class="nav-icon">üì¶</span>
            <span>Materials</span>
          </div>
          <div class="nav-item" onclick="switchPage('duct-design')">
            <span class="nav-icon">üèóÔ∏è</span>
            <span>Pro Duct Design</span>
          </div>
          <div class="nav-item" onclick="switchPage('cfm')">
            <span class="nav-icon">üå™Ô∏è</span>
            <span>CFM Calculator</span>
          </div>
          <div class="nav-item" onclick="switchPage('history')">
            <span class="nav-icon">üìä</span>
            <span>History & Reports</span>
          </div>
        </div>
        
        <div class="nav-section">
          <div class="nav-section-title">Tools</div>
          <div class="nav-item" onclick="saveData()">
            <span class="nav-icon">üíæ</span>
            <span>Save Progress</span>
          </div>
          <div class="nav-item" onclick="loadData()">
            <span class="nav-icon">üì•</span>
            <span>Load Saved Data</span>
          </div>
          <div class="nav-item" onclick="exportAllData()">
            <span class="nav-icon">üì§</span>
            <span>Export All Data</span>
          </div>
        </div>
      </nav>
    </aside>
    
    <!-- MAIN CONTENT -->
    <main class="main-content">
      
      <!-- PREMIUM HEADER -->
      <header class="top-header">
        <div class="header-left">
          <button class="menu-toggle" onclick="toggleMobileMenu()">‚ò∞</button>
          <div class="header-title" id="page-title">Dashboard</div>
        </div>
        <div class="header-actions">
          <div class="header-user">
            <div class="user-avatar">MP</div>
            <span id="header-tech-name">Mart√≠n Perez</span>
          </div>
        </div>
      </header>
      
      <!-- WORKSPACE -->
      <div class="workspace">
        
        <!-- ==================== DASHBOARD PAGE ==================== -->
        <div id="dashboard-page" class="page-content">
          
          <div style="margin-bottom: var(--spacing-2xl);">
            <h1 style="font-size: 32px; font-weight: 700; margin-bottom: var(--spacing-sm); background: var(--gradient-cyan); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">
              Welcome Back, Mart√≠n! üëã
            </h1>
            <p style="color: var(--text-secondary); font-size: 16px;">
              Your professional HVAC field service management system
            </p>
          </div>
          
          <div class="dashboard-grid">
            
            <!-- Service Calls Tile -->
            <div class="dashboard-tile" onclick="switchPage('service')">
              <div class="tile-header">
                <div class="tile-icon">üìã</div>
                <div class="tile-badge premium">Advanced</div>
              </div>
              <div class="tile-content">
                <div class="tile-title">Service Calls</div>
                <div class="tile-description">
                  Complete diagnostic system with refrigerant calculations, temperature analysis, and professional reporting
                </div>
                <div class="tile-stats">
                  <div class="tile-stat">
                    <span class="tile-stat-value" id="dash-stat-reports">0</span>
                    <span class="tile-stat-label">Reports</span>
                  </div>
                  <div class="tile-stat">
                    <span class="tile-stat-value" id="dash-stat-quality">0%</span>
                    <span class="tile-stat-label">Avg Quality</span>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Materials Tile -->
            <div class="dashboard-tile" onclick="switchPage('materials')">
              <div class="tile-header">
                <div class="tile-icon orange">üì¶</div>
                <div class="tile-badge pro">Pro</div>
              </div>
              <div class="tile-content">
                <div class="tile-title">Materials Catalog</div>
                <div class="tile-description">
                  Comprehensive 2025 materials database with instant lookup and professional takeoff lists
                </div>
                <div class="tile-stats">
                  <div class="tile-stat">
                    <span class="tile-stat-value">1000+</span>
                    <span class="tile-stat-label">Items</span>
                  </div>
                  <div class="tile-stat">
                    <span class="tile-stat-value">12</span>
                    <span class="tile-stat-label">Categories</span>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Duct Design Tile -->
            <div class="dashboard-tile" onclick="switchPage('duct-design')">
              <div class="tile-header">
                <div class="tile-icon purple">üèóÔ∏è</div>
                <div class="tile-badge">Premium</div>
              </div>
              <div class="tile-content">
                <div class="tile-title">Pro Duct Design</div>
                <div class="tile-description">
                  ACCA Manual D compliant duct system design with CFM calculations and material takeoffs
                </div>
                <div class="tile-stats">
                  <div class="tile-stat">
                    <span class="tile-stat-value">‚úì</span>
                    <span class="tile-stat-label">ACCA Compliant</span>
                  </div>
                  <div class="tile-stat">
                    <span class="tile-stat-value">Auto</span>
                    <span class="tile-stat-label">Material List</span>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- CFM Calculator Tile -->
            <div class="dashboard-tile" onclick="switchPage('cfm')">
              <div class="tile-header">
                <div class="tile-icon premium">üå™Ô∏è</div>
                <div class="tile-badge">Essential</div>
              </div>
              <div class="tile-content">
                <div class="tile-title">CFM & Duct Sizing</div>
                <div class="tile-description">
                  Professional airflow and duct sizing calculators with multiple calculation methods
                </div>
                <div class="tile-stats">
                  <div class="tile-stat">
                    <span class="tile-stat-value">4</span>
                    <span class="tile-stat-label">Calculators</span>
                  </div>
                  <div class="tile-stat">
                    <span class="tile-stat-value">Instant</span>
                    <span class="tile-stat-label">Results</span>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- History Tile -->
            <div class="dashboard-tile" onclick="switchPage('history')">
              <div class="tile-header">
                <div class="tile-icon orange">üìä</div>
                <div class="tile-badge pro">Pro</div>
              </div>
              <div class="tile-content">
                <div class="tile-title">History & Reports</div>
                <div class="tile-description">
                  Access all saved reports, track statistics, and manage your service history
                </div>
                <div class="tile-stats">
                  <div class="tile-stat">
                    <span class="tile-stat-value" id="dash-stat-total">0</span>
                    <span class="tile-stat-label">Total</span>
                  </div>
                  <div class="tile-stat">
                    <span class="tile-stat-value" id="dash-stat-month">0</span>
                    <span class="tile-stat-label">This Month</span>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Quick Actions Tile -->
            <div class="dashboard-tile" style="background: var(--gradient-premium);">
              <div class="tile-header">
                <div class="tile-icon" style="background: rgba(255,255,255,0.2);">‚ö°</div>
              </div>
              <div class="tile-content">
                <div class="tile-title" style="color: white;">Quick Actions</div>
                <div class="tile-description" style="color: rgba(255,255,255,0.9); margin-bottom: var(--spacing-lg);">
                  Common tasks and shortcuts
                </div>
                <div style="display: flex; flex-direction: column; gap: var(--spacing-sm);">
                  <button class="btn btn-secondary" onclick="switchPage('service')" style="justify-content: flex-start;">
                    <span>üÜï</span> New Service Call
                  </button>
                  <button class="btn btn-secondary" onclick="switchPage('materials')" style="justify-content: flex-start;">
                    <span>üìù</span> Create Material List
                  </button>
                  <button class="btn btn-secondary" onclick="saveData()" style="justify-content: flex-start;">
                    <span>üíæ</span> Save Progress
                  </button>
                </div>
              </div>
            </div>
            
          </div>
          
        </div>
        
        <!-- SERVICE CALL PAGE -->
        <div id="service-page" class="page-content hidden">
          
          <!-- Quality Dashboard -->
          <div class="quality-dashboard" id="quality-dashboard">
            <div class="quality-header">
              <span>üìä Report Quality Score</span>
              <span id="quality-badge" class="badge badge-info">In Progress</span>
            </div>
            <div class="quality-score-large" id="quality-score-large">0%</div>
            <div class="quality-metrics">
              <div class="quality-metric">
                <div class="metric-value" id="metric-basic">0/5</div>
                <div class="metric-label">Basic Info</div>
              </div>
              <div class="quality-metric">
                <div class="metric-value" id="metric-diagnostics">0/3</div>
                <div class="metric-label">Diagnostics</div>
              </div>
              <div class="quality-metric">
                <div class="metric-value" id="metric-photos">0</div>
                <div class="metric-label">Photos</div>
              </div>
              <div class="quality-metric">
                <div class="metric-value" id="metric-signature">‚úó</div>
                <div class="metric-label">Signature</div>
              </div>
            </div>
          </div>
          
          <!-- System Mode Selector -->
          <div class="card">
            <div class="card-header">
              <div class="card-title">System Mode</div>
              <div class="toggle-group">
                <button class="toggle-btn active" id="mode-cooling" onclick="setSystemMode('cooling')">
                  ‚ùÑÔ∏è Cooling
                </button>
                <button class="toggle-btn" id="mode-heating" onclick="setSystemMode('heating')">
                  üî• Heating
                </button>
              </div>
            </div>
          </div>
          
          <!-- Job Information -->
          <div class="card">
            <div class="card-header">
              <div class="card-title">Job Information</div>
            </div>
            <div class="card-body">
              <div class="card-section">
                <label>Call Type</label>
                <div class="toggle-group">
                  <button class="toggle-btn active" id="call-trouble" onclick="setCallType('trouble')">
                    Trouble Call
                  </button>
                  <button class="toggle-btn" id="call-maintenance" onclick="setCallType('maintenance')">
                    Maintenance
                  </button>
                </div>
              </div>
              
              <div class="form-grid form-grid-2">
                <div class="form-group">
                  <label>Customer Name</label>
                  <input type="text" id="customer-name" placeholder="Enter customer name" oninput="calculateQuality()">
                </div>
                <div class="form-group">
                  <label>Date</label>
                  <input type="date" id="service-date" oninput="calculateQuality()">
                </div>
              </div>
              
              <div class="form-grid">
                <div class="form-group">
                  <label>Service Address</label>
                  <input type="text" id="service-address" placeholder="123 Main St, City, State ZIP" oninput="calculateQuality()">
                </div>
              </div>
              
              <div class="form-grid">
                <div class="form-group">
                  <label>Customer Complaint / Reason for Service</label>
                  <textarea id="customer-complaint" placeholder="Describe the issue or maintenance reason..." oninput="calculateQuality()"></textarea>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Equipment Information -->
          <div class="card">
            <div class="card-header">
              <div class="card-title">Equipment Information</div>
            </div>
            <div class="card-body">
              <div class="form-grid">
                <div class="form-group">
                  <label>Unit Type</label>
                  <select id="unit-type" onchange="updateUnitFields(); calculateQuality();">
                    <option value="">Select unit type...</option>
                    <option value="split">Split System</option>
                    <option value="package">Package Unit</option>
                    <option value="mini-split">Mini-Split</option>
                    <option value="heat-pump">Heat Pump</option>
                  </select>
                </div>
              </div>
              
              <div class="form-grid form-grid-2">
                <div class="form-group">
                  <label>Indoor Unit (Model/Serial)</label>
                  <input type="text" id="indoor-unit" placeholder="Model & Serial Number">
                </div>
                <div class="form-group" id="outdoor-unit-group">
                  <label>Outdoor Unit (Model/Serial)</label>
                  <input type="text" id="outdoor-unit" placeholder="Model & Serial Number">
                </div>
              </div>
              
              <div class="form-grid form-grid-3">
                <div class="form-group">
                  <label>Tonnage</label>
                  <select id="tonnage">
                    <option value="">Select...</option>
                    <option value="1.5">1.5 Ton</option>
                    <option value="2">2 Ton</option>
                    <option value="2.5">2.5 Ton</option>
                    <option value="3">3 Ton</option>
                    <option value="3.5">3.5 Ton</option>
                    <option value="4">4 Ton</option>
                    <option value="5">5 Ton</option>
                  </select>
                </div>
                <div class="form-group">
                  <label>
                    Refrigerant Type
                    <span class="help-icon" data-tooltip="R-410A is most common in modern systems">?</span>
                  </label>
                  <select id="refrigerant-type">
                    <option value="R410A">R-410A</option>
                    <option value="R22">R-22</option>
                    <option value="R454B">R-454B</option>
                    <option value="R32">R-32</option>
                  </select>
                </div>
                <div class="form-group">
                  <label>Filter Size</label>
                  <input type="text" id="filter-size" placeholder="e.g., 16x25x1">
                </div>
              </div>
              
              <div class="form-grid form-grid-2">
                <div class="form-group">
                  <label>
                    Metering Device
                    <span class="help-icon" data-tooltip="TXV adjusts automatically, Fixed Orifice (piston) does not">?</span>
                  </label>
                  <select id="metering-device" onchange="calculateDiagnostics()">
                    <option value="">Unknown</option>
                    <option value="txv">TXV (Thermostatic Expansion Valve)</option>
                    <option value="piston">Fixed Orifice / Piston</option>
                  </select>
                </div>
                <div class="form-group">
                  <label>SEER Rating</label>
                  <input type="number" id="seer-rating" placeholder="e.g., 14">
                </div>
              </div>
            </div>
          </div>
          
          <!-- Cooling Measurements -->
          <div class="card" id="cooling-measurements">
            <div class="card-header">
              <div class="card-title">Diagnostic Measurements (Cooling Mode)</div>
            </div>
            <div class="card-body">
              <div class="card-section">
                <div class="section-title">Temperature Readings</div>
                <div class="form-grid form-grid-4">
                  <div class="form-group">
                    <label>
                      Outdoor Ambient (¬∞F)
                      <span class="help-icon" data-tooltip="Temperature outside near condensing unit">?</span>
                    </label>
                    <input type="number" step="0.1" id="outdoor-ambient" oninput="calculateDiagnostics()">
                  </div>
                  <div class="form-group">
                    <label>
                      Ambient Temp (¬∞F)
                      <span class="help-icon" data-tooltip="Temperature inside near return air">?</span>
                    </label>
                    <input type="number" step="0.1" id="ambient-temp" oninput="calculateDiagnostics()">
                  </div>
                  <div class="form-group">
                    <label>Return Temp (¬∞F)</label>
                    <input type="number" step="0.1" id="return-temp" oninput="calculateDiagnostics()">
                  </div>
                  <div class="form-group">
                    <label>Supply Temp (¬∞F)</label>
                    <input type="number" step="0.1" id="supply-temp" oninput="calculateDiagnostics()">
                  </div>
                </div>
                <div class="form-grid form-grid-2">
                  <div class="form-group">
                    <label>
                      Delta-T (Calculated)
                      <span class="help-icon" data-tooltip="Should be 16-22¬∞F for proper cooling">?</span>
                    </label>
                    <input type="text" id="delta-t" readonly>
                  </div>
                  <div class="form-group">
                    <label>
                      Wet Bulb Temperature (¬∞F)
                      <span class="help-icon" data-tooltip="Used for accurate charge verification">?</span>
                    </label>
                    <input type="number" step="0.1" id="wet-bulb" oninput="calculateDiagnostics()">
                  </div>
                </div>
              </div>
              
              <div class="card-section">
                <div class="section-title">Refrigerant Pressures & Temperatures</div>
                <div class="form-grid form-grid-2">
                  <div class="form-group">
                    <label>Suction Pressure (PSI)</label>
                    <input type="number" step="0.1" id="suction-pressure" oninput="calculateDiagnostics()">
                  </div>
                  <div class="form-group">
                    <label>Suction Line Temp (¬∞F)</label>
                    <input type="number" step="0.1" id="suction-temp" oninput="calculateDiagnostics()">
                  </div>
                  <div class="form-group">
                    <label>Liquid Pressure (PSI)</label>
                    <input type="number" step="0.1" id="liquid-pressure" oninput="calculateDiagnostics()">
                  </div>
                  <div class="form-group">
                    <label>Liquid Line Temp (¬∞F)</label>
                    <input type="number" step="0.1" id="liquid-temp" oninput="calculateDiagnostics()">
                  </div>
                </div>
                <div class="form-grid form-grid-2">
                  <div class="form-group">
                    <label>
                      Superheat (Calculated)
                      <span class="help-icon" data-tooltip="TXV: 8-15¬∞F | Fixed: 5-25¬∞F (varies with outdoor temp)">?</span>
                    </label>
                    <input type="text" id="superheat" readonly>
                  </div>
                  <div class="form-group">
                    <label>
                      Subcool (Calculated)
                      <span class="help-icon" data-tooltip="Should be 8-12¬∞F for most systems">?</span>
                    </label>
                    <input type="text" id="subcool" readonly>
                  </div>
                </div>
              </div>
              
              <div class="card-section">
                <div class="section-title">Airflow & Electrical</div>
                <div class="form-grid form-grid-4">
                  <div class="form-group">
                    <label>
                      Static Pressure (in w.c.)
                      <span class="help-icon" data-tooltip="Total ESP should be ‚â§0.50 for residential">?</span>
                    </label>
                    <input type="number" step="0.01" id="static-pressure" oninput="calculateDiagnostics()">
                  </div>
                  <div class="form-group">
                    <label>Voltage (V)</label>
                    <input type="number" step="0.1" id="voltage">
                  </div>
                  <div class="form-group">
                    <label>
                      Amperage (A)
                      <span class="help-icon" data-tooltip="Compressor running amps">?</span>
                    </label>
                    <input type="number" step="0.1" id="amperage">
                  </div>
                  <div class="form-group">
                    <label>
                      RLA/FLA Rating
                      <span class="help-icon" data-tooltip="From equipment nameplate">?</span>
                    </label>
                    <input type="number" step="0.1" id="rla-rating" placeholder="Nameplate">
                  </div>
                </div>
              </div>
              
              <!-- Pressure Chart -->
              <div class="chart-container">
                <canvas id="pressure-chart"></canvas>
              </div>
            </div>
          </div>
          
          <!-- Heating Measurements -->
          <div class="card hidden" id="heating-measurements">
            <div class="card-header">
              <div class="card-title">Diagnostic Measurements (Heating Mode)</div>
            </div>
            <div class="card-body">
              <div class="card-section">
                <div class="section-title">Temperature Readings</div>
                <div class="form-grid form-grid-3">
                  <div class="form-group">
                    <label>Return Temp (¬∞F)</label>
                    <input type="number" step="0.1" id="return-temp-heat" oninput="calculateDiagnostics()">
                  </div>
                  <div class="form-group">
                    <label>Supply Temp (¬∞F)</label>
                    <input type="number" step="0.1" id="supply-temp-heat" oninput="calculateDiagnostics()">
                  </div>
                  <div class="form-group">
                    <label>
                      Temp Rise (Calculated)
                      <span class="help-icon" data-tooltip="Should be 35-65¬∞F for gas furnaces">?</span>
                    </label>
                    <input type="text" id="temp-rise" readonly>
                  </div>
                </div>
              </div>
              
              <div class="card-section">
                <div class="section-title">Gas Furnace / Heat Measurements</div>
                <div class="form-grid form-grid-4">
                  <div class="form-group">
                    <label>
                      Manifold Pressure (in w.c.)
                      <span class="help-icon" data-tooltip="Natural gas: 3.3-3.8 | LP: 10-11">?</span>
                    </label>
                    <input type="number" step="0.01" id="manifold-pressure" oninput="calculateDiagnostics()">
                  </div>
                  <div class="form-group">
                    <label>Voltage (V)</label>
                    <input type="number" step="0.1" id="voltage-heat">
                  </div>
                  <div class="form-group">
                    <label>Amperage (A)</label>
                    <input type="number" step="0.1" id="amperage-heat">
                  </div>
                  <div class="form-group">
                    <label>
                      Gas Type
                    </label>
                    <select id="gas-type">
                      <option value="natural">Natural Gas</option>
                      <option value="lp">LP/Propane</option>
                    </select>
                  </div>
                </div>
              </div>
              
              <!-- Temperature Rise Chart -->
              <div class="chart-container">
                <canvas id="heating-chart"></canvas>
              </div>
            </div>
          </div>
          
          <!-- Diagnostic Results -->
          <div id="diagnostic-results" class="hidden"></div>
          
          <!-- Photo Gallery -->
          <div class="card">
            <div class="card-header">
              <div class="card-title">üì∏ Job Photos</div>
              <span class="badge badge-info" id="photo-count">0 photos</span>
            </div>
            <div class="card-body">
              <div class="photo-gallery" id="photo-gallery">
                <label class="photo-upload">
                  <input type="file" accept="image/*" capture="camera" multiple onchange="handlePhotos(event)" style="display:none">
                  <span style="font-size: 32px;">üì∑</span>
                  <span>Add Photo</span>
                </label>
              </div>
            </div>
          </div>
          
          <!-- Cooling Checklist -->
          <div class="card" id="cooling-checklist">
            <div class="card-header">
              <div class="card-title">Cooling Mode Inspection Checklist</div>
              <span class="badge badge-info" id="cooling-checklist-count">0/35</span>
            </div>
            <div class="card-body">
              <div class="card-section">
                <div class="section-title">Air Filter & Indoor Unit</div>
                <div class="checklist-item">
                  <input type="checkbox" id="cool-check-filter" onchange="updateCheckbox(this)">
                  <label for="cool-check-filter">Air filter inspected/replaced (check size & MERV rating)</label>
                </div>
                <div class="checklist-item">
                  <input type="checkbox" id="cool-check-evap-coil" onchange="updateCheckbox(this)">
                  <label for="cool-check-evap-coil">Evaporator coil inspected for dirt/debris/restrictions</label>
                </div>
                <div class="checklist-item">
                  <input type="checkbox" id="cool-check-blower" onchange="updateCheckbox(this)">
                  <label for="cool-check-blower">Blower wheel/motor inspected (clean, proper rotation)</label>
                </div>
                <div class="checklist-item">
                  <input type="checkbox" id="cool-check-blower-amp" onchange="updateCheckbox(this)">
                  <label for="cool-check-blower-amp">Blower motor amperage checked</label>
                </div>
                <div class="checklist-item">
                  <input type="checkbox" id="cool-check-drain-pan" onchange="updateCheckbox(this)">
                  <label for="cool-check-drain-pan">Drain pan inspected (clean, no standing water)</label>
                </div>
              </div>
              
              <div class="card-section">
                <div class="section-title">Condensate System</div>
                <div class="checklist-item">
                  <input type="checkbox" id="cool-check-drain-line" onchange="updateCheckbox(this)">
                  <label for="cool-check-drain-line">Condensate drain line cleared/flushed</label>
                </div>
                <div class="checklist-item">
                  <input type="checkbox" id="cool-check-ptrap" onchange="updateCheckbox(this)">
                  <label for="cool-check-ptrap">P-trap inspected and water level checked</label>
                </div>
                <div class="checklist-item">
                  <input type="checkbox" id="cool-check-float" onchange="updateCheckbox(this)">
                  <label for="cool-check-float">Float switch/safety switch tested</label>
                </div>
                <div class="checklist-item">
                  <input type="checkbox" id="cool-check-pump" onchange="updateCheckbox(this)">
                  <label for="cool-check-pump">Condensate pump operation verified (if applicable)</label>
                </div>
              </div>
              
              <div class="card-section">
                <div class="section-title">Outdoor Condensing Unit</div>
                <div class="checklist-item">
                  <input type="checkbox" id="cool-check-condenser-coil" onchange="updateCheckbox(this)">
                  <label for="cool-check-condenser-coil">Condenser coil cleaned (check fin condition)</label>
                </div>
                <div class="checklist-item">
                  <input type="checkbox" id="cool-check-fan-motor" onchange="updateCheckbox(this)">
                  <label for="cool-check-fan-motor">Condenser fan motor operation checked</label>
                </div>
                <div class="checklist-item">
                  <input type="checkbox" id="cool-check-fan-blade" onchange="updateCheckbox(this)">
                  <label for="cool-check-fan-blade">Fan blade inspected (no damage/proper clearance)</label>
                </div>
                <div class="checklist-item">
                  <input type="checkbox" id="cool-check-cabinet" onchange="updateCheckbox(this)">
                  <label for="cool-check-cabinet">Cabinet/housing inspected for damage/debris</label>
                </div>
                <div class="checklist-item">
                  <input type="checkbox" id="cool-check-clearance" onchange="updateCheckbox(this)">
                  <label for="cool-check-clearance">Airflow clearance verified (24" minimum all sides)</label>
                </div>
              </div>
              
              <div class="card-section">
                <div class="section-title">Electrical Components</div>
                <div class="checklist-item">
                  <input type="checkbox" id="cool-check-contactor" onchange="updateCheckbox(this)">
                  <label for="cool-check-contactor">Contactor inspected (pitting, burning, proper operation)</label>
                </div>
                <div class="checklist-item">
                  <input type="checkbox" id="cool-check-capacitor" onchange="updateCheckbox(this)">
                  <label for="cool-check-capacitor">Capacitor(s) tested with meter (¬µF reading within spec)</label>
                </div>
                <div class="checklist-item">
                  <input type="checkbox" id="cool-check-disconnect" onchange="updateCheckbox(this)">
                  <label for="cool-check-disconnect">Disconnect switch inspected and cycled</label>
                </div>
                <div class="checklist-item">
                  <input type="checkbox" id="cool-check-wiring" onchange="updateCheckbox(this)">
                  <label for="cool-check-wiring">All wiring connections tightened and inspected</label>
                </div>
                <div class="checklist-item">
                  <input type="checkbox" id="cool-check-voltage" onchange="updateCheckbox(this)">
                  <label for="cool-check-voltage">Supply voltage checked (¬±10% of rated voltage)</label>
                </div>
                <div class="checklist-item">
                  <input type="checkbox" id="cool-check-compressor-amp" onchange="updateCheckbox(this)">
                  <label for="cool-check-compressor-amp">Compressor amperage checked (within nameplate specs)</label>
                </div>
              </div>
              
              <div class="card-section">
                <div class="section-title">Refrigerant System</div>
                <div class="checklist-item">
                  <input type="checkbox" id="cool-check-pressures" onchange="updateCheckbox(this)">
                  <label for="cool-check-pressures">Operating pressures verified (superheat/subcool)</label>
                </div>
                <div class="checklist-item">
                  <input type="checkbox" id="cool-check-lineset" onchange="updateCheckbox(this)">
                  <label for="cool-check-lineset">Line set insulation inspected (no deterioration)</label>
                </div>
                <div class="checklist-item">
                  <input type="checkbox" id="cool-check-leak" onchange="updateCheckbox(this)">
                  <label for="cool-check-leak">System leak checked (visual/electronic detector)</label>
                </div>
                <div class="checklist-item">
                  <input type="checkbox" id="cool-check-txv" onchange="updateCheckbox(this)">
                  <label for="cool-check-txv">TXV/metering device operation verified</label>
                </div>
              </div>
              
              <div class="card-section">
                <div class="section-title">Thermostat & Controls</div>
                <div class="checklist-item">
                  <input type="checkbox" id="cool-check-tstat" onchange="updateCheckbox(this)">
                  <label for="cool-check-tstat">Thermostat calibration/operation verified</label>
                </div>
                <div class="checklist-item">
                  <input type="checkbox" id="cool-check-tstat-wiring" onchange="updateCheckbox(this)">
                  <label for="cool-check-tstat-wiring">Thermostat wiring connections checked</label>
                </div>
                <div class="checklist-item">
                  <input type="checkbox" id="cool-check-cycle" onchange="updateCheckbox(this)">
                  <label for="cool-check-cycle">System cycling tested (on/off operation normal)</label>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Heating Checklist -->
          <div class="card hidden" id="heating-checklist">
            <div class="card-header">
              <div class="card-title">Heating Mode Inspection Checklist</div>
              <span class="badge badge-info" id="heating-checklist-count">0/40</span>
            </div>
            <div class="card-body">
              <div class="card-section">
                <div class="section-title">Air Filter & Airflow</div>
                <div class="checklist-item">
                  <input type="checkbox" id="heat-check-filter" onchange="updateCheckbox(this)">
                  <label for="heat-check-filter">Air filter inspected/replaced (check size & MERV rating)</label>
                </div>
                <div class="checklist-item">
                  <input type="checkbox" id="heat-check-blower" onchange="updateCheckbox(this)">
                  <label for="heat-check-blower">Blower assembly cleaned and inspected</label>
                </div>
                <div class="checklist-item">
                  <input type="checkbox" id="heat-check-blower-motor" onchange="updateCheckbox(this)">
                  <label for="heat-check-blower-motor">Blower motor operation/amperage checked</label>
                </div>
                <div class="checklist-item">
                  <input type="checkbox" id="heat-check-static" onchange="updateCheckbox(this)">
                  <label for="heat-check-static">Static pressure measured (supply & return)</label>
                </div>
              </div>
              
              <div class="card-section">
                <div class="section-title">Heat Exchanger & Combustion</div>
                <div class="checklist-item">
                  <input type="checkbox" id="heat-check-exchanger" onchange="updateCheckbox(this)">
                  <label for="heat-check-exchanger">Heat exchanger visually inspected (cracks, rust, deterioration)</label>
                </div>
                <div class="checklist-item">
                  <input type="checkbox" id="heat-check-burners" onchange="updateCheckbox(this)">
                  <label for="heat-check-burners">Burners cleaned and inspected (flame pattern checked)</label>
                </div>
                <div class="checklist-item">
                  <input type="checkbox" id="heat-check-flame-sensor" onchange="updateCheckbox(this)">
                  <label for="heat-check-flame-sensor">Flame sensor cleaned and tested (microamp reading)</label>
                </div>
                <div class="checklist-item">
                  <input type="checkbox" id="heat-check-igniter" onchange="updateCheckbox(this)">
                  <label for="heat-check-igniter">Hot surface igniter/ignition system inspected</label>
                </div>
                <div class="checklist-item">
                  <input type="checkbox" id="heat-check-burner-box" onchange="updateCheckbox(this)">
                  <label for="heat-check-burner-box">Burner box/combustion chamber cleaned</label>
                </div>
              </div>
              
              <div class="card-section">
                <div class="section-title">Gas System (if applicable)</div>
                <div class="checklist-item">
                  <input type="checkbox" id="heat-check-gas-valve" onchange="updateCheckbox(this)">
                  <label for="heat-check-gas-valve">Gas valve operation verified</label>
                </div>
                <div class="checklist-item">
                  <input type="checkbox" id="heat-check-manifold" onchange="updateCheckbox(this)">
                  <label for="heat-check-manifold">Manifold gas pressure measured (3.3-3.8" w.c.)</label>
                </div>
                <div class="checklist-item">
                  <input type="checkbox" id="heat-check-gas-line" onchange="updateCheckbox(this)">
                  <label for="heat-check-gas-line">Gas line connections leak checked (soap test)</label>
                </div>
                <div class="checklist-item">
                  <input type="checkbox" id="heat-check-gas-supply" onchange="updateCheckbox(this)">
                  <label for="heat-check-gas-supply">Inlet gas pressure checked (incoming supply)</label>
                </div>
              </div>
              
              <div class="card-section">
                <div class="section-title">Venting & Exhaust</div>
                <div class="checklist-item">
                  <input type="checkbox" id="heat-check-flue" onchange="updateCheckbox(this)">
                  <label for="heat-check-flue">Flue pipe/vent system inspected (no obstructions/damage)</label>
                </div>
                <div class="checklist-item">
                  <input type="checkbox" id="heat-check-inducer" onchange="updateCheckbox(this)">
                  <label for="heat-check-inducer">Inducer motor operation and amperage checked</label>
                </div>
                <div class="checklist-item">
                  <input type="checkbox" id="heat-check-pressure-switch" onchange="updateCheckbox(this)">
                  <label for="heat-check-pressure-switch">Pressure switch(es) tested and verified</label>
                </div>
                <div class="checklist-item">
                  <input type="checkbox" id="heat-check-condensate-trap" onchange="updateCheckbox(this)">
                  <label for="heat-check-condensate-trap">Condensate trap cleaned (90%+ furnaces)</label>
                </div>
                <div class="checklist-item">
                  <input type="checkbox" id="heat-check-co" onchange="updateCheckbox(this)">
                  <label for="heat-check-co">Carbon monoxide levels tested (ambient & flue)</label>
                </div>
              </div>
              
              <div class="card-section">
                <div class="section-title">Safety Controls</div>
                <div class="checklist-item">
                  <input type="checkbox" id="heat-check-rollout" onchange="updateCheckbox(this)">
                  <label for="heat-check-rollout">Rollout switches inspected and tested</label>
                </div>
                <div class="checklist-item">
                  <input type="checkbox" id="heat-check-limit" onchange="updateCheckbox(this)">
                  <label for="heat-check-limit">High limit switch(es) tested</label>
                </div>
                <div class="checklist-item">
                  <input type="checkbox" id="heat-check-safeties" onchange="updateCheckbox(this)">
                  <label for="heat-check-safeties">All safety interlocks verified operational</label>
                </div>
                <div class="checklist-item">
                  <input type="checkbox" id="heat-check-sequence" onchange="updateCheckbox(this)">
                  <label for="heat-check-sequence">Ignition sequence timing verified (proper lockout)</label>
                </div>
              </div>
              
              <div class="card-section">
                <div class="section-title">Electrical & Wiring</div>
                <div class="checklist-item">
                  <input type="checkbox" id="heat-check-wiring" onchange="updateCheckbox(this)">
                  <label for="heat-check-wiring">All electrical connections tightened</label>
                </div>
                <div class="checklist-item">
                  <input type="checkbox" id="heat-check-voltage" onchange="updateCheckbox(this)">
                  <label for="heat-check-voltage">Supply voltage checked (115V or 230V ¬±10%)</label>
                </div>
                <div class="checklist-item">
                  <input type="checkbox" id="heat-check-transformer" onchange="updateCheckbox(this)">
                  <label for="heat-check-transformer">Control transformer voltage checked (24V AC)</label>
                </div>
                <div class="checklist-item">
                  <input type="checkbox" id="heat-check-disconnect" onchange="updateCheckbox(this)">
                  <label for="heat-check-disconnect">Disconnect/service switch inspected</label>
                </div>
              </div>
              
              <div class="card-section">
                <div class="section-title">Thermostat & Controls</div>
                <div class="checklist-item">
                  <input type="checkbox" id="heat-check-tstat" onchange="updateCheckbox(this)">
                  <label for="heat-check-tstat">Thermostat calibration/operation verified</label>
                </div>
                <div class="checklist-item">
                  <input type="checkbox" id="heat-check-tstat-wiring" onchange="updateCheckbox(this)">
                  <label for="heat-check-tstat-wiring">Thermostat wiring connections checked</label>
                </div>
                <div class="checklist-item">
                  <input type="checkbox" id="heat-check-cycle" onchange="updateCheckbox(this)">
                  <label for="heat-check-cycle">Heating cycle tested (ignition to shutdown)</label>
                </div>
                <div class="checklist-item">
                  <input type="checkbox" id="heat-check-fan-delay" onchange="updateCheckbox(this)">
                  <label for="heat-check-fan-delay">Fan on/off delay times verified</label>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Findings & Work Performed -->
          <div class="card">
            <div class="card-header">
              <div class="card-title">Findings & Work Performed</div>
            </div>
            <div class="card-body">
              <div class="card-section">
                <div class="form-group">
                  <label>Findings</label>
                  <textarea id="findings" placeholder="Describe what you found during the service call..." oninput="calculateQuality()"></textarea>
                </div>
              </div>
              
              <div class="card-section">
                <div class="form-group">
                  <label>Recommendations</label>
                  <textarea id="recommendations" placeholder="What do you recommend to the customer?"></textarea>
                </div>
              </div>
              
              <div class="card-section">
                <div class="form-group">
                  <label>Work Performed</label>
                  <textarea id="work-performed" placeholder="Detail the work you completed..." oninput="calculateQuality()"></textarea>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Customer Signature -->
          <div class="card">
            <div class="card-header">
              <div class="card-title">‚úçÔ∏è Customer Signature</div>
            </div>
            <div class="card-body">
              <div class="form-grid form-grid-2">
                <div class="form-group">
                  <label>Customer Name</label>
                  <input type="text" id="sig-name" placeholder="Customer name" oninput="calculateQuality()">
                </div>
                <div class="form-group">
                  <label>Date</label>
                  <input type="date" id="sig-date" oninput="calculateQuality()">
                </div>
              </div>
              <canvas id="signature-pad" class="signature-pad"></canvas>
              <div class="btn-group mt-lg">
                <button class="btn btn-secondary" onclick="clearSignature()">Clear</button>
                <button class="btn btn-primary" onclick="saveSignature()">Save Signature</button>
              </div>
            </div>
          </div>
          
          <!-- Technician Info -->
          <div class="card">
            <div class="card-header">
              <div class="card-title">Technician Information</div>
            </div>
            <div class="card-body">
              <div class="form-grid form-grid-2">
                <div class="form-group">
                  <label>Technician Name</label>
                  <input type="text" id="tech-name" value="Mart√≠n Perez">
                </div>
                <div class="form-group">
                  <label>Contact Phone</label>
                  <input type="tel" id="tech-phone" value="(346)451-0024">
                </div>
              </div>
              <div class="form-grid">
                <div class="form-group">
                  <label>Email Address</label>
                  <input type="email" id="tech-email" value="Mperez@villageplumbing.com">
                </div>
              </div>
            </div>
          </div>
          
          <!-- Action Buttons -->
          <div class="btn-group">
            <button class="btn btn-success" onclick="generatePDF()">üìÑ Generate PDF</button>
            <button class="btn btn-primary" onclick="generateTextReport()">üìã Text Report</button>
            <button class="btn btn-secondary" onclick="saveData()">üíæ Save Progress</button>
            <button class="btn btn-danger" onclick="clearForm()">üóëÔ∏è Clear Form</button>
          </div>
          
          <!-- Report Preview -->
          <div id="report-container"></div>
          
        </div>
        
        <!-- MATERIALS PAGE (TRUNCATED FOR LENGTH - SAME STRUCTURE AS SERVICE PAGE) -->
        <div id="materials-page" class="page-content hidden">
          <!-- [Materials page content - same as original but with new styling] -->
          <div class="card">
            <div class="card-header">
              <div class="card-title">Job Information</div>
            </div>
            <div class="card-body">
              <div class="form-grid form-grid-2">
                <div class="form-group">
                  <label>Customer/Job Name</label>
                  <input type="text" id="mat-customer" placeholder="Enter customer or job name">
                </div>
                <div class="form-group">
                  <label>Date</label>
                  <input type="date" id="mat-date">
                </div>
              </div>
              
              <div class="form-grid">
                <div class="form-group">
                  <label>Job Address</label>
                  <input type="text" id="mat-address" placeholder="123 Main St, City, State ZIP">
                </div>
              </div>
              
              <div class="form-grid">
                <div class="form-group">
                  <label>Job Notes</label>
                  <textarea id="mat-notes" placeholder="Special instructions, access codes, etc."></textarea>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Materials Catalog -->
          <div class="card">
            <div class="card-header">
              <div class="card-title">Materials Catalog (2025 Complete Edition)</div>
              <div class="btn-group">
                <button class="btn btn-secondary" onclick="expandAllCategories()">Expand All</button>
                <button class="btn btn-secondary" onclick="collapseAllCategories()">Collapse All</button>
              </div>
            </div>
            <div class="card-body">
              <div class="form-group">
                <input type="text" id="material-search" placeholder="üîç Search materials..." oninput="filterMaterials()">
              </div>
              <div id="materials-catalog"></div>
            </div>
          </div>
          
          <!-- Selected Materials -->
          <div class="card">
            <div class="card-header">
              <div class="card-title">Selected Materials</div>
              <span class="badge badge-info" id="selected-materials-count">0 items</span>
            </div>
            <div class="card-body">
              <div id="selected-materials">
                <div class="status-card info">
                  ‚ÑπÔ∏è No materials selected yet. Use the catalog above to add items.
                </div>
              </div>
            </div>
          </div>
          
          <!-- Technician Info -->
          <div class="card">
            <div class="card-header">
              <div class="card-title">Technician Information</div>
            </div>
            <div class="card-body">
              <div class="form-grid form-grid-2">
                <div class="form-group">
                  <label>Technician Name</label>
                  <input type="text" id="mat-tech-name" value="Mart√≠n Perez">
                </div>
                <div class="form-group">
                  <label>Contact Phone</label>
                  <input type="tel" id="mat-tech-phone" value="(346)451-0024">
                </div>
              </div>
              <div class="form-grid">
                <div class="form-group">
                  <label>Email Address</label>
                  <input type="email" id="mat-tech-email" value="Mperez@villageplumbing.com">
                </div>
              </div>
            </div>
          </div>
          
          <!-- Action Buttons -->
          <div class="btn-group">
            <button class="btn btn-success" onclick="generateMaterialsPDF()">üìÑ Generate PDF</button>
            <button class="btn btn-primary" onclick="generateMaterialsReport()">üìã Generate List</button>
            <button class="btn btn-secondary" onclick="saveData()">üíæ Save Progress</button>
            <button class="btn btn-danger" onclick="clearForm()">üóëÔ∏è Clear Form</button>
          </div>
          
          <!-- Report Preview -->
          <div id="report-container-mat"></div>
        </div>
        
        <!-- DUCT DESIGN PAGE -->
        <div id="duct-design-page" class="page-content hidden">
          
          <!-- Project Info -->
          <div class="card">
            <div class="card-header">
              <div class="card-title">üèóÔ∏è Professional Duct Design Project</div>
            </div>
            <div class="card-body">
              <div class="form-grid form-grid-2">
                <div class="form-group">
                  <label>Project Name</label>
                  <input type="text" id="duct-project-name" placeholder="Smith Residence">
                </div>
                <div class="form-group">
                  <label>Date</label>
                  <input type="date" id="duct-project-date">
                </div>
              </div>
              
              <div class="form-grid form-grid-3">
                <div class="form-group">
                  <label>
                    System Tonnage
                    <span class="help-icon" data-tooltip="Equipment capacity rating">?</span>
                  </label>
                  <select id="duct-tonnage" onchange="calculateSystemCFM()">
                    <option value="">Select...</option>
                    <option value="1.5">1.5 Ton</option>
                    <option value="2">2 Ton</option>
                    <option value="2.5">2.5 Ton</option>
                    <option value="3">3 Ton</option>
                    <option value="3.5">3.5 Ton</option>
                    <option value="4">4 Ton</option>
                    <option value="5">5 Ton</option>
                  </select>
                </div>
                <div class="form-group">
                  <label>
                    Equipment Location
                    <span class="help-icon" data-tooltip="Where the air handler is installed">?</span>
                  </label>
                  <select id="duct-equipment-location">
                    <option value="attic">Attic</option>
                    <option value="closet">Closet</option>
                    <option value="basement">Basement</option>
                    <option value="garage">Garage</option>
                  </select>
                </div>
                <div class="form-group">
                  <label>
                    Return Type
                    <span class="help-icon" data-tooltip="Central = 1 return | Distributed = multiple returns">?</span>
                  </label>
                  <select id="duct-return-type">
                    <option value="central">Central Return</option>
                    <option value="distributed">Distributed Returns</option>
                  </select>
                </div>
              </div>
              
              <div class="form-grid">
                <div class="form-group">
                  <label>Known Airflow Issues</label>
                  <textarea id="duct-airflow-issues" placeholder="e.g., Master bedroom too hot, poor circulation in living room"></textarea>
                </div>
              </div>
              
              <div class="info-box">
                <div class="info-box-title">System CFM Calculation</div>
                <div class="info-box-content">
                  <strong>Total System CFM: <span id="system-cfm-display">0</span></strong> (Tonnage √ó 400 CFM/ton)
                </div>
              </div>
            </div>
          </div>
          
          <!-- Room-by-Room Design -->
          <div class="card">
            <div class="card-header">
              <div class="card-title">Room-by-Room Airflow Design</div>
              <button class="btn btn-primary" onclick="addDuctRoom()">+ Add Room</button>
            </div>
            <div class="card-body">
              <div id="duct-rooms-container">
                <div class="status-card info">
                  ‚ÑπÔ∏è Click "Add Room" to start your duct design. Input room details to calculate CFM requirements and duct sizing.
                </div>
              </div>
              
              <div id="duct-totals" class="hidden">
                <div class="quality-metrics" style="margin-top: var(--spacing-xl);">
                  <div class="quality-metric" style="background: var(--bg-elevated); border: 1px solid var(--glass-border);">
                    <div class="metric-value" style="color: var(--accent-cyan);" id="total-branches-cfm">0</div>
                    <div class="metric-label">Total Branch CFM</div>
                  </div>
                  <div class="quality-metric" style="background: var(--bg-elevated); border: 1px solid var(--glass-border);">
                    <div class="metric-value" style="color: var(--success);" id="cfm-balance">0%</div>
                    <div class="metric-label">System Balance</div>
                  </div>
                  <div class="quality-metric" style="background: var(--bg-elevated); border: 1px solid var(--glass-border);">
                    <div class="metric-value" style="color: var(--info);" id="rooms-designed">0</div>
                    <div class="metric-label">Rooms Designed</div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Trunk & Plenum Design -->
          <div class="card">
            <div class="card-header">
              <div class="card-title">Main Trunk & Plenum Specifications</div>
            </div>
            <div class="card-body">
              <div class="card-section">
                <div class="section-title">Main Supply Trunk</div>
                <div class="form-grid form-grid-3">
                  <div class="form-group">
                    <label>
                      Trunk CFM
                      <span class="help-icon" data-tooltip="Total system CFM for main trunk sizing">?</span>
                    </label>
                    <input type="text" id="trunk-cfm" readonly>
                  </div>
                  <div class="form-group">
                    <label>
                      Target Velocity (FPM)
                      <span class="help-icon" data-tooltip="700-900 FPM for main trunks">?</span>
                    </label>
                    <select id="trunk-velocity" onchange="calculateTrunkSize()">
                      <option value="700">700 FPM (Quiet)</option>
                      <option value="800" selected>800 FPM (Standard)</option>
                      <option value="900">900 FPM (Maximum)</option>
                    </select>
                  </div>
                  <div class="form-group">
                    <label>Recommended Size</label>
                    <input type="text" id="trunk-size-result" readonly style="font-weight: 600; color: var(--success);">
                  </div>
                </div>
              </div>
              
              <div class="card-section">
                <div class="section-title">Supply Plenum (Custom Duct Board)</div>
                <div class="form-grid form-grid-3">
                  <div class="form-group">
                    <label>Length (inches)</label>
                    <input type="number" id="supply-plenum-length" value="24" oninput="calculatePlenumMaterial()">
                  </div>
                  <div class="form-group">
                    <label>Width (inches)</label>
                    <input type="number" id="supply-plenum-width" value="24" oninput="calculatePlenumMaterial()">
                  </div>
                  <div class="form-group">
                    <label>Height (inches)</label>
                    <input type="number" id="supply-plenum-height" value="18" oninput="calculatePlenumMaterial()">
                  </div>
                </div>
              </div>
              
              <div class="card-section">
                <div class="section-title">Return Plenum (Custom Duct Board)</div>
                <div class="form-grid form-grid-3">
                  <div class="form-group">
                    <label>Length (inches)</label>
                    <input type="number" id="return-plenum-length" value="26" oninput="calculatePlenumMaterial()">
                  </div>
                  <div class="form-group">
                    <label>Width (inches)</label>
                    <input type="number" id="return-plenum-width" value="26" oninput="calculatePlenumMaterial()">
                  </div>
                  <div class="form-group">
                    <label>Height (inches)</label>
                    <input type="number" id="return-plenum-height" value="20" oninput="calculatePlenumMaterial()">
                  </div>
                </div>
              </div>
              
              <div class="info-box">
                <div class="info-box-title">Duct Board Required</div>
                <div class="info-box-content">
                  <strong>Total Sheets Needed: <span id="duct-board-sheets">0</span></strong> (4√ó8 sheets, 1.5" thick, includes 20% waste)
                </div>
              </div>
            </div>
          </div>
          
          <!-- System Schematic -->
          <div class="card" id="system-schematic-card" style="display: none;">
            <div class="card-header">
              <div class="card-title">System Schematic</div>
            </div>
            <div class="card-body">
              <div id="system-schematic" class="duct-tree"></div>
            </div>
          </div>
          
          <!-- Material Takeoff -->
          <div class="card" id="material-takeoff-card" style="display: none;">
            <div class="card-header">
              <div class="card-title">Complete Material Takeoff</div>
            </div>
            <div class="card-body">
              <div id="material-takeoff"></div>
            </div>
          </div>
          
          <!-- Generate Design -->
          <div class="btn-group">
            <button class="btn btn-success" onclick="generateDuctDesign()" id="generate-design-btn" disabled>
              üèóÔ∏è Generate Complete Design
            </button>
            <button class="btn btn-primary" onclick="exportDuctDesign()">üìÑ Export PDF</button>
            <button class="btn btn-secondary" onclick="saveDuctDesign()">üíæ Save Design</button>
            <button class="btn btn-danger" onclick="clearDuctDesignForm()">üóëÔ∏è Clear All</button>
          </div>
          
          <!-- Design Report Container -->
          <div id="duct-design-report-container"></div>
          
        </div>
        
        <!-- CFM CALCULATOR PAGE -->
        <div id="cfm-page" class="page-content hidden">
          
          <!-- CFM Calculators -->
          <div class="card">
            <div class="card-header">
              <div class="card-title">üå™Ô∏è CFM Calculators</div>
            </div>
            <div class="card-body">
              
              <!-- By Tonnage -->
              <div class="card-section">
                <div class="section-title">Calculate CFM by System Tonnage</div>
                <div class="form-grid form-grid-3">
                  <div class="form-group">
                    <label>System Tonnage</label>
                    <select id="cfm-tonnage" onchange="calculateCFMByTonnage()">
                      <option value="">Select...</option>
                      <option value="1.5">1.5 Ton</option>
                      <option value="2">2 Ton</option>
                      <option value="2.5">2.5 Ton</option>
                      <option value="3">3 Ton</option>
                      <option value="3.5">3.5 Ton</option>
                      <option value="4">4 Ton</option>
                      <option value="5">5 Ton</option>
                    </select>
                  </div>
                  <div class="form-group">
                    <label>CFM per Ton (Standard: 400)</label>
                    <input type="number" id="cfm-per-ton" value="400" onchange="calculateCFMByTonnage()">
                  </div>
                  <div class="form-group">
                    <label>Required CFM</label>
                    <input type="text" id="cfm-result-tonnage" readonly style="font-weight: 600; font-size: 18px; color: var(--accent-cyan);">
                  </div>
                </div>
              </div>
              
              <!-- By Temperature -->
              <div class="card-section">
                <div class="section-title">Calculate CFM by Temperature & BTU</div>
                <p style="font-size: 12px; color: var(--text-tertiary); margin-bottom: 12px;">
                  Formula: CFM = BTU √∑ (1.08 √ó ŒîT)
                </p>
                <div class="form-grid form-grid-3">
                  <div class="form-group">
                    <label>BTU/hr (Tonnage √ó 12,000)</label>
                    <input type="number" id="cfm-btu" placeholder="e.g., 36000" onchange="calculateCFMByTemp()">
                  </div>
                  <div class="form-group">
                    <label>Temperature Difference (¬∞F)</label>
                    <input type="number" step="0.1" id="cfm-delta-t" placeholder="e.g., 20" onchange="calculateCFMByTemp()">
                  </div>
                  <div class="form-group">
                    <label>Required CFM</label>
                    <input type="text" id="cfm-result-temp" readonly style="font-weight: 600; font-size: 18px; color: var(--accent-cyan);">
                  </div>
                </div>
              </div>
              
              <!-- By Room Size -->
              <div class="card-section">
                <div class="section-title">Calculate CFM by Room Size (ACH Method)</div>
                <p style="font-size: 12px; color: var(--text-tertiary); margin-bottom: 12px;">
                  Formula: CFM = (Room Volume √ó Air Changes per Hour) √∑ 60
                </p>
                <div class="form-grid form-grid-4">
                  <div class="form-group">
                    <label>Length (ft)</label>
                    <input type="number" id="room-length" placeholder="e.g., 12" onchange="calculateCFMByRoom()">
                  </div>
                  <div class="form-group">
                    <label>Width (ft)</label>
                    <input type="number" id="room-width" placeholder="e.g., 10" onchange="calculateCFMByRoom()">
                  </div>
                  <div class="form-group">
                    <label>Height (ft)</label>
                    <input type="number" id="room-height" value="8" onchange="calculateCFMByRoom()">
                  </div>
                  <div class="form-group">
                    <label>Air Changes/Hour</label>
                    <select id="room-ach" onchange="calculateCFMByRoom()">
                      <option value="4">4 (Bedroom)</option>
                      <option value="6" selected>6 (Living Room)</option>
                      <option value="8">8 (Kitchen)</option>
                      <option value="10">10 (Bathroom)</option>
                    </select>
                  </div>
                </div>
                <div class="form-grid form-grid-2">
                  <div class="form-group">
                    <label>Room Volume (cu ft)</label>
                    <input type="text" id="room-volume" readonly>
                  </div>
                  <div class="form-group">
                    <label>Required CFM</label>
                    <input type="text" id="cfm-result-room" readonly style="font-weight: 600; font-size: 18px; color: var(--accent-cyan);">
                  </div>
                </div>
              </div>
              
            </div>
          </div>
          
          <!-- Duct Sizing Calculator -->
          <div class="card">
            <div class="card-header">
              <div class="card-title">üìè Duct Sizing Calculator</div>
            </div>
            <div class="card-body">
              
              <!-- Input Parameters -->
              <div class="card-section">
                <div class="section-title">Input Parameters</div>
                <div class="form-grid form-grid-3">
                  <div class="form-group">
                    <label>Airflow (CFM)</label>
                    <input type="number" id="duct-cfm" placeholder="e.g., 1200" onchange="calculateDuctSize()">
                  </div>
                  <div class="form-group">
                    <label>Target Velocity (FPM)</label>
                    <select id="duct-velocity" onchange="calculateDuctSize()">
                      <option value="600">600 (Residential Supply)</option>
                      <option value="700" selected>700 (Standard)</option>
                      <option value="800">800 (Commercial)</option>
                      <option value="900">900 (High Velocity)</option>
                      <option value="500">500 (Return Air)</option>
                    </select>
                  </div>
                  <div class="form-group">
                    <label>Duct Type</label>
                    <select id="duct-type" onchange="calculateDuctSize()">
                      <option value="round">Round</option>
                      <option value="rectangular">Rectangular</option>
                    </select>
                  </div>
                </div>
              </div>
              
              <!-- Round Duct Results -->
              <div class="card-section" id="round-duct-results">
                <div class="section-title">Round Duct Sizing</div>
                <div class="form-grid form-grid-3">
                  <div class="form-group">
                    <label>Required Diameter (inches)</label>
                    <input type="text" id="round-diameter-calc" readonly style="font-weight: 600; color: var(--accent-cyan);">
                  </div>
                  <div class="form-group">
                    <label>Recommended Standard Size</label>
                    <input type="text" id="round-diameter-standard" readonly style="font-weight: 600; color: var(--success);">
                  </div>
                  <div class="form-group">
                    <label>Actual Velocity (FPM)</label>
                    <input type="text" id="round-velocity-actual" readonly>
                  </div>
                </div>
                <div class="form-grid">
                  <div class="form-group">
                    <label>Cross-Sectional Area (sq in)</label>
                    <input type="text" id="round-area" readonly>
                  </div>
                </div>
              </div>
              
              <!-- Rectangular Duct Results -->
              <div class="card-section hidden" id="rectangular-duct-results">
                <div class="section-title">Rectangular Duct Sizing Options</div>
                <div id="rectangular-options"></div>
              </div>
              
              <!-- Velocity Chart -->
              <div class="chart-container">
                <canvas id="velocity-chart"></canvas>
              </div>
              
            </div>
          </div>
          
          <!-- Quick Reference -->
          <div class="card">
            <div class="card-header">
              <div class="card-title">üìö Quick Reference Guide</div>
            </div>
            <div class="card-body">
              <div class="form-grid form-grid-2">
                <div>
                  <div class="section-title">Standard CFM Guidelines</div>
                  <ul style="font-size: 13px; line-height: 1.8; color: var(--text-secondary);">
                    <li><strong>Residential Cooling:</strong> 400 CFM per ton</li>
                    <li><strong>High Efficiency:</strong> 450 CFM per ton</li>
                    <li><strong>Dehumidification:</strong> 350 CFM per ton</li>
                    <li><strong>Heating (Gas):</strong> Temperature rise 40-70¬∞F</li>
                    <li><strong>Heat Pump:</strong> 400-450 CFM per ton</li>
                  </ul>
                </div>
                <div>
                  <div class="section-title">Recommended Velocities (FPM)</div>
                  <ul style="font-size: 13px; line-height: 1.8; color: var(--text-secondary);">
                    <li><strong>Main Supply Trunk:</strong> 700-900</li>
                    <li><strong>Branch Ducts:</strong> 500-700</li>
                    <li><strong>Residential Supply:</strong> 600-800</li>
                    <li><strong>Return Air:</strong> 500-600</li>
                    <li><strong>Maximum (noise):</strong> 900</li>
                  </ul>
                </div>
              </div>
              
              <div class="section-title mt-lg">Standard Round Duct Sizes (inches)</div>
              <div style="display: flex; gap: 8px; flex-wrap: wrap; font-size: 13px;">
                <span class="badge badge-info">4"</span>
                <span class="badge badge-info">5"</span>
                <span class="badge badge-info">6"</span>
                <span class="badge badge-info">7"</span>
                <span class="badge badge-info">8"</span>
                <span class="badge badge-info">9"</span>
                <span class="badge badge-info">10"</span>
                <span class="badge badge-info">12"</span>
                <span class="badge badge-info">14"</span>
                <span class="badge badge-info">16"</span>
                <span class="badge badge-info">18"</span>
                <span class="badge badge-info">20"</span>
              </div>
              
              <div class="section-title mt-lg">Common Rectangular Duct Sizes (inches)</div>
              <div style="display: flex; gap: 8px; flex-wrap: wrap; font-size: 13px;">
                <span class="badge badge-info">6x8</span>
                <span class="badge badge-info">6x10</span>
                <span class="badge badge-info">6x12</span>
                <span class="badge badge-info">8x10</span>
                <span class="badge badge-info">8x12</span>
                <span class="badge badge-info">10x12</span>
                <span class="badge badge-info">10x14</span>
                <span class="badge badge-info">12x14</span>
                <span class="badge badge-info">12x16</span>
                <span class="badge badge-info">14x16</span>
                <span class="badge badge-info">16x20</span>
                <span class="badge badge-info">18x24</span>
              </div>
            </div>
          </div>
          
          <!-- Report Container -->
          <div id="duct-report-container"></div>
          
        </div>
        
        <!-- HISTORY PAGE -->
        <div id="history-page" class="page-content hidden">
          
          <div class="card">
            <div class="card-header">
              <div class="card-title">üìä Saved Reports & History</div>
              <button class="btn btn-primary" onclick="refreshHistory()">Refresh</button>
            </div>
            <div class="card-body">
              <div id="history-list">
                <div class="status-card info">
                  ‚ÑπÔ∏è No saved reports yet. Complete a service call and save your progress to see history here.
                </div>
              </div>
            </div>
          </div>
          
          <!-- Statistics -->
          <div class="card">
            <div class="card-header">
              <div class="card-title">üìà Statistics</div>
            </div>
            <div class="card-body">
              <div class="quality-metrics">
                <div class="quality-metric" style="background: var(--bg-elevated); border: 1px solid var(--glass-border);">
                  <div class="metric-value" style="color: var(--accent-cyan);" id="stat-total">0</div>
                  <div class="metric-label">Total Reports</div>
                </div>
                <div class="quality-metric" style="background: var(--bg-elevated); border: 1px solid var(--glass-border);">
                  <div class="metric-value" style="color: var(--accent-orange);" id="stat-this-month">0</div>
                  <div class="metric-label">This Month</div>
                </div>
                <div class="quality-metric" style="background: var(--bg-elevated); border: 1px solid var(--glass-border);">
                  <div class="metric-value" style="color: var(--success);" id="stat-avg-quality">0%</div>
                  <div class="metric-label">Avg Quality</div>
                </div>
                <div class="quality-metric" style="background: var(--bg-elevated); border: 1px solid var(--glass-border);">
                  <div class="metric-value" style="color: var(--info);" id="stat-photos">0</div>
                  <div class="metric-label">Total Photos</div>
                </div>
              </div>
            </div>
          </div>
          
        </div>
        
      </div>
      
    </main>
    
  </div>
  
  <!-- TOAST NOTIFICATION -->
  <div class="toast" id="toast"></div>
  
  <!-- MODAL -->
  <div class="modal-overlay" id="modal-overlay">
    <div class="modal">
      <div class="modal-title" id="modal-title">Confirm Action</div>
      <div class="modal-content" id="modal-content">Are you sure?</div>
      <div class="modal-actions">
        <button class="btn btn-secondary" onclick="closeModal(false)">Cancel</button>
        <button class="btn btn-primary" onclick="closeModal(true)">Confirm</button>
      </div>
    </div>
  </div>
  
  <script>
    // ==================== [ALL ORIGINAL JAVASCRIPT CODE PRESERVED] ====================
    // [Due to character limits, I'm indicating that ALL the original JavaScript from the previous version
    // should be included here - the STATE MANAGEMENT, R410A calculations, materials catalog, 
    // diagnostics logic, duct design functions, CFM calculators, data persistence, report generation, etc.]
    
    // ==================== STATE MANAGEMENT ====================
    let currentPage = 'dashboard';
    let callType = 'trouble';
    let systemMode = 'cooling';
    let selectedMaterials = [];
    let diagnosticResults = [];
    let categoryStates = {};
    let photos = [];
    let signaturePad = null;
    let customerSignature = null;
    let pressureChart = null;
    let heatingChart = null;
    let velocityChart = null;
    let savedReports = [];
    let ductDesignRooms = [];
    let currentDuctDesign = null;
    
    // R410A PRESSURE-TEMPERATURE CHART
    const R410A_PT = {
      43: 0, 57: 10, 73: 20, 92: 30, 114: 40, 117: 41, 121: 42, 125: 43,
      140: 50, 169: 60, 201: 70, 237: 80, 278: 90, 323: 100, 330: 102,
      335: 103, 338: 104, 347: 105, 373: 110, 400: 115, 428: 120,
      460: 125, 493: 130, 528: 135, 565: 140
    };
    
    const FIXED_ORIFICE_SUPERHEAT_TARGETS = {
      65: 25, 70: 23, 75: 21, 80: 18, 85: 15, 90: 12, 95: 10, 100: 8, 105: 6
    };
    
    // [INCLUDE ALL MATERIALS CATALOG DATA]
    const materialsCatalog = {
      equipment: {
        name: 'Equipment',
        icon: 'üè†',
        items: [
          { id: 'furnace-gas', name: 'Gas Furnace', sizes: ['40K BTU', '60K BTU', '80K BTU', '100K BTU', '120K BTU'] },
          { id: 'furnace-electric', name: 'Electric Furnace', sizes: ['10kW', '15kW', '20kW', '25kW'] },
          { id: 'ac-unit', name: 'Air Conditioner', sizes: ['1.5 Ton', '2 Ton', '2.5 Ton', '3 Ton', '3.5 Ton', '4 Ton', '5 Ton'] },
          { id: 'heat-pump', name: 'Heat Pump', sizes: ['2 Ton', '2.5 Ton', '3 Ton', '3.5 Ton', '4 Ton', '5 Ton'] },
          { id: 'evap-coil', name: 'Evaporator Coil', sizes: ['2 Ton', '2.5 Ton', '3 Ton', '3.5 Ton', '4 Ton', '5 Ton'] },
          { id: 'air-handler', name: 'Air Handler', sizes: ['2 Ton', '2.5 Ton', '3 Ton', '3.5 Ton', '4 Ton'] },
          { id: 'package-unit', name: 'Package Unit', sizes: ['2 Ton', '3 Ton', '4 Ton', '5 Ton'] },
          { id: 'minisplit', name: 'Mini-Split System', sizes: ['9K BTU', '12K BTU', '18K BTU', '24K BTU', '36K BTU'] }
        ]
      },
      electrical: {
        name: 'Electrical Components',
        icon: '‚ö°',
        items: [
          { id: 'contactor', name: 'Contactor', sizes: ['1-Pole 30A', '2-Pole 30A', '2-Pole 40A', '3-Pole 30A', '3-Pole 40A'] },
          { id: 'capacitor-single', name: 'Run Capacitor (Single)', sizes: ['5¬µF', '7.5¬µF', '10¬µF', '15¬µF', '20¬µF', '25¬µF', '30¬µF', '35¬µF', '40¬µF', '45¬µF', '50¬µF', '60¬µF'] },
          { id: 'capacitor-dual', name: 'Dual Run Capacitor', sizes: ['35/5¬µF', '40/5¬µF', '45/5¬µF', '50/5¬µF', '55/5¬µF', '60/5¬µF'] },
          { id: 'hard-start', name: 'Hard Start Kit', sizes: ['1-2 Ton', '2-3 Ton', '3-5 Ton'] },
          { id: 'soft-start', name: 'Soft Start Kit', sizes: ['1-2 Ton', '2-3 Ton', '3-5 Ton'] },
          { id: 'compressor-saver', name: 'Compressor Saver', sizes: ['Universal'] },
          { id: 'potential-relay', name: 'Potential Relay', sizes: ['Standard', 'Heavy Duty'] },
          { id: 'voltage-regulator', name: 'Voltage Regulator/Stabilizer', sizes: ['240V 15A', '240V 30A', '240V 60A'] },
          { id: 'surge-protector', name: 'Surge Protector (HVAC)', sizes: ['Whole Unit', 'Panel Mount'] },
          { id: 'disconnect-30', name: 'Disconnect Box (30A)', sizes: ['30A Non-Fused', '30A Fused'] },
          { id: 'disconnect-60', name: 'Disconnect Box (60A)', sizes: ['60A Non-Fused', '60A Fused'] },
          { id: 'breaker', name: 'Circuit Breaker', sizes: ['15A', '20A', '25A', '30A', '40A', '50A', '60A'] },
          { id: 'whip', name: 'Electrical Whip', sizes: ['3 ft', '6 ft', '10 ft'] },
          { id: 'wire-lv', name: 'Low Voltage Wire (18ga)', sizes: ['18/2', '18/3', '18/5', '18/8'], unit: 'ft' },
          { id: 'wire-hv', name: 'High Voltage Wire', sizes: ['14/2', '12/2', '10/2', '10/3', '8/2', '8/3'], unit: 'ft' },
          { id: 'transformer', name: 'Control Transformer', sizes: ['24V 40VA', '24V 75VA', '24V 100VA'] }
        ]
      },
      controls: {
        name: 'Controls & Thermostats',
        icon: 'üå°Ô∏è',
        items: [
          { id: 'tstat-smart', name: 'WiFi Smart Thermostat', sizes: ['Nest', 'Ecobee', 'Honeywell T9'] },
          { id: 'tstat-programmable', name: 'Programmable Thermostat', sizes: ['5-2 Day', '7 Day'] },
          { id: 'tstat-nonprog', name: 'Non-Programmable Thermostat', sizes: ['Digital', 'Mercury Free'] },
          { id: 'zone-control-panel', name: 'Zone Control Panel', sizes: ['2 Zone', '3 Zone', '4 Zone', '6 Zone'] },
          { id: 'zone-damper', name: 'Zone Damper', sizes: ['6" Round', '8" Round', '10" Round', '6x10 Rect'] },
          { id: 'humidistat', name: 'Humidistat Control', sizes: ['Digital', 'Mechanical'] }
        ]
      },
      ductwork: {
        name: 'Ductwork & Distribution',
        icon: 'üå¨Ô∏è',
        items: [
          { id: 'flex-duct-insulated', name: 'Flex Duct (Insulated R6)', sizes: ['4"', '5"', '6"', '7"', '8"', '10"', '12"', '14"', '16"'], unit: '25ft bag' },
          { id: 'rigid-galv', name: 'Rigid Galvanized Duct', sizes: ['4"', '6"', '8"', '10"', '12"', '14"', '16"'], unit: 'ft' },
          { id: 'duct-board', name: 'Duct Board (1.5" thick)', sizes: ['4x8 sheet'], unit: 'sheet' },
          { id: 'starting-collar', name: 'Starting Collar', sizes: ['4"', '5"', '6"', '7"', '8"', '10"', '12"'], unit: 'ea' },
          { id: 'register', name: 'Supply Register', sizes: ['4x10', '4x12', '6x10', '6x12', '8x10', '10x10', '12x12'] },
          { id: 'grille', name: 'Return Grille', sizes: ['10x10', '12x12', '14x14', '16x16', '20x20', '24x24'] },
          { id: 'diffuser', name: 'Ceiling Diffuser', sizes: ['6" Round', '8" Round', '10" Round', '12" Round'] },
          { id: 'damper-manual', name: 'Manual Balancing Damper', sizes: ['4"', '6"', '8"', '10"', '12"'] },
          { id: 'boot-register', name: 'Register Boot', sizes: ['4"', '6"', '8"', '10"'], unit: 'ea' },
          { id: 'duct-strap', name: 'Adjustable Duct Strap', sizes: ['Standard'], unit: 'box' }
        ]
      },
      ductFittings: {
        name: 'Duct Fittings',
        icon: 'üîß',
        items: [
          { id: 'elbow-90', name: '90¬∞ Elbow', sizes: ['4"', '6"', '8"', '10"', '12"'], unit: 'ea' },
          { id: 'elbow-45', name: '45¬∞ Elbow', sizes: ['4"', '6"', '8"', '10"', '12"'], unit: 'ea' },
          { id: 'tee', name: 'Tee/Wye Fitting', sizes: ['6"', '8"', '10"', '12"'], unit: 'ea' },
          { id: 'reducer', name: 'Reducer', sizes: ['10-8"', '12-10"', '10-6"', '8-6"'], unit: 'ea' },
          { id: 'takeoff-collar', name: 'Takeoff Collar', sizes: ['6"', '7"', '8"', '10"'], unit: 'ea' },
          { id: 'end-cap', name: 'End Cap', sizes: ['4"', '6"', '8"', '10"'], unit: 'ea' }
        ]
      },
      iaq: {
        name: 'Air Quality & Filtration',
        icon: 'üí®',
        items: [
          { id: 'filter-disposable', name: 'Disposable Filter', sizes: ['16x20x1', '16x25x1', '20x20x1', '20x25x1', '24x24x1'], unit: 'pack' },
          { id: 'filter-pleated', name: 'Pleated Filter (MERV 11)', sizes: ['16x20x1', '16x25x1', '20x20x1', '20x25x1'], unit: 'pack' },
          { id: 'filter-hepa', name: 'HEPA Filter (MERV 13)', sizes: ['16x20', '16x25', '20x20', '20x25'] },
          { id: 'media-cleaner', name: 'Media Air Cleaner', sizes: ['16x25', '20x25'] },
          { id: 'uv-light-single', name: 'UV Light System (Single)', sizes: ['24V'] },
          { id: 'uv-light-dual', name: 'UV Light System (Dual)', sizes: ['24V'] },
          { id: 'reme-halo', name: 'REME HALO Air Purifier', sizes: ['24V'] },
          { id: 'humidifier-bypass', name: 'Bypass Humidifier', sizes: ['12 GPD', '17 GPD'] },
          { id: 'dehumidifier-90', name: 'Whole-Home Dehumidifier', sizes: ['90 Pint', '120 Pint'] },
          { id: 'erv', name: 'ERV System', sizes: ['100 CFM', '150 CFM', '200 CFM'] }
        ]
      },
      refrigeration: {
        name: 'Refrigeration',
        icon: '‚ùÑÔ∏è',
        items: [
          { id: 'lineset-small', name: 'Line Set (1.5-2.5 Ton)', sizes: ['15 ft', '25 ft', '35 ft', '50 ft'], spec: '1/4" x 3/8"' },
          { id: 'lineset-medium', name: 'Line Set (3-3.5 Ton)', sizes: ['15 ft', '25 ft', '35 ft', '50 ft'], spec: '3/8" x 3/4"' },
          { id: 'lineset-large', name: 'Line Set (4-5 Ton)', sizes: ['15 ft', '25 ft', '35 ft', '50 ft'], spec: '3/8" x 7/8"' },
          { id: 'copper-tubing', name: 'Copper Tubing (ACR)', sizes: ['1/4"', '3/8"', '1/2"', '5/8"', '3/4"', '7/8"'], unit: 'ft' },
          { id: 'r410a', name: 'R-410A Refrigerant', sizes: ['25 lb', '50 lb'], unit: 'cylinder' },
          { id: 'r22', name: 'R-22 Refrigerant', sizes: ['30 lb'], unit: 'cylinder' },
          { id: 'r32', name: 'R-32 Refrigerant', sizes: ['20 lb'], unit: 'cylinder' },
          { id: 'r454b', name: 'R-454B Refrigerant', sizes: ['25 lb'], unit: 'cylinder' },
          { id: 'txv', name: 'TXV (Expansion Valve)', sizes: ['2 Ton', '2.5 Ton', '3 Ton', '3.5 Ton', '4 Ton', '5 Ton'] },
          { id: 'filter-drier', name: 'Filter Drier', sizes: ['1/2"', '5/8"', '3/4"'] },
          { id: 'refrig-oil', name: 'Refrigerant Oil', sizes: ['POE 8oz', 'POE 16oz'] }
        ]
      },
      drainage: {
        name: 'Condensate Management',
        icon: 'üíß',
        items: [
          { id: 'condensate-pump', name: 'Condensate Pump', sizes: ['Standard', 'Heavy Duty'] },
          { id: 'drain-pvc', name: 'PVC Drain Pipe (3/4")', sizes: ['10 ft', '20 ft'], unit: 'length' },
          { id: 'drain-pan-primary', name: 'Drain Pan (Primary)', sizes: ['24x24', '30x30', '36x36'] },
          { id: 'drain-pan-secondary', name: 'Drain Pan (Secondary)', sizes: ['24x24', '30x30', '36x36'] },
          { id: 'ptrap', name: 'P-Trap', sizes: ['3/4"', '1"'] },
          { id: 'float-switch', name: 'Float Switch', sizes: ['Standard'] },
          { id: 'drain-tubing', name: 'Clear Vinyl Drain Tubing', sizes: ['3/8"', '1/2"', '5/8"'], unit: 'ft' }
        ]
      },
      venting: {
        name: 'Venting (Gas/Oil)',
        icon: 'üî•',
        items: [
          { id: 'bvent', name: 'B-Vent Pipe', sizes: ['3"', '4"', '5"', '6"', '7"'], unit: 'ft' },
          { id: 'pvc-vent', name: 'PVC Vent Pipe', sizes: ['2"', '3"', '4"'], unit: 'ft' },
          { id: 'vent-cap', name: 'Vent Cap/Termination', sizes: ['2"', '3"', '4"', '5"', '6"'] },
          { id: 'vent-elbow-90', name: 'Vent Elbow (90¬∞)', sizes: ['2"', '3"', '4"', '5"'] },
          { id: 'inducer', name: 'Inducer Motor', sizes: ['Standard', 'High Efficiency'] }
        ]
      },
      insulation: {
        name: 'Insulation & Sealants',
        icon: 'üß±',
        items: [
          { id: 'duct-insulation-fiberglass', name: 'Fiberglass Duct Wrap', sizes: ['R-6', 'R-8'], unit: 'roll' },
          { id: 'pipe-insulation-foam', name: 'Foam Pipe Insulation', sizes: ['1/4"', '3/8"', '1/2"', '5/8"', '3/4"', '7/8"'], unit: 'ft' },
          { id: 'mastic', name: 'Duct Mastic', sizes: ['1 Gallon', '5 Gallon'] },
          { id: 'foil-tape', name: 'Foil Tape', sizes: ['2"', '3"'], unit: 'roll' },
          { id: 'mesh-tape', name: 'Mesh Tape (for mastic)', sizes: ['2"', '3"'], unit: 'roll' },
          { id: 'silicone-caulk', name: 'Silicone Caulk', sizes: ['Clear', 'White', 'Aluminum'], unit: 'tube' },
          { id: 'foam-sealant', name: 'Expanding Foam Sealant', sizes: ['Standard', 'Fire-Rated'], unit: 'can' }
        ]
      },
      tools: {
        name: 'Tools & Instruments',
        icon: 'üîß',
        items: [
          { id: 'multimeter', name: 'Digital Multimeter', sizes: ['Standard'] },
          { id: 'clamp-meter', name: 'Clamp Meter', sizes: ['Digital'] },
          { id: 'manometer-digital', name: 'Digital Manometer', sizes: ['Dual Port'] },
          { id: 'leak-detector', name: 'Refrigerant Leak Detector', sizes: ['Electronic'] },
          { id: 'thermometer-infrared', name: 'Infrared Thermometer', sizes: ['Standard'] },
          { id: 'vacuum-pump', name: 'Vacuum Pump', sizes: ['3 CFM', '6 CFM'] },
          { id: 'tubing-cutter', name: 'Tubing Cutter', sizes: ['1/8"-7/8"', '1/8"-1 1/8"'] }
        ]
      },
      safety: {
        name: 'Safety & PPE',
        icon: 'ü¶∫',
        items: [
          { id: 'safety-glasses', name: 'Safety Glasses', sizes: ['Clear', 'Tinted'], unit: 'each' },
          { id: 'gloves-work', name: 'Work Gloves', sizes: ['S', 'M', 'L', 'XL'], unit: 'pair' },
          { id: 'respirator', name: 'Respirator', sizes: ['Half-Face', 'Full-Face'] },
          { id: 'ear-protection', name: 'Ear Protection', sizes: ['Plugs', 'Muffs'] },
          { id: 'fire-extinguisher', name: 'Fire Extinguisher', sizes: ['5 lb ABC', '10 lb ABC'] },
          { id: 'first-aid', name: 'First Aid Kit', sizes: ['Basic', 'Complete'] }
        ]
      },
      accessories: {
        name: 'Accessories & Misc',
        icon: 'üõ†Ô∏è',
        items: [
          { id: 'condenser-pad', name: 'Condenser Pad', sizes: ['24x24', '30x30', '36x36'] },
          { id: 'vibration-isolator', name: 'Vibration Isolators', sizes: ['Standard'], unit: 'set' },
          { id: 'line-hide', name: 'Line Set Cover', sizes: ['3"', '4"', '6"'], unit: 'ft' },
          { id: 'cleaning-coil', name: 'Coil Cleaner', sizes: ['Aerosol', '1 Gallon'] },
          { id: 'cleaning-evap', name: 'Evaporator Coil Cleaner (No-Rinse)', sizes: ['Aerosol', '32 oz'] }
        ]
      }
    };
    
    // ==================== HELPER FUNCTIONS ====================
    function $(id) {
      return document.getElementById(id);
    }
    
    function showToast(message, type = 'success') {
      const toast = $('toast');
      toast.textContent = message;
      toast.className = `toast show ${type}`;
      setTimeout(() => toast.classList.remove('show'), 3000);
    }
    
    function showModal(title, content) {
      return new Promise((resolve) => {
        $('modal-title').textContent = title;
        $('modal-content').textContent = content;
        $('modal-overlay').classList.add('show');
        window.modalResolve = resolve;
      });
    }
    
    function closeModal(result) {
      $('modal-overlay').classList.remove('show');
      if (window.modalResolve) {
        window.modalResolve(result);
        window.modalResolve = null;
      }
    }
    
    // ==================== NAVIGATION ====================
    function toggleMobileMenu() {
      const sidebar = $('sidebar');
      const overlay = $('mobile-menu-overlay');
      sidebar.classList.toggle('mobile-open');
      overlay.classList.toggle('show');
    }
    
    function switchPage(page) {
      currentPage = page;
      $('dashboard-page').classList.toggle('hidden', page !== 'dashboard');
      $('service-page').classList.toggle('hidden', page !== 'service');
      $('materials-page').classList.toggle('hidden', page !== 'materials');
      $('duct-design-page').classList.toggle('hidden', page !== 'duct-design');
      $('cfm-page').classList.toggle('hidden', page !== 'cfm');
      $('history-page').classList.toggle('hidden', page !== 'history');
      
      const titles = { 
        dashboard: 'Dashboard',
        service: 'Service Call', 
        materials: 'Materials', 
        'duct-design': 'Pro Duct Design',
        cfm: 'CFM Calculator', 
        history: 'History & Reports' 
      };
      $('page-title').textContent = titles[page];
      
      document.querySelectorAll('.nav-item').forEach((item, index) => {
        item.classList.toggle('active', 
          (index === 0 && page === 'dashboard') ||
          (index === 1 && page === 'service') || 
          (index === 2 && page === 'materials') || 
          (index === 3 && page === 'duct-design') ||
          (index === 4 && page === 'cfm') ||
          (index === 5 && page === 'history')
        );
      });
      
      const sidebar = $('sidebar');
      const overlay = $('mobile-menu-overlay');
      sidebar.classList.remove('mobile-open');
      overlay.classList.remove('show');
      
      if (page === 'history') {
        refreshHistory();
      }
      
      if (page === 'dashboard') {
        updateDashboardStats();
      }
    }
    
    function updateDashboardStats() {
      const stored = localStorage.getItem('fieldBuddyReports');
      if (stored) {
        savedReports = JSON.parse(stored);
        const thisMonth = savedReports.filter(r => {
          const rDate = new Date(r.timestamp);
          const now = new Date();
          return rDate.getMonth() === now.getMonth() && rDate.getFullYear() === now.getFullYear();
        });
        const avgQuality = savedReports.length > 0 ? savedReports.reduce((sum, r) => sum + r.quality, 0) / savedReports.length : 0;
        
        $('dash-stat-reports').textContent = savedReports.length;
        $('dash-stat-quality').textContent = `${Math.round(avgQuality)}%`;
        $('dash-stat-total').textContent = savedReports.length;
        $('dash-stat-month').textContent = thisMonth.length;
      }
    }
    
    function setCallType(type) {
      callType = type;
      $('call-trouble').classList.toggle('active', type === 'trouble');
      $('call-maintenance').classList.toggle('active', type === 'maintenance');
    }
    
    function setSystemMode(mode) {
      systemMode = mode;
      $('mode-cooling').classList.toggle('active', mode === 'cooling');
      $('mode-heating').classList.toggle('active', mode === 'heating');
      $('cooling-measurements').classList.toggle('hidden', mode !== 'cooling');
      $('heating-measurements').classList.toggle('hidden', mode !== 'heating');
      $('cooling-checklist').classList.toggle('hidden', mode !== 'cooling');
      $('heating-checklist').classList.toggle('hidden', mode !== 'heating');
      calculateDiagnostics();
    }
    
    function updateUnitFields() {
      const unitType = $('unit-type').value;
      const outdoorGroup = $('outdoor-unit-group');
      if (unitType === 'package' || unitType === 'mini-split') {
        outdoorGroup.classList.add('hidden');
      } else {
        outdoorGroup.classList.remove('hidden');
      }
    }
    
    function updateCheckbox(checkbox) {
      const item = checkbox.closest('.checklist-item');
      item.classList.toggle('checked', checkbox.checked);
      updateChecklistCount();
    }
    
    function updateChecklistCount() {
      if (systemMode === 'cooling') {
        const total = document.querySelectorAll('#cooling-checklist input[type="checkbox"]').length;
        const checked = document.querySelectorAll('#cooling-checklist input[type="checkbox"]:checked').length;
        $('cooling-checklist-count').textContent = `${checked}/${total}`;
      } else {
        const total = document.querySelectorAll('#heating-checklist input[type="checkbox"]').length;
        const checked = document.querySelectorAll('#heating-checklist input[type="checkbox"]:checked').length;
        $('heating-checklist-count').textContent = `${checked}/${total}`;
      }
      calculateQuality();
    }
    
    // ==================== QUALITY SCORE ====================
    function calculateQuality() {
      let score = 0;
      let basicInfo = 0;
      let diagnostics = 0;
      
      if ($('customer-name').value) basicInfo++;
      if ($('service-date').value) basicInfo++;
      if ($('service-address').value) basicInfo++;
      if ($('customer-complaint').value) basicInfo++;
      if ($('unit-type').value) basicInfo++;
      
      score += (basicInfo / 5) * 30;
      
      if (systemMode === 'cooling') {
        if ($('delta-t').value && $('delta-t').value !== 'N/A') diagnostics++;
        if ($('superheat').value && $('superheat').value !== 'N/A') diagnostics++;
        if ($('subcool').value && $('subcool').value !== 'N/A') diagnostics++;
      } else {
        if ($('temp-rise').value && $('temp-rise').value !== 'N/A') diagnostics++;
        if ($('manifold-pressure').value) diagnostics++;
        if ($('voltage-heat').value) diagnostics++;
      }
      
      score += (diagnostics / 3) * 25;
      
      if ($('findings').value) score += 10;
      if ($('work-performed').value) score += 10;
      score += Math.min(photos.length * 3, 15);
      if (customerSignature) score += 10;
      
      const finalScore = Math.round(score);
      
      $('quality-score-large').textContent = `${finalScore}%`;
      $('metric-basic').textContent = `${basicInfo}/5`;
      $('metric-diagnostics').textContent = `${diagnostics}/3`;
      $('metric-photos').textContent = photos.length;
      $('metric-signature').textContent = customerSignature ? '‚úì' : '‚úó';
      
      const badge = $('quality-badge');
      if (finalScore >= 80) {
        badge.textContent = 'Excellent';
        badge.className = 'badge badge-success';
      } else if (finalScore >= 60) {
        badge.textContent = 'Good';
        badge.className = 'badge badge-info';
      } else if (finalScore >= 40) {
        badge.textContent = 'Fair';
        badge.className = 'badge badge-warning';
      } else {
        badge.textContent = 'Incomplete';
        badge.className = 'badge badge-danger';
      }
    }
    
    // ==================== ENHANCED DIAGNOSTICS ====================
    function calculateDiagnostics() {
      if (systemMode === 'cooling') {
        calculateCoolingDiagnostics();
      } else {
        calculateHeatingDiagnostics();
      }
    }
    
    function getTargetSuperheat(outdoorTemp) {
      const temps = Object.keys(FIXED_ORIFICE_SUPERHEAT_TARGETS).map(Number);
      const closest = temps.reduce((prev, curr) => 
        Math.abs(curr - outdoorTemp) < Math.abs(prev - outdoorTemp) ? curr : prev
      );
      return FIXED_ORIFICE_SUPERHEAT_TARGETS[closest];
    }
    
    function calculateCoolingDiagnostics() {
      const outdoorAmbient = parseFloat($('outdoor-ambient').value);
      const returnTemp = parseFloat($('return-temp').value);
      const supplyTemp = parseFloat($('supply-temp').value);
      const suctionPressure = parseFloat($('suction-pressure').value);
      const suctionTemp = parseFloat($('suction-temp').value);
      const liquidPressure = parseFloat($('liquid-pressure').value);
      const liquidTemp = parseFloat($('liquid-temp').value);
      const meteringDevice = $('metering-device').value;
      
      // Calculate Delta-T
      if (!isNaN(returnTemp) && !isNaN(supplyTemp)) {
        const deltaT = returnTemp - supplyTemp;
        $('delta-t').value = `${deltaT.toFixed(1)}¬∞F`;
        
        const deltaTInput = $('delta-t');
        if (deltaT < 14 || deltaT > 24) {
          deltaTInput.classList.add('warning');
        } else if (deltaT >= 16 && deltaT <= 22) {
          deltaTInput.classList.remove('warning');
          deltaTInput.classList.remove('error');
        }
      } else {
        $('delta-t').value = '';
      }
      
      // Calculate Superheat
      if (!isNaN(suctionPressure) && !isNaN(suctionTemp)) {
        const satTemp = getSaturationTemp(suctionPressure);
        if (satTemp !== null) {
          const superheat = suctionTemp - satTemp;
          $('superheat').value = `${superheat.toFixed(1)}¬∞F`;
          
          const superheatInput = $('superheat');
          if (meteringDevice === 'txv') {
            if (superheat < 8 || superheat > 15) {
              superheatInput.classList.add('warning');
            } else {
              superheatInput.classList.remove('warning');
            }
          } else if (meteringDevice === 'piston' && !isNaN(outdoorAmbient)) {
            const targetSH = getTargetSuperheat(outdoorAmbient);
            if (Math.abs(superheat - targetSH) > 5) {
              superheatInput.classList.add('warning');
            } else {
              superheatInput.classList.remove('warning');
            }
          }
        }
      } else {
        $('superheat').value = '';
      }
      
      // Calculate Subcool
      if (!isNaN(liquidPressure) && !isNaN(liquidTemp)) {
        const satTemp = getSaturationTemp(liquidPressure);
        if (satTemp !== null) {
          const subcool = satTemp - liquidTemp;
          $('subcool').value = `${subcool.toFixed(1)}¬∞F`;
          
          const subcoolInput = $('subcool');
          if (subcool < 8 || subcool > 12) {
            subcoolInput.classList.add('warning');
          } else {
            subcoolInput.classList.remove('warning');
          }
        }
      } else {
        $('subcool').value = '';
      }
      
      runDiagnosticAnalysis();
      updatePressureChart();
      calculateQuality();
    }
    
    function calculateHeatingDiagnostics() {
      const returnTemp = parseFloat($('return-temp-heat').value);
      const supplyTemp = parseFloat($('supply-temp-heat').value);
      const manifoldPressure = parseFloat($('manifold-pressure').value);
      const gasType = $('gas-type').value;
      
      // Calculate Temperature Rise
      if (!isNaN(returnTemp) && !isNaN(supplyTemp)) {
        const tempRise = supplyTemp - returnTemp;
        $('temp-rise').value = `${tempRise.toFixed(1)}¬∞F`;
        
        const tempRiseInput = $('temp-rise');
        if (tempRise < 35 || tempRise > 65) {
          tempRiseInput.classList.add('warning');
        } else {
          tempRiseInput.classList.remove('warning');
        }
      } else {
        $('temp-rise').value = '';
      }
      
      // Validate manifold pressure
      if (!isNaN(manifoldPressure)) {
        const manifoldInput = $('manifold-pressure');
        if (gasType === 'natural') {
          if (manifoldPressure < 3.3 || manifoldPressure > 3.8) {
            manifoldInput.classList.add('warning');
          } else {
            manifoldInput.classList.remove('warning');
          }
        } else {
          if (manifoldPressure < 10 || manifoldPressure > 11) {
            manifoldInput.classList.add('warning');
          } else {
            manifoldInput.classList.remove('warning');
          }
        }
      }
      
      runDiagnosticAnalysis();
      updateHeatingChart();
      calculateQuality();
    }
    
    function getSaturationTemp(pressure) {
      const pressures = Object.keys(R410A_PT).map(Number);
      const closest = pressures.reduce((prev, curr) => 
        Math.abs(curr - pressure) < Math.abs(prev - pressure) ? curr : prev
      );
      return R410A_PT[closest];
    }
    
    function runDiagnosticAnalysis() {
      diagnosticResults = [];
      
      if (systemMode === 'cooling') {
        const deltaT = parseFloat($('delta-t').value);
        const superheat = parseFloat($('superheat').value);
        const subcool = parseFloat($('subcool').value);
        const staticPressure = parseFloat($('static-pressure').value);
        const meteringDevice = $('metering-device').value;
        const outdoorAmbient = parseFloat($('outdoor-ambient').value);
        const rlaRating = parseFloat($('rla-rating').value);
        const amperage = parseFloat($('amperage').value);
        
        // Delta-T Analysis
        if (!isNaN(deltaT)) {
          if (deltaT < 14) {
            diagnosticResults.push({
              severity: 'danger',
              title: 'Low Delta-T Detected - Insufficient Cooling',
              message: `Delta-T is ${deltaT.toFixed(1)}¬∞F (Expected: 16-22¬∞F)`,
              recommendations: [
                'Check and replace air filter immediately',
                'Inspect evaporator coil for dirt/restrictions',
                'Verify blower motor operation and speed settings',
                'Check for closed or blocked supply vents',
                'Measure total external static pressure',
                'Verify ductwork is properly sized'
              ]
            });
          } else if (deltaT >= 16 && deltaT <= 22) {
            diagnosticResults.push({
              severity: 'success',
              title: 'Delta-T in Optimal Range',
              message: `Delta-T is ${deltaT.toFixed(1)}¬∞F - Airflow is within specifications`
            });
          } else if (deltaT > 24) {
            diagnosticResults.push({
              severity: 'danger',
              title: 'High Delta-T - Severe Airflow Restriction',
              message: `Delta-T is ${deltaT.toFixed(1)}¬∞F (Expected: 16-22¬∞F)`,
              recommendations: [
                'CRITICAL: Replace air filter immediately',
                'Inspect ductwork for collapsed/crushed sections',
                'Check blower speed - may be set too low',
                'Verify return air pathway is adequate',
                'Check for undersized ductwork',
                'Measure ESP - likely exceeding 0.50 in w.c.'
              ]
            });
          }
        }
        
        // Static Pressure Analysis
        if (!isNaN(staticPressure)) {
          if (staticPressure > 0.7) {
            diagnosticResults.push({
              severity: 'danger',
              title: 'Excessive Static Pressure - System Stress',
              message: `Static pressure is ${staticPressure.toFixed(2)} in w.c. (Max: 0.50 for residential)`,
              recommendations: [
                'URGENT: Replace filter and verify improvement',
                'Inspect ductwork for restrictions/damage',
                'Verify proper duct sizing using Manual D',
                'Check for closed dampers in trunk lines',
                'Consider duct system redesign if oversized equipment',
                'Monitor blower motor amperage - may be overloaded'
              ]
            });
          } else if (staticPressure <= 0.5) {
            diagnosticResults.push({
              severity: 'success',
              title: 'Static Pressure Acceptable',
              message: `Static pressure is ${staticPressure.toFixed(2)} in w.c. - within specifications`
            });
          }
        }
        
        // Enhanced Charge Analysis
        if (!isNaN(superheat) && !isNaN(subcool)) {
          if (meteringDevice === 'txv') {
            if (superheat > 20 && subcool < 8) {
              diagnosticResults.push({
                severity: 'danger',
                title: 'System Undercharged - Refrigerant Loss Detected',
                message: `Superheat: ${superheat.toFixed(1)}¬∞F, Subcool: ${subcool.toFixed(1)}¬∞F`,
                recommendations: [
                  'Perform thorough leak detection on evaporator coil',
                  'Check all brazed joints for leaks',
                  'Inspect line set connections at both ends',
                  'Check service valve cores for leaks',
                  'Verify filter drier is not restricted',
                  'After leak repair, evacuate and recharge by weight',
                  'Verify charge using subcooling method (target: 8-12¬∞F)'
                ]
              });
            } else if (superheat < 5 && subcool > 15) {
              diagnosticResults.push({
                severity: 'warning',
                title: 'System May Be Overcharged',
                message: `Superheat: ${superheat.toFixed(1)}¬∞F, Subcool: ${subcool.toFixed(1)}¬∞F`,
                recommendations: [
                  'Verify charge was not added incorrectly',
                  'Check for non-condensables in system',
                  'Ensure condenser has adequate airflow',
                  'Verify condenser coil is clean',
                  'Consider recovering excess refrigerant',
                  'Re-verify charge using manufacturer specs'
                ]
              });
            } else if (superheat >= 8 && superheat <= 15 && subcool >= 8 && subcool <= 12) {
              diagnosticResults.push({
                severity: 'success',
                title: 'Refrigerant Charge Correct (TXV System)',
                message: `Superheat: ${superheat.toFixed(1)}¬∞F, Subcool: ${subcool.toFixed(1)}¬∞F - within TXV system specifications`
              });
            } else if (superheat > 25 && subcool >= 8) {
              diagnosticResults.push({
                severity: 'danger',
                title: 'TXV Malfunction Suspected',
                message: `High superheat (${superheat.toFixed(1)}¬∞F) with normal subcool indicates TXV not opening properly`,
                recommendations: [
                  'Check TXV sensing bulb placement and contact',
                  'Verify bulb is properly insulated',
                  'Inspect for kinked liquid line before TXV',
                  'Check for clogged filter drier or strainer',
                  'Verify TXV is correct tonnage for system',
                  'Consider TXV replacement if other checks pass'
                ]
              });
            }
          } else if (meteringDevice === 'piston' && !isNaN(outdoorAmbient)) {
            const targetSH = getTargetSuperheat(outdoorAmbient);
            const shDifference = Math.abs(superheat - targetSH);
            
            if (shDifference > 5) {
              if (superheat > targetSH) {
                diagnosticResults.push({
                  severity: 'warning',
                  title: 'Refrigerant Charge Low (Fixed Orifice System)',
                  message: `Superheat: ${superheat.toFixed(1)}¬∞F (Target: ${targetSH}¬∞F at ${outdoorAmbient}¬∞F outdoor) | Subcool: ${subcool.toFixed(1)}¬∞F`,
                  recommendations: [
                    'Perform leak check before adding refrigerant',
                    'Use superheat method for charge verification',
                    'Add refrigerant in small increments',
                    'Monitor both superheat and subcool while charging',
                    'Target superheat varies with outdoor temperature',
                    'Re-check after system stabilizes (15-20 minutes)'
                  ]
                });
              } else {
                diagnosticResults.push({
                  severity: 'warning',
                  title: 'Possible Overcharge (Fixed Orifice System)',
                  message: `Superheat: ${superheat.toFixed(1)}¬∞F (Target: ${targetSH}¬∞F at ${outdoorAmbient}¬∞F outdoor) | Subcool: ${subcool.toFixed(1)}¬∞F`,
                  recommendations: [
                    'Verify outdoor ambient temperature is correct',
                    'Check for restricted airflow across evaporator',
                    'Consider recovering small amount of refrigerant',
                    'Monitor head pressure - may be elevated',
                    'Re-verify charge using manufacturer chart'
                  ]
                });
              }
            } else {
              diagnosticResults.push({
                severity: 'success',
                title: 'Refrigerant Charge Correct (Fixed Orifice)',
                message: `Superheat: ${superheat.toFixed(1)}¬∞F (Target: ${targetSH}¬∞F at ${outdoorAmbient}¬∞F outdoor) - charge is accurate`
              });
            }
          }
        }
        
        // Amperage Analysis
        if (!isNaN(amperage) && !isNaN(rlaRating)) {
          const amperagePercent = (amperage / rlaRating) * 100;
          if (amperagePercent > 110) {
            diagnosticResults.push({
              severity: 'danger',
              title: 'Compressor Drawing Excessive Current',
              message: `Running at ${amperagePercent.toFixed(0)}% of RLA (${amperage.toFixed(1)}A / ${rlaRating.toFixed(1)}A rated)`,
              recommendations: [
                'Check supply voltage - low voltage increases amperage',
                'Verify capacitor is within spec',
                'Check for refrigerant overcharge',
                'Inspect for restricted airflow (high head pressure)',
                'Monitor compressor for overheating',
                'May indicate failing compressor'
              ]
            });
          }
        }
        
      } else {
        // Heating mode diagnostics
        const tempRise = parseFloat($('temp-rise').value);
        const manifoldPressure = parseFloat($('manifold-pressure').value);
        const gasType = $('gas-type').value;
        
        if (!isNaN(tempRise)) {
          if (tempRise < 35) {
            diagnosticResults.push({
              severity: 'danger',
              title: 'Low Temperature Rise - Insufficient Heating',
              message: `Temp rise is ${tempRise.toFixed(1)}¬∞F (Expected: 35-65¬∞F)`,
              recommendations: [
                'Check gas input - verify manifold pressure',
                'Inspect burners for proper flame pattern',
                'Check for excessive airflow (blower speed too high)',
                'Verify all burners are igniting',
                'Check gas valve for proper operation',
                'Verify orifice size matches gas type'
              ]
            });
          } else if (tempRise > 65) {
            diagnosticResults.push({
              severity: 'danger',
              title: 'High Temperature Rise - Airflow Restriction',
              message: `Temp rise is ${tempRise.toFixed(1)}¬∞F (Expected: 35-65¬∞F)`,
              recommendations: [
                'CRITICAL: Check airflow restriction immediately',
                'Replace air filter',
                'Verify blower speed is correct',
                'Inspect heat exchanger for restrictions',
                'Check limit switches - may be cycling',
                'High temp rise can crack heat exchanger'
              ]
            });
          } else {
            diagnosticResults.push({
              severity: 'success',
              title: 'Temperature Rise in Range',
              message: `Temp rise is ${tempRise.toFixed(1)}¬∞F - heating output is correct`
            });
          }
        }
        
        if (!isNaN(manifoldPressure)) {
          if (gasType === 'natural') {
            if (manifoldPressure < 3.3 || manifoldPressure > 3.8) {
              diagnosticResults.push({
                severity: 'warning',
                title: 'Manifold Pressure Out of Range (Natural Gas)',
                message: `Manifold pressure is ${manifoldPressure.toFixed(2)} in w.c. (Expected: 3.3-3.8)`,
                recommendations: [
                  'Adjust gas valve regulator',
                  'Check incoming gas supply pressure',
                  'Verify regulator is not failed',
                  'Ensure proper orifice size installed',
                  'Consult furnace specifications'
                ]
              });
            } else {
              diagnosticResults.push({
                severity: 'success',
                title: 'Manifold Pressure Correct (Natural Gas)',
                message: `Manifold pressure is ${manifoldPressure.toFixed(2)} in w.c.`
              });
            }
          } else {
            if (manifoldPressure < 10 || manifoldPressure > 11) {
              diagnosticResults.push({
                severity: 'warning',
                title: 'Manifold Pressure Out of Range (LP/Propane)',
                message: `Manifold pressure is ${manifoldPressure.toFixed(2)} in w.c. (Expected: 10-11)`,
                recommendations: [
                  'Adjust gas valve regulator for LP operation',
                  'Verify LP orifices are installed (smaller than NG)',
                  'Check LP supply tank pressure',
                  'Ensure conversion kit was properly installed',
                  'Consult manufacturer LP conversion specs'
                ]
              });
            } else {
              diagnosticResults.push({
                severity: 'success',
                title: 'Manifold Pressure Correct (LP)',
                message: `Manifold pressure is ${manifoldPressure.toFixed(2)} in w.c.`
              });
            }
          }
        }
      }
      
      displayDiagnosticResults();
    }
    
    function displayDiagnosticResults() {
      const container = $('diagnostic-results');
      
      if (diagnosticResults.length === 0) {
        container.classList.add('hidden');
        return;
      }
      
      container.classList.remove('hidden');
      
      let html = '<div class="diagnostic-panel">';
      html += '<div class="diagnostic-header">üéØ Master Tech Diagnostic Analysis</div>';
      
      diagnosticResults.forEach(result => {
        html += '<div class="diagnostic-card">';
        html += '<div class="diagnostic-card-header">';
        html += `<div class="diagnostic-card-title">${result.title}</div>`;
        html += `<span class="badge badge-${result.severity}">${result.severity}</span>`;
        html += '</div>';
        html += `<p style="margin-bottom: 8px; color: var(--text-secondary);">${result.message}</p>`;
        
        if (result.recommendations && result.recommendations.length > 0) {
          html += '<div class="diagnostic-recommendations">';
          html += '<strong style="font-size: 12px; color: var(--text-primary);">Recommended Actions:</strong>';
          html += '<ul>';
          result.recommendations.forEach(rec => {
            html += `<li>${rec}</li>`;
          });
          html += '</ul>';
          html += '</div>';
        }
        
        html += '</div>';
      });
      
      html += '</div>';
      container.innerHTML = html;
    }
    
    // ==================== CHARTS ====================
    function updatePressureChart() {
      const ctx = $('pressure-chart');
      if (!ctx) return;
      
      const suctionPressure = parseFloat($('suction-pressure').value) || 0;
      const liquidPressure = parseFloat($('liquid-pressure').value) || 0;
      
      if (pressureChart) {
        pressureChart.data.datasets[0].data = [suctionPressure, liquidPressure];
        pressureChart.update();
      } else {
        pressureChart = new Chart(ctx.getContext('2d'), {
          type: 'bar',
          data: {
            labels: ['Suction', 'Liquid'],
            datasets: [{
              label: 'Pressure (PSI)',
              data: [suctionPressure, liquidPressure],
              backgroundColor: ['rgba(0,217,255,0.2)', 'rgba(255,107,53,0.2)'],
              borderColor: ['rgb(0,217,255)', 'rgb(255,107,53)'],
              borderWidth: 2
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              y: {
                beginAtZero: true,
                title: {
                  display: true,
                  text: 'Pressure (PSI)',
                  color: '#CBD5E1'
                },
                ticks: { color: '#CBD5E1' },
                grid: { color: 'rgba(203, 213, 225, 0.1)' }
              },
              x: {
                ticks: { color: '#CBD5E1' },
                grid: { color: 'rgba(203, 213, 225, 0.1)' }
              }
            },
            plugins: {
              title: {
                display: true,
                text: 'Refrigerant Pressures',
                color: '#F8FAFC'
              },
              legend: {
                display: false
              }
            }
          }
        });
      }
    }
    
    function updateHeatingChart() {
      const ctx = $('heating-chart');
      if (!ctx) return;
      
      const returnTemp = parseFloat($('return-temp-heat').value) || 0;
      const supplyTemp = parseFloat($('supply-temp-heat').value) || 0;
      
      if (heatingChart) {
        heatingChart.data.datasets[0].data = [returnTemp, supplyTemp];
        heatingChart.update();
      } else {
        heatingChart = new Chart(ctx.getContext('2d'), {
          type: 'bar',
          data: {
            labels: ['Return', 'Supply'],
            datasets: [{
              label: 'Temperature (¬∞F)',
              data: [returnTemp, supplyTemp],
              backgroundColor: ['rgba(59,130,246,0.2)', 'rgba(255,107,53,0.2)'],
              borderColor: ['rgb(59,130,246)', 'rgb(255,107,53)'],
              borderWidth: 2
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              y: {
                beginAtZero: true,
                title: {
                  display: true,
                  text: 'Temperature (¬∞F)',
                  color: '#CBD5E1'
                },
                ticks: { color: '#CBD5E1' },
                grid: { color: 'rgba(203, 213, 225, 0.1)' }
              },
              x: {
                ticks: { color: '#CBD5E1' },
                grid: { color: 'rgba(203, 213, 225, 0.1)' }
              }
            },
            plugins: {
              title: {
                display: true,
                text: 'Air Temperatures',
                color: '#F8FAFC'
              },
              legend: {
                display: false
              }
            }
          }
        });
      }
    }
    
    // ==================== PHOTOS ====================
    function handlePhotos(e) {
      Array.from(e.target.files).forEach(file => {
        const reader = new FileReader();
        reader.onload = (ev) => {
          photos.push({
            data: ev.target.result,
            name: file.name,
            timestamp: new Date().toISOString()
          });
          displayPhotos();
          calculateQuality();
          showToast(`Photo "${file.name}" added`);
        };
        reader.readAsDataURL(file);
      });
      e.target.value = '';
    }
    
    function displayPhotos() {
      const gallery = $('photo-gallery');
      let html = '<label class="photo-upload"><input type="file" accept="image/*" capture="camera" multiple onchange="handlePhotos(event)" style="display:none"><span style="font-size: 32px;">üì∑</span><span>Add Photo</span></label>';
      
      photos.forEach((photo, i) => {
        html += `<div class="photo-item">`;
        html += `<img src="${photo.data}" onclick="viewPhoto(${i})">`;
        html += `<div class="photo-item-actions">`;
        html += `<button class="photo-btn" onclick="deletePhoto(${i}); event.stopPropagation();">üóëÔ∏è</button>`;
        html += `</div>`;
        html += `</div>`;
      });
      
      gallery.innerHTML = html;
      $('photo-count').textContent = `${photos.length} photo${photos.length !== 1 ? 's' : ''}`;
    }
    
    function viewPhoto(index) {
      window.open(photos[index].data);
    }
    
    function deletePhoto(index) {
      photos.splice(index, 1);
      displayPhotos();
      calculateQuality();
      showToast('Photo deleted');
    }
    
    // ==================== SIGNATURE ====================
    function initSignature() {
      const canvas = $('signature-pad');
      if (!canvas) return;
      
      signaturePad = new SignaturePad(canvas, {
        backgroundColor: 'rgb(30, 38, 56)',
        penColor: 'rgb(0, 217, 255)'
      });
      
      function resize() {
        const ratio = Math.max(window.devicePixelRatio || 1, 1);
        canvas.width = canvas.offsetWidth * ratio;
        canvas.height = canvas.offsetHeight * ratio;
        canvas.getContext('2d').scale(ratio, ratio);
        if (customerSignature) {
          const img = new Image();
          img.onload = () => signaturePad.fromDataURL(customerSignature);
          img.src = customerSignature;
        }
      }
      
      window.addEventListener('resize', resize);
      resize();
    }
    
    function clearSignature() {
      if (signaturePad) {
        signaturePad.clear();
        customerSignature = null;
        calculateQuality();
        showToast('Signature cleared');
      }
    }
    
    function saveSignature() {
      if (!signaturePad || signaturePad.isEmpty()) {
        showToast('Please provide a signature first', 'danger');
        return;
      }
      customerSignature = signaturePad.toDataURL();
      calculateQuality();
      showToast('Signature saved!');
    }
    
    // ==================== MATERIALS ====================
    function initMaterialsCatalog() {
      const catalog = $('materials-catalog');
      let html = '';
      
      Object.keys(materialsCatalog).forEach(catKey => {
        const category = materialsCatalog[catKey];
        categoryStates[catKey] = false;
        
        html += `<div class="materials-category" id="cat-${catKey}" data-category="${catKey}">`;
        html += `<div class="category-header" onclick="toggleCategory('${catKey}')">`;
        html += '<div class="category-title-group">';
        html += `<span class="category-icon">${category.icon}</span>`;
        html += `<span class="category-name">${category.name}</span>`;
        html += '</div>';
        html += '<div class="category-meta">';
        html += `<span class="category-count">${category.items.length} items</span>`;
        html += `<span class="category-selected hidden" id="cat-selected-${catKey}">0 selected</span>`;
        html += '<span class="category-arrow">‚ñº</span>';
        html += '</div>';
        html += '</div>';
        html += '<div class="category-items">';
        
        category.items.forEach(item => {
          const itemId = `${catKey}-${item.id}`;
          const sizeDisplay = item.spec || item.sizes.slice(0, 3).join(', ') + (item.sizes.length > 3 ? ' +more' : '');
          html += `<div class="material-item" data-search="${item.name.toLowerCase()} ${category.name.toLowerCase()}">`;
          html += `<input type="checkbox" id="${itemId}" onchange="toggleMaterial('${catKey}', '${item.id}')">`;
          html += '<div class="material-info">';
          html += `<div class="material-name">${item.name}</div>`;
          html += `<div class="material-spec">${sizeDisplay}</div>`;
          html += '</div>';
          html += '</div>';
        });
        
        html += '</div>';
        html += '</div>';
      });
      
      catalog.innerHTML = html;
    }
    
    function toggleCategory(catKey) {
      const cat = $(`cat-${catKey}`);
      cat.classList.toggle('expanded');
      categoryStates[catKey] = !categoryStates[catKey];
    }
    
    function expandAllCategories() {
      Object.keys(materialsCatalog).forEach(catKey => {
        $(`cat-${catKey}`).classList.add('expanded');
        categoryStates[catKey] = true;
      });
      showToast('All categories expanded');
    }
    
    function collapseAllCategories() {
      Object.keys(materialsCatalog).forEach(catKey => {
        $(`cat-${catKey}`).classList.remove('expanded');
        categoryStates[catKey] = false;
      });
      showToast('All categories collapsed');
    }
    
    function filterMaterials() {
      const search = $('material-search').value.toLowerCase();
      const items = document.querySelectorAll('.material-item');
      let hasVisibleItems = {};
      
      if (search) {
        items.forEach(item => {
          const searchText = item.dataset.search || '';
          const isMatch = searchText.includes(search);
          item.style.display = isMatch ? 'flex' : 'none';
          
          if (isMatch) {
            const category = item.closest('.materials-category');
            const catKey = category.dataset.category;
            hasVisibleItems[catKey] = true;
          }
        });
        
        Object.keys(materialsCatalog).forEach(catKey => {
          const cat = $(`cat-${catKey}`);
          if (hasVisibleItems[catKey]) {
            cat.classList.add('expanded');
            cat.style.display = 'block';
          } else {
            cat.style.display = 'none';
          }
        });
      } else {
        items.forEach(item => {
          item.style.display = 'flex';
        });
        Object.keys(materialsCatalog).forEach(catKey => {
          const cat = $(`cat-${catKey}`);
          cat.style.display = 'block';
          if (!categoryStates[catKey]) {
            cat.classList.remove('expanded');
          }
        });
      }
    }
    
    function toggleMaterial(catKey, itemId) {
      const category = materialsCatalog[catKey];
      const item = category.items.find(i => i.id === itemId);
      const checkbox = $(`${catKey}-${itemId}`);
      
      if (checkbox.checked) {
        selectedMaterials.push({
          catKey,
          catName: category.name,
          name: item.name,
          spec: item.spec || item.sizes[0],
          sizes: item.sizes,
          unit: item.unit || 'ea',
          quantity: 1
        });
      } else {
        selectedMaterials = selectedMaterials.filter(m => !(m.catKey === catKey && m.name === item.name));
      }
      
      updateCategorySelectedCount(catKey);
      displaySelectedMaterials();
    }
    
    function updateCategorySelectedCount(catKey) {
      const count = selectedMaterials.filter(m => m.catKey === catKey).length;
      const badge = $(`cat-selected-${catKey}`);
      
      if (count > 0) {
        badge.textContent = `${count} selected`;
        badge.classList.remove('hidden');
      } else {
        badge.classList.add('hidden');
      }
    }
    
    function displaySelectedMaterials() {
      const container = $('selected-materials');
      
      if (selectedMaterials.length === 0) {
        container.innerHTML = '<div class="status-card info">‚ÑπÔ∏è No materials selected yet. Use the catalog above to add items.</div>';
        $('selected-materials-count').textContent = '0 items';
        return;
      }
      
      let html = '';
      selectedMaterials.forEach((item, idx) => {
        html += '<div class="selected-material">';
        html += '<div class="selected-material-info">';
        html += `<div class="material-name">${item.name}</div>`;
        html += `<div class="material-spec">${item.spec}</div>`;
        html += '</div>';
        html += '<div class="selected-material-controls">';
        
        if (item.sizes.length > 1) {
          html += `<select onchange="selectedMaterials[${idx}].spec = this.value">`;
          item.sizes.forEach(size => {
            html += `<option value="${size}" ${item.spec === size ? 'selected' : ''}>${size}</option>`;
          });
          html += '</select>';
        }
        
        html += `<input type="number" value="${item.quantity}" min="1" onchange="selectedMaterials[${idx}].quantity = parseInt(this.value); displaySelectedMaterials();">`;
        html += `<span>${item.unit}</span>`;
        html += `<button class="photo-btn" onclick="removeMaterial(${idx})">‚úï</button>`;
        html += '</div>';
        html += '</div>';
      });
      
      container.innerHTML = html;
      $('selected-materials-count').textContent = `${selectedMaterials.length} item${selectedMaterials.length !== 1 ? 's' : ''}`;
    }
    
    function removeMaterial(index) {
      const item = selectedMaterials[index];
      const checkbox = $(`${item.catKey}-${materialsCatalog[item.catKey].items.find(i => i.name === item.name).id}`);
      if (checkbox) checkbox.checked = false;
      
      selectedMaterials.splice(index, 1);
      updateCategorySelectedCount(item.catKey);
      displaySelectedMaterials();
      showToast('Material removed');
    }
    
    // ==================== PROFESSIONAL DUCT DESIGN ====================
    
    function calculateSystemCFM() {
      const tonnage = parseFloat($('duct-tonnage').value);
      if (!isNaN(tonnage)) {
        const systemCFM = tonnage * 400;
        $('system-cfm-display').textContent = systemCFM;
        $('trunk-cfm').value = systemCFM;
        calculateTrunkSize();
        checkDesignReadiness();
      } else {
        $('system-cfm-display').textContent = '0';
        $('trunk-cfm').value = '';
      }
    }
    
    function addDuctRoom() {
      const roomId = Date.now();
      const room = {
        id: roomId,
        name: '',
        length: '',
        width: '',
        height: 8,
        cfm: 0,
        ductSize: '',
        ductLength: 20,
        registerSize: '',
        location: ''
      };
      
      ductDesignRooms.push(room);
      displayDuctRooms();
      showToast('Room added');
    }
    
    function displayDuctRooms() {
      const container = $('duct-rooms-container');
      
      if (ductDesignRooms.length === 0) {
        container.innerHTML = '<div class="status-card info">‚ÑπÔ∏è Click "Add Room" to start your duct design. Input room details to calculate CFM requirements and duct sizing.</div>';
        $('duct-totals').classList.add('hidden');
        checkDesignReadiness();
        return;
      }
      
      let html = '';
      ductDesignRooms.forEach((room, index) => {
        html += `<div class="card" style="margin-bottom: 16px;">`;
        html += `<div class="card-header">`;
        html += `<div class="card-title">Room ${index + 1}: ${room.name || 'Unnamed'}</div>`;
        html += `<button class="btn btn-danger btn-sm" onclick="removeDuctRoom(${index})">Remove</button>`;
        html += `</div>`;
        html += `<div class="card-body">`;
        html += `<div class="form-grid form-grid-2">`;
        html += `<div class="form-group">`;
        html += `<label>Room Name</label>`;
        html += `<input type="text" value="${room.name}" onchange="ductDesignRooms[${index}].name = this.value; displayDuctRooms();" placeholder="e.g., Master Bedroom">`;
        html += `</div>`;
        html += `<div class="form-group">`;
        html += `<label>Register Location</label>`;
        html += `<input type="text" value="${room.location}" onchange="ductDesignRooms[${index}].location = this.value;" placeholder="e.g., SW corner wall">`;
        html += `</div>`;
        html += `</div>`;
        html += `<div class="form-grid form-grid-4">`;
        html += `<div class="form-group">`;
        html += `<label>Length (ft)</label>`;
        html += `<input type="number" value="${room.length}" onchange="ductDesignRooms[${index}].length = parseFloat(this.value); calculateRoomDuctCFM(${index});" placeholder="12">`;
        html += `</div>`;
        html += `<div class="form-group">`;
        html += `<label>Width (ft)</label>`;
        html += `<input type="number" value="${room.width}" onchange="ductDesignRooms[${index}].width = parseFloat(this.value); calculateRoomDuctCFM(${index});" placeholder="10">`;
        html += `</div>`;
        html += `<div class="form-group">`;
        html += `<label>Height (ft)</label>`;
        html += `<input type="number" value="${room.height}" onchange="ductDesignRooms[${index}].height = parseFloat(this.value); calculateRoomDuctCFM(${index});" placeholder="8">`;
        html += `</div>`;
        html += `<div class="form-group">`;
        html += `<label>Duct Length (ft)</label>`;
        html += `<input type="number" value="${room.ductLength}" onchange="ductDesignRooms[${index}].ductLength = parseFloat(this.value); displayDuctRooms();" placeholder="20">`;
        html += `</div>`;
        html += `</div>`;
        html += `<div class="form-grid form-grid-3">`;
        html += `<div class="form-group">`;
        html += `<label>Required CFM</label>`;
        html += `<input type="text" value="${room.cfm ? room.cfm + ' CFM' : ''}" readonly style="font-weight: 600; color: var(--accent-cyan);">`;
        html += `</div>`;
        html += `<div class="form-group">`;
        html += `<label>Recommended Duct Size</label>`;
        html += `<input type="text" value="${room.ductSize}" readonly style="font-weight: 600; color: var(--success);">`;
        html += `</div>`;
        html += `<div class="form-group">`;
        html += `<label>Register Size</label>`;
        html += `<input type="text" value="${room.registerSize || ''}" readonly>`;
        html += `</div>`;
        html += `</div>`;
        html += `</div>`;
        html += `</div>`;
      });
      
      container.innerHTML = html;
      $('duct-totals').classList.remove('hidden');
      updateDuctTotals();
      checkDesignReadiness();
    }
    
    function calculateRoomDuctCFM(index) {
      const room = ductDesignRooms[index];
      const length = parseFloat(room.length);
      const width = parseFloat(room.width);
      const height = parseFloat(room.height);
      
      if (!isNaN(length) && !isNaN(width) && !isNaN(height)) {
        const volume = length * width * height;
        const ach = 6;
        const cfm = Math.round((volume * ach) / 60);
        
        room.cfm = cfm;
        
        const area = (cfm * 144) / 700;
        const diameter = 2 * Math.sqrt(area / Math.PI);
        const standardSizes = [4, 5, 6, 7, 8, 9, 10, 12, 14, 16];
        const standardDiameter = standardSizes.find(size => size >= diameter) || standardSizes[standardSizes.length - 1];
        
        room.ductSize = `${standardDiameter}" Round Flex`;
        
        if (cfm < 75) room.registerSize = '4x10';
        else if (cfm < 125) room.registerSize = '4x12 or 6x10';
        else if (cfm < 175) room.registerSize = '6x12';
        else if (cfm < 225) room.registerSize = '8x10';
        else room.registerSize = '8x12 or 10x10';
        
        displayDuctRooms();
      }
    }
    
    function updateDuctTotals() {
      const systemCFM = parseFloat($('system-cfm-display').textContent) || 0;
      const totalBranchCFM = ductDesignRooms.reduce((sum, room) => sum + (room.cfm || 0), 0);
      const balance = systemCFM > 0 ? ((totalBranchCFM / systemCFM) * 100).toFixed(1) : 0;
      
      $('total-branches-cfm').textContent = totalBranchCFM;
      $('cfm-balance').textContent = `${balance}%`;
      $('rooms-designed').textContent = ductDesignRooms.length;
      
      const balanceElement = $('cfm-balance');
      const numBalance = parseFloat(balance);
      if (numBalance >= 95 && numBalance <= 105) {
        balanceElement.style.color = 'var(--success)';
      } else if (numBalance >= 90 && numBalance <= 110) {
        balanceElement.style.color = 'var(--warning)';
      } else {
        balanceElement.style.color = 'var(--danger)';
      }
    }
    
    function removeDuctRoom(index) {
      ductDesignRooms.splice(index, 1);
      displayDuctRooms();
      showToast('Room removed');
    }
    
    function calculateTrunkSize() {
      const cfm = parseFloat($('trunk-cfm').value);
      const velocity = parseFloat($('trunk-velocity').value);
      
      if (!isNaN(cfm) && !isNaN(velocity)) {
        const area = (cfm * 144) / velocity;
        const diameter = 2 * Math.sqrt(area / Math.PI);
        const standardSizes = [10, 12, 14, 16, 18, 20, 22, 24];
        const standardDiameter = standardSizes.find(size => size >= diameter) || standardSizes[standardSizes.length - 1];
        
        $('trunk-size-result').value = `${standardDiameter}" Round Flex`;
      }
    }
    
    function calculatePlenumMaterial() {
      const supplyL = parseFloat($('supply-plenum-length').value) || 0;
      const supplyW = parseFloat($('supply-plenum-width').value) || 0;
      const supplyH = parseFloat($('supply-plenum-height').value) || 0;
      
      const returnL = parseFloat($('return-plenum-length').value) || 0;
      const returnW = parseFloat($('return-plenum-width').value) || 0;
      const returnH = parseFloat($('return-plenum-height').value) || 0;
      
      const supplySF = 2 * ((supplyL * supplyW) + (supplyL * supplyH) + (supplyW * supplyH)) / 144;
      const returnSF = 2 * ((returnL * returnW) + (returnL * returnH) + (returnW * returnH)) / 144;
      
      const totalSF = supplySF + returnSF;
      const sheets = Math.ceil((totalSF * 1.2) / 32);
      
      $('duct-board-sheets').textContent = sheets;
    }
    
    function checkDesignReadiness() {
      const tonnage = parseFloat($('duct-tonnage').value);
      const hasRooms = ductDesignRooms.length > 0;
      const roomsComplete = ductDesignRooms.every(room => room.cfm > 0);
      
      const btn = $('generate-design-btn');
      if (tonnage && hasRooms && roomsComplete) {
        btn.disabled = false;
      } else {
        btn.disabled = true;
      }
    }
    
    function generateDuctDesign() {
      if (ductDesignRooms.length === 0) {
        showToast('Add rooms before generating design', 'warning');
        return;
      }
      
      const projectName = $('duct-project-name').value || 'Untitled Project';
      const tonnage = parseFloat($('duct-tonnage').value);
      const systemCFM = tonnage * 400;
      const equipmentLocation = $('duct-equipment-location').value;
      const returnType = $('duct-return-type').value;
      const trunkSize = $('trunk-size-result').value;
      
      let schematic = '<div class="duct-trunk">Main Supply Trunk</div>';
      schematic += `<div class="duct-branch">‚îú‚îÄ ${trunkSize} from plenum, ${systemCFM} CFM total</div>`;
      
      ductDesignRooms.forEach((room, index) => {
        const prefix = index === ductDesignRooms.length - 1 ? '‚îî‚îÄ' : '‚îú‚îÄ';
        schematic += `<div class="duct-branch">${prefix} ${room.name || 'Room ' + (index + 1)}: ${room.ductSize}, ${room.cfm} CFM, ${room.ductLength} ft${room.location ? ', ' + room.location : ''}</div>`;
      });
      
      schematic += '<br><div class="duct-trunk">Return Air System</div>';
      if (returnType === 'central') {
        const returnGrilleSize = systemCFM < 800 ? '14x14' : systemCFM < 1200 ? '16x20' : systemCFM < 1600 ? '20x20' : '24x24';
        schematic += `<div class="duct-branch">‚îî‚îÄ Central return: ${trunkSize}, ${systemCFM} CFM, ${returnGrilleSize} grille</div>`;
      } else {
        schematic += '<div class="duct-branch">‚îú‚îÄ Distributed returns in bedrooms and living spaces</div>';
        schematic += `<div class="duct-branch">‚îî‚îÄ Main return trunk: ${trunkSize}, ${systemCFM} CFM</div>`;
      }
      
      $('system-schematic').innerHTML = schematic;
      $('system-schematic-card').style.display = 'block';
      
      let materialHTML = '';
      
      const ductSizes = {};
      ductDesignRooms.forEach(room => {
        const size = room.ductSize.split('"')[0];
        if (!ductSizes[size]) ductSizes[size] = 0;
        ductSizes[size] += room.ductLength;
      });
      
      materialHTML += '<div class="card-section"><div class="section-title">Flexible Duct (Insulated R-6)</div><ul style="font-size: 13px; line-height: 1.8; color: var(--text-secondary);">';
      Object.keys(ductSizes).sort((a, b) => parseInt(a) - parseInt(b)).forEach(size => {
        const feet = ductSizes[size];
        const bags = Math.ceil((feet * 1.1) / 25);
        materialHTML += `<li><strong>${size}" diameter:</strong> ${feet} ft needed, order <strong>${bags} bags</strong> (25 ft each)</li>`;
      });
      materialHTML += '</ul></div>';
      
      materialHTML += '<div class="card-section"><div class="section-title">Starting Collars</div><ul style="font-size: 13px; line-height: 1.8; color: var(--text-secondary);">';
      const collarCounts = {};
      ductDesignRooms.forEach(room => {
        const size = room.ductSize.split('"')[0];
        if (!collarCounts[size]) collarCounts[size] = 0;
        collarCounts[size]++;
      });
      Object.keys(collarCounts).sort((a, b) => parseInt(a) - parseInt(b)).forEach(size => {
        materialHTML += `<li><strong>${size}" collar:</strong> ${collarCounts[size]} pieces</li>`;
      });
      materialHTML += '</ul></div>';
      
      const supplyL = $('supply-plenum-length').value;
      const supplyW = $('supply-plenum-width').value;
      const supplyH = $('supply-plenum-height').value;
      const returnL = $('return-plenum-length').value;
      const returnW = $('return-plenum-width').value;
      const returnH = $('return-plenum-height').value;
      const sheets = $('duct-board-sheets').textContent;
      
      materialHTML += '<div class="card-section"><div class="section-title">Plenums (Custom Duct Board)</div>';
      materialHTML += '<ul style="font-size: 13px; line-height: 1.8; color: var(--text-secondary);">';
      materialHTML += `<li><strong>Supply Plenum:</strong> ${supplyL}√ó${supplyW}√ó${supplyH} inches</li>`;
      materialHTML += `<li><strong>Return Plenum:</strong> ${returnL}√ó${returnW}√ó${returnH} inches</li>`;
      materialHTML += `<li><strong>Duct Board:</strong> ${sheets} sheets (4√ó8 ft, 1.5" thick) - includes 20% waste</li>`;
      materialHTML += '</ul></div>';
      
      materialHTML += '<div class="card-section"><div class="section-title">Registers & Grilles</div><ul style="font-size: 13px; line-height: 1.8; color: var(--text-secondary);">';
      const registerSizes = {};
      ductDesignRooms.forEach(room => {
        const size = room.registerSize.split(' ')[0];
        if (!registerSizes[size]) registerSizes[size] = 0;
        registerSizes[size]++;
      });
      Object.keys(registerSizes).forEach(size => {
        materialHTML += `<li><strong>${size}</strong> supply register: ${registerSizes[size]} pieces</li>`;
      });
      const returnGrilleSize = systemCFM < 800 ? '14x14' : systemCFM < 1200 ? '16x20' : systemCFM < 1600 ? '20x20' : '24x24';
      materialHTML += `<li><strong>${returnGrilleSize}</strong> return grille: 1 piece (central return)</li>`;
      materialHTML += '</ul></div>';
      
      materialHTML += '<div class="card-section"><div class="section-title">Additional Materials</div><ul style="font-size: 13px; line-height: 1.8; color: var(--text-secondary);">';
      materialHTML += '<li>Mastic and mesh tape: 1 gallon + 1 roll</li>';
      materialHTML += '<li>Foil tape (3"): 2 rolls</li>';
      materialHTML += '<li>Adjustable duct straps: 2 boxes</li>';
      materialHTML += '<li>Sheet metal screws (#8 x 1/2"): 1 box</li>';
      materialHTML += '</ul></div>';
      
      $('material-takeoff').innerHTML = materialHTML;
      $('material-takeoff-card').style.display = 'block';
      
      currentDuctDesign = {
        projectName,
        tonnage,
        systemCFM,
        equipmentLocation,
        returnType,
        rooms: ductDesignRooms,
        schematic: schematic,
        materials: materialHTML
      };
      
      showToast('Professional duct design generated!', 'success');
      $('system-schematic-card').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }
    
    function exportDuctDesign() {
      if (!currentDuctDesign) {
        showToast('Generate design first', 'warning');
        return;
      }
      
      const report = generateDuctDesignReport();
      
      try {
        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF();
        
        pdf.setFontSize(16);
        pdf.setFont(undefined, 'bold');
        pdf.text('Professional Duct Design Report', 105, 20, { align: 'center' });
        pdf.setFontSize(10);
        pdf.setFont(undefined, 'normal');
        pdf.text('Field Buddy Pro v4.0 Premium', 105, 27, { align: 'center' });
        
        pdf.setFontSize(8);
        const lines = pdf.splitTextToSize(report, 180);
        let y = 35;
        
        lines.forEach(line => {
          if (y > 280) {
            pdf.addPage();
            y = 20;
          }
          pdf.text(line, 15, y);
          y += 4;
        });
        
        pdf.save(`duct-design-${currentDuctDesign.projectName.replace(/\s+/g, '-')}.pdf`);
        showToast('Duct design PDF exported!');
      } catch (e) {
        console.error('PDF generation error:', e);
        showToast('Error generating PDF', 'danger');
      }
    }
    
    function generateDuctDesignReport() {
      const d = currentDuctDesign;
      const date = new Date().toLocaleString();
      
      let report = `‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
‚ïë       PROFESSIONAL DUCT SYSTEM DESIGN REPORT              ‚ïë
‚ïë       Field Buddy Pro v4.0 Premium                         ‚ïë
‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù

PROJECT INFORMATION
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
Project: ${d.projectName}
System Size: ${d.tonnage} Ton (${d.systemCFM} CFM)
Equipment Location: ${d.equipmentLocation}
Return Type: ${d.returnType === 'central' ? 'Central Return' : 'Distributed Returns'}
Date Generated: ${date}

AIRFLOW PLAN
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

Total System CFM: ${d.systemCFM} (${d.tonnage} ton √ó 400 CFM/ton)

Room-by-Room Breakdown:
`;

      d.rooms.forEach((room, index) => {
        report += `\n${index + 1}. ${room.name || 'Room ' + (index + 1)}
   Dimensions: ${room.length} √ó ${room.width} √ó ${room.height} ft
   Volume: ${(room.length * room.width * room.height).toFixed(0)} cu ft
   Required CFM: ${room.cfm} (1 CFM per sq ft rule of thumb)
   Duct Size: ${room.ductSize}
   Duct Length: ${room.ductLength} ft
   Register Size: ${room.registerSize}
   Location: ${room.location || 'Not specified'}
`;
      });
      
      const totalBranchCFM = d.rooms.reduce((sum, room) => sum + room.cfm, 0);
      const balance = ((totalBranchCFM / d.systemCFM) * 100).toFixed(1);
      
      report += `\nTotal Branch CFM: ${totalBranchCFM}
System Balance: ${balance}% (Target: 95-105%)
`;
      
      report += `\n\nDUCT LAYOUT SCHEMATIC
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

${d.schematic.replace(/<[^>]*>/g, '').replace(/&nbsp;/g, ' ')}

PLENUM SPECIFICATIONS
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
Supply Plenum: ${$('supply-plenum-length').value}√ó${$('supply-plenum-width').value}√ó${$('supply-plenum-height').value} inches (L√óW√óH)
Return Plenum: ${$('return-plenum-length').value}√ó${$('return-plenum-width').value}√ó${$('return-plenum-height').value} inches (L√óW√óH)

Fabrication: Custom duct board plenums, 1.5" thick
Assembly: Seal all joints with mastic and mesh tape

INSTALLER NOTES
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

Critical Installation Requirements:

1. Flex Duct Installation
   ‚Ä¢ Fully extend all flex duct - zero compression
   ‚Ä¢ Support every 4-5 feet with adjustable strapping
   ‚Ä¢ Maintain minimum 8" bend radius at all turns
   ‚Ä¢ Seal connections with mastic and mesh (foil tape insufficient)

2. Trunk Line
   ‚Ä¢ Route main trunk to central location for shortest branch runs
   ‚Ä¢ Support trunk adequately to prevent sagging
   ‚Ä¢ Seal all longitudinal and transverse seams

3. Plenum Assembly
   ‚Ä¢ Cut duct board accurately for tight-fitting joints
   ‚Ä¢ Use manufacturer-recommended staples or fasteners
   ‚Ä¢ Seal all corners and joints with mastic
   ‚Ä¢ Ensure smooth transitions from plenum to trunk

4. Airflow Balancing
   ‚Ä¢ Install balancing dampers in each branch run
   ‚Ä¢ Start with all dampers fully open
   ‚Ä¢ Balance system after installation using airflow measurements
   ‚Ä¢ Target: ¬±10% of design CFM per room

5. Quality Checkpoints
   ‚Ä¢ All duct connections sealed (no air leaks)
   ‚Ä¢ Proper slope on drain lines (if condensing equipment)
   ‚Ä¢ Filter grille accessible for maintenance
   ‚Ä¢ System tested for proper airflow before drywall

COMPLETE MATERIAL TAKEOFF
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

${$('material-takeoff').innerText}

DESIGN STANDARDS
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
This design follows ACCA Manual D guidelines and industry best
practices:

‚Ä¢ Main trunk velocity: 700-900 FPM
‚Ä¢ Branch duct velocity: 500-700 FPM
‚Ä¢ Return air velocity: 400-450 FPM at grilles
‚Ä¢ Friction rate: 0.08 in.w.c. per 100 ft (flexible duct)
‚Ä¢ Total ESP target: ‚â§0.50 in.w.c.
‚Ä¢ CFM per ton: 400 (standard residential cooling)

RECOMMENDATIONS
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
‚Ä¢ Consider Manual J load calculation for precise room CFM
‚Ä¢ Verify equipment specifications match design requirements
‚Ä¢ Install service access at trunk line for future maintenance
‚Ä¢ Photograph installation before insulation/drywall
‚Ä¢ Test and balance system per manufacturer guidelines

‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
Field Buddy Pro v4.0 Premium - Professional HVAC Solutions
Village Plumbing - Mart√≠n Perez
`;
      
      return report;
    }
    
    function saveDuctDesign() {
      if (!currentDuctDesign) {
        showToast('Generate design first', 'warning');
        return;
      }
      
      const design = {
        ...currentDuctDesign,
        timestamp: new Date().toISOString(),
        techName: $('tech-name').value
      };
      
      localStorage.setItem('lastDuctDesign', JSON.stringify(design));
      showToast('Duct design saved!', 'success');
    }
    
    function clearDuctDesignForm() {
      showModal('Clear Duct Design', 'Are you sure you want to clear all rooms and start over?').then(confirmed => {
        if (confirmed) {
          ductDesignRooms = [];
          currentDuctDesign = null;
          displayDuctRooms();
          $('system-schematic-card').style.display = 'none';
          $('material-takeoff-card').style.display = 'none';
          $('duct-project-name').value = '';
          $('duct-tonnage').value = '';
          $('system-cfm-display').textContent = '0';
          showToast('Duct design cleared');
        }
      });
    }
    
    // ==================== CFM CALCULATIONS ====================
    
    function calculateCFMByTonnage() {
      const tonnage = parseFloat($('cfm-tonnage').value);
      const cfmPerTon = parseFloat($('cfm-per-ton').value) || 400;
      
      if (!isNaN(tonnage)) {
        const cfm = tonnage * cfmPerTon;
        $('cfm-result-tonnage').value = `${cfm.toFixed(0)} CFM`;
        
        $('duct-cfm').value = cfm.toFixed(0);
        calculateDuctSize();
      } else {
        $('cfm-result-tonnage').value = '';
      }
    }
    
    function calculateCFMByTemp() {
      const btu = parseFloat($('cfm-btu').value);
      const deltaT = parseFloat($('cfm-delta-t').value);
      
      if (!isNaN(btu) && !isNaN(deltaT) && deltaT !== 0) {
        const cfm = btu / (1.08 * deltaT);
        $('cfm-result-temp').value = `${cfm.toFixed(0)} CFM`;
      } else {
        $('cfm-result-temp').value = '';
      }
    }
    
    function calculateCFMByRoom() {
      const length = parseFloat($('room-length').value);
      const width = parseFloat($('room-width').value);
      const height = parseFloat($('room-height').value);
      const ach = parseFloat($('room-ach').value);
      
      if (!isNaN(length) && !isNaN(width) && !isNaN(height)) {
        const volume = length * width * height;
        $('room-volume').value = `${volume.toFixed(0)} cu ft`;
        
        if (!isNaN(ach)) {
          const cfm = (volume * ach) / 60;
          $('cfm-result-room').value = `${cfm.toFixed(0)} CFM`;
        }
      } else {
        $('room-volume').value = '';
        $('cfm-result-room').value = '';
      }
    }
    
    // ==================== DUCT SIZING ====================
    function calculateDuctSize() {
      const cfm = parseFloat($('duct-cfm').value);
      const velocity = parseFloat($('duct-velocity').value);
      const ductType = $('duct-type').value;
      
      if (isNaN(cfm) || isNaN(velocity)) return;
      
      const area = (cfm * 144) / velocity;
      
      if (ductType === 'round') {
        calculateRoundDuct(cfm, velocity, area);
        $('round-duct-results').classList.remove('hidden');
        $('rectangular-duct-results').classList.add('hidden');
      } else {
        calculateRectangularDuct(cfm, velocity, area);
        $('round-duct-results').classList.add('hidden');
        $('rectangular-duct-results').classList.remove('hidden');
      }
      
      updateVelocityChart(cfm);
    }
    
    function calculateRoundDuct(cfm, targetVelocity, area) {
      const diameter = 2 * Math.sqrt(area / Math.PI);
      
      const standardSizes = [4, 5, 6, 7, 8, 9, 10, 12, 14, 16, 18, 20, 22, 24];
      
      let standardDiameter = standardSizes.find(size => size >= diameter);
      if (!standardDiameter) standardDiameter = standardSizes[standardSizes.length - 1];
      
      const standardArea = Math.PI * Math.pow(standardDiameter / 2, 2);
      const actualVelocity = (cfm * 144) / standardArea;
      
      $('round-diameter-calc').value = `${diameter.toFixed(2)}"`;
      $('round-diameter-standard').value = `${standardDiameter}"`;
      $('round-velocity-actual').value = `${actualVelocity.toFixed(0)} FPM`;
      $('round-area').value = `${standardArea.toFixed(1)} sq in`;
    }
    
    function calculateRectangularDuct(cfm, targetVelocity, area) {
      const commonSizes = [
        [6, 8], [6, 10], [6, 12], [6, 14],
        [8, 10], [8, 12], [8, 14], [8, 16],
        [10, 12], [10, 14], [10, 16], [10, 18],
        [12, 14], [12, 16], [12, 18], [12, 20],
        [14, 16], [14, 18], [14, 20], [14, 24],
        [16, 18], [16, 20], [16, 24], [18, 24],
        [20, 24], [24, 24]
      ];
      
      let options = [];
      
      commonSizes.forEach(([width, height]) => {
        const ductArea = width * height;
        const velocity = (cfm * 144) / ductArea;
        const perimeter = 2 * (width + height);
        
        if (velocity >= 400 && velocity <= 1500) {
          options.push({
            width,
            height,
            area: ductArea,
            velocity: velocity.toFixed(0),
            perimeter,
            suitable: velocity >= targetVelocity * 0.8 && velocity <= targetVelocity * 1.2
          });
        }
      });
      
      options.sort((a, b) => {
        const diffA = Math.abs(parseFloat(a.velocity) - targetVelocity);
        const diffB = Math.abs(parseFloat(b.velocity) - targetVelocity);
        return diffA - diffB;
      });
      
      let html = '<div style="display: grid; gap: 12px;">';
      options.slice(0, 6).forEach(opt => {
        const badgeClass = opt.suitable ? 'badge-success' : 'badge-info';
        html += `<div class="selected-material">`;
        html += `<div class="selected-material-info">`;
        html += `<div class="material-name">${opt.width}" √ó ${opt.height}"</div>`;
        html += `<div class="material-spec">Area: ${opt.area} sq in | Perimeter: ${opt.perimeter}"</div>`;
        html += `</div>`;
        html += `<div style="display: flex; align-items: center; gap: 12px;">`;
        html += `<span class="badge ${badgeClass}">${opt.velocity} FPM</span>`;
        if (opt.suitable) html += `<span style="color: var(--success); font-weight: 600;">‚úì Recommended</span>`;
        html += `</div>`;
        html += `</div>`;
      });
      html += '</div>';
      
      $('rectangular-options').innerHTML = html;
    }
    
    function updateVelocityChart(cfm) {
      const ctx = document.getElementById('velocity-chart');
      if (!ctx) return;
      
      const sizes = [6, 7, 8, 9, 10, 12, 14, 16];
      const velocities = sizes.map(diameter => {
        const area = Math.PI * Math.pow(diameter / 2, 2);
        return (cfm * 144) / area;
      });
      
      const chartCtx = ctx.getContext('2d');
      
      if (velocityChart) {
        velocityChart.data.labels = sizes.map(s => `${s}"`);
        velocityChart.data.datasets[0].data = velocities;
        velocityChart.update();
      } else {
        velocityChart = new Chart(chartCtx, {
          type: 'line',
          data: {
            labels: sizes.map(s => `${s}"`),
            datasets: [{
              label: 'Velocity (FPM)',
              data: velocities,
              borderColor: 'rgb(0, 217, 255)',
              backgroundColor: 'rgba(0, 217, 255, 0.1)',
              tension: 0.4,
              fill: true
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              y: {
                beginAtZero: true,
                title: {
                  display: true,
                  text: 'Velocity (FPM)',
                  color: '#CBD5E1'
                },
                ticks: { color: '#CBD5E1' },
                grid: { color: 'rgba(203, 213, 225, 0.1)' }
              },
              x: {
                title: {
                  display: true,
                  text: 'Round Duct Diameter',
                  color: '#CBD5E1'
                },
                ticks: { color: '#CBD5E1' },
                grid: { color: 'rgba(203, 213, 225, 0.1)' }
              }
            },
            plugins: {
              title: {
                display: true,
                text: `Velocity vs Duct Size (${cfm} CFM)`,
                color: '#F8FAFC'
              },
              legend: {
                labels: {
                  color: '#CBD5E1'
                }
              }
            }
          }
        });
      }
    }
    
    // ==================== DATA PERSISTENCE ====================
    function saveData() {
      const report = {
        id: Date.now(),
        timestamp: new Date().toISOString(),
        customer: $('customer-name').value,
        date: $('service-date').value,
        callType,
        systemMode,
        data: {
          address: $('service-address').value,
          complaint: $('customer-complaint').value,
          unitType: $('unit-type').value,
          indoorUnit: $('indoor-unit').value,
          outdoorUnit: $('outdoor-unit').value,
          tonnage: $('tonnage').value,
          refrigerant: $('refrigerant-type').value,
          filterSize: $('filter-size').value,
          meteringDevice: $('metering-device').value,
          seerRating: $('seer-rating').value,
          outdoorAmbient: $('outdoor-ambient').value,
          ambientTemp: $('ambient-temp').value,
          returnTemp: $('return-temp').value,
          supplyTemp: $('supply-temp').value,
          deltaT: $('delta-t').value,
          wetBulb: $('wet-bulb').value,
          suctionPressure: $('suction-pressure').value,
          suctionTemp: $('suction-temp').value,
          superheat: $('superheat').value,
          liquidPressure: $('liquid-pressure').value,
          liquidTemp: $('liquid-temp').value,
          subcool: $('subcool').value,
          staticPressure: $('static-pressure').value,
          voltage: $('voltage').value,
          amperage: $('amperage').value,
          rlaRating: $('rla-rating').value,
          returnTempHeat: $('return-temp-heat').value,
          supplyTempHeat: $('supply-temp-heat').value,
          tempRise: $('temp-rise').value,
          manifoldPressure: $('manifold-pressure').value,
          voltageHeat: $('voltage-heat').value,
          amperageHeat: $('amperage-heat').value,
          gasType: $('gas-type').value,
          findings: $('findings').value,
          recommendations: $('recommendations').value,
          workPerformed: $('work-performed').value,
          sigName: $('sig-name').value,
          sigDate: $('sig-date').value,
          signature: customerSignature,
          techName: $('tech-name').value,
          techPhone: $('tech-phone').value,
          techEmail: $('tech-email').value
        },
        photos: photos,
        diagnostics: diagnosticResults,
        quality: parseInt($('quality-score-large').textContent)
      };
      
      savedReports.push(report);
      localStorage.setItem('fieldBuddyReports', JSON.stringify(savedReports));
      showToast('Progress saved successfully!', 'success');
    }
    
    function loadData() {
      const stored = localStorage.getItem('fieldBuddyReports');
      if (stored) {
        savedReports = JSON.parse(stored);
        showToast(`Loaded ${savedReports.length} saved report(s)`, 'info');
        switchPage('history');
      } else {
        showToast('No saved data found', 'warning');
      }
    }
    
    function exportAllData() {
      if (savedReports.length === 0) {
        showToast('No data to export', 'warning');
        return;
      }
      
      const dataStr = JSON.stringify(savedReports, null, 2);
      const dataBlob = new Blob([dataStr], { type: 'application/json' });
      const url = URL.createObjectURL(dataBlob);
      const link = document.createElement('a');
      link.href = url;
      link.download = `field-buddy-export-${new Date().toISOString().split('T')[0]}.json`;
      link.click();
      URL.revokeObjectURL(url);
      showToast('Data exported successfully!', 'success');
    }
    
    function refreshHistory() {
      const stored = localStorage.getItem('fieldBuddyReports');
      if (stored) {
        savedReports = JSON.parse(stored);
      }
      
      const container = $('history-list');
      
      if (savedReports.length === 0) {
        container.innerHTML = '<div class="status-card info">‚ÑπÔ∏è No saved reports yet. Complete a service call and save your progress to see history here.</div>';
        $('stat-total').textContent = '0';
        $('stat-this-month').textContent = '0';
        $('stat-avg-quality').textContent = '0%';
        $('stat-photos').textContent = '0';
        return;
      }
      
      savedReports.sort((a, b) => b.timestamp.localeCompare(a.timestamp));
      
      let html = '';
      savedReports.forEach((report, index) => {
        const date = new Date(report.timestamp);
        const qualityClass = report.quality >= 80 ? 'success' : report.quality >= 60 ? 'info' : 'warning';
        
        html += '<div class="card mb-lg">';
        html += '<div class="card-header">';
        html += `<div class="card-title">${report.customer || 'Unnamed'} - ${report.date}</div>`;
        html += `<span class="badge badge-${qualityClass}">${report.quality}%</span>`;
        html += '</div>';
        html += '<div class="card-body">';
        html += `<p style="color: var(--text-secondary);"><strong>Type:</strong> ${report.callType} | <strong>Mode:</strong> ${report.systemMode}</p>`;
        html += `<p style="color: var(--text-secondary);"><strong>Photos:</strong> ${report.photos.length} | <strong>Saved:</strong> ${date.toLocaleString()}</p>`;
        html += '<div class="btn-group mt-lg">';
        html += `<button class="btn btn-primary" onclick="loadReport(${index})">Load</button>`;
        html += `<button class="btn btn-danger" onclick="deleteReport(${index})">Delete</button>`;
        html += '</div>';
        html += '</div>';
        html += '</div>';
      });
      
      container.innerHTML = html;
      
      const thisMonth = savedReports.filter(r => {
        const rDate = new Date(r.timestamp);
        const now = new Date();
        return rDate.getMonth() === now.getMonth() && rDate.getFullYear() === now.getFullYear();
      });
      
      const avgQuality = savedReports.reduce((sum, r) => sum + r.quality, 0) / savedReports.length;
      const totalPhotos = savedReports.reduce((sum, r) => sum + r.photos.length, 0);
      
      $('stat-total').textContent = savedReports.length;
      $('stat-this-month').textContent = thisMonth.length;
      $('stat-avg-quality').textContent = `${Math.round(avgQuality)}%`;
      $('stat-photos').textContent = totalPhotos;
    }
    
    function loadReport(index) {
      const report = savedReports[index];
      
      $('customer-name').value = report.customer || '';
      $('service-date').value = report.date || '';
      $('service-address').value = report.data.address || '';
      $('customer-complaint').value = report.data.complaint || '';
      $('unit-type').value = report.data.unitType || '';
      $('indoor-unit').value = report.data.indoorUnit || '';
      $('outdoor-unit').value = report.data.outdoorUnit || '';
      $('tonnage').value = report.data.tonnage || '';
      $('refrigerant-type').value = report.data.refrigerant || 'R410A';
      $('filter-size').value = report.data.filterSize || '';
      $('metering-device').value = report.data.meteringDevice || '';
      $('seer-rating').value = report.data.seerRating || '';
      
      if (report.systemMode === 'cooling') {
        $('outdoor-ambient').value = report.data.outdoorAmbient || '';
        $('ambient-temp').value = report.data.ambientTemp || '';
        $('return-temp').value = report.data.returnTemp || '';
        $('supply-temp').value = report.data.supplyTemp || '';
        $('wet-bulb').value = report.data.wetBulb || '';
        $('suction-pressure').value = report.data.suctionPressure || '';
        $('suction-temp').value = report.data.suctionTemp || '';
        $('liquid-pressure').value = report.data.liquidPressure || '';
        $('liquid-temp').value = report.data.liquidTemp || '';
        $('static-pressure').value = report.data.staticPressure || '';
        $('voltage').value = report.data.voltage || '';
        $('amperage').value = report.data.amperage || '';
        $('rla-rating').value = report.data.rlaRating || '';
      } else {
        $('return-temp-heat').value = report.data.returnTempHeat || '';
        $('supply-temp-heat').value = report.data.supplyTempHeat || '';
        $('manifold-pressure').value = report.data.manifoldPressure || '';
        $('voltage-heat').value = report.data.voltageHeat || '';
        $('amperage-heat').value = report.data.amperageHeat || '';
        $('gas-type').value = report.data.gasType || 'natural';
      }
      
      $('findings').value = report.data.findings || '';
      $('recommendations').value = report.data.recommendations || '';
      $('work-performed').value = report.data.workPerformed || '';
      $('sig-name').value = report.data.sigName || '';
      $('sig-date').value = report.data.sigDate || '';
      customerSignature = report.data.signature;
      if (customerSignature && signaturePad) {
        const img = new Image();
        img.onload = () => signaturePad.fromDataURL(customerSignature);
        img.src = customerSignature;
      }
      
      photos = report.photos || [];
      displayPhotos();
      
      callType = report.callType;
      systemMode = report.systemMode;
      setCallType(callType);
      setSystemMode(systemMode);
      
      calculateDiagnostics();
      calculateQuality();
      
      switchPage('service');
      showToast('Report loaded successfully!', 'success');
    }
    
    async function deleteReport(index) {
      const confirmed = await showModal('Delete Report', 'Are you sure you want to delete this report? This cannot be undone.');
      if (!confirmed) return;
      
      savedReports.splice(index, 1);
      localStorage.setItem('fieldBuddyReports', JSON.stringify(savedReports));
      refreshHistory();
      showToast('Report deleted', 'success');
    }
    
    // ==================== REPORT GENERATION ====================
    function generateTextReport() {
      const customer = $('customer-name').value || 'N/A';
      const date = $('service-date').value || new Date().toISOString().split('T')[0];
      const address = $('service-address').value || 'N/A';
      const complaint = $('customer-complaint').value || 'N/A';
      const tech = $('tech-name').value;
      const techPhone = $('tech-phone').value;
      const techEmail = $('tech-email').value;
      
      let report = `‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
‚ïë       FIELD BUDDY PRO - SERVICE REPORT v4.0 PREMIUM       ‚ïë
‚ïë       Dark Theme Professional Edition                      ‚ïë
‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù

JOB INFORMATION
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
Customer: ${customer}
Date: ${date}
Address: ${address}
Call Type: ${callType === 'trouble' ? 'Trouble Call' : 'Maintenance'}
System Mode: ${systemMode === 'cooling' ? 'Cooling' : 'Heating'}

Customer Complaint:
${complaint}

EQUIPMENT INFORMATION
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
Unit Type: ${$('unit-type').value || 'N/A'}
Indoor Unit: ${$('indoor-unit').value || 'N/A'}
Outdoor Unit: ${$('outdoor-unit').value || 'N/A'}
Tonnage: ${$('tonnage').value || 'N/A'} Ton
Refrigerant: ${$('refrigerant-type').value}
Filter Size: ${$('filter-size').value || 'N/A'}
Metering Device: ${$('metering-device').value || 'Not Specified'}
SEER Rating: ${$('seer-rating').value || 'N/A'}

`;

      if (systemMode === 'cooling') {
        report += `COOLING MEASUREMENTS
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
Outdoor Ambient: ${$('outdoor-ambient').value || 'N/A'}¬∞F
Indoor Ambient: ${$('ambient-temp').value || 'N/A'}¬∞F
Return Air Temp: ${$('return-temp').value || 'N/A'}¬∞F
Supply Air Temp: ${$('supply-temp').value || 'N/A'}¬∞F
Delta-T: ${$('delta-t').value || 'N/A'}
Wet Bulb: ${$('wet-bulb').value || 'N/A'}¬∞F

Suction Pressure: ${$('suction-pressure').value || 'N/A'} PSI
Suction Line Temp: ${$('suction-temp').value || 'N/A'}¬∞F
Superheat: ${$('superheat').value || 'N/A'}

Liquid Pressure: ${$('liquid-pressure').value || 'N/A'} PSI
Liquid Line Temp: ${$('liquid-temp').value || 'N/A'}¬∞F
Subcool: ${$('subcool').value || 'N/A'}

Static Pressure: ${$('static-pressure').value || 'N/A'} in w.c.
Supply Voltage: ${$('voltage').value || 'N/A'} V
Compressor Amperage: ${$('amperage').value || 'N/A'} A
RLA Rating: ${$('rla-rating').value || 'N/A'} A

`;
      } else {
        report += `HEATING MEASUREMENTS
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
Return Air Temp: ${$('return-temp-heat').value || 'N/A'}¬∞F
Supply Air Temp: ${$('supply-temp-heat').value || 'N/A'}¬∞F
Temperature Rise: ${$('temp-rise').value || 'N/A'}

Gas Type: ${$('gas-type').value === 'natural' ? 'Natural Gas' : 'LP/Propane'}
Manifold Pressure: ${$('manifold-pressure').value || 'N/A'} in w.c.
Supply Voltage: ${$('voltage-heat').value || 'N/A'} V
Amperage: ${$('amperage-heat').value || 'N/A'} A

`;
      }

      if (diagnosticResults.length > 0) {
        report += `DIAGNOSTIC ANALYSIS
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

`;
        diagnosticResults.forEach(result => {
          report += `${result.title}\nSeverity: ${result.severity.toUpperCase()}\n${result.message}\n`;
          if (result.recommendations && result.recommendations.length > 0) {
            report += 'Recommended Actions:\n';
            result.recommendations.forEach(rec => {
              report += `  ‚Ä¢ ${rec}\n`;
            });
          }
          report += '\n';
        });
      }

      report += `FINDINGS & RECOMMENDATIONS
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
Findings:
${$('findings').value || 'N/A'}

Recommendations:
${$('recommendations').value || 'N/A'}

Work Performed:
${$('work-performed').value || 'N/A'}

`;

      if (photos.length > 0) {
        report += `JOB PHOTOS
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
${photos.length} photo(s) attached

`;
      }

      if (customerSignature) {
        report += `CUSTOMER SIGNATURE
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
Customer: ${$('sig-name').value || 'N/A'}
Date: ${$('sig-date').value || date}
[Digital signature on file]

`;
      }

      report += `TECHNICIAN INFORMATION
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
Technician: ${tech}
Phone: ${techPhone}
Email: ${techEmail}

Generated: ${new Date().toLocaleString()}
Quality Score: ${$('quality-score-large').textContent}

‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
Field Buddy Pro v4.0 Premium - Dark Theme Professional Edition
Village Plumbing - Excellence in HVAC Service
`;

      displayTextReport(report);
      showToast('Text report generated!');
    }
    
    function displayTextReport(text) {
      const container = $('report-container');
      let html = '<div class="card mt-lg">';
      html += '<div class="card-header"><div class="card-title">üìÑ Generated Report</div></div>';
      html += '<div class="card-body">';
      html += '<div class="status-card success">‚úì Report ready to copy or print</div>';
      html += `<pre style="background:var(--bg-elevated);padding:15px;border-radius:var(--radius-lg);overflow-x:auto;font-size:11px;line-height:1.4;font-family:monospace;color:var(--text-secondary);border:1px solid var(--glass-border);">${text}</pre>`;
      html += '<div class="btn-group mt-lg">';
      html += '<button class="btn btn-primary" onclick="copyToClipboard()">üìã Copy to Clipboard</button>';
      html += '<button class="btn btn-secondary" onclick="printReport()">üñ®Ô∏è Print</button>';
      html += '</div>';
      html += '</div>';
      html += '</div>';
      container.innerHTML = html;
      container.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }
    
    function copyToClipboard() {
      const text = document.querySelector('pre').textContent;
      navigator.clipboard.writeText(text).then(() => {
        showToast('‚úì Copied to clipboard!');
      }).catch(() => {
        showToast('Failed to copy', 'danger');
      });
    }
    
    function printReport() {
      const text = document.querySelector('pre').textContent;
      const w = window.open('', '_blank');
      w.document.write(`<html><head><title>Service Report</title><style>body{font-family:monospace;font-size:12px;line-height:1.4;margin:0.5in;white-space:pre-wrap;background:#0B1121;color:#F8FAFC;}</style></head><body>${text}</body></html>`);
      w.document.close();
      setTimeout(() => {
        w.print();
        w.close();
      }, 250);
    }
    
    function generatePDF() {
      try {
        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF();
        
        pdf.setFontSize(16);
        pdf.setFont(undefined, 'bold');
        pdf.text('Village Plumbing - Service Report', 105, 20, { align: 'center' });
        pdf.setFontSize(10);
        pdf.setFont(undefined, 'normal');
        pdf.text('Field Buddy Pro v4.0 Premium Edition', 105, 27, { align: 'center' });
        
        generateTextReport();
        const textReport = document.querySelector('pre').textContent;
        
        pdf.setFontSize(8);
        const lines = pdf.splitTextToSize(textReport, 180);
        let y = 35;
        
        lines.forEach(line => {
          if (y > 280) {
            pdf.addPage();
            y = 20;
          }
          pdf.text(line, 15, y);
          y += 4;
        });
        
        if (photos.length > 0) {
          pdf.addPage();
          pdf.setFontSize(12);
          pdf.setFont(undefined, 'bold');
          pdf.text('Job Photos', 105, 20, { align: 'center' });
          pdf.setFont(undefined, 'normal');
          
          let pY = 30;
          let pX = 15;
          photos.forEach((photo, i) => {
            if (pY > 200) {
              pdf.addPage();
              pY = 20;
            }
            try {
              pdf.addImage(photo.data, 'JPEG', pX, pY, 80, 60);
              pdf.setFontSize(7);
              pdf.text(photo.name || `Photo ${i + 1}`, pX, pY + 65);
            } catch (e) {
              console.error('Error adding photo:', e);
            }
            pX = (i % 2 === 0) ? 115 : 15;
            if (i % 2 === 1) pY += 75;
          });
        }
        
        if (customerSignature) {
          pdf.addPage();
          pdf.setFontSize(12);
          pdf.setFont(undefined, 'bold');
          pdf.text('Customer Signature', 105, 20, { align: 'center' });
          pdf.setFont(undefined, 'normal');
          pdf.addImage(customerSignature, 'PNG', 40, 30, 130, 50);
        }
        
        pdf.save(`service-report-${new Date().toISOString().split('T')[0]}.pdf`);
        showToast('PDF generated successfully!');
      } catch (e) {
        console.error('PDF generation error:', e);
        showToast('Error generating PDF', 'danger');
      }
    }
    
    function generateMaterialsReport() {
      const customer = $('mat-customer').value || 'N/A';
      const date = $('mat-date').value || new Date().toISOString().split('T')[0];
      const address = $('mat-address').value || 'N/A';
      const notes = $('mat-notes').value || 'N/A';
      const tech = $('mat-tech-name').value;
      const techPhone = $('mat-tech-phone').value;
      const techEmail = $('mat-tech-email').value;
      
      let report = `‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
‚ïë       FIELD BUDDY PRO - MATERIALS LIST v4.0 PREMIUM       ‚ïë
‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù

JOB INFORMATION
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
Customer/Job: ${customer}
Date: ${date}
Address: ${address}
Notes: ${notes}

MATERIALS NEEDED
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

`;

      if (selectedMaterials.length === 0) {
        report += 'No materials added to list.\n\n';
      } else {
        const grouped = {};
        selectedMaterials.forEach(item => {
          if (!grouped[item.catName]) grouped[item.catName] = [];
          grouped[item.catName].push(item);
        });
        
        Object.keys(grouped).forEach(category => {
          report += `${category}:\n`;
          report += '‚îÄ'.repeat(60) + '\n';
          grouped[category].forEach(item => {
            report += `‚òê ${item.name}\n`;
            report += `  Spec: ${item.spec}\n`;
            report += `  Quantity: ${item.quantity} ${item.unit}\n\n`;
          });
          report += '\n';
        });
        
        const totalQty = selectedMaterials.reduce((sum, m) => sum + m.quantity, 0);
        report += '‚ïê'.repeat(60) + '\n';
        report += `TOTAL ITEMS: ${totalQty}\n`;
        report += `TOTAL LINE ITEMS: ${selectedMaterials.length}\n`;
        report += '‚ïê'.repeat(60) + '\n';
      }

      report += `\nTECHNICIAN INFORMATION
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
Technician: ${tech}
Phone: ${techPhone}
Email: ${techEmail}
Generated: ${new Date().toLocaleString()}

‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
Field Buddy Pro v4.0 Premium - Dark Theme Professional Edition
Village Plumbing - Excellence in HVAC Service
`;

      const container = $('report-container-mat');
      let html = '<div class="card mt-lg">';
      html += '<div class="card-header"><div class="card-title">üìÑ Materials List Generated</div></div>';
      html += '<div class="card-body">';
      html += '<div class="status-card success">‚úì List ready to copy or print</div>';
      html += `<pre style="background:var(--bg-elevated);padding:15px;border-radius:var(--radius-lg);overflow-x:auto;font-size:11px;line-height:1.4;font-family:monospace;color:var(--text-secondary);border:1px solid var(--glass-border);">${report}</pre>`;
      html += '<div class="btn-group mt-lg">';
      html += '<button class="btn btn-primary" onclick="copyToClipboard()">üìã Copy to Clipboard</button>';
      html += '<button class="btn btn-secondary" onclick="printReport()">üñ®Ô∏è Print</button>';
      html += '</div>';
      html += '</div>';
      html += '</div>';
      container.innerHTML = html;
      container.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
      showToast('Materials list generated!');
    }
    
    function generateMaterialsPDF() {
      try {
        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF();
        
        pdf.setFontSize(16);
        pdf.setFont(undefined, 'bold');
        pdf.text('Village Plumbing - Materials List', 105, 20, { align: 'center' });
        pdf.setFontSize(10);
        pdf.setFont(undefined, 'normal');
        pdf.text('Field Buddy Pro v4.0 Premium', 105, 27, { align: 'center' });
        
        generateMaterialsReport();
        const textReport = document.querySelector('#report-container-mat pre').textContent;
        
        pdf.setFontSize(8);
        const lines = pdf.splitTextToSize(textReport, 180);
        let y = 35;
        
        lines.forEach(line => {
          if (y > 280) {
            pdf.addPage();
            y = 20;
          }
          pdf.text(line, 15, y);
          y += 4;
        });
        
        pdf.save(`materials-list-${new Date().toISOString().split('T')[0]}.pdf`);
        showToast('Materials PDF generated!');
      } catch (e) {
        console.error('PDF generation error:', e);
        showToast('Error generating PDF', 'danger');
      }
    }
    
    async function clearForm() {
      const confirmed = await showModal('Clear Form', 'Are you sure you want to clear all data? This cannot be undone.');
      if (!confirmed) return;
      
      document.querySelectorAll('input, select, textarea').forEach(el => {
        if (el.type === 'checkbox') {
          el.checked = false;
          const item = el.closest('.checklist-item');
          if (item) item.classList.remove('checked');
        } else if (el.id.includes('tech-') || el.id.includes('mat-tech-')) {
          // Keep tech info
        } else if (el.type === 'date') {
          el.value = new Date().toISOString().split('T')[0];
        } else {
          el.value = '';
        }
      });
      
      photos = [];
      selectedMaterials = [];
      customerSignature = null;
      diagnosticResults = [];
      
      displayPhotos();
      displaySelectedMaterials();
      if (signaturePad) signaturePad.clear();
      $('diagnostic-results').classList.add('hidden');
      $('report-container').innerHTML = '';
      $('report-container-mat').innerHTML = '';
      
      Object.keys(materialsCatalog).forEach(catKey => {
        updateCategorySelectedCount(catKey);
      });
      
      calculateQuality();
      showToast('Form cleared successfully');
    }
    
    // ==================== INIT ====================
    window.addEventListener('load', () => {
      const today = new Date().toISOString().split('T')[0];
      $('service-date').value = today;
      $('sig-date').value = today;
      $('mat-date').value = today;
      $('duct-project-date').value = today;
      
      initSignature();
      initMaterialsCatalog();
      calculateQuality();
      displayDuctRooms();
      updateDashboardStats();
      
      const stored = localStorage.getItem('fieldBuddyReports');
      if (stored) {
        savedReports = JSON.parse(stored);
      }
      
      console.log('%cüîß Field Buddy Pro v4.0 Premium', 'color: #00D9FF; font-size: 20px; font-weight: bold; text-shadow: 0 0 10px rgba(0,217,255,0.5);');
      console.log('%c‚ú® Dark Theme Professional Edition', 'color: #10B981; font-size: 16px;');
      console.log('%cüèóÔ∏è Professional Duct Design System (ACCA Manual D)', 'color: #A855F7; font-size: 14px;');
      console.log('%cüì¶ Complete 2025 Materials Catalog', 'color: #FF6B35; font-size: 14px;');
      console.log('%cüë®‚Äçüîß Default Tech: Mart√≠n Perez | Village Plumbing', 'color: #94A3B8; font-size: 12px;');
      
      showToast('Field Buddy Pro v4.0 Premium Ready!', 'success');
    });
  </script>
</body>
</html>
