<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="mobile-web-app-capable" content="yes">
  <title>Field Buddy Pro v5.0 - Flow Edition</title>
  
  <!-- PWA Manifest -->
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#0B1121">
  
  <!-- Libraries (lazy loaded) -->
  <script>
    // Lazy load heavy libs only when needed
    window.loadPDF = () => import('https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js');
    window.loadChart = () => import('https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js');
    window.loadSignature = () => import('https://cdn.jsdelivr.net/npm/signature_pad@4.1.7/dist/signature_pad.umd.min.js');
  </script>
  
  <style>
    /* ==================== DESIGN TOKENS ==================== */
    :root {
      /* Dark Theme */
      --bg-primary: #0B1121;
      --bg-secondary: #151B2D;
      --bg-tertiary: #1E2638;
      --bg-elevated: #242D42;
      --bg-card: #1A2332;
      
      /* Accents */
      --cyan: #00D9FF;
      --cyan-dark: #00A8CC;
      --orange: #FF6B35;
      --purple: #A855F7;
      --green: #10B981;
      --yellow: #FCD34D;
      --red: #EF4444;
      --blue: #3B82F6;
      
      /* Status Colors */
      --success: #10B981;
      --warning: #FCD34D;
      --danger: #EF4444;
      --info: #3B82F6;
      
      /* Text */
      --text-primary: #F8FAFC;
      --text-secondary: #CBD5E1;
      --text-tertiary: #94A3B8;
      --text-muted: #64748B;
      
      /* Glass Effects */
      --glass-bg: rgba(30, 38, 56, 0.8);
      --glass-border: rgba(255, 255, 255, 0.1);
      --glass-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
      
      /* Shadows */
      --shadow-sm: 0 2px 4px rgba(0, 0, 0, 0.3);
      --shadow: 0 4px 6px rgba(0, 0, 0, 0.4);
      --shadow-md: 0 8px 16px rgba(0, 0, 0, 0.4);
      --shadow-lg: 0 16px 32px rgba(0, 0, 0, 0.5);
      --shadow-xl: 0 24px 48px rgba(0, 0, 0, 0.6);
      
      /* Radius */
      --radius-sm: 6px;
      --radius: 8px;
      --radius-md: 12px;
      --radius-lg: 16px;
      --radius-xl: 24px;
      --radius-full: 9999px;
      
      /* Spacing */
      --space-xs: 4px;
      --space-sm: 8px;
      --space-md: 12px;
      --space-lg: 16px;
      --space-xl: 24px;
      --space-2xl: 32px;
      --space-3xl: 48px;
      
      /* Transitions */
      --transition-fast: 150ms cubic-bezier(0.4, 0, 0.2, 1);
      --transition: 200ms cubic-bezier(0.4, 0, 0.2, 1);
      --transition-slow: 300ms cubic-bezier(0.4, 0, 0.2, 1);
      
      /* Touch Targets (Android GS24 optimized) */
      --touch-min: 48px;
      --touch-comfortable: 56px;
    }
    
    /* ==================== RESET & BASE ==================== */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }
    
    html {
      font-size: 16px;
      -webkit-text-size-adjust: 100%;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      font-size: 0.875rem;
      line-height: 1.6;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      overflow-x: hidden;
      position: relative;
    }
    
    /* ==================== LAYOUT ==================== */
    .app {
      display: flex;
      min-height: 100vh;
      position: relative;
    }
    
    .sidebar {
      width: 280px;
      background: var(--bg-secondary);
      border-right: 1px solid var(--glass-border);
      position: fixed;
      left: 0;
      top: 0;
      height: 100vh;
      overflow-y: auto;
      z-index: 1000;
      transition: transform var(--transition-slow);
      transform: translateX(0);
    }
    
    .sidebar.collapsed {
      transform: translateX(-100%);
    }
    
    .main {
      flex: 1;
      margin-left: 280px;
      min-height: 100vh;
      transition: margin-left var(--transition-slow);
    }
    
    .main.full-width {
      margin-left: 0;
    }
    
    .header {
      background: var(--glass-bg);
      backdrop-filter: blur(20px);
      border-bottom: 1px solid var(--glass-border);
      padding: 0 var(--space-xl);
      height: 64px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      position: sticky;
      top: 0;
      z-index: 100;
      box-shadow: var(--shadow);
    }
    
    .header-left {
      display: flex;
      align-items: center;
      gap: var(--space-lg);
    }
    
    .menu-toggle {
      display: none;
      width: var(--touch-min);
      height: var(--touch-min);
      background: none;
      border: none;
      color: var(--text-primary);
      font-size: 1.5rem;
      cursor: pointer;
      padding: 0;
      align-items: center;
      justify-content: center;
      border-radius: var(--radius);
      transition: var(--transition);
    }
    
    .menu-toggle:active {
      background: rgba(255, 255, 255, 0.1);
    }
    
    .page-title {
      font-size: 1.25rem;
      font-weight: 700;
      background: linear-gradient(135deg, var(--cyan) 0%, var(--cyan-dark) 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    
    .workspace {
      padding: var(--space-xl);
      max-width: 1400px;
      margin: 0 auto;
    }
    
    /* ==================== SIDEBAR COMPONENTS ==================== */
    .sidebar-header {
      padding: var(--space-2xl);
      border-bottom: 1px solid var(--glass-border);
      background: linear-gradient(135deg, var(--bg-tertiary) 0%, var(--bg-secondary) 100%);
    }
    
    .logo {
      display: flex;
      align-items: center;
      gap: var(--space-md);
    }
    
    .logo-icon {
      width: 48px;
      height: 48px;
      background: linear-gradient(135deg, var(--cyan) 0%, var(--cyan-dark) 100%);
      border-radius: var(--radius-lg);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
      box-shadow: 0 0 20px rgba(0, 217, 255, 0.4);
      animation: pulse-glow 3s ease-in-out infinite;
    }
    
    @keyframes pulse-glow {
      0%, 100% { box-shadow: 0 0 20px rgba(0, 217, 255, 0.4); }
      50% { box-shadow: 0 0 30px rgba(0, 217, 255, 0.6); }
    }
    
    .logo-text h1 {
      font-size: 1.125rem;
      font-weight: 700;
      background: linear-gradient(135deg, var(--cyan) 0%, var(--cyan-dark) 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      line-height: 1.2;
    }
    
    .logo-text .version {
      font-size: 0.6875rem;
      color: var(--text-tertiary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      font-weight: 600;
    }
    
    .nav {
      padding: var(--space-xl) 0;
    }
    
    .nav-section {
      margin-bottom: var(--space-xl);
    }
    
    .nav-section-title {
      padding: var(--space-sm) var(--space-xl);
      font-size: 0.6875rem;
      font-weight: 700;
      color: var(--text-tertiary);
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    
    .nav-item {
      display: flex;
      align-items: center;
      gap: var(--space-md);
      padding: var(--space-md) var(--space-xl);
      color: var(--text-secondary);
      text-decoration: none;
      cursor: pointer;
      transition: var(--transition);
      border-left: 3px solid transparent;
      font-weight: 500;
      min-height: var(--touch-min);
      position: relative;
      user-select: none;
      background: none;
      border-top: none;
      border-right: none;
      border-bottom: none;
      width: 100%;
      text-align: left;
      font-size: 0.875rem;
    }
    
    .nav-item::before {
      content: '';
      position: absolute;
      left: 0;
      top: 0;
      height: 100%;
      width: 0;
      background: linear-gradient(90deg, var(--cyan) 0%, transparent 100%);
      opacity: 0;
      transition: var(--transition);
    }
    
    .nav-item:hover {
      color: var(--cyan);
      background: rgba(0, 217, 255, 0.05);
    }
    
    .nav-item:hover::before {
      width: 100%;
      opacity: 0.1;
    }
    
    .nav-item.active {
      color: var(--cyan);
      background: rgba(0, 217, 255, 0.1);
      border-left-color: var(--cyan);
      font-weight: 600;
    }
    
    .nav-item .icon {
      font-size: 1.25rem;
      width: 28px;
      text-align: center;
      flex-shrink: 0;
    }
    
    /* ==================== CARDS ==================== */
    .card {
      background: var(--glass-bg);
      backdrop-filter: blur(20px);
      border: 1px solid var(--glass-border);
      border-radius: var(--radius-xl);
      margin-bottom: var(--space-xl);
      box-shadow: var(--shadow);
      overflow: hidden;
      transition: var(--transition);
    }
    
    .card:hover {
      box-shadow: var(--shadow-md);
      border-color: rgba(0, 217, 255, 0.2);
    }
    
    .card-header {
      padding: var(--space-xl);
      border-bottom: 1px solid var(--glass-border);
      background: rgba(0, 0, 0, 0.2);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    
    .card-title {
      font-size: 1.125rem;
      font-weight: 700;
      color: var(--text-primary);
      display: flex;
      align-items: center;
      gap: var(--space-sm);
    }
    
    .card-body {
      padding: var(--space-xl);
    }
    
    .card-section {
      margin-bottom: var(--space-xl);
    }
    
    .card-section:last-child {
      margin-bottom: 0;
    }
    
    .section-title {
      font-size: 0.875rem;
      font-weight: 700;
      color: var(--cyan);
      margin-bottom: var(--space-md);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      display: flex;
      align-items: center;
      gap: var(--space-sm);
    }
    
    .section-title::before {
      content: '';
      width: 4px;
      height: 16px;
      background: var(--cyan);
      border-radius: 2px;
    }
    
    /* ==================== FORM ELEMENTS ==================== */
    .form-grid {
      display: grid;
      gap: var(--space-lg);
    }
    
    .form-grid-2 {
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    }
    
    .form-grid-3 {
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    }
    
    .form-group {
      display: flex;
      flex-direction: column;
    }
    
    label {
      font-size: 0.8125rem;
      font-weight: 600;
      color: var(--text-secondary);
      margin-bottom: var(--space-sm);
      display: flex;
      align-items: center;
      gap: var(--space-xs);
    }
    
    .required::after {
      content: '*';
      color: var(--red);
      margin-left: 2px;
    }
    
    .help-icon {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 16px;
      height: 16px;
      background: var(--cyan);
      color: var(--bg-primary);
      border-radius: 50%;
      font-size: 0.625rem;
      font-weight: 700;
      cursor: help;
      position: relative;
    }
    
    input,
    select,
    textarea {
      width: 100%;
      padding: var(--space-md) var(--space-lg);
      min-height: var(--touch-min);
      background: var(--bg-elevated);
      border: 1px solid var(--glass-border);
      border-radius: var(--radius);
      color: var(--text-primary);
      font-size: 0.875rem;
      font-family: inherit;
      transition: var(--transition);
      outline: none;
    }
    
    input:focus,
    select:focus,
    textarea:focus {
      border-color: var(--cyan);
      box-shadow: 0 0 0 3px rgba(0, 217, 255, 0.2);
      background: var(--bg-tertiary);
    }
    
    input[readonly] {
      background: var(--bg-secondary);
      color: var(--text-tertiary);
      cursor: not-allowed;
    }
    
    input.success {
      border-color: var(--success);
      background: rgba(16, 185, 129, 0.05);
    }
    
    input.warning {
      border-color: var(--warning);
      background: rgba(252, 211, 77, 0.05);
    }
    
    input.error {
      border-color: var(--danger);
      background: rgba(239, 68, 68, 0.05);
    }
    
    textarea {
      min-height: 100px;
      resize: vertical;
      line-height: 1.6;
    }
    
    /* ==================== BUTTONS ==================== */
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: var(--space-sm);
      padding: var(--space-md) var(--space-xl);
      min-height: var(--touch-min);
      background: var(--bg-elevated);
      border: 1px solid var(--glass-border);
      border-radius: var(--radius);
      color: var(--text-primary);
      font-size: 0.875rem;
      font-weight: 600;
      font-family: inherit;
      cursor: pointer;
      transition: var(--transition);
      user-select: none;
      text-decoration: none;
      position: relative;
      overflow: hidden;
    }
    
    .btn::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 0;
      height: 0;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.3);
      transform: translate(-50%, -50%);
      transition: width 0.6s, height 0.6s;
    }
    
    .btn:active::before {
      width: 300px;
      height: 300px;
    }
    
    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    .btn-primary {
      background: linear-gradient(135deg, var(--cyan) 0%, var(--cyan-dark) 100%);
      color: white;
      border-color: transparent;
      box-shadow: 0 0 20px rgba(0, 217, 255, 0.3);
    }
    
    .btn-primary:hover:not(:disabled) {
      box-shadow: 0 0 30px rgba(0, 217, 255, 0.5);
      transform: translateY(-2px);
    }
    
    .btn-primary:active:not(:disabled) {
      transform: translateY(0);
    }
    
    .btn-success {
      background: linear-gradient(135deg, var(--green) 0%, #059669 100%);
      color: white;
      border-color: transparent;
      box-shadow: 0 0 20px rgba(16, 185, 129, 0.3);
    }
    
    .btn-danger {
      background: linear-gradient(135deg, var(--red) 0%, #DC2626 100%);
      color: white;
      border-color: transparent;
      box-shadow: 0 0 20px rgba(239, 68, 68, 0.3);
    }
    
    .btn-secondary {
      background: var(--bg-elevated);
      border-color: var(--glass-border);
    }
    
    .btn-secondary:hover:not(:disabled) {
      background: var(--bg-tertiary);
      border-color: var(--cyan);
    }
    
    .btn-group {
      display: flex;
      gap: var(--space-sm);
      flex-wrap: wrap;
    }
    
    .btn-icon {
      min-width: var(--touch-min);
      padding: 0;
    }
    
    .btn-lg {
      min-height: var(--touch-comfortable);
      padding: var(--space-lg) var(--space-2xl);
      font-size: 1rem;
    }
    
    .btn-sm {
      min-height: 40px;
      padding: var(--space-sm) var(--space-lg);
      font-size: 0.8125rem;
    }
    
    /* ==================== QUICK ACTION CARDS ==================== */
    .quick-actions {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: var(--space-lg);
      margin-bottom: var(--space-2xl);
    }
    
    .action-card {
      background: var(--bg-card);
      border: 2px solid var(--glass-border);
      border-radius: var(--radius-xl);
      padding: var(--space-2xl);
      cursor: pointer;
      transition: var(--transition);
      position: relative;
      overflow: hidden;
      min-height: 200px;
      display: flex;
      flex-direction: column;
    }
    
    .action-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, var(--cyan) 0%, var(--purple) 100%);
      opacity: 0;
      transition: var(--transition);
    }
    
    .action-card:hover {
      border-color: var(--cyan);
      transform: translateY(-4px);
      box-shadow: 0 0 30px rgba(0, 217, 255, 0.3);
    }
    
    .action-card:hover::before {
      opacity: 1;
    }
    
    .action-card:active {
      transform: translateY(-2px);
    }
    
    .action-card.selected {
      border-color: var(--cyan);
      background: rgba(0, 217, 255, 0.1);
    }
    
    .action-icon {
      width: 64px;
      height: 64px;
      background: linear-gradient(135deg, var(--cyan) 0%, var(--cyan-dark) 100%);
      border-radius: var(--radius-lg);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 2rem;
      margin-bottom: var(--space-lg);
      box-shadow: 0 0 20px rgba(0, 217, 255, 0.4);
    }
    
    .action-card.orange .action-icon {
      background: linear-gradient(135deg, var(--orange) 0%, #E85D2F 100%);
      box-shadow: 0 0 20px rgba(255, 107, 53, 0.4);
    }
    
    .action-card.purple .action-icon {
      background: linear-gradient(135deg, var(--purple) 0%, #7C3AED 100%);
      box-shadow: 0 0 20px rgba(168, 85, 247, 0.4);
    }
    
    .action-title {
      font-size: 1.25rem;
      font-weight: 700;
      margin-bottom: var(--space-sm);
      color: var(--text-primary);
    }
    
    .action-description {
      font-size: 0.875rem;
      color: var(--text-secondary);
      line-height: 1.6;
      flex: 1;
    }
    
    .action-badge {
      display: inline-block;
      padding: 4px 12px;
      background: var(--cyan);
      color: white;
      border-radius: var(--radius-full);
      font-size: 0.625rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-top: var(--space-md);
      align-self: flex-start;
    }
    
    /* ==================== UTILITIES ==================== */
    .hidden {
      display: none !important;
    }
    
    .mt-sm { margin-top: var(--space-sm); }
    .mt-md { margin-top: var(--space-md); }
    .mt-lg { margin-top: var(--space-lg); }
    .mt-xl { margin-top: var(--space-xl); }
    
    .mb-sm { margin-bottom: var(--space-sm); }
    .mb-md { margin-bottom: var(--space-md); }
    .mb-lg { margin-bottom: var(--space-lg); }
    .mb-xl { margin-bottom: var(--space-xl); }
    
    .text-center { text-align: center; }
    .text-right { text-align: right; }
    
    .text-success { color: var(--success); }
    .text-warning { color: var(--warning); }
    .text-danger { color: var(--danger); }
    .text-info { color: var(--info); }
    .text-muted { color: var(--text-muted); }
    
    /* ==================== TOAST NOTIFICATIONS ==================== */
    .toast {
      position: fixed;
      bottom: var(--space-2xl);
      right: var(--space-2xl);
      background: var(--bg-elevated);
      backdrop-filter: blur(20px);
      border: 1px solid var(--glass-border);
      border-radius: var(--radius-lg);
      padding: var(--space-lg) var(--space-xl);
      box-shadow: var(--shadow-xl);
      z-index: 9999;
      min-width: 280px;
      max-width: 400px;
      opacity: 0;
      transform: translateY(20px);
      transition: var(--transition);
      pointer-events: none;
    }
    
    .toast.show {
      opacity: 1;
      transform: translateY(0);
      pointer-events: auto;
    }
    
    .toast.success {
      background: linear-gradient(135deg, var(--cyan) 0%, var(--cyan-dark) 100%);
      color: white;
      border-color: transparent;
    }
    
    .toast.error {
      background: linear-gradient(135deg, var(--red) 0%, #DC2626 100%);
      color: white;
      border-color: transparent;
    }
    
    .toast.warning {
      background: linear-gradient(135deg, var(--orange) 0%, #E85D2F 100%);
      color: white;
      border-color: transparent;
    }
    
    /* ==================== LOADING STATES ==================== */
    .spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(255, 255, 255, 0.3);
      border-top-color: white;
      border-radius: 50%;
      animation: spin 0.6s linear infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    .skeleton {
      background: linear-gradient(90deg, var(--bg-tertiary) 25%, var(--bg-elevated) 50%, var(--bg-tertiary) 75%);
      background-size: 200% 100%;
      animation: skeleton-loading 1.5s ease-in-out infinite;
      border-radius: var(--radius);
    }
    
    @keyframes skeleton-loading {
      0% { background-position: 200% 0; }
      100% { background-position: -200% 0; }
    }
    
    /* ==================== RESPONSIVE ==================== */
    @media (max-width: 1024px) {
      .sidebar {
        transform: translateX(-100%);
      }
      
      .sidebar.open {
        transform: translateX(0);
        box-shadow: var(--shadow-xl);
      }
      
      .main {
        margin-left: 0;
      }
      
      .menu-toggle {
        display: flex;
      }
      
      .form-grid-2,
      .form-grid-3 {
        grid-template-columns: 1fr;
      }
    }
    
    @media (max-width: 640px) {
      .workspace {
        padding: var(--space-lg);
      }
      
      .header {
        padding: 0 var(--space-lg);
        height: 56px;
      }
      
      .quick-actions {
        grid-template-columns: 1fr;
      }
      
      .card-header {
        padding: var(--space-lg);
      }
      
      .card-body {
        padding: var(--space-lg);
      }
      
      .toast {
        bottom: var(--space-lg);
        right: var(--space-lg);
        left: var(--space-lg);
        min-width: auto;
      }
    }
  </style>
</head>

<body>
  <div class="app">
    
    <!-- ==================== SIDEBAR ==================== -->
    <aside class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <div class="logo">
          <div class="logo-icon">üîß</div>
          <div class="logo-text">
            <h1>Field Buddy Pro</h1>
            <div class="version">v5.0 Flow Edition</div>
          </div>
        </div>
      </div>
      
      <nav class="nav">
        <div class="nav-section">
          <div class="nav-section-title">Quick Start</div>
          <button class="nav-item active" data-page="dashboard">
            <span class="icon">üè†</span>
            <span>Dashboard</span>
          </button>
          <button class="nav-item" data-page="new-job">
            <span class="icon">‚ûï</span>
            <span>New Service Call</span>
          </button>
          <button class="nav-item" data-page="continue">
            <span class="icon">‚ñ∂Ô∏è</span>
            <span>Continue Last Job</span>
          </button>
        </div>
        
        <div class="nav-section">
          <div class="nav-section-title">Tools</div><button class="nav-item" data-page="measurements">
            <span class="icon">üìè</span>
            <span>Quick Measurements</span>
          </button>
          <button class="nav-item" data-page="materials">
            <span class="icon">üì¶</span>
            <span>Materials & Parts</span>
          </button>
          <button class="nav-item" data-page="photos">
            <span class="icon">üì∑</span>
            <span>Photo Gallery</span>
          </button>
        </div>
        
        <div class="nav-section">
          <div class="nav-section-title">History</div>
          <button class="nav-item" data-page="history">
            <span class="icon">üìä</span>
            <span>Past Jobs</span>
          </button>
          <button class="nav-item" data-page="reports">
            <span class="icon">üìÑ</span>
            <span>Saved Reports</span>
          </button>
        </div>
        
        <div class="nav-section">
          <div class="nav-section-title">Settings</div>
          <button class="nav-item" data-page="sync">
            <span class="icon">üîÑ</span>
            <span>Sync Data</span>
          </button>
          <button class="nav-item" data-page="settings">
            <span class="icon">‚öôÔ∏è</span>
            <span>Preferences</span>
          </button>
        </div>
      </nav>
    </aside>
    
    <!-- ==================== MAIN CONTENT ==================== -->
    <main class="main" id="main">
      
      <!-- Header -->
      <header class="header">
        <div class="header-left">
          <button class="menu-toggle" id="menu-toggle" aria-label="Toggle menu">
            ‚ò∞
          </button>
          <h2 class="page-title" id="page-title">Dashboard</h2>
        </div>
        <div class="header-right">
          <button class="btn btn-icon" id="sync-status" aria-label="Sync status" title="All data saved locally">
            üíæ
          </button>
        </div>
      </header>
      
      <!-- Workspace -->
      <div class="workspace">
        
        <!-- ==================== DASHBOARD PAGE ==================== -->
        <div id="page-dashboard" class="page-content">
          <div class="mb-xl">
            <h1 style="font-size: 2rem; font-weight: 700; margin-bottom: 0.5rem;">
              Welcome back, Mart√≠n! üëã
            </h1>
            <p style="color: var(--text-secondary); font-size: 1rem;">
              Let's get to work. What would you like to do?
            </p>
          </div>
          
          <div class="quick-actions">
            <div class="action-card" data-action="new-job">
              <div class="action-icon">‚ûï</div>
              <div class="action-title">Start New Job</div>
              <div class="action-description">
                Begin a fresh service call with guided workflow
              </div>
              <span class="action-badge">Quick Start</span>
            </div>
            
            <div class="action-card orange" data-action="continue">
              <div class="action-icon">‚ñ∂Ô∏è</div>
              <div class="action-title">Continue Last Job</div>
              <div class="action-description">
                Resume your most recent in-progress service call
              </div>
              <span class="action-badge" style="background: var(--orange);">Resume</span>
            </div>
            
            <div class="action-card purple" data-action="quick-measure">
              <div class="action-icon">üìè</div>
              <div class="action-title">Quick Measurements</div>
              <div class="action-description">
                Log temps & pressures without starting a full job
              </div>
              <span class="action-badge" style="background: var(--purple);">Fast Entry</span>
            </div>
          </div>
          
          <div id="recent-jobs-container"></div>
          <div id="quick-stats-container"></div>
        </div>
        
        <!-- ==================== NEW JOB PAGE ==================== -->
        <div id="page-new-job" class="page-content hidden">
          <div id="issue-type-container"></div>
          <div id="equipment-info-container"></div>
          <div id="measurements-container"></div>
          <div id="suggestions-container"></div>
          <div id="photos-notes-container"></div>
          
          <div class="btn-group mt-xl">
            <button class="btn btn-secondary" id="save-draft">
              üíæ Save Draft
            </button>
            <button class="btn btn-success" id="complete-job">
              ‚úì Complete Job
            </button>
          </div>
        </div>
        
        <!-- ==================== CONTINUE JOB PAGE ==================== -->
        <div id="page-continue" class="page-content hidden">
          <div class="card">
            <div class="card-header">
              <div class="card-title">Resume Job</div>
            </div>
            <div class="card-body">
              <div id="continue-job-content">
                <p class="text-muted">No jobs in progress</p>
              </div>
            </div>
          </div>
        </div>
        
        <!-- ==================== MEASUREMENTS PAGE ==================== -->
        <div id="page-measurements" class="page-content hidden">
          <div id="quick-measurements-form"></div>
        </div>
        
        <!-- ==================== MATERIALS PAGE ==================== -->
        <div id="page-materials" class="page-content hidden">
          <div id="material-packages-container"></div>
          <div id="custom-materials-container"></div>
        </div>
        
        <!-- ==================== PHOTOS PAGE ==================== -->
        <div id="page-photos" class="page-content hidden">
          <div id="photo-gallery-container"></div>
        </div>
        
        <!-- ==================== HISTORY PAGE ==================== -->
        <div id="page-history" class="page-content hidden">
          <div id="job-history-container"></div>
        </div>
        
        <!-- ==================== REPORTS PAGE ==================== -->
        <div id="page-reports" class="page-content hidden">
          <div id="saved-reports-container"></div>
        </div>
        
        <!-- ==================== SYNC PAGE ==================== -->
        <div id="page-sync" class="page-content hidden">
          <div class="card">
            <div class="card-header">
              <div class="card-title">Data Sync Status</div>
            </div>
            <div class="card-body">
              <div id="sync-status-content">
                <p class="text-success">‚úì All data saved locally</p>
                <p class="text-muted mt-md">Last saved: <span id="last-save-time">Never</span></p>
              </div>
              <div class="btn-group mt-lg">
                <button class="btn btn-primary" id="export-data">
                  üì§ Export All Data
                </button>
                <button class="btn btn-secondary" id="import-data">
                  üì• Import Data
                </button>
              </div>
            </div>
          </div>
        </div>
        
        <!-- ==================== SETTINGS PAGE ==================== -->
        <div id="page-settings" class="page-content hidden">
          <div class="card">
            <div class="card-header">
              <div class="card-title">Preferences</div>
            </div>
            <div class="card-body">
              
              <div class="card-section">
                <div class="section-title">Technician Info</div>
                <div class="form-grid form-grid-2">
                  <div class="form-group">
                    <label>Your Name</label>
                    <input type="text" id="tech-name" value="Mart√≠n Perez">
                  </div>
                  <div class="form-group">
                    <label>Phone</label>
                    <input type="tel" id="tech-phone" value="(346)451-0024">
                  </div>
                </div>
                <div class="form-group mt-md">
                  <label>Email</label>
                  <input type="email" id="tech-email" value="Mperez@villageplumbing.com">
                </div>
              </div>
              
              <div class="card-section">
                <div class="section-title">Default Values</div>
                <div class="form-grid form-grid-2">
                  <div class="form-group">
                    <label>Default Refrigerant</label>
                    <select id="default-refrigerant">
                      <option value="R-410A" selected>R-410A</option>
                      <option value="R-22">R-22</option>
                      <option value="R-32">R-32</option>
                      <option value="R-454B">R-454B</option>
                    </select>
                  </div>
                  <div class="form-group">
                    <label>Measurement Units</label>
                    <select id="default-units">
                      <option value="imperial" selected>Imperial (¬∞F, PSI)</option>
                      <option value="metric">Metric (¬∞C, kPa)</option>
                    </select>
                  </div>
                </div>
              </div>
              
              <div class="btn-group mt-xl">
                <button class="btn btn-success" id="save-settings">
                  ‚úì Save Preferences
                </button>
                <button class="btn btn-danger" id="clear-all-data">
                  üóëÔ∏è Clear All Data
                </button>
              </div>
              
            </div>
          </div>
        </div>
        
      </div>
      
    </main>
    
  </div>
  
  <!-- Toast Notification -->
  <div class="toast" id="toast" role="alert" aria-live="polite"></div>
  
  <script>
    // ==================== FIELD BUDDY PRO v5.0 - COMPLETE SCRIPT ====================// ==================== PART 1: STATE MANAGEMENT & UTILITIES ====================

// Global application state
const AppState = {
  tech: {
    name: 'Mart√≠n Perez',
    phone: '(346)451-0024',
    email: 'Mperez@villageplumbing.com'
  },
  currentJob: null,
  jobs: [],
  settings: {
    defaultRefrigerant: 'R-410A',
    units: 'imperial',
    autoSave: true,
    photoQuality: 'high'
  },
  ui: {
    currentPage: 'dashboard',
    sidebarOpen: false,
    unsavedChanges: false
  },
  quickMeasurements: []
};

const createNewJob = () => ({
  id: generateUUID(),
  createdAt: new Date().toISOString(),
  updatedAt: new Date().toISOString(),
  status: 'in_progress',
  customer: {
    name: '',
    address: '',
    phone: ''
  },
  issue: {
    type: '',
    description: '',
    reportedBy: 'customer'
  },
  equipment: {
    type: '',
    indoor: { brand: '', model: '', serial: '' },
    outdoor: { brand: '', model: '', serial: '' },
    tonnage: '',
    refrigerant: 'R-410A',
    filterSize: '',
    ageYears: null,
    rla: null
  },
  measurements: [],
  photos: [],
  notes: [],
  materials: [],
  suggestions: [],
  diagnosis: {
    issue: '',
    cause: '',
    workPerformed: '',
    recommendations: ''
  },
  signature: null,
  qualityScore: 0
});

const addMeasurement = (type, value, unit, label) => {
  if (!AppState.currentJob) return;
  
  const measurement = {
    id: generateUUID(),
    timestamp: new Date().toISOString(),
    type,
    field: label,
    value: parseFloat(value),
    unit,
    valid: true
  };
  
  AppState.currentJob.measurements.push(measurement);
  AppState.currentJob.updatedAt = new Date().toISOString();
  AppState.ui.unsavedChanges = true;
  
  if (AppState.settings.autoSave) {
    saveToStorage();
  }
  
  return measurement;
};

const addPhoto = (dataUrl, category = 'general') => {
  if (!AppState.currentJob) return;
  
  const photo = {
    id: generateUUID(),
    timestamp: new Date().toISOString(),
    data: dataUrl,
    category,
    caption: ''
  };
  
  AppState.currentJob.photos.push(photo);
  AppState.currentJob.updatedAt = new Date().toISOString();
  AppState.ui.unsavedChanges = true;
  
  if (AppState.settings.autoSave) {
    saveToStorage();
  }
  
  return photo;
};

const updateJobStatus = (status) => {
  if (!AppState.currentJob) return;
  
  AppState.currentJob.status = status;
  AppState.currentJob.updatedAt = new Date().toISOString();
  
  if (status === 'completed') {
    AppState.currentJob.completedAt = new Date().toISOString();
    calculateQualityScore();
  }
  
  saveToStorage();
};

const calculateQualityScore = () => {
  if (!AppState.currentJob) return 0;
  
  let score = 0;
  const job = AppState.currentJob;
  
  if (job.customer.name) score += 7;
  if (job.customer.address) score += 7;
  if (job.customer.phone) score += 6;
  if (job.equipment.type) score += 5;
  if (job.equipment.indoor.brand) score += 5;
  if (job.equipment.indoor.model) score += 5;
  if (job.measurements.length >= 3) score += 10;
  if (job.measurements.length >= 6) score += 10;
  if (job.measurements.length >= 10) score += 5;
  if (job.photos.length >= 1) score += 5;
  if (job.photos.length >= 3) score += 5;
  if (job.photos.length >= 5) score += 5;
  if (job.diagnosis.issue) score += 5;
  if (job.diagnosis.cause) score += 5;
  if (job.diagnosis.workPerformed) score += 5;
  if (job.signature) score += 10;
  
  job.qualityScore = Math.min(score, 100);
  return job.qualityScore;
};

const getLastMeasurement = (type) => {
  if (!AppState.currentJob) return null;
  
  const measurements = AppState.currentJob.measurements
    .filter(m => m.type === type)
    .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
  
  return measurements[0] || null;
};

const getMeasurementsByType = (type) => {
  if (!AppState.currentJob) return [];
  
  return AppState.currentJob.measurements
    .filter(m => m.type === type)
    .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
};

// ==================== UTILITY FUNCTIONS ====================

const generateUUID = () => {
  return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
    const r = Math.random() * 16 | 0;
    const v = c === 'x' ? r : (r & 0x3 | 0x8);
    return v.toString(16);
  });
};

const formatDateTime = (isoString) => {
  const date = new Date(isoString);
  return date.toLocaleString('en-US', {
    month: 'short',
    day: 'numeric',
    year: 'numeric',
    hour: 'numeric',
    minute: '2-digit',
    hour12: true
  });
};

const formatDate = (isoString) => {
  const date = new Date(isoString);
  return date.toLocaleDateString('en-US', {
    month: 'short',
    day: 'numeric',
    year: 'numeric'
  });
};

const showToast = (message, type = 'success') => {
  const toast = document.getElementById('toast');
  toast.textContent = message;
  toast.className = `toast show ${type}`;
  
  setTimeout(() => {
    toast.classList.remove('show');
  }, 3000);
};

const $ = (id) => document.getElementById(id);
const $$ = (selector) => document.querySelectorAll(selector);

const debounce = (func, wait) => {
  let timeout;
  return function executedFunction(...args) {
    const later = () => {
      clearTimeout(timeout);
      func(...args);
    };
    clearTimeout(timeout);
    timeout = setTimeout(later, wait);
  };
};

const isValidNumber = (value) => {
  return !isNaN(parseFloat(value)) && isFinite(value);
};

const clamp = (num, min, max) => {
  return Math.min(Math.max(num, min), max);
};

const formatTemp = (value, unit = 'F') => {
  if (!isValidNumber(value)) return 'N/A';
  return `${parseFloat(value).toFixed(1)}¬∞${unit}`;
};

const formatPressure = (value, unit = 'PSI') => {
  if (!isValidNumber(value)) return 'N/A';
  return `${parseFloat(value).toFixed(1)} ${unit}`;
};

const formatVoltage = (value) => {
  if (!isValidNumber(value)) return 'N/A';
  return `${parseFloat(value).toFixed(1)}V`;
};

const formatAmperage = (value) => {
  if (!isValidNumber(value)) return 'N/A';
  return `${parseFloat(value).toFixed(1)}A`;
};

const getRelativeTime = (isoString) => {
  const date = new Date(isoString);
  const now = new Date();
  const diffMs = now - date;
  const diffMins = Math.floor(diffMs / 60000);
  const diffHours = Math.floor(diffMs / 3600000);
  const diffDays = Math.floor(diffMs / 86400000);
  
  if (diffMins < 1) return 'Just now';
  if (diffMins < 60) return `${diffMins} min ago`;
  if (diffHours < 24) return `${diffHours} hour${diffHours > 1 ? 's' : ''} ago`;
  if (diffDays < 7) return `${diffDays} day${diffDays > 1 ? 's' : ''} ago`;
  return formatDate(isoString);
};

const compressImage = (dataUrl, maxWidth = 1200, quality = 0.8) => {
  return new Promise((resolve) => {
    const img = new Image();
    img.onload = () => {
      const canvas = document.createElement('canvas');
      let width = img.width;
      let height = img.height;
      
      if (width > maxWidth) {
        height = (height * maxWidth) / width;
        width = maxWidth;
      }
      
      canvas.width = width;
      canvas.height = height;
      
      const ctx = canvas.getContext('2d');
      ctx.drawImage(img, 0, 0, width, height);
      
      resolve(canvas.toDataURL('image/jpeg', quality));
    };
    img.src = dataUrl;
  });
};

const exportJSON = (data, filename) => {
  const json = JSON.stringify(data, null, 2);
  const blob = new Blob([json], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const link = document.createElement('a');
  link.href = url;
  link.download = filename;
  link.click();
  URL.revokeObjectURL(url);
};

const copyToClipboard = (text) => {
  if (navigator.clipboard) {
    navigator.clipboard.writeText(text).then(() => {
      showToast('Copied to clipboard!');
    }).catch(() => {
      showToast('Failed to copy', 'error');
    });
  } else {
    const textarea = document.createElement('textarea');
    textarea.value = text;
    document.body.appendChild(textarea);
    textarea.select();
    document.execCommand('copy');
    document.body.removeChild(textarea);
    showToast('Copied to clipboard!');
  }
};

// ==================== PART 2: NAVIGATION SYSTEM ====================

const switchPage = (pageName) => {
  $$('.page-content').forEach(page => {
    page.classList.add('hidden');
  });
  
  const targetPage = $(`page-${pageName}`);
  if (targetPage) {
    targetPage.classList.remove('hidden');
  }
  
  $$('.nav-item').forEach(item => {
    item.classList.remove('active');
  });
  
  const activeNavItem = document.querySelector(`.nav-item[data-page="${pageName}"]`);
  if (activeNavItem) {
    activeNavItem.classList.add('active');
  }
  
  const titleMap = {
    'dashboard': 'Dashboard',
    'new-job': 'New Service Call',
    'continue': 'Continue Job',
    'measurements': 'Quick Measurements',
    'materials': 'Materials & Parts',
    'photos': 'Photo Gallery',
    'history': 'Job History',
    'reports': 'Saved Reports',
    'sync': 'Data Sync',
    'settings': 'Settings'
  };
  
  const pageTitle = $('page-title');
  if (pageTitle) {
    pageTitle.textContent = titleMap[pageName] || 'Field Buddy Pro';
  }
  
  AppState.ui.currentPage = pageName;
  closeMobileMenu();
  onPageLoad(pageName);
};

const onPageLoad = (pageName) => {
  switch(pageName) {
    case 'dashboard':
      renderRecentJobs();
      renderQuickStats();
      break;
    case 'new-job':
      if (!AppState.currentJob) {
        AppState.currentJob = createNewJob();
      }
      renderCustomerInfo();
      renderIssueTypeSelector();
      break;
    case 'continue':
      renderContinueJob();
      break;
    case 'measurements':
      renderQuickMeasurementsForm();
      break;
    case 'materials':
      renderMaterialPackages();
      break;
    case 'photos':
      renderPhotoGallery();
      break;
    case 'history':
      renderJobHistory();
      break;
    case 'reports':
      renderSavedReports();
      break;
  }
};

const toggleMobileMenu = () => {
  const sidebar = $('sidebar');
  
  if (sidebar.classList.contains('open')) {
    closeMobileMenu();
  } else {
    openMobileMenu();
  }
};

const openMobileMenu = () => {
  const sidebar = $('sidebar');
  const main = $('main');
  
  sidebar.classList.remove('collapsed');
  sidebar.classList.add('open');
  main.classList.add('full-width');
  AppState.ui.sidebarOpen = true;
};

const closeMobileMenu = () => {
  const sidebar = $('sidebar');
  const main = $('main');
  
  if (window.innerWidth <= 1024) {
    sidebar.classList.add('collapsed');
    sidebar.classList.remove('open');
  }
  
  AppState.ui.sidebarOpen = false;
};

window.addEventListener('popstate', (e) => {
  const page = e.state?.page || 'dashboard';
  switchPage(page);
});

const handleQuickAction = (action) => {
  switch(action) {
    case 'new-job':
      AppState.currentJob = createNewJob();
      switchPage('new-job');
      showToast('New job started');
      break;
      
    case 'continue':
      const lastJob = AppState.jobs
        .filter(j => j.status === 'in_progress')
        .sort((a, b) => new Date(b.updatedAt) - new Date(a.updatedAt))[0];
      
      if (lastJob) {
        AppState.currentJob = lastJob;
        switchPage('new-job');
        showToast('Resuming job');
      } else {
        switchPage('continue');
        showToast('No jobs in progress', 'warning');
      }
      break;
      
    case 'quick-measure':
      switchPage('measurements');
      break;
  }
};

// ==================== PART 3: OFFLINE STORAGE ====================

const DB_NAME = 'FieldBuddyPro';
const DB_VERSION = 1;
let db = null;

const initDB = () => {
  return new Promise((resolve, reject) => {
    const request = indexedDB.open(DB_NAME, DB_VERSION);
    
    request.onerror = () => {
      console.error('IndexedDB error:', request.error);
      reject(request.error);
    };
    
    request.onsuccess = () => {
      db = request.result;
      console.log('IndexedDB initialized');
      resolve(db);
    };
    
    request.onupgradeneeded = (event) => {
      db = event.target.result;
      
      if (!db.objectStoreNames.contains('jobs')) {
        const jobsStore = db.createObjectStore('jobs', { keyPath: 'id' });
        jobsStore.createIndex('status', 'status', { unique: false });
        jobsStore.createIndex('createdAt', 'createdAt', { unique: false });
        jobsStore.createIndex('updatedAt', 'updatedAt', { unique: false });
      }
      
      if (!db.objectStoreNames.contains('settings')) {
        db.createObjectStore('settings', { keyPath: 'key' });
      }
      
      if (!db.objectStoreNames.contains('photos')) {
        const photosStore = db.createObjectStore('photos', { keyPath: 'id' });
        photosStore.createIndex('jobId', 'jobId', { unique: false });
      }
      
      console.log('IndexedDB schema created');
    };
  });
};

const saveToStorage = debounce(() => {
  if (!db) {
    console.warn('Database not initialized');
    return;
  }
  
  const transaction = db.transaction(['jobs', 'settings'], 'readwrite');
  
  if (AppState.currentJob) {
    const jobsStore = transaction.objectStore('jobs');
    
    const existingJobIndex = AppState.jobs.findIndex(j => j.id === AppState.currentJob.id);
    
    if (existingJobIndex >= 0) {
      AppState.jobs[existingJobIndex] = AppState.currentJob;
    } else {
      AppState.jobs.push(AppState.currentJob);
    }
    
    jobsStore.put(AppState.currentJob);
  }
  
  const settingsStore = transaction.objectStore('settings');
  settingsStore.put({ key: 'appSettings', value: AppState.settings });
  settingsStore.put({ key: 'techInfo', value: AppState.tech });
  
  transaction.oncomplete = () => {
    AppState.ui.unsavedChanges = false;
    updateSyncStatus();
    console.log('Data saved to IndexedDB');
  };
  
  transaction.onerror = () => {
    console.error('Save failed:', transaction.error);
    showToast('Failed to save data', 'error');
  };
}, 500);

const loadFromStorage = async () => {
  if (!db) {
    await initDB();
  }
  
  return new Promise((resolve, reject) => {
    const transaction = db.transaction(['jobs', 'settings'], 'readonly');
    
    const jobsStore = transaction.objectStore('jobs');
    const jobsRequest = jobsStore.getAll();
    
    jobsRequest.onsuccess = () => {
      AppState.jobs = jobsRequest.result || [];
      console.log(`Loaded ${AppState.jobs.length} jobs`);
    };
    
    const settingsStore = transaction.objectStore('settings');
    
    const settingsRequest = settingsStore.get('appSettings');
    settingsRequest.onsuccess = () => {
      if (settingsRequest.result) {
        AppState.settings = { ...AppState.settings, ...settingsRequest.result.value };
      }
    };
    
    const techRequest = settingsStore.get('techInfo');
    techRequest.onsuccess = () => {
      if (techRequest.result) {
        AppState.tech = { ...AppState.tech, ...techRequest.result.value };
      }
    };
    
    transaction.oncomplete = () => {
      console.log('Data loaded from IndexedDB');
      resolve();
    };
    
    transaction.onerror = () => {
      console.error('Load failed:', transaction.error);
      reject(transaction.error);
    };
  });
};

const deleteJob = (jobId) => {
  return new Promise((resolve, reject) => {
    const transaction = db.transaction(['jobs'], 'readwrite');
    const jobsStore = transaction.objectStore('jobs');
    const request = jobsStore.delete(jobId);
    
    request.onsuccess = () => {
      AppState.jobs = AppState.jobs.filter(j => j.id !== jobId);
      
      if (AppState.currentJob?.id === jobId) {
        AppState.currentJob = null;
      }
      
      showToast('Job deleted');
      resolve();
    };
    
    request.onerror = () => {
      showToast('Failed to delete job', 'error');
      reject(request.error);
    };
  });
};

const exportAllData = () => {
  const exportData = {
    version: '5.0',
    exportedAt: new Date().toISOString(),
    tech: AppState.tech,
    jobs: AppState.jobs,
    settings: AppState.settings
  };
  
  const filename = `field-buddy-backup-${new Date().toISOString().split('T')[0]}.json`;
  exportJSON(exportData, filename);
  showToast('Data exported successfully');
};

const importData = (file) => {
  const reader = new FileReader();
  
  reader.onload = async (e) => {
    try {
      const importedData = JSON.parse(e.target.result);
      
      if (!importedData.jobs || !Array.isArray(importedData.jobs)) {
        throw new Error('Invalid data format');
      }
      
      importedData.jobs.forEach(importedJob => {
        const existingIndex = AppState.jobs.findIndex(j => j.id === importedJob.id);
        
        if (existingIndex >= 0) {
          if (new Date(importedJob.updatedAt) > new Date(AppState.jobs[existingIndex].updatedAt)) {
            AppState.jobs[existingIndex] = importedJob;
          }
        } else {
          AppState.jobs.push(importedJob);
        }
      });
      
      if (importedData.settings) {
        AppState.settings = { ...AppState.settings, ...importedData.settings };
      }
      
      if (importedData.tech) {
        AppState.tech = { ...AppState.tech, ...importedData.tech };
      }
      
      await saveAllJobs();
      
      showToast(`Imported ${importedData.jobs.length} jobs`);
      renderJobHistory();
      
    } catch (error) {
      console.error('Import error:', error);
      showToast('Failed to import data', 'error');
    }
  };
  
  reader.readAsText(file);
};

const saveAllJobs = () => {
  return new Promise((resolve, reject) => {
    const transaction = db.transaction(['jobs', 'settings'], 'readwrite');
    const jobsStore = transaction.objectStore('jobs');
    const settingsStore = transaction.objectStore('settings');
    
    jobsStore.clear();
    
    AppState.jobs.forEach(job => {
      jobsStore.add(job);
    });
    
    settingsStore.put({ key: 'appSettings', value: AppState.settings });
    settingsStore.put({ key: 'techInfo', value: AppState.tech });
    
    transaction.oncomplete = () => {
      console.log('All jobs saved');
      resolve();
    };
    
    transaction.onerror = () => {
      console.error('Save all failed:', transaction.error);
      reject(transaction.error);
    };
  });
};

const updateSyncStatus = () => {
  const syncBtn = $('sync-status');
  const lastSaveTime = $('last-save-time');
  
  if (syncBtn) {
    if (AppState.ui.unsavedChanges) {
      syncBtn.textContent = '‚è≥';
      syncBtn.title = 'Saving...';
    } else {
      syncBtn.textContent = '‚úì';
      syncBtn.title = 'All data saved';
    }
  }
  
  if (lastSaveTime) {
    lastSaveTime.textContent = formatDateTime(new Date().toISOString());
  }
};

const clearAllData = async () => {
  const confirmed = confirm('‚ö†Ô∏è This will delete ALL jobs and data. Are you sure?');
  
  if (!confirmed) return;
  
  const doubleConfirm = confirm('This cannot be undone. Really delete everything?');
  
  if (!doubleConfirm) return;
  
  try {
    const transaction = db.transaction(['jobs', 'settings', 'photos'], 'readwrite');
    
    transaction.objectStore('jobs').clear();
    transaction.objectStore('settings').clear();
    transaction.objectStore('photos').clear();
    
    transaction.oncomplete = () => {
      AppState.jobs = [];
      AppState.currentJob = null;
      showToast('All data cleared');
      switchPage('dashboard');
    };
    
    transaction.onerror = () => {
      showToast('Failed to clear data', 'error');
    };
  } catch (error) {
    console.error('Clear data error:', error);
    showToast('Failed to clear data', 'error');
  }
};

// ==================== PART 4: CUSTOMER INFO ====================

const renderCustomerInfo = () => {
  const container = $('issue-type-container');
  if (!container) return;
  
  const job = AppState.currentJob;
  if (!job) return;
  
  let html = `
    <div class="card">
      <div class="card-header">
        <div class="card-title">Customer Information</div>
      </div>
      <div class="card-body">
        <div class="form-grid form-grid-2">
          <div class="form-group">
            <label>Customer Name</label>
            <input 
              type="text" 
              id="customer-name"
              value="${job.customer.name || ''}"
              oninput="updateCustomerField('name', this.value)"
              placeholder="Enter customer name">
          </div>
          
          <div class="form-group">
            <label>Phone Number</label>
            <input 
              type="tel" 
              id="customer-phone"
              value="${job.customer.phone || ''}"
              oninput="updateCustomerField('phone', this.value)"
              placeholder="(555) 123-4567">
          </div>
        </div>
        
        <div class="form-group mt-md">
          <label>Service Address</label>
          <input 
            type="text" 
            id="customer-address"
            value="${job.customer.address || ''}"
            oninput="updateCustomerField('address', this.value)"
            placeholder="Enter service address">
        </div>
      </div>
    </div>
  `;
  
  container.innerHTML = html + (container.innerHTML || '');
};

const updateCustomerField = (field, value) => {
  if (!AppState.currentJob) return;
  
  AppState.currentJob.customer[field] = value;
  AppState.currentJob.updatedAt = new Date().toISOString();
  AppState.ui.unsavedChanges = true;
  
  saveToStorage();
};onchange="handleMeasurementInput('${field.id}', this.value, '${field.unit}', '${field.label}', ${field.min}, ${field.max})"
              placeholder="Enter ${field.unit}">
            ${lastValue ? `<span style="position: absolute; right: 12px; top: 50%; transform: translateY(-50%); color: var(--text-tertiary); font-size: 0.75rem;">${field.unit}</span>` : ''}
          </div>
        </div>
      `;
    });
    
    html += `
        </div>
      </div>
    `;
  }
  
  html += `
      <div class="card-section">
        <div class="section-title">Calculated Values</div>
        <div class="form-grid form-grid-3" id="calculated-values">
          <!-- Auto-populated by diagnostic engine -->
        </div>
      </div>
      
      </div>
    </div>
  `;
  
  container.innerHTML = html;
  
  if (AppState.currentJob?.measurements.length > 0) {
    runDiagnosticEngine();
  }
};

const handleMeasurementInput = (fieldId, value, unit, label, min, max) => {
  if (!value || value === '') return;
  
  const numValue = parseFloat(value);
  
  const input = $(fieldId);
  if (numValue < min || numValue > max) {
    input.classList.add('warning');
    showToast(`${label} seems unusual (expected ${min}-${max} ${unit})`, 'warning');
  } else {
    input.classList.remove('warning');
    input.classList.add('success');
  }
  
  addMeasurement('measurement', numValue, unit, label);
  runDiagnosticEngine();
  renderSmartSuggestions();
};

const getLastMeasurementValue = (fieldId) => {
  if (!AppState.currentJob) return null;
  
  const measurements = AppState.currentJob.measurements
    .filter(m => m.field.toLowerCase().includes(fieldId.replace(/-/g, ' ')))
    .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
  
  return measurements[0]?.value || null;
};

const clearAllMeasurements = () => {
  if (!AppState.currentJob) return;
  
  const confirmed = confirm('Clear all measurements?');
  if (!confirmed) return;
  
  AppState.currentJob.measurements = [];
  AppState.currentJob.updatedAt = new Date().toISOString();
  
  saveToStorage();
  renderMeasurementsSection();
  renderSmartSuggestions();
  
  showToast('Measurements cleared');
};

const renderQuickMeasurementsForm = () => {
  const container = $('quick-measurements-form');
  if (!container) return;
  
  let html = `
    <div class="card">
      <div class="card-header">
        <div class="card-title">Quick Entry</div>
      </div>
      <div class="card-body">
        <p class="text-muted mb-lg">Record measurements without creating a full job</p>
        
        <div class="form-group">
          <label>Measurement Type</label>
          <select id="quick-meas-type">
            <option value="">Select type...</option>
            <option value="temp">Temperature</option>
            <option value="pressure">Pressure</option>
            <option value="voltage">Voltage</option>
            <option value="amperage">Amperage</option>
          </select>
        </div>
        
        <div class="form-group">
          <label>Value</label>
          <input type="number" step="0.1" id="quick-meas-value" placeholder="Enter value">
        </div>
        
        <div class="form-group">
          <label>Notes (Optional)</label>
          <textarea id="quick-meas-notes" rows="2" placeholder="Additional context..."></textarea>
        </div>
        
        <button class="btn btn-primary" onclick="saveQuickMeasurement()">
          ‚úì Save Measurement
        </button>
      </div>
    </div>
  `;
  
  container.innerHTML = html;
};

const saveQuickMeasurement = () => {
  const type = $('quick-meas-type')?.value;
  const value = $('quick-meas-value')?.value;
  const notes = $('quick-meas-notes')?.value;
  
  if (!type || !value) {
    showToast('Please fill in type and value', 'warning');
    return;
  }
  
  const measurement = {
    id: generateUUID(),
    timestamp: new Date().toISOString(),
    type,
    value: parseFloat(value),
    notes
  };
  
  if (!AppState.quickMeasurements) {
    AppState.quickMeasurements = [];
  }
  
  AppState.quickMeasurements.push(measurement);
  
  $('quick-meas-type').value = '';
  $('quick-meas-value').value = '';
  $('quick-meas-notes').value = '';
  
  showToast('Measurement saved');
  saveToStorage();
};

// ==================== PART 8: DIAGNOSTIC ENGINE ====================

const R410A_PT = {
  118: 40, 125: 45, 133: 50, 140: 55, 148: 60,
  156: 65, 164: 70, 173: 75, 181: 80, 190: 85,
  200: 90, 210: 95, 220: 100, 230: 105, 241: 110,
  252: 115, 263: 120, 275: 125, 287: 130, 299: 135,
  312: 140, 325: 145, 338: 150
};

const getSaturationTemp = (pressure) => {
  const pressures = Object.keys(R410A_PT).map(Number);
  const closest = pressures.reduce((prev, curr) => 
    Math.abs(curr - pressure) < Math.abs(prev - pressure) ? curr : prev
  );
  return R410A_PT[closest];
};

const diagnosticRules = {
  undercharged: {
    conditions: (data) => {
      return data.superheat > 15 && data.subcool < 8;
    },
    diagnosis: 'System Undercharged - Refrigerant Leak Likely',
    confidence: 'high',
    evidence: ['High superheat', 'Low subcool', 'Reduced cooling capacity'],
    nextSteps: [
      'Perform leak check on evaporator coil',
      'Check all brazed joints and fittings',
      'Inspect line set connections',
      'Check service valve cores',
      'After leak repair, evacuate and recharge by weight'
    ],
    partsLikely: ['R-410A refrigerant', 'Filter drier', 'Leak seal'],
    safetyNotes: []
  },
  
  overcharged: {
    conditions: (data) => {
      return data.subcool > 15 && data.headPressure > 350;
    },
    diagnosis: 'System Overcharged',
    confidence: 'high',
    evidence: ['High subcool', 'Elevated head pressure', 'High amp draw'],
    nextSteps: [
      'Verify charge was not added incorrectly',
      'Check for non-condensables in system',
      'Recover excess refrigerant',
      'Recharge to manufacturer specifications'
    ],
    partsLikely: [],
    safetyNotes: ['High pressures - risk of compressor damage']
  },
  
  txv_restricted: {
    conditions: (data) => {
      return data.superheat > 20 && data.subcool >= 8 && data.subcool <= 12;
    },
    diagnosis: 'TXV Restricted or Sensing Bulb Issue',
    confidence: 'high',
    evidence: ['Very high superheat', 'Normal subcool', 'Low suction pressure'],
    nextSteps: [
      'Check TXV sensing bulb placement and contact',
      'Verify bulb insulation is intact',
      'Check for kinked liquid line before TXV',
      'Inspect filter drier for restriction',
      'Consider TXV replacement'
    ],
    partsLikely: ['TXV valve', 'Sensing bulb', 'Filter drier'],
    safetyNotes: []
  },
  
  low_airflow: {
    conditions: (data) => {
      return data.deltaT > 24 || data.staticPressure > 0.6;
    },
    diagnosis: 'Restricted Airflow - Low CFM',
    confidence: 'high',
    evidence: ['High temperature split', 'Elevated static pressure', 'Possible frozen coil'],
    nextSteps: [
      'CRITICAL: Replace air filter immediately',
      'Inspect evaporator coil for dirt/restrictions',
      'Check blower speed and motor',
      'Verify ductwork is properly sized',
      'Measure total external static pressure',
      'Check for closed/blocked supply vents'
    ],
    partsLikely: ['Air filter', 'Blower motor', 'Capacitor'],
    safetyNotes: ['Risk of frozen evaporator coil']
  },
  
  excessive_airflow: {
    conditions: (data) => {
      return data.deltaT < 14;
    },
    diagnosis: 'Excessive Airflow or Low Refrigerant',
    confidence: 'medium',
    evidence: ['Low temperature split', 'Reduced dehumidification'],
    nextSteps: [
      'Check blower speed setting',
      'Verify ductwork design CFM',
      'Check for refrigerant undercharge',
      'Measure actual CFM at registers'
    ],
    partsLikely: [],
    safetyNotes: []
  },
  
  dirty_condenser: {
    conditions: (data) => {
      return data.headPressure > 350 && data.outdoorAmbient < 95;
    },
    diagnosis: 'Restricted Condenser Airflow - Dirty Coil',
    confidence: 'high',
    evidence: ['High head pressure', 'Normal outdoor temp', 'High amp draw'],
    nextSteps: [
      'Clean condenser coil thoroughly',
      'Check condenser fan operation',
      'Verify condenser fan motor amps',
      'Inspect for debris or obstructions',
      'Check fin condition'
    ],
    partsLikely: ['Coil cleaner', 'Condenser fan motor', 'Fan blade'],
    safetyNotes: ['High head pressure - monitor compressor']
  },
  
  low_voltage: {
    conditions: (data) => {
      return data.voltage < 207 || data.voltage > 253;
    },
    diagnosis: 'Supply Voltage Out of Range',
    confidence: 'high',
    evidence: ['Voltage outside ¬±10% of rated', 'Possible compressor damage'],
    nextSteps: [
      'Check voltage at disconnect',
      'Inspect wire connections for looseness',
      'Contact utility company if persistently low',
      'Consider voltage stabilizer'
    ],
    partsLikely: ['Voltage regulator/stabilizer'],
    safetyNotes: ['Low voltage can damage compressor']
  },
  
  high_amp_draw: {
    conditions: (data) => {
      return data.rla && data.compressorAmps > (data.rla * 1.1);
    },
    diagnosis: 'Compressor Drawing Excessive Current',
    confidence: 'high',
    evidence: ['Amps exceed RLA by >10%', 'Possible failing compressor'],
    nextSteps: [
      'Check supply voltage (low voltage increases amps)',
      'Verify capacitor is within spec',
      'Check for refrigerant overcharge',
      'Inspect for restricted airflow',
      'Monitor compressor temperature'
    ],
    partsLikely: ['Run capacitor', 'Compressor'],
    safetyNotes: ['High amps - compressor may fail soon']
  },
  
  low_temp_rise: {
    conditions: (data) => {
      return data.tempRise && data.tempRise < 35;
    },
    diagnosis: 'Low Temperature Rise - Insufficient Heating',
    confidence: 'high',
    evidence: ['Temp rise below 35¬∞F', 'Reduced heating output'],
    nextSteps: [
      'Check gas manifold pressure (3.3-3.8" w.c.)',
      'Inspect burners for proper flame pattern',
      'Verify all burners are igniting',
      'Check for excessive airflow (blower too fast)',
      'Inspect gas valve operation'
    ],
    partsLikely: ['Gas valve', 'Orifices', 'Igniter'],
    safetyNotes: []
  },
  
  high_temp_rise: {
    conditions: (data) => {
      return data.tempRise && data.tempRise > 70;
    },
    diagnosis: 'High Temperature Rise - Airflow Restriction',
    confidence: 'high',
    evidence: ['Temp rise above 70¬∞F', 'Risk of heat exchanger damage'],
    nextSteps: [
      'CRITICAL: Check airflow restriction immediately',
      'Replace air filter',
      'Verify blower speed is correct',
      'Inspect heat exchanger for restrictions',
      'Check limit switches for cycling'
    ],
    partsLikely: ['Air filter', 'Blower motor', 'Limit switch'],
    safetyNotes: ['CRITICAL: High temp rise can crack heat exchanger']
  }
};

const runDiagnosticEngine = () => {
  if (!AppState.currentJob) return;
  
  const measurements = AppState.currentJob.measurements;
  if (measurements.length === 0) return;
  
  const data = {
    outdoorAmbient: getLastMeasurementValue('outdoor-ambient'),
    returnAir: getLastMeasurementValue('return-air'),
    supplyAir: getLastMeasurementValue('supply-air'),
    suctionPressure: getLastMeasurementValue('suction-pressure'),
    suctionTemp: getLastMeasurementValue('suction-line'),
    headPressure: getLastMeasurementValue('head-pressure'),
    liquidTemp: getLastMeasurementValue('liquid-line'),
    voltage: getLastMeasurementValue('voltage'),
    compressorAmps: getLastMeasurementValue('compressor-amps'),
    staticPressure: getLastMeasurementValue('static-pressure'),
    rla: AppState.currentJob.equipment.rla,
    tempRise: null,
    deltaT: null,
    superheat: null,
    subcool: null
  };
  
  if (data.returnAir && data.supplyAir) {
    data.deltaT = data.returnAir - data.supplyAir;
  }
  
  if (data.suctionPressure && data.suctionTemp) {
    const satTemp = getSaturationTemp(data.suctionPressure);
    data.superheat = data.suctionTemp - satTemp;
  }
  
  if (data.headPressure && data.liquidTemp) {
    const satTemp = getSaturationTemp(data.headPressure);
    data.subcool = satTemp - data.liquidTemp;
  }
  
  const returnHeat = getLastMeasurementValue('return-air-heat');
  const supplyHeat = getLastMeasurementValue('supply-air-heat');
  if (returnHeat && supplyHeat) {
    data.tempRise = supplyHeat - returnHeat;
  }
  
  updateCalculatedValues(data);
  
  const suggestions = [];
  
  Object.keys(diagnosticRules).forEach(ruleKey => {
    const rule = diagnosticRules[ruleKey];
    
    if (rule.conditions(data)) {
      suggestions.push({
        id: ruleKey,
        ...rule,
        timestamp: new Date().toISOString()
      });
    }
  });
  
  AppState.currentJob.suggestions = suggestions;
  renderSmartSuggestions();
};

const updateCalculatedValues = (data) => {
  const container = $('calculated-values');
  if (!container) return;
  
  let html = '';
  
  if (data.deltaT !== null) {
    const deltaClass = data.deltaT >= 16 && data.deltaT <= 22 ? 'success' : 'warning';
    html += `
      <div class="form-group">
        <label>Delta-T (Return - Supply)</label>
        <input type="text" class="${deltaClass}" readonly value="${data.deltaT.toFixed(1)}¬∞F">
      </div>
    `;
  }
  
  if (data.superheat !== null) {
    const shClass = data.superheat >= 8 && data.superheat <= 15 ? 'success' : 'warning';
    html += `
      <div class="form-group">
        <label>Superheat</label>
        <input type="text" class="${shClass}" readonly value="${data.superheat.toFixed(1)}¬∞F">
      </div>
    `;
  }
  
  if (data.subcool !== null) {
    const scClass = data.subcool >= 8 && data.subcool <= 12 ? 'success' : 'warning';
    html += `
      <div class="form-group">
        <label>Subcool</label>
        <input type="text" class="${scClass}" readonly value="${data.subcool.toFixed(1)}¬∞F">
      </div>
    `;
  }
  
  if (data.tempRise !== null) {
    const trClass = data.tempRise >= 35 && data.tempRise <= 65 ? 'success' : 'warning';
    html += `
      <div class="form-group">
        <label>Temperature Rise</label>
        <input type="text" class="${trClass}" readonly value="${data.tempRise.toFixed(1)}¬∞F">
      </div>
    `;
  }
  
  if (html === '') {
    html = '<p class="text-muted">Enter measurements to see calculated values</p>';
  }
  
  container.innerHTML = html;
};

const renderSmartSuggestions = () => {
  const container = $('suggestions-container');
  if (!container) return;
  
  const suggestions = AppState.currentJob?.suggestions || [];
  
  if (suggestions.length === 0) {
    container.innerHTML = '';
    return;
  }
  
  let html = `
    <div class="card" style="border: 2px solid var(--cyan); background: rgba(0, 217, 255, 0.05);">
      <div class="card-header" style="background: rgba(0, 217, 255, 0.1);">
        <div class="card-title">üí° Smart Diagnostic Suggestions</div>
      </div>
      <div class="card-body">
  `;
  
  suggestions.forEach(suggestion => {
    const confidenceColor = suggestion.confidence === 'high' ? 'var(--success)' : 'var(--warning)';
    
    html += `
      <div style="background: var(--bg-elevated); border: 1px solid var(--glass-border); border-radius: var(--radius-lg); padding: var(--space-xl); margin-bottom: var(--space-lg);">
        
        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: var(--space-md);">
          <h3 style="font-size: 1.125rem; font-weight: 700; color: var(--text-primary); margin: 0;">
            ${suggestion.diagnosis}
          </h3>
          <span style="padding: 4px 12px; background: ${confidenceColor}; color: white; border-radius: 20px; font-size: 0.6875rem; font-weight: 700; text-transform: uppercase;">
            ${suggestion.confidence} confidence
          </span>
        </div>
        
        ${suggestion.safetyNotes.length > 0 ? `
          <div style="background: rgba(239, 68, 68, 0.1); border-left: 4px solid var(--danger); padding: var(--space-md); margin-bottom: var(--space-md); border-radius: var(--radius);">
            <strong style="color: var(--danger);">‚ö†Ô∏è Safety Alert:</strong>
            <ul style="margin: var(--space-sm) 0 0 var(--space-lg); color: var(--text-secondary);">
              ${suggestion.safetyNotes.map(note => `<li>${note}</li>`).join('')}
            </ul>
          </div>
        ` : ''}
        
        <div style="margin-bottom: var(--space-md);">
          <strong style="color: var(--cyan); font-size: 0.875rem;">Evidence:</strong>
          <ul style="margin: var(--space-sm) 0 0 var(--space-lg); color: var(--text-secondary); font-size: 0.875rem;">
            ${suggestion.evidence.map(item => `<li>${item}</li>`).join('')}
          </ul>
        </div>
        
        <div style="margin-bottom: var(--space-md);">
          <strong style="color: var(--cyan); font-size: 0.875rem;">Next Steps:</strong>
          <ol style="margin: var(--space-sm) 0 0 var(--space-lg); color: var(--text-secondary); font-size: 0.875rem;">
            ${suggestion.nextSteps.map(step => `<li style="margin: var(--space-sm) 0;">${step}</li>`).join('')}
          </ol>
        </div>
        
        ${suggestion.partsLikely.length > 0 ? `
          <div>
            <strong style="color: var(--cyan); font-size: 0.875rem;">Parts Likely Needed:</strong>
            <div style="display: flex; gap: var(--space-sm); flex-wrap: wrap; margin-top: var(--space-sm);">
              ${suggestion.partsLikely.map(part => `
                <span style="background: var(--bg-tertiary); padding: 4px 12px; border-radius: 20px; font-size: 0.75rem; color: var(--text-secondary);">
                  ${part}
                </span>
              `).join('')}
            </div>
          </div>
        ` : ''}
        
      </div>
    `;
  });
  
  html += `
      </div>
    </div>
  `;
  
  container.innerHTML = html;
};const renderPhotoGallery = () => {
  const container = $('photos-notes-container');
  if (!container) return;
  
  const job = AppState.currentJob;
  
  let html = `
    <div class="card">
      <div class="card-header">
        <div class="card-title">üì∑ Photos & Documentation</div>
        <button class="btn btn-primary btn-sm" onclick="triggerPhotoCapture()">
          + Add Photo
        </button>
      </div>
      <div class="card-body">
  `;
  
  if (job && job.photos.length > 0) {
    html += `
      <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: var(--space-lg);">
    `;
    
    job.photos.forEach((photo, index) => {
      html += `
        <div style="position: relative; border: 1px solid var(--glass-border); border-radius: var(--radius-lg); overflow: hidden;">
          <img 
            src="${photo.data}" 
            alt="Job photo ${index + 1}"
            style="width: 100%; height: 200px; object-fit: cover; cursor: pointer;"
            onclick="viewPhotoFullscreen('${photo.id}')">
          <div style="padding: var(--space-sm); background: var(--bg-elevated);">
            <div style="font-size: 0.75rem; color: var(--text-tertiary);">
              ${formatDateTime(photo.timestamp)}
            </div>
            <div style="display: flex; gap: var(--space-xs); margin-top: var(--space-xs);">
              <button 
                class="btn btn-secondary btn-sm" 
                onclick="deletePhoto('${photo.id}')"
                style="flex: 1; padding: 4px 8px; min-height: 32px;">
                üóëÔ∏è
              </button>
            </div>
          </div>
        </div>
      `;
    });
    
    html += `</div>`;
  } else {
    html += `
      <div style="text-align: center; padding: var(--space-3xl); color: var(--text-tertiary);">
        <div style="font-size: 3rem; margin-bottom: var(--space-md);">üì∑</div>
        <p>No photos yet</p>
        <button class="btn btn-primary mt-md" onclick="triggerPhotoCapture()">
          Take First Photo
        </button>
      </div>
    `;
  }
  
  html += `
      </div>
    </div>
    
    <div class="card">
      <div class="card-header">
        <div class="card-title">üìù Notes</div>
      </div>
      <div class="card-body">
        <div class="form-group">
          <label>Work Notes</label>
          <textarea 
            id="work-notes"
            rows="4"
            placeholder="Additional observations, work performed, etc..."
            oninput="updateWorkNotes(this.value)"
          >${job?.diagnosis.workPerformed || ''}</textarea>
        </div>
        
        <div class="form-group">
          <label>Recommendations</label>
          <textarea 
            id="recommendations"
            rows="3"
            placeholder="Recommendations for customer..."
            oninput="updateRecommendations(this.value)"
          >${job?.diagnosis.recommendations || ''}</textarea>
        </div>
      </div>
    </div>
    
    <input type="file" id="photo-input" accept="image/*" capture="environment" style="display: none;" onchange="handlePhotoCapture(event)">
  `;
  
  container.innerHTML = html;
};

const triggerPhotoCapture = () => {
  const input = $('photo-input');
  if (input) {
    input.click();
  }
};

const handlePhotoCapture = async (event) => {
  const file = event.target.files[0];
  if (!file) return;
  
  const reader = new FileReader();
  
  reader.onload = async (e) => {
    try {
      const dataUrl = e.target.result;
      const compressed = await compressImage(dataUrl, 1200, 0.8);
      
      addPhoto(compressed, 'general');
      renderPhotoGallery();
      
      showToast('Photo added');
    } catch (error) {
      console.error('Photo capture error:', error);
      showToast('Failed to add photo', 'error');
    }
  };
  
  reader.readAsDataURL(file);
  
  event.target.value = '';
};

const deletePhoto = (photoId) => {
  if (!AppState.currentJob) return;
  
  const confirmed = confirm('Delete this photo?');
  if (!confirmed) return;
  
  AppState.currentJob.photos = AppState.currentJob.photos.filter(p => p.id !== photoId);
  AppState.currentJob.updatedAt = new Date().toISOString();
  
  saveToStorage();
  renderPhotoGallery();
  
  showToast('Photo deleted');
};

const viewPhotoFullscreen = (photoId) => {
  if (!AppState.currentJob) return;
  
  const photo = AppState.currentJob.photos.find(p => p.id === photoId);
  if (!photo) return;
  
  const modal = document.createElement('div');
  modal.style.cssText = `
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.95);
    z-index: 10000;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: var(--space-xl);
  `;
  
  modal.innerHTML = `
    <img 
      src="${photo.data}" 
      style="max-width: 100%; max-height: 100%; object-fit: contain;"
      onclick="this.parentElement.remove()">
  `;
  
  modal.onclick = () => modal.remove();
  document.body.appendChild(modal);
};

const updateWorkNotes = (notes) => {
  if (!AppState.currentJob) return;
  
  AppState.currentJob.diagnosis.workPerformed = notes;
  AppState.currentJob.updatedAt = new Date().toISOString();
  AppState.ui.unsavedChanges = true;
  
  saveToStorage();
};

const updateRecommendations = (recommendations) => {
  if (!AppState.currentJob) return;
  
  AppState.currentJob.diagnosis.recommendations = recommendations;
  AppState.currentJob.updatedAt = new Date().toISOString();
  AppState.ui.unsavedChanges = true;
  
  saveToStorage();
};

// ==================== PART 10: MATERIALS & PARTS ====================

const commonMaterials = [
  {
    id: 'r410a_recharge',
    name: 'R-410A Recharge Kit',
    description: 'Standard refrigerant recharge',
    parts: [
      { name: 'R-410A Refrigerant', qty: 1, unit: 'lb' },
      { name: 'Filter Drier', qty: 1, unit: 'ea' },
      { name: 'Nitrogen (purge)', qty: 1, unit: 'tank' }
    ]
  },
  {
    id: 'capacitor_replacement',
    name: 'Capacitor Replacement',
    description: 'Run/start capacitor swap',
    parts: [
      { name: 'Dual Run Capacitor', qty: 1, unit: 'ea' },
      { name: 'Wire connectors', qty: 3, unit: 'ea' }
    ]
  },
  {
    id: 'contactor_replacement',
    name: 'Contactor Replacement',
    description: 'Standard contactor swap',
    parts: [
      { name: 'Contactor (30A)', qty: 1, unit: 'ea' },
      { name: 'Wire connectors', qty: 2, unit: 'ea' }
    ]
  },
  {
    id: 'txv_replacement',
    name: 'TXV Valve Replacement',
    description: 'Expansion valve + accessories',
    parts: [
      { name: 'TXV Valve', qty: 1, unit: 'ea' },
      { name: 'Filter Drier', qty: 1, unit: 'ea' },
      { name: 'R-410A Refrigerant', qty: 1, unit: 'lb' },
      { name: 'Nitrogen (purge)', qty: 1, unit: 'tank' }
    ]
  },
  {
    id: 'coil_cleaning',
    name: 'Coil Cleaning Service',
    description: 'Indoor/outdoor coil cleaning',
    parts: [
      { name: 'Coil Cleaner', qty: 1, unit: 'bottle' },
      { name: 'Air Filter', qty: 1, unit: 'ea' }
    ]
  }
];

const renderMaterialPackages = () => {
  const container = $('material-packages-container');
  if (!container) return;
  
  let html = `
    <div class="card">
      <div class="card-header">
        <div class="card-title">Common Material Packages</div>
      </div>
      <div class="card-body">
        <div class="quick-actions">
  `;
  
  commonMaterials.forEach(pkg => {
    html += `
      <div class="action-card" onclick="addMaterialPackage('${pkg.id}')" style="min-height: 180px;">
        <div class="action-icon">üì¶</div>
        <div class="action-title">${pkg.name}</div>
        <div class="action-description">${pkg.description}</div>
        <div style="margin-top: var(--space-sm); font-size: 0.75rem; color: var(--text-tertiary);">
          ${pkg.parts.length} items
        </div>
      </div>
    `;
  });
  
  html += `
        </div>
      </div>
    </div>
    
    <div class="card">
      <div class="card-header">
        <div class="card-title">Materials Used</div>
      </div>
      <div class="card-body" id="materials-used-list">
        <p class="text-muted">No materials added yet</p>
      </div>
    </div>
  `;
  
  container.innerHTML = html;
  renderMaterialsList();
};

const addMaterialPackage = (packageId) => {
  if (!AppState.currentJob) return;
  
  const pkg = commonMaterials.find(p => p.id === packageId);
  if (!pkg) return;
  
  pkg.parts.forEach(part => {
    AppState.currentJob.materials.push({
      id: generateUUID(),
      name: part.name,
      qty: part.qty,
      unit: part.unit,
      addedAt: new Date().toISOString()
    });
  });
  
  AppState.currentJob.updatedAt = new Date().toISOString();
  saveToStorage();
  
  showToast(`Added ${pkg.name}`);
  renderMaterialsList();
};

const renderMaterialsList = () => {
  const container = $('materials-used-list');
  if (!container) return;
  
  const materials = AppState.currentJob?.materials || [];
  
  if (materials.length === 0) {
    container.innerHTML = '<p class="text-muted">No materials added yet</p>';
    return;
  }
  
  let html = '<div style="display: flex; flex-direction: column; gap: var(--space-sm);">';
  
  materials.forEach(material => {
    html += `
      <div style="display: flex; align-items: center; justify-content: space-between; padding: var(--space-md); background: var(--bg-elevated); border-radius: var(--radius); border: 1px solid var(--glass-border);">
        <div>
          <div style="font-weight: 600;">${material.name}</div>
          <div style="font-size: 0.75rem; color: var(--text-tertiary);">
            Qty: ${material.qty} ${material.unit}
          </div>
        </div>
        <button class="btn btn-secondary btn-sm" onclick="removeMaterial('${material.id}')">
          üóëÔ∏è
        </button>
      </div>
    `;
  });
  
  html += '</div>';
  
  container.innerHTML = html;
};

const removeMaterial = (materialId) => {
  if (!AppState.currentJob) return;
  
  AppState.currentJob.materials = AppState.currentJob.materials.filter(m => m.id !== materialId);
  AppState.currentJob.updatedAt = new Date().toISOString();
  
  saveToStorage();
  renderMaterialsList();
  
  showToast('Material removed');
};

// ==================== PART 11: DASHBOARD & HISTORY ====================

const renderRecentJobs = () => {
  const container = $('recent-jobs-container');
  if (!container) return;
  
  const recentJobs = AppState.jobs
    .sort((a, b) => new Date(b.updatedAt) - new Date(a.updatedAt))
    .slice(0, 5);
  
  if (recentJobs.length === 0) {
    container.innerHTML = `
      <div class="card">
        <div class="card-body" style="text-align: center; padding: var(--space-3xl);">
          <div style="font-size: 3rem; margin-bottom: var(--space-md);">üìã</div>
          <h3 style="margin-bottom: var(--space-sm);">No jobs yet</h3>
          <p class="text-muted">Start your first service call to see it here</p>
        </div>
      </div>
    `;
    return;
  }
  
  let html = `
    <div class="card">
      <div class="card-header">
        <div class="card-title">Recent Jobs</div>
        <button class="btn btn-secondary btn-sm" onclick="switchPage('history')">
          View All
        </button>
      </div>
      <div class="card-body">
        <div style="display: flex; flex-direction: column; gap: var(--space-md);">
  `;
  
  recentJobs.forEach(job => {
    const statusColor = job.status === 'completed' ? 'var(--success)' : 
                       job.status === 'in_progress' ? 'var(--cyan)' : 
                       'var(--warning)';
    
    html += `
      <div style="padding: var(--space-lg); background: var(--bg-elevated); border-radius: var(--radius-lg); border: 1px solid var(--glass-border); cursor: pointer; transition: var(--transition);"
           onmouseover="this.style.borderColor='var(--cyan)'"
           onmouseout="this.style.borderColor='var(--glass-border)'"
           onclick="loadJob('${job.id}')">
        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: var(--space-sm);">
          <div style="font-weight: 700; font-size: 1rem;">${job.customer.name || 'Unnamed Customer'}</div>
          <span style="padding: 4px 12px; background: ${statusColor}; color: white; border-radius: 20px; font-size: 0.625rem; font-weight: 700; text-transform: uppercase;">
            ${job.status.replace('_', ' ')}
          </span>
        </div>
        <div style="font-size: 0.875rem; color: var(--text-secondary); margin-bottom: var(--space-xs);">
          ${job.issue.type ? issueTypes.find(i => i.id === job.issue.type)?.label : 'No issue selected'}
        </div>
        <div style="font-size: 0.75rem; color: var(--text-tertiary);">
          ${getRelativeTime(job.updatedAt)}
        </div>
      </div>
    `;
  });
  
  html += `
        </div>
      </div>
    </div>
  `;
  
  container.innerHTML = html;
};

const renderQuickStats = () => {
  const container = $('quick-stats-container');
  if (!container) return;
  
  const totalJobs = AppState.jobs.length;
  const completedJobs = AppState.jobs.filter(j => j.status === 'completed').length;
  const inProgressJobs = AppState.jobs.filter(j => j.status === 'in_progress').length;
  
  let html = `
    <div class="card">
      <div class="card-header">
        <div class="card-title">Quick Stats</div>
      </div>
      <div class="card-body">
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: var(--space-lg);">
          
          <div style="text-align: center; padding: var(--space-xl); background: var(--bg-elevated); border-radius: var(--radius-lg);">
            <div style="font-size: 2rem; font-weight: 700; color: var(--cyan);">${totalJobs}</div>
            <div style="font-size: 0.875rem; color: var(--text-secondary); margin-top: var(--space-xs);">Total Jobs</div>
          </div>
          
          <div style="text-align: center; padding: var(--space-xl); background: var(--bg-elevated); border-radius: var(--radius-lg);">
            <div style="font-size: 2rem; font-weight: 700; color: var(--success);">${completedJobs}</div>
            <div style="font-size: 0.875rem; color: var(--text-secondary); margin-top: var(--space-xs);">Completed</div>
          </div>
          
          <div style="text-align: center; padding: var(--space-xl); background: var(--bg-elevated); border-radius: var(--radius-lg);">
            <div style="font-size: 2rem; font-weight: 700; color: var(--warning);">${inProgressJobs}</div>
            <div style="font-size: 0.875rem; color: var(--text-secondary); margin-top: var(--space-xs);">In Progress</div>
          </div>
          
        </div>
      </div>
    </div>
  `;
  
  container.innerHTML = html;
};

const loadJob = (jobId) => {
  const job = AppState.jobs.find(j => j.id === jobId);
  if (!job) return;
  
  AppState.currentJob = job;
  switchPage('new-job');
};

const renderJobHistory = () => {
  const container = $('job-history-container');
  if (!container) return;
  
  const allJobs = AppState.jobs
    .sort((a, b) => new Date(b.updatedAt) - new Date(a.updatedAt));
  
  if (allJobs.length === 0) {
    container.innerHTML = `
      <div class="card">
        <div class="card-body" style="text-align: center; padding: var(--space-3xl);">
          <div style="font-size: 3rem; margin-bottom: var(--space-md);">üìä</div>
          <h3 style="margin-bottom: var(--space-sm);">No job history</h3>
          <p class="text-muted">Completed jobs will appear here</p>
        </div>
      </div>
    `;
    return;
  }
  
  let html = `
    <div class="card">
      <div class="card-header">
        <div class="card-title">All Jobs (${allJobs.length})</div>
      </div>
      <div class="card-body">
        <div style="display: flex; flex-direction: column; gap: var(--space-md);">
  `;
  
  allJobs.forEach(job => {
    const statusColor = job.status === 'completed' ? 'var(--success)' : 
                       job.status === 'in_progress' ? 'var(--cyan)' : 
                       'var(--warning)';
    
    html += `
      <div style="padding: var(--space-lg); background: var(--bg-elevated); border-radius: var(--radius-lg); border: 1px solid var(--glass-border);">
        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: var(--space-md);">
          <div>
            <div style="font-weight: 700; font-size: 1.125rem; margin-bottom: var(--space-xs);">
              ${job.customer.name || 'Unnamed Customer'}
            </div>
            <div style="font-size: 0.875rem; color: var(--text-secondary);">
              ${job.customer.address || 'No address'}
            </div>
          </div>
          <span style="padding: 6px 16px; background: ${statusColor}; color: white; border-radius: 20px; font-size: 0.75rem; font-weight: 700; text-transform: uppercase;">
            ${job.status.replace('_', ' ')}
          </span>
        </div>
        
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: var(--space-md); margin-bottom: var(--space-md);">
          <div>
            <div style="font-size: 0.75rem; color: var(--text-tertiary); margin-bottom: 4px;">Issue</div>
            <div style="font-size: 0.875rem; color: var(--text-secondary);">
              ${job.issue.type ? issueTypes.find(i => i.id === job.issue.type)?.label : 'Not specified'}
            </div>
          </div>
          <div>
            <div style="font-size: 0.75rem; color: var(--text-tertiary); margin-bottom: 4px;">Equipment</div>
            <div style="font-size: 0.875rem; color: var(--text-secondary);">
              ${job.equipment.type ? equipmentDatabase[job.equipment.type]?.label : 'Not specified'}
            </div>
          </div>
          <div>
            <div style="font-size: 0.75rem; color: var(--text-tertiary); margin-bottom: 4px;">Date</div>
            <div style="font-size: 0.875rem; color: var(--text-secondary);">
              ${formatDate(job.createdAt)}
            </div>
          </div>
          <div>
            <div style="font-size: 0.75rem; color: var(--text-tertiary); margin-bottom: 4px;">Quality Score</div>
            <div style="font-size: 0.875rem; color: var(--text-secondary);">
              ${job.qualityScore || 0}%
            </div>
          </div>
        </div>
        
        <div style="display: flex; gap: var(--space-sm);">
          <button class="btn btn-secondary btn-sm" onclick="loadJob('${job.id}')">
            üìù View
          </button>
          <button class="btn btn-secondary btn-sm" onclick="exportJobReport('${job.id}')">
            üìÑ Export
          </button>
          <button class="btn btn-danger btn-sm" onclick="confirmDeleteJob('${job.id}')">
            üóëÔ∏è Delete
          </button>
        </div>
      </div>
    `;
  });
  
  html += `
        </div>
      </div>
    </div>
  `;
  
  container.innerHTML = html;
};

const confirmDeleteJob = (jobId) => {
  const job = AppState.jobs.find(j => j.id === jobId);
  if (!job) return;
  
  const confirmed = confirm(`Delete job for ${job.customer.name || 'Unnamed Customer'}?`);
  if (!confirmed) return;
  
  deleteJob(jobId).then(() => {
    renderJobHistory();
    renderRecentJobs();
    renderQuickStats();
  });
};

const renderContinueJob = () => {
  const container = $('continue-job-content');
  if (!container) return;
  
  const inProgressJobs = AppState.jobs
    .filter(j => j.status === 'in_progress')
    .sort((a, b) => new Date(b.updatedAt) - new Date(a.updatedAt));
  
  if (inProgressJobs.length === 0) {
    container.innerHTML = '<p class="text-muted">No jobs in progress</p>';
    return;
  }
  
  let html = '<div style="display: flex; flex-direction: column; gap: var(--space-md);">';
  
  inProgressJobs.forEach(job => {
    html += `
      <div style="padding: var(--space-lg); background: var(--bg-elevated); border-radius: var(--radius-lg); border: 1px solid var(--glass-border); cursor: pointer;"
           onclick="loadJob('${job.id}')">
        <div style="font-weight: 700; margin-bottom: var(--space-sm);">${job.customer.name || 'Unnamed Customer'}</div>
        <div style="font-size: 0.875rem; color: var(--text-secondary);">
          Last updated: ${getRelativeTime(job.updatedAt)}
        </div>
      </div>
    `;
  });
  
  html += '</div>';
  
  container.innerHTML = html;
};

const renderSavedReports = () => {
  const container = $('saved-reports-container');
  if (!container) return;
  
  container.innerHTML = `
    <div class="card">
      <div class="card-body" style="text-align: center; padding: var(--space-3xl);">
        <div style="font-size: 3rem; margin-bottom: var(--space-md);">üìÑ</div>
        <h3 style="margin-bottom: var(--space-sm);">Reports</h3>
        <p class="text-muted">Export reports from job history</p>
      </div>
    </div>
  `;
};

// ==================== PART 12: REPORT GENERATION ====================

const exportJobReport = (jobId) => {
  const job = AppState.jobs.find(j => j.id === jobId);
  if (!job) return;
  
  const reportText = generateTextReport(job);
  
  const blob = new Blob([reportText], { type: 'text/plain' });
  const url = URL.createObjectURL(blob);
  const link = document.createElement('a');
  link.href = url;
  link.download = `job-report-${job.customer.name?.replace(/\s+/g, '-') || 'unnamed'}-${formatDate(job.createdAt)}.txt`;
  link.click();
  URL.revokeObjectURL(url);
  
  showToast('Report exported');
};

const generateTextReport = (job) => {
  let report = '';
  
  report += '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n';
  report += '              FIELD BUDDY PRO - SERVICE REPORT\n';
  report += '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\n';
  
  report += `Technician: ${AppState.tech.name}\n`;
  report += `Phone: ${AppState.tech.phone}\n`;
  report += `Email: ${AppState.tech.email}\n\n`;
  
  report += '‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n';
  report += 'CUSTOMER INFORMATION\n';
  report += '‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n';
  report += `Name: ${job.customer.name || 'Not provided'}\n`;
  report += `Address: ${job.customer.address || 'Not provided'}\n`;
  report += `Phone: ${job.customer.phone || 'Not provided'}\n`;
  report += `Service Date: ${formatDate(job.createdAt)}\n`;
  report += `Job Status: ${job.status.replace('_', ' ').toUpperCase()}\n\n`;
  
  report += '‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n';
  report += 'ISSUE REPORTED\n';
  report += '‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n';
  const issueType = issueTypes.find(i => i.id === job.issue.type);
  report += `Type: ${issueType?.label || 'Not specified'}\n`;
  report += `Description: ${job.issue.description || 'None provided'}\n\n`;
  
  if (job.equipment.type) {
    report += '‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n';
    report += 'EQUIPMENT INFORMATION\n';
    report += '‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n';
    const eqType = equipmentDatabase[job.equipment.type];
    report += `Type: ${eqType?.label || job.equipment.type}\n`;
    
    if (job.equipment.indoor.brand) {
      report += `\nIndoor Unit:\n`;
      report += `  Brand: ${job.equipment.indoor.brand}\n`;
      report += `  Model: ${job.equipment.indoor.model || 'N/A'}\n`;
      report += `  Serial: ${job.equipment.indoor.serial || 'N/A'}\n`;
    }
    
    if (job.equipment.outdoor.brand) {
      report += `\nOutdoor Unit:\n`;
      report += `  Brand: ${job.equipment.outdoor.brand}\n`;
      report += `  Model: ${job.equipment.outdoor.model || 'N/A'}\n`;
      report += `  Serial: ${job.equipment.outdoor.serial || 'N/A'}\n`;
    }
    
    report += `\nSpecifications:\n`;
    if (job.equipment.tonnage) report += `  Tonnage: ${job.equipment.tonnage} Ton\n`;
    if (job.equipment.refrigerant) report += `  Refrigerant: ${job.equipment.refrigerant}\n`;
    if (job.equipment.filterSize) report += `  Filter Size: ${job.equipment.filterSize}\n`;
    if (job.equipment.ageYears) report += `  Age: ${job.equipment.ageYears} years\n`;
    report += '\n';
  }
  
  if (job.measurements.length > 0) {
    report += '‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n';
    report += 'DIAGNOSTIC MEASUREMENTS\n';
    report += '‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n';
    
    job.measurements.forEach(m => {
      report += `${m.field}: ${m.value} ${m.unit}\n`;
    });
    report += '\n';
  }
  
  if (job.suggestions.length > 0) {
    report += '‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n';
    report += 'DIAGNOSTIC FINDINGS\n';
    report += '‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n';
    
    job.suggestions.forEach((suggestion, index) => {
      report += `\n${index + 1}. ${suggestion.diagnosis}\n`;
      report += `   Confidence: ${suggestion.confidence.toUpperCase()}\n`;
      report += `\n   Evidence:\n`;
      suggestion.evidence.forEach(e => {
        report += `   ‚Ä¢ ${e}\n`;
      });
      
      if (suggestion.safetyNotes.length > 0) {
        report += `\n   ‚ö†Ô∏è SAFETY ALERTS:\n`;
        suggestion.safetyNotes.forEach(note => {
          report += `   ‚Ä¢ ${note}\n`;
        });
      }
      
      report += `\n   Recommended Actions:\n`;
      suggestion.nextSteps.forEach((step, i) => {
        report += `   ${i + 1}) ${step}\n`;
      });
      
      if (suggestion.partsLikely.length > 0) {
        report += `\n   Parts Likely Needed:\n`;
        suggestion.partsLikely.forEach(part => {
          report += `   ‚Ä¢ ${part}\n`;
        });
      }
      report += '\n';
    });
  }
  
  if (job.materials.length > 0) {
    report += '‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n';
    report += 'MATERIALS USED\n';
    report += '‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n';
    
    job.materials.forEach(material => {
      report += `‚Ä¢ ${material.name} - Qty: ${material.qty} ${material.unit}\n`;
    });
    report += '\n';
  }
  
  if (job.diagnosis.workPerformed) {
    report += '‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n';
    report += 'WORK PERFORMED\n';
    report += '‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n';
    report += `${job.diagnosis.workPerformed}\n\n`;
  }
  
  if (job.diagnosis.recommendations) {
    report += '‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n';
    report += 'RECOMMENDATIONS\n';
    report += '‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n';
    report += `${job.diagnosis.recommendations}\n\n`;
  }
  
  if (job.photos.length > 0) {
    report += '‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n';
    report += 'PHOTO DOCUMENTATION\n';
    report += '‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n';
    report += `${job.photos.length} photo(s) attached to this job\n\n`;
  }
  
  report += '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n';
  report += `Report Generated: ${formatDateTime(new Date().toISOString())}\n`;
  report += `Quality Score: ${job.qualityScore || 0}%\n`;
  report += '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n';
  
  return report;
};

// ==================== PART 13: APP INITIALIZATION & EVENT HANDLERS ====================

const initializeApp = async () => {
  console.log('üöÄ Field Buddy Pro v5.0 initializing...');
  
  try {
    // Initialize IndexedDB
    await initDB();
    
    // Load saved data
    await loadFromStorage();
    
    // Bind navigation events
    $$('.nav-item').forEach(item => {
      item.addEventListener('click', () => {
        const page = item.dataset.page;
        if (page) {
          switchPage(page);
          history.pushState({ page }, '', `#${page}`);
        }
      });
    });
    
    // Bind quick action cards
    $$('.action-card').forEach(card => {
      card.addEventListener('click', () => {
        const action = card.dataset.action;
        if (action) {
          handleQuickAction(action);
        }
      });
    });
    
    // Bind menu toggle
    const menuToggle = $('menu-toggle');
    if (menuToggle) {
      menuToggle.addEventListener('click', toggleMobileMenu);
    }
    
    // Bind save/complete buttons
    const saveDraftBtn = $('save-draft');
    if (saveDraftBtn) {
      saveDraftBtn.addEventListener('click', () => {
        if (!AppState.currentJob) return;
        
        AppState.currentJob.status = 'draft';
        saveToStorage();
        showToast('Draft saved');
      });
    }
    
    const completeJobBtn = $('complete-job');
    if (completeJobBtn) {
      completeJobBtn.addEventListener('click', () => {
        if (!AppState.currentJob) return;
        
        const confirmed = confirm('Mark this job as complete?');
        if (!confirmed) return;
        
        updateJobStatus('completed');
        showToast('Job completed!');
        
        // Render photo section to capture any final notes
        renderPhotoGallery();
        
        setTimeout(() => {
          switchPage('dashboard');
        }, 1500);
      });
    }
    
    // Bind export/import buttons
    const exportBtn = $('export-data');
    if (exportBtn) {
      exportBtn.addEventListener('click', exportAllData);
    }
    
    const importBtn = $('import-data');
    if (importBtn) {
      importBtn.addEventListener('click', () => {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = '.json';
        input.onchange = (e) => {
          const file = e.target.files[0];
          if (file) {
            importData(file);
          }
        };
        input.click();
      });
    }
    
    // Bind settings save
    const saveSettingsBtn = $('save-settings');
    if (saveSettingsBtn) {
      saveSettingsBtn.addEventListener('click', () => {
        AppState.tech.name = $('tech-name')?.value || AppState.tech.name;
        AppState.tech.phone = $('tech-phone')?.value || AppState.tech.phone;
        AppState.tech.email = $('tech-email')?.value || AppState.tech.email;
        AppState.settings.defaultRefrigerant = $('default-refrigerant')?.value || AppState.settings.defaultRefrigerant;
        AppState.settings.units = $('default-units')?.value || AppState.settings.units;
        
        saveToStorage();
        showToast('Settings saved');
      });
    }
    
    // Bind clear data button
    const clearDataBtn = $('clear-all-data');
    if (clearDataBtn) {
      clearDataBtn.addEventListener('click', clearAllData);
    }
    
    // Handle browser back/forward
    window.addEventListener('popstate', (e) => {
      const page = e.state?.page || 'dashboard';
      switchPage(page);
    });
    
    // Handle responsive sidebar
    const handleResize = () => {
      if (window.innerWidth > 1024) {
        const sidebar = $('sidebar');
        if (sidebar) {
          sidebar.classList.remove('collapsed', 'open');
        }
      }
    };
    
    window.addEventListener('resize', handleResize);
    
    // Auto-save on page unload
    window.addEventListener('beforeunload', (e) => {
      if (AppState.ui.unsavedChanges) {
        e.preventDefault();
        e.returnValue = 'You have unsaved changes. Are you sure you want to leave?';
      }
    });
    
    // Initialize responsive menu state
    if (window.innerWidth <= 1024) {
      const sidebar = $('sidebar');
      if (sidebar) {
        sidebar.classList.add('collapsed');
      }
    }
    
    // Load initial page
    const hash = window.location.hash.slice(1);
    const initialPage = hash || 'dashboard';
    switchPage(initialPage);
    
    // Check for unfinished jobs
    const inProgressJobs = AppState.jobs.filter(j => j.status === 'in_progress');
    if (inProgressJobs.length > 0) {
      console.log(`üìã Found ${inProgressJobs.length} in-progress job(s)`);
    }
    
    console.log('‚úÖ Field Buddy Pro initialized successfully');
    console.log(`üìä Loaded ${AppState.jobs.length} total jobs`);
    
    // Show welcome message
    setTimeout(() => {
      showToast('Field Buddy Pro ready!');
    }, 500);
    
  } catch (error) {
    console.error('‚ùå Initialization error:', error);
    showToast('Failed to initialize app', 'error');
  }
};

// ==================== START THE APP ====================

// Wait for DOM to be ready
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', initializeApp);
} else {
  initializeApp();
}

// ==================== SERVICE WORKER (PWA) ====================

if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('/sw.js').then(
      registration => {
        console.log('‚úÖ Service Worker registered:', registration.scope);
      },
      error => {
        console.log('‚ùå Service Worker registration failed:', error);
      }
    );
  });
}

// ==================== MANIFEST.JSON GENERATOR ====================

const generateManifest = () => {
  return {
    name: "Field Buddy Pro",
    short_name: "Field Buddy",
    description: "HVAC Field Service Application",
    start_url: "/",
    display: "standalone",
    background_color: "#0B1121",
    theme_color: "#00D9FF",
    orientation: "portrait",
    icons: [
      {
        src: "/icon-192.png",
        sizes: "192x192",
        type: "image/png"
      },
      {
        src: "/icon-512.png",
        sizes: "512x512",
        type: "image/png"
      }
    ]
  };
};

// Log manifest to console for reference
console.log('üì± PWA Manifest:', generateManifest());

// ==================== GLOBAL ERROR HANDLER ====================

window.addEventListener('error', (event) => {
  console.error('Global error:', event.error);
  showToast('An error occurred. Check console for details.', 'error');
});

window.addEventListener('unhandledrejection', (event) => {
  console.error('Unhandled promise rejection:', event.reason);
  showToast('An error occurred. Check console for details.', 'error');
});

// ==================== DEVELOPER TOOLS ====================

window.FieldBuddyPro = {
  version: '5.0.0',
  state: AppState,
  clearAllData,
  exportAllData,
  importData,
  createTestJob: () => {
    const testJob = createNewJob();
    testJob.customer.name = 'Test Customer';
    testJob.customer.address = '123 Main St, Houston, TX 77001';
    testJob.customer.phone = '(555) 123-4567';
    testJob.issue.type = 'no_cool';
    testJob.issue.description = 'System not cooling, outdoor unit running';
    testJob.equipment.type = 'split_system';
    testJob.equipment.indoor.brand = 'Carrier';
    testJob.equipment.indoor.model = 'FE4A';
    testJob.equipment.outdoor.brand = 'Carrier';
    testJob.equipment.outdoor.model = '24ACC3';
    testJob.equipment.tonnage = '3';
    testJob.equipment.refrigerant = 'R-410A';
    
    AppState.currentJob = testJob;
    AppState.jobs.push(testJob);
    saveToStorage();
    
    console.log('‚úÖ Test job created');
    switchPage('new-job');
  },
  resetApp: () => {
    if (confirm('‚ö†Ô∏è This will reset the entire app. Continue?')) {
      clearAllData();
      location.reload();
    }
  }
};

console.log('üîß Developer tools available: window.FieldBuddyPro');
console.log('   - createTestJob(): Create a sample job');
console.log('   - resetApp(): Clear all data and reload');
console.log('   - state: View current app state');

  </script>
</body>
</html>