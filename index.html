<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HVAC Ductwork Designer Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #111827;
        }
        #designCanvas {
            cursor: crosshair;
            touch-action: none;
        }
        .tool-btn {
            transition: all 0.15s ease;
        }
        .tool-btn:hover {
            transform: translateY(-1px);
        }
        .tool-btn.active {
            background-color: #10b981 !important;
            border-color: #10b981 !important;
        }
        .panel {
            background: rgba(31, 41, 55, 0.95);
            backdrop-filter: blur(8px);
        }
        .tab-btn.active {
            background-color: #374151;
            border-bottom: 2px solid #10b981;
        }
        ::-webkit-scrollbar {
            width: 6px;
        }
        ::-webkit-scrollbar-track {
            background: #1f2937;
        }
        ::-webkit-scrollbar-thumb {
            background: #4b5563;
            border-radius: 3px;
        }
        .modal-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.5);
            align-items: center;
            justify-content: center;
            z-index: 50;
        }
        .modal-overlay.show {
            display: flex;
        }
    </style>
</head>
<body class="min-h-screen text-white">
    <div id="app" class="flex flex-col h-screen">
        <!-- Header -->
        <header class="bg-gray-800 border-b border-gray-700 px-4 py-2">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-lg font-bold text-white">HVAC Ductwork Designer Pro</h1>
                    <p class="text-xs text-gray-400">Scale: 1/4" = 1' | Grid: 1 ft squares</p>
                </div>
                <div class="flex gap-2">
                    <button id="btnUndo" class="px-2 py-1 bg-gray-700 hover:bg-gray-600 rounded text-xs" title="Ctrl+Z">‚Ü∂ Undo</button>
                    <button id="btnRedo" class="px-2 py-1 bg-gray-700 hover:bg-gray-600 rounded text-xs" title="Ctrl+Y">‚Ü∑ Redo</button>
                    <button id="btnSave" class="px-2 py-1 bg-blue-600 hover:bg-blue-700 rounded text-xs">üíæ Save</button>
                    <button id="btnLoad" class="px-2 py-1 bg-blue-600 hover:bg-blue-700 rounded text-xs">üìÇ Load</button>
                    <button id="btnExport" class="px-2 py-1 bg-green-600 hover:bg-green-700 rounded text-xs">üìÑ Export PNG</button>
                    <button id="btnClear" class="px-2 py-1 bg-red-600 hover:bg-red-700 rounded text-xs">üóëÔ∏è Clear</button>
                </div>
            </div>
        </header>

        <div class="flex flex-1 overflow-hidden">
            <!-- Left Toolbar -->
            <div class="w-52 bg-gray-800 border-r border-gray-700 p-2 flex flex-col gap-1 overflow-y-auto text-xs">
                <!-- Structure -->
                <div class="text-[10px] font-semibold text-gray-400 uppercase tracking-wider mb-1">Structure</div>
                <button class="tool-btn active flex items-center gap-2 px-2 py-1.5 bg-gray-700 hover:bg-gray-600 rounded text-left" data-mode="WALL">
                    <span class="w-3 h-3 bg-gray-500 rounded-sm"></span>Wall
                </button>
                <button class="tool-btn flex items-center gap-2 px-2 py-1.5 bg-gray-700 hover:bg-gray-600 rounded text-left" data-mode="ROOM">
                    <span class="w-3 h-3 border border-yellow-400 rounded-sm"></span>Room Label
                </button>

                <!-- Ductwork -->
                <div class="text-[10px] font-semibold text-gray-400 uppercase tracking-wider mb-1 mt-2">Ductwork</div>
                <button class="tool-btn flex items-center gap-2 px-2 py-1.5 bg-gray-700 hover:bg-gray-600 rounded text-left" data-mode="TRUNK">
                    <span class="w-3 h-3 bg-blue-700 rounded-sm"></span>Trunk Line
                </button>
                <button class="tool-btn flex items-center gap-2 px-2 py-1.5 bg-gray-700 hover:bg-gray-600 rounded text-left" data-mode="SUPPLY">
                    <span class="w-3 h-3 bg-blue-500 rounded-sm"></span>Supply Branch
                </button>
                <button class="tool-btn flex items-center gap-2 px-2 py-1.5 bg-gray-700 hover:bg-gray-600 rounded text-left" data-mode="RETURN">
                    <span class="w-3 h-3 bg-orange-500 rounded-sm"></span>Return Duct
                </button>
                <button class="tool-btn flex items-center gap-2 px-2 py-1.5 bg-gray-700 hover:bg-gray-600 rounded text-left" data-mode="FLEX">
                    <span class="w-3 h-3 bg-green-500 rounded-sm"></span>Flex Duct
                </button>

                <!-- Fittings -->
                <div class="text-[10px] font-semibold text-gray-400 uppercase tracking-wider mb-1 mt-2">Fittings</div>
                <button class="tool-btn flex items-center gap-2 px-2 py-1.5 bg-gray-700 hover:bg-gray-600 rounded text-left" data-mode="ELBOW90">
                    <span class="w-3 h-3 text-blue-400 font-bold">‚àü</span>90¬∞ Elbow
                </button>
                <button class="tool-btn flex items-center gap-2 px-2 py-1.5 bg-gray-700 hover:bg-gray-600 rounded text-left" data-mode="ELBOW45">
                    <span class="w-3 h-3 text-blue-400 font-bold">‚à†</span>45¬∞ Elbow
                </button>
                <button class="tool-btn flex items-center gap-2 px-2 py-1.5 bg-gray-700 hover:bg-gray-600 rounded text-left" data-mode="TEE">
                    <span class="w-3 h-3 text-blue-400 font-bold">‚ä•</span>Tee
                </button>
                <button class="tool-btn flex items-center gap-2 px-2 py-1.5 bg-gray-700 hover:bg-gray-600 rounded text-left" data-mode="TAKEOFF">
                    <span class="w-3 h-3 text-blue-400 font-bold">‚ä¢</span>Takeoff
                </button>

                <!-- Terminals -->
                <div class="text-[10px] font-semibold text-gray-400 uppercase tracking-wider mb-1 mt-2">Terminals</div>
                <button class="tool-btn flex items-center gap-2 px-2 py-1.5 bg-gray-700 hover:bg-gray-600 rounded text-left" data-mode="REGISTER">
                    <span class="w-3 h-3 border-2 border-cyan-400 rounded-sm"></span>Supply Register
                </button>
                <button class="tool-btn flex items-center gap-2 px-2 py-1.5 bg-gray-700 hover:bg-gray-600 rounded text-left" data-mode="RETURN_GRILLE">
                    <span class="w-3 h-3 border-2 border-orange-400 rounded-sm"></span>Return Grille
                </button>
                <button class="tool-btn flex items-center gap-2 px-2 py-1.5 bg-gray-700 hover:bg-gray-600 rounded text-left" data-mode="DIFFUSER">
                    <span class="w-3 h-3 border-2 border-purple-400 rounded-full"></span>Ceiling Diffuser
                </button>

                <!-- Equipment -->
                <div class="text-[10px] font-semibold text-gray-400 uppercase tracking-wider mb-1 mt-2">Equipment</div>
                <button class="tool-btn flex items-center gap-2 px-2 py-1.5 bg-gray-700 hover:bg-gray-600 rounded text-left" data-mode="AHU">
                    <span class="w-3 h-3 bg-purple-500 rounded-sm"></span>Air Handler
                </button>
                <button class="tool-btn flex items-center gap-2 px-2 py-1.5 bg-gray-700 hover:bg-gray-600 rounded text-left" data-mode="FURNACE">
                    <span class="w-3 h-3 bg-red-500 rounded-sm"></span>Furnace
                </button>

                <!-- Tools -->
                <div class="text-[10px] font-semibold text-gray-400 uppercase tracking-wider mb-1 mt-2">Tools</div>
                <button class="tool-btn flex items-center gap-2 px-2 py-1.5 bg-gray-700 hover:bg-gray-600 rounded text-left" data-mode="SELECT">
                    <span class="w-3 h-3">‚Üñ</span>Select/Delete
                </button>

                <!-- Settings -->
                <div class="mt-3 pt-2 border-t border-gray-700 space-y-1">
                    <label class="flex items-center gap-2 cursor-pointer">
                        <input type="checkbox" id="snapGrid" checked class="rounded w-3 h-3">
                        <span>Snap to Grid</span>
                    </label>
                    <label class="flex items-center gap-2 cursor-pointer">
                        <input type="checkbox" id="showGrid" checked class="rounded w-3 h-3">
                        <span>Show Grid</span>
                    </label>
                    <label class="flex items-center gap-2 cursor-pointer">
                        <input type="checkbox" id="showMeasure" checked class="rounded w-3 h-3">
                        <span>Show Measurements</span>
                    </label>
                    <label class="flex items-center gap-2 cursor-pointer">
                        <input type="checkbox" id="orthoLock" class="rounded w-3 h-3">
                        <span>Ortho Lock (H/V)</span>
                    </label>
                </div>

                <!-- Duct Size -->
                <div class="mt-2 pt-2 border-t border-gray-700">
                    <label class="text-[10px] font-semibold text-gray-400 uppercase">Duct Size</label>
                    <select id="ductSize" class="mt-1 w-full bg-gray-700 border border-gray-600 rounded px-1 py-1 text-xs">
                        <option value="4">4"</option>
                        <option value="5">5"</option>
                        <option value="6">6"</option>
                        <option value="7">7"</option>
                        <option value="8" selected>8"</option>
                        <option value="10">10"</option>
                        <option value="12">12"</option>
                        <option value="14">14"</option>
                        <option value="10x8">10"√ó8"</option>
                        <option value="12x8">12"√ó8"</option>
                        <option value="14x8">14"√ó8"</option>
                        <option value="16x8">16"√ó8"</option>
                        <option value="20x8">20"√ó8"</option>
                    </select>
                </div>

                <!-- CFM Input -->
                <div class="mt-2">
                    <label class="text-[10px] font-semibold text-gray-400 uppercase">Terminal CFM</label>
                    <input type="number" id="registerCFM" value="100" min="25" max="1000" step="25" 
                           class="mt-1 w-full bg-gray-700 border border-gray-600 rounded px-1 py-1 text-xs">
                </div>

                <!-- Fitting Rotation -->
                <div class="mt-2">
                    <label class="text-[10px] font-semibold text-gray-400 uppercase">Fitting Rotation</label>
                    <select id="fittingRotation" class="mt-1 w-full bg-gray-700 border border-gray-600 rounded px-1 py-1 text-xs">
                        <option value="0">0¬∞</option>
                        <option value="90">90¬∞</option>
                        <option value="180">180¬∞</option>
                        <option value="270">270¬∞</option>
                    </select>
                </div>
            </div>

            <!-- Canvas Area -->
            <div class="flex-1 relative overflow-hidden bg-gray-900">
                <canvas id="designCanvas" class="absolute inset-0"></canvas>
                
                <!-- Mode indicator -->
                <div id="modeIndicator" class="absolute top-2 left-2 panel px-2 py-1 rounded text-xs font-medium">
                    Mode: <span id="currentMode" class="text-green-400">WALL</span>
                </div>

                <!-- Measurement display -->
                <div id="measureDisplay" class="absolute bottom-2 left-2 panel px-2 py-1 rounded text-xs hidden">
                    <span id="liveLength">0</span> ft
                </div>
            </div>

            <!-- Right Panel -->
            <div class="w-72 bg-gray-800 border-l border-gray-700 flex flex-col overflow-hidden">
                <!-- Tabs -->
                <div class="flex border-b border-gray-700">
                    <button class="tab-btn active flex-1 px-2 py-2 text-xs hover:bg-gray-700" data-tab="summary">Summary</button>
                    <button class="tab-btn flex-1 px-2 py-2 text-xs hover:bg-gray-700" data-tab="pressure">Pressure</button>
                    <button class="tab-btn flex-1 px-2 py-2 text-xs hover:bg-gray-700" data-tab="materials">Materials</button>
                </div>

                <!-- Tab Content -->
                <div class="flex-1 overflow-y-auto p-2 text-xs">
                    <!-- Summary Tab -->
                    <div id="tab-summary" class="tab-content">
                        <div class="space-y-2">
                            <!-- Airflow Balance -->
                            <div class="bg-gray-700 rounded p-2">
                                <div class="font-semibold mb-1">Airflow Balance</div>
                                <div class="flex justify-between">
                                    <span class="text-blue-400">Supply:</span>
                                    <span id="totalSupplyCFM">0 CFM</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-orange-400">Return:</span>
                                    <span id="totalReturnCFM">0 CFM</span>
                                </div>
                                <div class="flex justify-between mt-1 pt-1 border-t border-gray-600">
                                    <span>Balance:</span>
                                    <span id="cfmBalance" class="font-bold">0 CFM</span>
                                </div>
                            </div>

                            <!-- Duct Lengths -->
                            <div class="bg-gray-700 rounded p-2">
                                <div class="font-semibold mb-1">Duct Lengths</div>
                                <div class="flex justify-between">
                                    <span class="text-blue-700">Trunk:</span>
                                    <span id="trunkTotal">0 ft</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-blue-400">Supply:</span>
                                    <span id="supplyTotal">0 ft</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-orange-400">Return:</span>
                                    <span id="returnTotal">0 ft</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-green-400">Flex:</span>
                                    <span id="flexTotal">0 ft</span>
                                </div>
                            </div>

                            <!-- Components -->
                            <div class="bg-gray-700 rounded p-2">
                                <div class="font-semibold mb-1">Components</div>
                                <div class="grid grid-cols-2 gap-1 text-[10px]">
                                    <span>Registers:</span><span id="registerCount" class="text-right">0</span>
                                    <span>Return Grilles:</span><span id="returnGrilleCount" class="text-right">0</span>
                                    <span>Diffusers:</span><span id="diffuserCount" class="text-right">0</span>
                                    <span>90¬∞ Elbows:</span><span id="elbow90Count" class="text-right">0</span>
                                    <span>45¬∞ Elbows:</span><span id="elbow45Count" class="text-right">0</span>
                                    <span>Tees:</span><span id="teeCount" class="text-right">0</span>
                                    <span>Takeoffs:</span><span id="takeoffCount" class="text-right">0</span>
                                </div>
                            </div>

                            <!-- Rooms -->
                            <div class="bg-gray-700 rounded p-2">
                                <div class="font-semibold mb-1">Rooms</div>
                                <div id="roomList" class="space-y-1 text-[10px]">
                                    <div class="text-gray-500 italic">No rooms defined</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Pressure Tab -->
                    <div id="tab-pressure" class="tab-content hidden">
                        <div class="space-y-2">
                            <div class="bg-gray-700 rounded p-2">
                                <div class="font-semibold mb-1">System Settings</div>
                                <div class="space-y-1">
                                    <div class="flex justify-between items-center">
                                        <span>System CFM:</span>
                                        <input type="number" id="systemCFM" value="1200" class="w-16 bg-gray-600 rounded px-1 text-right">
                                    </div>
                                    <div class="flex justify-between items-center">
                                        <span>Filter Drop:</span>
                                        <input type="number" id="filterDrop" value="0.10" step="0.01" class="w-16 bg-gray-600 rounded px-1 text-right">
                                    </div>
                                    <div class="flex justify-between items-center">
                                        <span>Coil Drop:</span>
                                        <input type="number" id="coilDrop" value="0.20" step="0.01" class="w-16 bg-gray-600 rounded px-1 text-right">
                                    </div>
                                </div>
                            </div>

                            <div class="bg-gray-700 rounded p-2">
                                <div class="font-semibold mb-1">Calculated Losses (in. w.c.)</div>
                                <div class="space-y-1">
                                    <div class="flex justify-between">
                                        <span>Supply Duct:</span>
                                        <span id="supplyLoss">0.00</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span>Supply Fittings:</span>
                                        <span id="supplyFittingLoss">0.00</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span>Return Duct:</span>
                                        <span id="returnLoss">0.00</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span>Terminals:</span>
                                        <span id="terminalLoss">0.00</span>
                                    </div>
                                    <div class="flex justify-between mt-1 pt-1 border-t border-gray-600 font-bold">
                                        <span>Total ESP:</span>
                                        <span id="totalESP">0.30</span>
                                    </div>
                                </div>
                            </div>

                            <button id="calcPressure" class="w-full bg-blue-600 hover:bg-blue-700 rounded py-1.5 text-xs font-medium">
                                Calculate Pressure
                            </button>
                        </div>
                    </div>

                    <!-- Materials Tab -->
                    <div id="tab-materials" class="tab-content hidden">
                        <div class="space-y-2">
                            <div class="bg-gray-700 rounded p-2">
                                <div class="font-semibold mb-1">Duct by Size</div>
                                <div id="ductBySize" class="space-y-1 text-[10px]">
                                    <div class="text-gray-500 italic">No ducts placed</div>
                                </div>
                            </div>

                            <div class="bg-gray-700 rounded p-2">
                                <div class="font-semibold mb-1">Fittings List</div>
                                <div id="fittingsList" class="space-y-1 text-[10px]">
                                    <div class="text-gray-500 italic">No fittings placed</div>
                                </div>
                            </div>

                            <div class="bg-gray-700 rounded p-2">
                                <div class="font-semibold mb-1">Estimated Materials</div>
                                <div class="space-y-1">
                                    <div class="flex justify-between">
                                        <span>Sheet Metal:</span>
                                        <span id="sheetMetalLbs">0 lbs</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span>Flex Duct:</span>
                                        <span id="flexDuctFt">0 ft</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span>Hangers:</span>
                                        <span id="hangerCount">0</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Room Label Modal -->
    <div id="roomModal" class="modal-overlay">
        <div class="bg-gray-800 rounded-lg p-4 w-80">
            <h3 class="font-bold mb-3">Room Details</h3>
            <div class="space-y-2">
                <div>
                    <label class="text-xs text-gray-400">Room Name</label>
                    <input type="text" id="roomName" class="w-full bg-gray-700 border border-gray-600 rounded px-2 py-1 text-sm" placeholder="e.g., Master Bedroom">
                </div>
                <div>
                    <label class="text-xs text-gray-400">Square Footage</label>
                    <input type="number" id="roomSqft" class="w-full bg-gray-700 border border-gray-600 rounded px-2 py-1 text-sm" placeholder="150">
                </div>
                <div>
                    <label class="text-xs text-gray-400">Required CFM</label>
                    <input type="number" id="roomCFM" class="w-full bg-gray-700 border border-gray-600 rounded px-2 py-1 text-sm" placeholder="100">
                </div>
            </div>
            <div class="flex gap-2 mt-4">
                <button id="roomCancel" class="flex-1 bg-gray-600 hover:bg-gray-500 rounded py-1.5 text-sm">Cancel</button>
                <button id="roomSave" class="flex-1 bg-green-600 hover:bg-green-700 rounded py-1.5 text-sm">Save</button>
            </div>
        </div>
    </div>

    <!-- Hidden file input -->
    <input type="file" id="fileInput" accept=".json" class="hidden">

    <script>
        (function() {
            'use strict';
            
            const canvas = document.getElementById('designCanvas');
            const ctx = canvas.getContext('2d');

            // State
            let elements = [];
            let undoStack = [];
            let redoStack = [];
            let currentMode = 'WALL';
            let isDrawing = false;
            let startX = 0;
            let startY = 0;
            let currentElement = null;
            let selectedElement = null;
            let pendingRoomCoords = null;

            // Constants
            const GRID_SIZE = 20; // pixels per foot
            const COLORS = {
                WALL: '#6b7280',
                TRUNK: '#1d4ed8',
                SUPPLY: '#3b82f6',
                RETURN: '#f97316',
                FLEX: '#22c55e',
                REGISTER: '#06b6d4',
                RETURN_GRILLE: '#fb923c',
                DIFFUSER: '#a855f7',
                AHU: '#9333ea',
                FURNACE: '#dc2626',
                ELBOW90: '#60a5fa',
                ELBOW45: '#60a5fa',
                TEE: '#60a5fa',
                TAKEOFF: '#60a5fa',
                ROOM: '#fbbf24',
                GRID: '#374151',
                SELECTED: '#fbbf24'
            };

            // Equivalent lengths for pressure calc
            const EQUIV_LENGTHS = {
                ELBOW90: 15,
                ELBOW45: 7,
                TEE: 30,
                TAKEOFF: 35
            };

            // Resize canvas
            function resizeCanvas() {
                const container = canvas.parentElement;
                canvas.width = container.clientWidth;
                canvas.height = container.clientHeight;
                draw();
            }

            window.addEventListener('resize', resizeCanvas);
            resizeCanvas();

            // Snap to grid
            function snap(val) {
                if (!document.getElementById('snapGrid').checked) return val;
                return Math.round(val / GRID_SIZE) * GRID_SIZE;
            }

            // Get mouse/touch coordinates relative to canvas
            function getCanvasCoords(e) {
                const rect = canvas.getBoundingClientRect();
                let clientX, clientY;
                
                if (e.touches && e.touches.length > 0) {
                    clientX = e.touches[0].clientX;
                    clientY = e.touches[0].clientY;
                } else {
                    clientX = e.clientX;
                    clientY = e.clientY;
                }
                
                return {
                    x: clientX - rect.left,
                    y: clientY - rect.top
                };
            }

            // Calculate length in feet
            function calcLength(el) {
                if (!el.endX) return 0;
                const dx = el.endX - el.startX;
                const dy = el.endY - el.startY;
                return Math.sqrt(dx * dx + dy * dy) / GRID_SIZE;
            }

            // Draw grid
            function drawGrid() {
                if (!document.getElementById('showGrid').checked) return;
                
                ctx.strokeStyle = COLORS.GRID;
                ctx.lineWidth = 0.5;

                for (let x = 0; x <= canvas.width; x += GRID_SIZE) {
                    ctx.beginPath();
                    ctx.moveTo(x, 0);
                    ctx.lineTo(x, canvas.height);
                    ctx.stroke();
                }

                for (let y = 0; y <= canvas.height; y += GRID_SIZE) {
                    ctx.beginPath();
                    ctx.moveTo(0, y);
                    ctx.lineTo(canvas.width, y);
                    ctx.stroke();
                }
            }

            // Draw a single element
            function drawElement(el, isPreview) {
                const alpha = isPreview ? 0.5 : 1;
                const isSelected = el === selectedElement;

                ctx.save();
                ctx.globalAlpha = alpha;

                // Line-based elements (walls, ducts)
                if (['WALL', 'TRUNK', 'SUPPLY', 'RETURN', 'FLEX'].includes(el.type)) {
                    let color = COLORS[el.type];
                    let width = 8;
                    
                    if (el.type === 'TRUNK') width = 14;
                    else if (el.type === 'SUPPLY') width = 10;
                    else if (el.type === 'RETURN') width = 10;
                    else if (el.type === 'FLEX') width = 6;

                    ctx.strokeStyle = isSelected ? COLORS.SELECTED : color;
                    ctx.lineWidth = width;
                    ctx.lineCap = 'round';
                    ctx.beginPath();
                    ctx.moveTo(el.startX, el.startY);
                    ctx.lineTo(el.endX, el.endY);
                    ctx.stroke();

                    // Center line for ducts
                    if (el.type !== 'WALL' && el.type !== 'FLEX') {
                        ctx.strokeStyle = 'rgba(255,255,255,0.3)';
                        ctx.lineWidth = 1;
                        ctx.setLineDash([4, 4]);
                        ctx.beginPath();
                        ctx.moveTo(el.startX, el.startY);
                        ctx.lineTo(el.endX, el.endY);
                        ctx.stroke();
                        ctx.setLineDash([]);
                    }

                    // Measurement label
                    if (document.getElementById('showMeasure').checked && !isPreview) {
                        const len = calcLength(el).toFixed(1);
                        const midX = (el.startX + el.endX) / 2;
                        const midY = (el.startY + el.endY) / 2;
                        
                        ctx.fillStyle = 'white';
                        ctx.font = '10px sans-serif';
                        ctx.textAlign = 'center';
                        ctx.globalAlpha = 1;
                        ctx.fillText(len + "'", midX, midY - 10);
                        
                        if (el.size && el.type !== 'WALL') {
                            ctx.font = '8px sans-serif';
                            ctx.fillText(el.size + '"', midX, midY + 12);
                        }
                    }
                }
                // Fittings
                else if (['ELBOW90', 'ELBOW45', 'TEE', 'TAKEOFF'].includes(el.type)) {
                    const size = 12;
                    const rotation = (el.rotation || 0) * Math.PI / 180;
                    
                    ctx.translate(el.startX, el.startY);
                    ctx.rotate(rotation);
                    
                    ctx.strokeStyle = isSelected ? COLORS.SELECTED : COLORS[el.type];
                    ctx.lineWidth = 4;
                    ctx.lineCap = 'round';

                    if (el.type === 'ELBOW90') {
                        ctx.beginPath();
                        ctx.moveTo(-size, 0);
                        ctx.lineTo(0, 0);
                        ctx.lineTo(0, -size);
                        ctx.stroke();
                    } else if (el.type === 'ELBOW45') {
                        ctx.beginPath();
                        ctx.moveTo(-size, 0);
                        ctx.lineTo(0, 0);
                        ctx.lineTo(size * 0.7, -size * 0.7);
                        ctx.stroke();
                    } else if (el.type === 'TEE') {
                        ctx.beginPath();
                        ctx.moveTo(-size, 0);
                        ctx.lineTo(size, 0);
                        ctx.moveTo(0, 0);
                        ctx.lineTo(0, -size);
                        ctx.stroke();
                    } else if (el.type === 'TAKEOFF') {
                        ctx.beginPath();
                        ctx.moveTo(-size, 0);
                        ctx.lineTo(size, 0);
                        ctx.moveTo(0, 0);
                        ctx.lineTo(0, -size);
                        ctx.stroke();
                        // Add circle at takeoff point
                        ctx.beginPath();
                        ctx.arc(0, -size, 3, 0, Math.PI * 2);
                        ctx.fillStyle = ctx.strokeStyle;
                        ctx.fill();
                    }
                }
                // Terminals (registers, grilles, diffusers)
                else if (['REGISTER', 'RETURN_GRILLE', 'DIFFUSER'].includes(el.type)) {
                    const color = COLORS[el.type];
                    const size = 14;
                    
                    ctx.fillStyle = isSelected ? COLORS.SELECTED : color;
                    
                    if (el.type === 'DIFFUSER') {
                        ctx.beginPath();
                        ctx.arc(el.startX, el.startY, size / 2, 0, Math.PI * 2);
                        ctx.fill();
                    } else {
                        ctx.fillRect(el.startX - size/2, el.startY - size/2, size, size);
                    }
                    
                    // CFM label
                    if (el.cfm) {
                        ctx.fillStyle = 'white';
                        ctx.font = 'bold 8px sans-serif';
                        ctx.textAlign = 'center';
                        ctx.textBaseline = 'middle';
                        ctx.fillText(el.cfm, el.startX, el.startY);
                    }
                }
                // Equipment
                else if (el.type === 'AHU' || el.type === 'FURNACE') {
                    const width = 50;
                    const height = 35;
                    
                    ctx.fillStyle = isSelected ? COLORS.SELECTED : COLORS[el.type];
                    ctx.fillRect(el.startX - width/2, el.startY - height/2, width, height);
                    
                    ctx.strokeStyle = 'white';
                    ctx.lineWidth = 1;
                    ctx.strokeRect(el.startX - width/2, el.startY - height/2, width, height);
                    
                    ctx.fillStyle = 'white';
                    ctx.font = 'bold 9px sans-serif';
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.fillText(el.type === 'AHU' ? 'AHU' : 'FURN', el.startX, el.startY);
                }
                // Room labels
                else if (el.type === 'ROOM') {
                    ctx.fillStyle = COLORS.ROOM;
                    ctx.font = 'bold 11px sans-serif';
                    ctx.textAlign = 'center';
                    ctx.fillText(el.name || 'Room', el.startX, el.startY);
                    
                    if (el.sqft || el.cfm) {
                        ctx.font = '9px sans-serif';
                        let label = [];
                        if (el.sqft) label.push(el.sqft + ' sf');
                        if (el.cfm) label.push(el.cfm + ' CFM');
                        ctx.fillText(label.join(' | '), el.startX, el.startY + 12);
                    }
                }

                ctx.restore();
            }

            // Main draw function
            function draw() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                drawGrid();

                // Draw all saved elements
                for (let i = 0; i < elements.length; i++) {
                    drawElement(elements[i], false);
                }

                // Draw current element being created
                if (isDrawing && currentElement) {
                    drawElement(currentElement, true);
                }

                updateSummary();
            }

            // Update summary panels
            function updateSummary() {
                let trunkLen = 0, supplyLen = 0, returnLen = 0, flexLen = 0;
                let registerCount = 0, returnGrilleCount = 0, diffuserCount = 0;
                let supplyCFM = 0, returnCFM = 0;
                let elbow90Count = 0, elbow45Count = 0, teeCount = 0, takeoffCount = 0;
                
                const ductBySizeMap = {};
                const fittingsMap = {};
                const rooms = [];

                elements.forEach(el => {
                    const len = calcLength(el);
                    
                    if (el.type === 'TRUNK') {
                        trunkLen += len;
                        const key = 'Trunk ' + (el.size || '14') + '"';
                        ductBySizeMap[key] = (ductBySizeMap[key] || 0) + len;
                    }
                    if (el.type === 'SUPPLY') {
                        supplyLen += len;
                        const key = 'Supply ' + (el.size || '8') + '"';
                        ductBySizeMap[key] = (ductBySizeMap[key] || 0) + len;
                    }
                    if (el.type === 'RETURN') {
                        returnLen += len;
                        const key = 'Return ' + (el.size || '8') + '"';
                        ductBySizeMap[key] = (ductBySizeMap[key] || 0) + len;
                    }
                    if (el.type === 'FLEX') {
                        flexLen += len;
                        const key = 'Flex ' + (el.size || '6') + '"';
                        ductBySizeMap[key] = (ductBySizeMap[key] || 0) + len;
                    }

                    if (el.type === 'REGISTER') {
                        registerCount++;
                        supplyCFM += el.cfm || 0;
                    }
                    if (el.type === 'RETURN_GRILLE') {
                        returnGrilleCount++;
                        returnCFM += el.cfm || 0;
                    }
                    if (el.type === 'DIFFUSER') {
                        diffuserCount++;
                        supplyCFM += el.cfm || 0;
                    }

                    if (el.type === 'ELBOW90') {
                        elbow90Count++;
                        const key = '90¬∞ Elbow ' + (el.size || '8') + '"';
                        fittingsMap[key] = (fittingsMap[key] || 0) + 1;
                    }
                    if (el.type === 'ELBOW45') {
                        elbow45Count++;
                        const key = '45¬∞ Elbow ' + (el.size || '8') + '"';
                        fittingsMap[key] = (fittingsMap[key] || 0) + 1;
                    }
                    if (el.type === 'TEE') {
                        teeCount++;
                        const key = 'Tee ' + (el.size || '8') + '"';
                        fittingsMap[key] = (fittingsMap[key] || 0) + 1;
                    }
                    if (el.type === 'TAKEOFF') {
                        takeoffCount++;
                        const key = 'Takeoff ' + (el.size || '6') + '"';
                        fittingsMap[key] = (fittingsMap[key] || 0) + 1;
                    }

                    if (el.type === 'ROOM') {
                        rooms.push(el);
                    }
                });

                // Update summary tab
                document.getElementById('totalSupplyCFM').textContent = supplyCFM + ' CFM';
                document.getElementById('totalReturnCFM').textContent = returnCFM + ' CFM';
                
                const balance = supplyCFM - returnCFM;
                const balanceEl = document.getElementById('cfmBalance');
                balanceEl.textContent = (balance >= 0 ? '+' : '') + balance + ' CFM';
                balanceEl.className = 'font-bold ' + (balance === 0 ? 'text-green-400' : 
                                     Math.abs(balance) <= supplyCFM * 0.1 ? 'text-yellow-400' : 'text-red-400');

                document.getElementById('trunkTotal').textContent = trunkLen.toFixed(1) + ' ft';
                document.getElementById('supplyTotal').textContent = supplyLen.toFixed(1) + ' ft';
                document.getElementById('returnTotal').textContent = returnLen.toFixed(1) + ' ft';
                document.getElementById('flexTotal').textContent = flexLen.toFixed(1) + ' ft';

                document.getElementById('registerCount').textContent = registerCount;
                document.getElementById('returnGrilleCount').textContent = returnGrilleCount;
                document.getElementById('diffuserCount').textContent = diffuserCount;
                document.getElementById('elbow90Count').textContent = elbow90Count;
                document.getElementById('elbow45Count').textContent = elbow45Count;
                document.getElementById('teeCount').textContent = teeCount;
                document.getElementById('takeoffCount').textContent = takeoffCount;

                // Room list
                const roomList = document.getElementById('roomList');
                if (rooms.length === 0) {
                    roomList.innerHTML = '<div class="text-gray-500 italic">No rooms defined</div>';
                } else {
                    roomList.innerHTML = rooms.map(r => 
                        '<div class="flex justify-between"><span>' + (r.name || 'Room') + '</span><span>' + (r.cfm || 0) + ' CFM</span></div>'
                    ).join('');
                }

                // Materials tab - duct by size
                const ductBySize = document.getElementById('ductBySize');
                const ductKeys = Object.keys(ductBySizeMap);
                if (ductKeys.length === 0) {
                    ductBySize.innerHTML = '<div class="text-gray-500 italic">No ducts placed</div>';
                } else {
                    ductBySize.innerHTML = ductKeys.map(k => 
                        '<div class="flex justify-between"><span>' + k + '</span><span>' + ductBySizeMap[k].toFixed(1) + ' ft</span></div>'
                    ).join('');
                }

                // Materials tab - fittings
                const fittingsList = document.getElementById('fittingsList');
                const fittingKeys = Object.keys(fittingsMap);
                if (fittingKeys.length === 0) {
                    fittingsList.innerHTML = '<div class="text-gray-500 italic">No fittings placed</div>';
                } else {
                    fittingsList.innerHTML = fittingKeys.map(k => 
                        '<div class="flex justify-between"><span>' + k + '</span><span>√ó' + fittingsMap[k] + '</span></div>'
                    ).join('');
                }

                // Estimated materials
                const totalDuct = trunkLen + supplyLen + returnLen;
                document.getElementById('sheetMetalLbs').textContent = Math.ceil(totalDuct * 2.5) + ' lbs';
                document.getElementById('flexDuctFt').textContent = flexLen.toFixed(0) + ' ft';
                document.getElementById('hangerCount').textContent = Math.ceil(totalDuct / 4);
            }

            // Calculate static pressure
            function calculatePressure() {
                const filterDrop = parseFloat(document.getElementById('filterDrop').value) || 0.1;
                const coilDrop = parseFloat(document.getElementById('coilDrop').value) || 0.2;

                let supplyDuctLoss = 0;
                let returnDuctLoss = 0;
                let supplyFittingLoss = 0;
                let terminalLoss = 0;

                elements.forEach(el => {
                    const len = calcLength(el);
                    
                    // Duct friction (0.08" per 100 ft typical)
                    if (el.type === 'TRUNK' || el.type === 'SUPPLY') {
                        supplyDuctLoss += len * 0.08 / 100;
                    }
                    if (el.type === 'RETURN') {
                        returnDuctLoss += len * 0.08 / 100;
                    }
                    if (el.type === 'FLEX') {
                        supplyDuctLoss += len * 0.15 / 100; // Flex has higher friction
                    }

                    // Fitting equivalent lengths
                    if (EQUIV_LENGTHS[el.type]) {
                        supplyFittingLoss += EQUIV_LENGTHS[el.type] * 0.08 / 100;
                    }

                    // Terminal losses
                    if (['REGISTER', 'RETURN_GRILLE', 'DIFFUSER'].includes(el.type)) {
                        terminalLoss += 0.03;
                    }
                });

                const totalESP = filterDrop + coilDrop + supplyDuctLoss + supplyFittingLoss + 
                                returnDuctLoss + terminalLoss;

                document.getElementById('supplyLoss').textContent = supplyDuctLoss.toFixed(3);
                document.getElementById('supplyFittingLoss').textContent = supplyFittingLoss.toFixed(3);
                document.getElementById('returnLoss').textContent = returnDuctLoss.toFixed(3);
                document.getElementById('terminalLoss').textContent = terminalLoss.toFixed(3);
                document.getElementById('totalESP').textContent = totalESP.toFixed(3);
            }

            // Save state for undo
            function saveState() {
                undoStack.push(JSON.stringify(elements));
                if (undoStack.length > 50) undoStack.shift();
                redoStack = [];
            }

            // Check if element type is point-based (single click)
            function isPointElement(mode) {
                return ['REGISTER', 'RETURN_GRILLE', 'DIFFUSER', 'AHU', 'FURNACE', 
                        'ELBOW90', 'ELBOW45', 'TEE', 'TAKEOFF'].includes(mode);
            }

            // Check if element type is line-based (click and drag)
            function isLineElement(mode) {
                return ['WALL', 'TRUNK', 'SUPPLY', 'RETURN', 'FLEX'].includes(mode);
            }

            // Point near line for selection
            function pointNearLine(px, py, x1, y1, x2, y2, threshold) {
                const A = px - x1;
                const B = py - y1;
                const C = x2 - x1;
                const D = y2 - y1;

                const dot = A * C + B * D;
                const lenSq = C * C + D * D;
                let param = lenSq !== 0 ? dot / lenSq : -1;

                let xx, yy;
                if (param < 0) { xx = x1; yy = y1; }
                else if (param > 1) { xx = x2; yy = y2; }
                else { xx = x1 + param * C; yy = y1 + param * D; }

                const dx = px - xx;
                const dy = py - yy;
                return Math.sqrt(dx * dx + dy * dy) < threshold;
            }

            // Find element at coordinates
            function findElementAt(x, y) {
                for (let i = elements.length - 1; i >= 0; i--) {
                    const el = elements[i];
                    
                    if (isLineElement(el.type)) {
                        if (pointNearLine(x, y, el.startX, el.startY, el.endX, el.endY, 12)) {
                            return el;
                        }
                    } else {
                        // Point elements - check distance from center
                        const dx = x - el.startX;
                        const dy = y - el.startY;
                        if (Math.sqrt(dx * dx + dy * dy) < 20) {
                            return el;
                        }
                    }
                }
                return null;
            }

            // EVENT HANDLERS

            // Mouse/touch down
            function handlePointerDown(e) {
                e.preventDefault();
                
                const coords = getCanvasCoords(e);
                const x = snap(coords.x);
                const y = snap(coords.y);

                // Select mode
                if (currentMode === 'SELECT') {
                    selectedElement = findElementAt(coords.x, coords.y);
                    draw();
                    return;
                }

                // Room mode - show modal
                if (currentMode === 'ROOM') {
                    pendingRoomCoords = { x: x, y: y };
                    document.getElementById('roomModal').classList.add('show');
                    document.getElementById('roomName').focus();
                    return;
                }

                // Point elements - place immediately
                if (isPointElement(currentMode)) {
                    saveState();
                    
                    const newElement = {
                        type: currentMode,
                        startX: x,
                        startY: y,
                        size: document.getElementById('ductSize').value,
                        rotation: parseInt(document.getElementById('fittingRotation').value) || 0
                    };
                    
                    // Add CFM for terminals
                    if (['REGISTER', 'RETURN_GRILLE', 'DIFFUSER'].includes(currentMode)) {
                        newElement.cfm = parseInt(document.getElementById('registerCFM').value) || 100;
                    }
                    
                    elements.push(newElement);
                    draw();
                    return;
                }

                // Line elements - start drawing
                if (isLineElement(currentMode)) {
                    isDrawing = true;
                    startX = x;
                    startY = y;
                    
                    currentElement = {
                        type: currentMode,
                        startX: x,
                        startY: y,
                        endX: x,
                        endY: y,
                        size: document.getElementById('ductSize').value
                    };
                    
                    draw();
                }
            }

            // Mouse/touch move
            function handlePointerMove(e) {
                if (!isDrawing || !currentElement) return;
                e.preventDefault();

                const coords = getCanvasCoords(e);
                let x = snap(coords.x);
                let y = snap(coords.y);

                // Ortho lock
                if (document.getElementById('orthoLock').checked) {
                    const dx = Math.abs(x - startX);
                    const dy = Math.abs(y - startY);
                    if (dx > dy) {
                        y = startY;
                    } else {
                        x = startX;
                    }
                }

                currentElement.endX = x;
                currentElement.endY = y;

                // Update live measurement
                const len = calcLength(currentElement).toFixed(1);
                document.getElementById('liveLength').textContent = len;
                document.getElementById('measureDisplay').classList.remove('hidden');

                draw();
            }

            // Mouse/touch up
            function handlePointerUp(e) {
                if (!isDrawing || !currentElement) return;
                
                isDrawing = false;
                document.getElementById('measureDisplay').classList.add('hidden');

                // Only save if element has meaningful length
                const len = calcLength(currentElement);
                if (len > 0.25) {
                    saveState();
                    elements.push(currentElement);
                }

                currentElement = null;
                draw();
            }

            // Canvas event listeners
            canvas.addEventListener('mousedown', handlePointerDown);
            canvas.addEventListener('mousemove', handlePointerMove);
            document.addEventListener('mouseup', handlePointerUp);

            canvas.addEventListener('touchstart', handlePointerDown, { passive: false });
            canvas.addEventListener('touchmove', handlePointerMove, { passive: false });
            document.addEventListener('touchend', handlePointerUp);

            // Tool selection
            document.querySelectorAll('[data-mode]').forEach(btn => {
                btn.addEventListener('click', function() {
                    currentMode = this.dataset.mode;
                    document.getElementById('currentMode').textContent = currentMode;
                    
                    // Update active button
                    document.querySelectorAll('[data-mode]').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    
                    // Update cursor
                    canvas.style.cursor = currentMode === 'SELECT' ? 'default' : 'crosshair';
                    
                    selectedElement = null;
                    draw();
                });
            });

            // Tab switching
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
                    document.getElementById('tab-' + this.dataset.tab).classList.remove('hidden');
                });
            });

            // Room modal handlers
            document.getElementById('roomSave').addEventListener('click', function() {
                if (!pendingRoomCoords) return;
                
                saveState();
                elements.push({
                    type: 'ROOM',
                    startX: pendingRoomCoords.x,
                    startY: pendingRoomCoords.y,
                    name: document.getElementById('roomName').value || 'Room',
                    sqft: parseInt(document.getElementById('roomSqft').value) || null,
                    cfm: parseInt(document.getElementById('roomCFM').value) || null
                });
                
                document.getElementById('roomModal').classList.remove('show');
                document.getElementById('roomName').value = '';
                document.getElementById('roomSqft').value = '';
                document.getElementById('roomCFM').value = '';
                pendingRoomCoords = null;
                draw();
            });

            document.getElementById('roomCancel').addEventListener('click', function() {
                document.getElementById('roomModal').classList.remove('show');
                pendingRoomCoords = null;
            });

            // Undo
            document.getElementById('btnUndo').addEventListener('click', function() {
                if (undoStack.length === 0) return;
                redoStack.push(JSON.stringify(elements));
                elements = JSON.parse(undoStack.pop());
                selectedElement = null;
                draw();
            });

            // Redo
            document.getElementById('btnRedo').addEventListener('click', function() {
                if (redoStack.length === 0) return;
                undoStack.push(JSON.stringify(elements));
                elements = JSON.parse(redoStack.pop());
                draw();
            });

            // Clear
            document.getElementById('btnClear').addEventListener('click', function() {
                if (elements.length === 0) return;
                if (confirm('Clear all elements?')) {
                    saveState();
                    elements = [];
                    selectedElement = null;
                    draw();
                }
            });

            // Save
            document.getElementById('btnSave').addEventListener('click', function() {
                const data = JSON.stringify({ elements: elements, version: 1 });
                const blob = new Blob([data], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'ductwork-design.json';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            });

            // Load
            document.getElementById('btnLoad').addEventListener('click', function() {
                document.getElementById('fileInput').click();
            });

            document.getElementById('fileInput').addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = function(evt) {
                    try {
                        const data = JSON.parse(evt.target.result);
                        if (data.elements) {
                            saveState();
                            elements = data.elements;
                            draw();
                        }
                    } catch (err) {
                        alert('Invalid file format');
                    }
                };
                reader.readAsText(file);
                e.target.value = '';
            });

            // Export PNG
            document.getElementById('btnExport').addEventListener('click', function() {
                const exportCanvas = document.createElement('canvas');
                exportCanvas.width = canvas.width;
                exportCanvas.height = canvas.height;
                const exportCtx = exportCanvas.getContext('2d');
                
                // White background
                exportCtx.fillStyle = 'white';
                exportCtx.fillRect(0, 0, exportCanvas.width, exportCanvas.height);
                exportCtx.drawImage(canvas, 0, 0);
                
                const url = exportCanvas.toDataURL('image/png');
                const a = document.createElement('a');
                a.href = url;
                a.download = 'ductwork-design.png';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
            });

            // Calculate pressure button
            document.getElementById('calcPressure').addEventListener('click', calculatePressure);

            // Keyboard shortcuts
            document.addEventListener('keydown', function(e) {
                // Ignore if typing in input
                if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
                
                if (e.ctrlKey && e.key === 'z') {
                    e.preventDefault();
                    document.getElementById('btnUndo').click();
                }
                if (e.ctrlKey && e.key === 'y') {
                    e.preventDefault();
                    document.getElementById('btnRedo').click();
                }
                if (e.key === 'Delete' || e.key === 'Backspace') {
                    if (selectedElement && currentMode === 'SELECT') {
                        e.preventDefault();
                        saveState();
                        elements = elements.filter(el => el !== selectedElement);
                        selectedElement = null;
                        draw();
                    }
                }
                if (e.key === 'Escape') {
                    selectedElement = null;
                    isDrawing = false;
                    currentElement = null;
                    document.getElementById('roomModal').classList.remove('show');
                    draw();
                }
            });

            // Settings changes trigger redraw
            ['snapGrid', 'showGrid', 'showMeasure', 'orthoLock'].forEach(function(id) {
                document.getElementById(id).addEventListener('change', draw);
            });

            // Initial draw
            draw();
            
            console.log('HVAC Ductwork Designer initialized');
        })();
    </script>
</body>
</html>