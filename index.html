<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <meta name="description" content="Field Buddy Pro v4.0 - Professional HVAC Field Service Management">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <title>Field Buddy Pro v4.0 - Professional Edition</title>

    <!-- CDN Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.1.7/dist/signature_pad.umd.min.js"></script>

    <style>
        /* ==================== LIGHT THEME DESIGN SYSTEM ==================== */
        :root {
            /* Light Theme Colors */
            --bg-primary: #F8FAFC;
            --bg-secondary: #FFFFFF;
            --bg-tertiary: #F1F5F9;
            --bg-elevated: #FFFFFF;
            --bg-hover: #E2E8F0;

            /* Accent Colors */
            --accent-primary: #3B82F6;
            --accent-primary-dark: #2563EB;
            --accent-primary-light: #DBEAFE;
            --accent-secondary: #64748B;

            /* Status Colors */
            --success: #10B981;
            --success-light: #D1FAE5;
            --warning: #F59E0B;
            --warning-light: #FEF3C7;
            --danger: #EF4444;
            --danger-light: #FEE2E2;
            --info: #3B82F6;
            --info-light: #DBEAFE;

            /* Text Colors */
            --text-primary: #1E293B;
            --text-secondary: #475569;
            --text-tertiary: #94A3B8;
            --text-inverse: #FFFFFF;

            /* Borders */
            --border-light: #E2E8F0;
            --border-medium: #CBD5E1;
            --border-dark: #94A3B8;

            /* Shadows */
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px -1px rgba(0, 0, 0, 0.1);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.1);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1);

            /* Spacing */
            --spacing-xs: 4px;
            --spacing-sm: 8px;
            --spacing-md: 12px;
            --spacing-lg: 16px;
            --spacing-xl: 24px;
            --spacing-2xl: 32px;
            --spacing-3xl: 48px;

            /* Transitions */
            --transition-fast: 0.15s ease;
            --transition: 0.2s ease;
            --transition-slow: 0.3s ease;

            /* Border Radius */
            --radius-sm: 6px;
            --radius: 8px;
            --radius-lg: 12px;
            --radius-xl: 16px;
        }

        /* ==================== RESET & BASE ==================== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            font-size: 14px;
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-tertiary);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border-medium);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--accent-secondary);
        }

        /* ==================== LAYOUT ==================== */
        .app-container {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar */
        .sidebar {
            width: 260px;
            background: var(--bg-secondary);
            border-right: 1px solid var(--border-light);
            height: 100vh;
            position: fixed;
            left: 0;
            top: 0;
            overflow-y: auto;
            z-index: 100;
            transition: transform var(--transition-slow);
        }

        .sidebar-header {
            padding: var(--spacing-xl);
            border-bottom: 1px solid var(--border-light);
        }

        .sidebar-logo {
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
        }

        .sidebar-logo-icon {
            width: 40px;
            height: 40px;
            background: var(--accent-primary);
            border-radius: var(--radius-lg);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        .sidebar-title {
            font-size: 16px;
            font-weight: 700;
            color: var(--text-primary);
        }

        .sidebar-version {
            font-size: 11px;
            color: var(--text-tertiary);
            font-weight: 500;
        }

        .sidebar-nav {
            padding: var(--spacing-lg) 0;
        }

        .nav-section {
            margin-bottom: var(--spacing-lg);
        }

        .nav-section-title {
            padding: var(--spacing-sm) var(--spacing-xl);
            font-size: 11px;
            font-weight: 600;
            color: var(--text-tertiary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
            padding: var(--spacing-md) var(--spacing-xl);
            color: var(--text-secondary);
            cursor: pointer;
            transition: var(--transition);
            border-left: 3px solid transparent;
            font-size: 14px;
            font-weight: 500;
        }

        .nav-item:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .nav-item.active {
            background: var(--accent-primary-light);
            color: var(--accent-primary);
            border-left-color: var(--accent-primary);
            font-weight: 600;
        }

        .nav-icon {
            font-size: 18px;
            width: 24px;
            text-align: center;
        }

        /* Main Content */
        .main-content {
            margin-left: 260px;
            flex: 1;
            min-height: 100vh;
            background: var(--bg-primary);
        }

        /* Header */
        .top-header {
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-light);
            padding: 0 var(--spacing-xl);
            height: 64px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            z-index: 50;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: var(--spacing-lg);
        }

        .menu-toggle {
            display: none;
            width: 40px;
            height: 40px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-light);
            border-radius: var(--radius);
            cursor: pointer;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            color: var(--text-primary);
            transition: var(--transition);
        }

        .menu-toggle:hover {
            background: var(--bg-hover);
        }

        .header-title {
            font-size: 20px;
            font-weight: 700;
            color: var(--text-primary);
        }

        .header-user {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            padding: var(--spacing-sm) var(--spacing-md);
            background: var(--bg-tertiary);
            border-radius: var(--radius-lg);
            font-size: 13px;
            font-weight: 500;
        }

        .user-avatar {
            width: 32px;
            height: 32px;
            background: var(--accent-primary);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
            font-size: 12px;
        }

        .workspace {
            padding: var(--spacing-xl);
            max-width: 1400px;
            margin: 0 auto;
        }

        /* ==================== DASHBOARD GRID ==================== */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: var(--spacing-lg);
            margin-bottom: var(--spacing-2xl);
        }

        .dashboard-tile {
            background: var(--bg-secondary);
            border: 1px solid var(--border-light);
            border-radius: var(--radius-xl);
            padding: var(--spacing-xl);
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            flex-direction: column;
        }

        .dashboard-tile:hover {
            border-color: var(--accent-primary);
            box-shadow: var(--shadow-md);
            transform: translateY(-2px);
        }

        .tile-header {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            margin-bottom: var(--spacing-md);
        }

        .tile-icon {
            width: 48px;
            height: 48px;
            border-radius: var(--radius-lg);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            background: var(--accent-primary-light);
        }

        .tile-icon.orange { background: var(--warning-light); }
        .tile-icon.green { background: var(--success-light); }
        .tile-icon.purple { background: #F3E8FF; }

        .tile-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            background: var(--accent-primary-light);
            color: var(--accent-primary);
        }

        .tile-title {
            font-size: 16px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: var(--spacing-xs);
        }

        .tile-description {
            font-size: 13px;
            color: var(--text-secondary);
            line-height: 1.5;
            flex: 1;
        }

        .tile-stats {
            display: flex;
            gap: var(--spacing-lg);
            margin-top: var(--spacing-lg);
            padding-top: var(--spacing-lg);
            border-top: 1px solid var(--border-light);
        }

        .tile-stat-value {
            font-size: 18px;
            font-weight: 700;
            color: var(--accent-primary);
            display: block;
        }

        .tile-stat-label {
            font-size: 11px;
            color: var(--text-tertiary);
            text-transform: uppercase;
        }

        /* ==================== CARDS ==================== */
        .card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-light);
            border-radius: var(--radius-xl);
            margin-bottom: var(--spacing-lg);
            overflow: hidden;
        }

        .card-header {
            padding: var(--spacing-lg) var(--spacing-xl);
            border-bottom: 1px solid var(--border-light);
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: var(--bg-tertiary);
        }

        .card-title {
            font-size: 15px;
            font-weight: 700;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }

        .card-body {
            padding: var(--spacing-xl);
        }

        .card-section {
            margin-bottom: var(--spacing-xl);
        }

        .card-section:last-child {
            margin-bottom: 0;
        }

        .section-title {
            font-size: 12px;
            font-weight: 700;
            color: var(--accent-primary);
            margin-bottom: var(--spacing-md);
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }/* ==================== FORMS ==================== */
        .form-grid {
            display: grid;
            gap: var(--spacing-lg);
        }

        .form-grid-2 { grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); }
        .form-grid-3 { grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); }
        .form-grid-4 { grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); }

        .form-group {
            position: relative;
        }

        label {
            display: block;
            font-size: 12px;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: var(--spacing-xs);
        }

        .help-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 14px;
            height: 14px;
            background: var(--accent-primary);
            color: white;
            border-radius: 50%;
            font-size: 9px;
            font-weight: 700;
            cursor: help;
            margin-left: 4px;
        }

        .help-icon:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 0;
            background: var(--text-primary);
            color: white;
            padding: 8px 12px;
            border-radius: var(--radius);
            font-size: 11px;
            font-weight: normal;
            white-space: nowrap;
            z-index: 1000;
            margin-bottom: 4px;
        }

        input, select, textarea {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--border-medium);
            border-radius: var(--radius);
            font-size: 14px;
            font-family: inherit;
            background: var(--bg-secondary);
            color: var(--text-primary);
            transition: var(--transition);
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px var(--accent-primary-light);
        }

        input[readonly] {
            background: var(--bg-tertiary);
            color: var(--text-secondary);
        }

        input.warning {
            border-color: var(--warning);
            background: var(--warning-light);
        }

        input.error {
            border-color: var(--danger);
            background: var(--danger-light);
        }

        textarea {
            resize: vertical;
            min-height: 80px;
        }

        /* ==================== BUTTONS ==================== */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: var(--spacing-sm);
            padding: 10px 16px;
            border: none;
            border-radius: var(--radius);
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            min-height: 40px;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-primary {
            background: var(--accent-primary);
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            background: var(--accent-primary-dark);
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-success:hover:not(:disabled) {
            background: #059669;
        }

        .btn-warning {
            background: var(--warning);
            color: white;
        }

        .btn-warning:hover:not(:disabled) {
            background: #D97706;
        }

        .btn-secondary {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border: 1px solid var(--border-medium);
        }

        .btn-secondary:hover:not(:disabled) {
            background: var(--bg-hover);
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-danger:hover:not(:disabled) {
            background: #DC2626;
        }

        .btn-group {
            display: flex;
            gap: var(--spacing-sm);
            flex-wrap: wrap;
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 12px;
            min-height: 32px;
        }

        /* ==================== SERVICE MODE SELECTOR ==================== */
        .service-mode-selector {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: var(--spacing-md);
            padding: var(--spacing-lg);
            background: var(--bg-secondary);
            border: 1px solid var(--border-light);
            border-radius: var(--radius-xl);
            margin-bottom: var(--spacing-xl);
        }

        .mode-option {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: var(--spacing-lg);
            border-radius: var(--radius-lg);
            cursor: pointer;
            transition: var(--transition);
            border: 2px solid var(--border-light);
            background: var(--bg-tertiary);
        }

        .mode-option:hover {
            border-color: var(--accent-primary);
        }

        .mode-option.active {
            background: var(--accent-primary);
            color: white;
            border-color: var(--accent-primary-dark);
        }

        .mode-option-icon {
            font-size: 28px;
            margin-bottom: var(--spacing-sm);
        }

        .mode-option-label {
            font-weight: 600;
            font-size: 13px;
        }

        /* ==================== BADGES ==================== */
        .badge {
            display: inline-flex;
            align-items: center;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
        }

        .badge-success {
            background: var(--success-light);
            color: var(--success);
        }

        .badge-warning {
            background: var(--warning-light);
            color: #B45309;
        }

        .badge-danger {
            background: var(--danger-light);
            color: var(--danger);
        }

        .badge-info {
            background: var(--info-light);
            color: var(--info);
        }

        /* ==================== QUALITY DASHBOARD ==================== */
        .quality-dashboard {
            background: var(--accent-primary);
            border-radius: var(--radius-xl);
            padding: var(--spacing-xl);
            margin-bottom: var(--spacing-xl);
            color: white;
        }

        .quality-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: var(--spacing-lg);
        }

        .quality-header span:first-child {
            font-size: 16px;
            font-weight: 700;
        }

        .quality-score-large {
            font-size: 48px;
            font-weight: 700;
            text-align: center;
            margin: var(--spacing-lg) 0;
        }

        .quality-metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: var(--spacing-md);
        }

        .quality-metric {
            background: rgba(255, 255, 255, 0.15);
            border-radius: var(--radius-lg);
            padding: var(--spacing-md);
            text-align: center;
        }

        .metric-value {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 2px;
        }

        .metric-label {
            font-size: 10px;
            opacity: 0.9;
            text-transform: uppercase;
        }

        /* ==================== DIAGNOSTIC PANEL ==================== */
        .diagnostic-panel {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-light);
            border-radius: var(--radius-xl);
            padding: var(--spacing-xl);
            margin: var(--spacing-xl) 0;
        }

        .diagnostic-header {
            font-size: 16px;
            font-weight: 700;
            margin-bottom: var(--spacing-lg);
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }

        .diagnostic-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-light);
            border-radius: var(--radius-lg);
            padding: var(--spacing-lg);
            margin-bottom: var(--spacing-md);
        }

        .diagnostic-card:last-child {
            margin-bottom: 0;
        }

        .diagnostic-card.success {
            border-left: 4px solid var(--success);
            background: var(--success-light);
        }

        .diagnostic-card.warning {
            border-left: 4px solid var(--warning);
            background: var(--warning-light);
        }

        .diagnostic-card.danger {
            border-left: 4px solid var(--danger);
            background: var(--danger-light);
        }

        .diagnostic-card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: var(--spacing-sm);
        }

        .diagnostic-card-title {
            font-weight: 700;
            font-size: 14px;
            color: var(--text-primary);
        }

        .diagnostic-recommendations {
            margin-top: var(--spacing-md);
            padding-top: var(--spacing-md);
            border-top: 1px solid var(--border-light);
        }

        .diagnostic-recommendations ul {
            margin: var(--spacing-sm) 0;
            padding-left: var(--spacing-xl);
            font-size: 12px;
        }

        .diagnostic-recommendations li {
            margin: var(--spacing-xs) 0;
            color: var(--text-secondary);
        }

        /* ==================== PHOTO GALLERY ==================== */
        .photo-gallery {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: var(--spacing-md);
        }

        .photo-item {
            position: relative;
            aspect-ratio: 1;
            border-radius: var(--radius-lg);
            overflow: hidden;
            border: 2px solid var(--border-light);
            cursor: pointer;
            transition: var(--transition);
        }

        .photo-item:hover {
            border-color: var(--accent-primary);
        }

        .photo-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .photo-item-actions {
            position: absolute;
            top: 4px;
            right: 4px;
            opacity: 0;
            transition: var(--transition);
        }

        .photo-item:hover .photo-item-actions {
            opacity: 1;
        }

        .photo-btn {
            width: 28px;
            height: 28px;
            border-radius: var(--radius);
            border: none;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
        }

        .photo-upload {
            aspect-ratio: 1;
            border: 2px dashed var(--border-medium);
            border-radius: var(--radius-lg);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            background: var(--bg-tertiary);
            transition: var(--transition);
            font-size: 12px;
            color: var(--text-tertiary);
        }

        .photo-upload:hover {
            border-color: var(--accent-primary);
            background: var(--accent-primary-light);
        }

        .photo-upload span:first-child {
            font-size: 24px;
            margin-bottom: var(--spacing-xs);
        }

        /* ==================== SIGNATURE PAD ==================== */
        .signature-pad {
            width: 100%;
            height: 150px;
            border: 2px solid var(--border-medium);
            border-radius: var(--radius-lg);
            cursor: crosshair;
            background: var(--bg-tertiary);
        }

        /* ==================== CHART CONTAINER ==================== */
        .chart-container {
            height: 250px;
            margin: var(--spacing-lg) 0;
            padding: var(--spacing-md);
            background: var(--bg-tertiary);
            border-radius: var(--radius-lg);
        }

        /* ==================== CHECKLIST ==================== */
        .checklist-item {
            display: flex;
            align-items: flex-start;
            padding: var(--spacing-md);
            background: var(--bg-tertiary);
            border: 1px solid var(--border-light);
            border-radius: var(--radius);
            margin-bottom: var(--spacing-sm);
            cursor: pointer;
            transition: var(--transition);
        }

        .checklist-item:hover {
            background: var(--bg-hover);
        }

        .checklist-item.checked {
            background: var(--success-light);
            border-color: var(--success);
        }

        input[type="checkbox"] {
            width: 18px;
            height: 18px;
            margin-right: var(--spacing-md);
            accent-color: var(--accent-primary);
            cursor: pointer;
            flex-shrink: 0;
        }

        .checklist-item label {
            margin: 0;
            cursor: pointer;
            font-weight: 400;
            font-size: 13px;
            color: var(--text-secondary);
        }/* ==================== MATERIALS CATALOG ==================== */
        .materials-category {
            margin-bottom: var(--spacing-md);
            border: 1px solid var(--border-light);
            border-radius: var(--radius-lg);
            overflow: hidden;
            background: var(--bg-secondary);
        }

        .category-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: var(--spacing-lg);
            background: var(--bg-tertiary);
            cursor: pointer;
            user-select: none;
            transition: var(--transition);
        }

        .category-header:hover {
            background: var(--bg-hover);
        }

        .category-title-group {
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
        }

        .category-icon {
            font-size: 20px;
        }

        .category-name {
            font-weight: 700;
            font-size: 14px;
            color: var(--text-primary);
        }

        .category-meta {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }

        .category-count {
            font-size: 11px;
            color: var(--text-tertiary);
            background:background: var(--bg-secondary);
            padding: 4px 8px;
            border-radius: 10px;
            font-weight: 500;
        }

        .category-selected {
            font-size: 11px;
            color: white;
            background: var(--accent-primary);
            padding: 4px 8px;
            border-radius: 10px;
            font-weight: 600;
        }

        .category-arrow {
            transition: transform 0.3s ease;
            color: var(--text-tertiary);
            font-size: 12px;
        }

        .materials-category.expanded .category-arrow {
            transform: rotate(180deg);
        }

        .category-items {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .materials-category.expanded .category-items {
            max-height: 5000px;
        }

        .material-item {
            display: flex;
            align-items: center;
            padding: var(--spacing-md) var(--spacing-lg);
            border-top: 1px solid var(--border-light);
            transition: var(--transition);
        }

        .material-item:hover {
            background: var(--bg-tertiary);
        }

        .material-info {
            flex: 1;
            margin-left: var(--spacing-sm);
        }

        .material-name {
            font-weight: 600;
            font-size: 13px;
            color: var(--text-primary);
        }

        .material-spec {
            font-size: 11px;
            color: var(--text-tertiary);
            margin-top: 2px;
        }

        /* ==================== SELECTED MATERIALS ==================== */
        .selected-material {
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
            padding: var(--spacing-md);
            background: var(--bg-tertiary);
            border: 1px solid var(--border-light);
            border-radius: var(--radius);
            margin-bottom: var(--spacing-sm);
        }

        .selected-material-info {
            flex: 1;
        }

        .selected-material-controls {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }

        .selected-material-controls select,
        .selected-material-controls input {
            padding: 6px 10px;
            font-size: 12px;
        }

        .selected-material-controls select {
            width: 120px;
        }

        .selected-material-controls input {
            width: 60px;
            text-align: center;
        }

        /* ==================== STATUS CARDS ==================== */
        .status-card {
            padding: var(--spacing-lg);
            border-radius: var(--radius-lg);
            font-size: 13px;
            line-height: 1.5;
            margin-bottom: var(--spacing-md);
        }

        .status-card.success {
            background: var(--success-light);
            color: #065F46;
        }

        .status-card.warning {
            background: var(--warning-light);
            color: #92400E;
        }

        .status-card.danger {
            background: var(--danger-light);
            color: #991B1B;
        }

        .status-card.info {
            background: var(--info-light);
            color: #1E40AF;
        }

        /* ==================== CALCULATOR TABS ==================== */
        .calculator-tabs {
            display: flex;
            gap: 4px;
            background: var(--bg-tertiary);
            padding: 4px;
            border-radius: var(--radius-lg);
            margin-bottom: var(--spacing-xl);
        }

        .calculator-tab {
            flex: 1;
            padding: 10px 16px;
            border: none;
            background: transparent;
            border-radius: var(--radius);
            font-weight: 600;
            font-size: 13px;
            cursor: pointer;
            transition: var(--transition);
            color: var(--text-secondary);
        }

        .calculator-tab.active {
            background: var(--bg-secondary);
            box-shadow: var(--shadow-sm);
            color: var(--accent-primary);
        }

        .calculator-tab:hover:not(.active) {
            color: var(--text-primary);
        }

        .calculator-section {
            display: none;
        }

        .calculator-section.active {
            display: block;
        }

        /* ==================== DUCT SIZE VISUAL ==================== */
        .duct-size-visual {
            display: flex;
            align-items: center;
            gap: var(--spacing-xl);
            padding: var(--spacing-xl);
            background: var(--bg-tertiary);
            border-radius: var(--radius-lg);
            margin-top: var(--spacing-lg);
        }

        .duct-circle {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            border: 4px solid var(--accent-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            font-weight: 700;
            color: var(--accent-primary);
            flex-shrink: 0;
        }

        .duct-info-primary {
            font-size: 18px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .duct-info-secondary {
            font-size: 13px;
            color: var(--text-secondary);
        }

        /* ==================== DUCT DESIGN TREE ==================== */
        .duct-tree {
            font-family: 'Courier New', monospace;
            font-size: 12px;
            background: var(--bg-tertiary);
            padding: var(--spacing-lg);
            border-radius: var(--radius-lg);
            line-height: 1.8;
            overflow-x: auto;
            color: var(--text-secondary);
        }

        .duct-branch {
            margin-left: 20px;
            padding: 2px 0;
        }

        .duct-trunk {
            font-weight: 700;
            color: var(--accent-primary);
        }

        /* ==================== INFO BOX ==================== */
        .info-box {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-light);
            border-radius: var(--radius-lg);
            padding: var(--spacing-lg);
            margin: var(--spacing-md) 0;
        }

        .info-box-title {
            font-weight: 700;
            font-size: 13px;
            color: var(--accent-primary);
            margin-bottom: var(--spacing-sm);
        }

        .info-box-content {
            font-size: 13px;
            color: var(--text-secondary);
        }

        /* ==================== REPORT OUTPUT ==================== */
        .report-output {
            background: var(--bg-secondary);
            border: 1px solid var(--border-light);
            border-radius: var(--radius-xl);
            overflow: hidden;
            margin-top: var(--spacing-xl);
        }

        .report-header {
            background: var(--accent-primary);
            color: white;
            padding: var(--spacing-xl);
            text-align: center;
        }

        .report-header-title {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .report-header-subtitle {
            font-size: 12px;
            opacity: 0.9;
        }

        .report-section {
            padding: var(--spacing-lg) var(--spacing-xl);
            border-bottom: 1px solid var(--border-light);
        }

        .report-section:last-child {
            border-bottom: none;
        }

        .report-section-title {
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-tertiary);
            margin-bottom: var(--spacing-md);
        }

        .report-row {
            display: flex;
            justify-content: space-between;
            padding: 6px 0;
            font-size: 13px;
        }

        .report-row-label {
            color: var(--text-secondary);
        }

        .report-row-value {
            font-weight: 600;
            color: var(--text-primary);
        }

        .report-actions {
            padding: var(--spacing-lg) var(--spacing-xl);
            background: var(--bg-tertiary);
            display: flex;
            gap: var(--spacing-sm);
            justify-content: center;
        }

        /* ==================== TOAST ==================== */
        .toast {
            position: fixed;
            bottom: 24px;
            right: 24px;
            background: var(--text-primary);
            color: white;
            padding: var(--spacing-md) var(--spacing-xl);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-xl);
            z-index: 9999;
            font-size: 13px;
            font-weight: 500;
            opacity: 0;
            transform: translateY(10px);
            transition: var(--transition);
        }

        .toast.show {
            opacity: 1;
            transform: translateY(0);
        }

        .toast.success {
            background: var(--success);
        }

        .toast.danger {
            background: var(--danger);
        }

        .toast.warning {
            background: var(--warning);
        }

        /* ==================== MODAL ==================== */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            padding: var(--spacing-xl);
        }

        .modal-overlay.show {
            display: flex;
        }

        .modal {
            background: var(--bg-secondary);
            border-radius: var(--radius-xl);
            padding: var(--spacing-xl);
            max-width: 400px;
            width: 100%;
            box-shadow: var(--shadow-xl);
        }

        .modal-title {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: var(--spacing-md);
            color: var(--text-primary);
        }

        .modal-content {
            color: var(--text-secondary);
            margin-bottom: var(--spacing-xl);
            font-size: 14px;
        }

        .modal-actions {
            display: flex;
            gap: var(--spacing-sm);
            justify-content: flex-end;
        }

        /* ==================== MOBILE OVERLAY ==================== */
        .mobile-menu-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 99;
        }

        .mobile-menu-overlay.show {
            display: block;
        }

        /* ==================== UTILITIES ==================== */
        .hidden { display: none !important; }
        .mt-lg { margin-top: var(--spacing-lg); }
        .mb-lg { margin-bottom: var(--spacing-lg); }

        /* ==================== RESPONSIVE ==================== */
        @media (max-width: 1024px) {
            .sidebar {
                transform: translateX(-100%);
            }

            .sidebar.mobile-open {
                transform: translateX(0);
            }

            .main-content {
                margin-left: 0;
            }

            .menu-toggle {
                display: flex;
            }

            .service-mode-selector {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .workspace {
                padding: var(--spacing-lg);
            }

            .top-header {
                padding: 0 var(--spacing-lg);
            }

            .header-title {
                font-size: 16px;
            }

            .quality-metrics {
                grid-template-columns: repeat(2, 1fr);
            }

            .dashboard-grid {
                grid-template-columns: 1fr;
            }

            .form-grid-2,
            .form-grid-3,
            .form-grid-4 {
                grid-template-columns: 1fr;
            }

            .btn {
                min-height: 44px;
            }

            input, select, textarea {
                min-height: 44px;
                font-size: 16px;
            }
        }
    </style>
</head>

<body>
    <div class="app-container">
        <!-- MOBILE MENU OVERLAY -->
        <div class="mobile-menu-overlay" id="mobile-menu-overlay" onclick="toggleMobileMenu()"></div>

        <!-- SIDEBAR -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-logo">
                    <div class="sidebar-logo-icon">üîß</div>
                    <div>
                        <div class="sidebar-title">Field Buddy Pro</div>
                        <div class="sidebar-version">v4.0 Professional</div>
                    </div>
                </div>
            </div>

            <nav class="sidebar-nav">
                <div class="nav-section">
                    <div class="nav-section-title">Navigation</div>
                    <div class="nav-item active" onclick="switchPage('dashboard')">
                        <span class="nav-icon">üè†</span>
                        <span>Dashboard</span>
                    </div>
                    <div class="nav-item" onclick="switchPage('service')">
                        <span class="nav-icon">üìã</span>
                        <span>Service Calls</span>
                    </div>
                    <div class="nav-item" onclick="switchPage('materials')">
                        <span class="nav-icon">üì¶</span>
                        <span>Materials</span>
                    </div>
                    <div class="nav-item" onclick="switchPage('duct-design')">
                        <span class="nav-icon">üèóÔ∏è</span>
                        <span>Duct Design</span>
                    </div>
                    <div class="nav-item" onclick="switchPage('cfm')">
                        <span class="nav-icon">üå™Ô∏è</span>
                        <span>CFM Calculator</span>
                    </div>
                    <div class="nav-item" onclick="switchPage('history')">
                        <span class="nav-icon">üìä</span>
                        <span>History</span>
                    </div>
                </div>

                <div class="nav-section">
                    <div class="nav-section-title">Actions</div>
                    <div class="nav-item" onclick="saveData()">
                        <span class="nav-icon">üíæ</span>
                        <span>Save Progress</span>
                    </div>
                    <div class="nav-item" onclick="loadData()">
                        <span class="nav-icon">üì•</span>
                        <span>Load Data</span>
                    </div>
                    <div class="nav-item" onclick="exportAllData()">
                        <span class="nav-icon">üì§</span>
                        <span>Export All</span>
                    </div>
                </div>
            </nav>
        </aside><!-- MAIN CONTENT -->
        <main class="main-content">
            <!-- HEADER -->
            <header class="top-header">
                <div class="header-left">
                    <button class="menu-toggle" onclick="toggleMobileMenu()">‚ò∞</button>
                    <div class="header-title" id="page-title">Dashboard</div>
                </div>
                <div class="header-user">
                    <div class="user-avatar">MP</div>
                    <span>Mart√≠n Perez</span>
                </div>
            </header>

            <!-- WORKSPACE -->
            <div class="workspace">
                <!-- DASHBOARD PAGE -->
                <div id="dashboard-page" class="page-content">
                    <div style="margin-bottom: var(--spacing-xl);">
                        <h1 style="font-size: 24px; font-weight: 700; margin-bottom: var(--spacing-xs); color: var(--text-primary);">
                            Welcome back, Mart√≠n üëã
                        </h1>
                        <p style="color: var(--text-secondary); font-size: 14px;">
                            Professional HVAC field service management
                        </p>
                    </div>

                    <div class="dashboard-grid">
                        <div class="dashboard-tile" onclick="switchPage('service')">
                            <div class="tile-header">
                                <div class="tile-icon">üìã</div>
                                <div class="tile-badge">Pro</div>
                            </div>
                            <div class="tile-title">Service Calls</div>
                            <div class="tile-description">
                                Complete diagnostics with refrigerant calculations and professional reporting
                            </div>
                            <div class="tile-stats">
                                <div>
                                    <span class="tile-stat-value" id="dash-stat-reports">0</span>
                                    <span class="tile-stat-label">Reports</span>
                                </div>
                                <div>
                                    <span class="tile-stat-value" id="dash-stat-quality">0%</span>
                                    <span class="tile-stat-label">Avg Quality</span>
                                </div>
                            </div>
                        </div>

                        <div class="dashboard-tile" onclick="switchPage('materials')">
                            <div class="tile-header">
                                <div class="tile-icon orange">üì¶</div>
                                <div class="tile-badge">Pro</div>
                            </div>
                            <div class="tile-title">Materials Catalog</div>
                            <div class="tile-description">
                                Comprehensive 2025 materials database with instant lookup
                            </div>
                            <div class="tile-stats">
                                <div>
                                    <span class="tile-stat-value">1000+</span>
                                    <span class="tile-stat-label">Items</span>
                                </div>
                                <div>
                                    <span class="tile-stat-value">12</span>
                                    <span class="tile-stat-label">Categories</span>
                                </div>
                            </div>
                        </div>

                        <div class="dashboard-tile" onclick="switchPage('duct-design')">
                            <div class="tile-header">
                                <div class="tile-icon purple">üèóÔ∏è</div>
                                <div class="tile-badge">Pro</div>
                            </div>
                            <div class="tile-title">Duct Design</div>
                            <div class="tile-description">
                                ACCA Manual D compliant design with material takeoffs
                            </div>
                            <div class="tile-stats">
                                <div>
                                    <span class="tile-stat-value">‚úì</span>
                                    <span class="tile-stat-label">ACCA</span>
                                </div>
                                <div>
                                    <span class="tile-stat-value">Auto</span>
                                    <span class="tile-stat-label">Takeoff</span>
                                </div>
                            </div>
                        </div>

                        <div class="dashboard-tile" onclick="switchPage('cfm')">
                            <div class="tile-header">
                                <div class="tile-icon green">üå™Ô∏è</div>
                                <div class="tile-badge">Pro</div>
                            </div>
                            <div class="tile-title">CFM Calculator</div>
                            <div class="tile-description">
                                Professional airflow and duct sizing calculations
                            </div>
                            <div class="tile-stats">
                                <div>
                                    <span class="tile-stat-value">4</span>
                                    <span class="tile-stat-label">Methods</span>
                                </div>
                                <div>
                                    <span class="tile-stat-value">Instant</span>
                                    <span class="tile-stat-label">Results</span>
                                </div>
                            </div>
                        </div>

                        <div class="dashboard-tile" onclick="switchPage('history')">
                            <div class="tile-header">
                                <div class="tile-icon orange">üìä</div>
                                <div class="tile-badge">Pro</div>
                            </div>
                            <div class="tile-title">History & Reports</div>
                            <div class="tile-description">
                                Access saved reports and track service statistics
                            </div>
                            <div class="tile-stats">
                                <div>
                                    <span class="tile-stat-value" id="dash-stat-total">0</span>
                                    <span class="tile-stat-label">Total</span>
                                </div>
                                <div>
                                    <span class="tile-stat-value" id="dash-stat-month">0</span>
                                    <span class="tile-stat-label">This Month</span>
                                </div>
                            </div>
                        </div>

                        <div class="dashboard-tile" style="background: var(--accent-primary); color: white;">
                            <div class="tile-header">
                                <div class="tile-icon" style="background: rgba(255,255,255,0.2);">‚ö°</div>
                            </div>
                            <div class="tile-title" style="color: white;">Quick Actions</div>
                            <div class="tile-description" style="color: rgba(255,255,255,0.9); margin-bottom: var(--spacing-lg);">
                                Common tasks and shortcuts
                            </div>
                            <div style="display: flex; flex-direction: column; gap: var(--spacing-sm);">
                                <button class="btn btn-secondary" onclick="switchPage('service')" style="justify-content: flex-start; background: rgba(255,255,255,0.2); border: none; color: white;">
                                    üÜï New Service Call
                                </button>
                                <button class="btn btn-secondary" onclick="switchPage('materials')" style="justify-content: flex-start; background: rgba(255,255,255,0.2); border: none; color: white;">
                                    üìù Material List
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- SERVICE CALL PAGE -->
                <div id="service-page" class="page-content hidden">
                    <!-- Quality Dashboard -->
                    <div class="quality-dashboard" id="quality-dashboard">
                        <div class="quality-header">
                            <span>üìä Report Quality Score</span>
                            <span class="badge" style="background: rgba(255,255,255,0.2); color: white;" id="quality-badge">In Progress</span>
                        </div>
                        <div class="quality-score-large" id="quality-score-large">0%</div>
                        <div class="quality-metrics">
                            <div class="quality-metric">
                                <div class="metric-value" id="metric-basic">0/5</div>
                                <div class="metric-label">Basic Info</div>
                            </div>
                            <div class="quality-metric">
                                <div class="metric-value" id="metric-diagnostics">0/3</div>
                                <div class="metric-label">Diagnostics</div>
                            </div>
                            <div class="quality-metric">
                                <div class="metric-value" id="metric-photos">0</div>
                                <div class="metric-label">Photos</div>
                            </div>
                            <div class="quality-metric">
                                <div class="metric-value" id="metric-signature">‚úó</div>
                                <div class="metric-label">Signature</div>
                            </div>
                        </div>
                    </div>

                    <!-- Service Mode Selector -->
                    <div class="service-mode-selector">
                        <div class="mode-option active" id="mode-cooling" onclick="setSystemMode('cooling')">
                            <span class="mode-option-icon">‚ùÑÔ∏è</span>
                            <span class="mode-option-label">Cooling</span>
                        </div>
                        <div class="mode-option" id="mode-heating" onclick="setSystemMode('heating')">
                            <span class="mode-option-icon">üî•</span>
                            <span class="mode-option-label">Heating</span>
                        </div>
                        <div class="mode-option" id="mode-trouble" onclick="setCallType('trouble')">
                            <span class="mode-option-icon">üîß</span>
                            <span class="mode-option-label">Trouble Call</span>
                        </div>
                    </div>

                    <!-- Job Information -->
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Job Information</div>
                        </div>
                        <div class="card-body">
                            <div class="form-grid form-grid-2">
                                <div class="form-group">
                                    <label>Customer Name</label>
                                    <input type="text" id="customer-name" placeholder="Enter customer name" oninput="calculateQuality()">
                                </div>
                                <div class="form-group">
                                    <label>Date</label>
                                    <input type="date" id="service-date" oninput="calculateQuality()">
                                </div>
                            </div>
                            <div class="form-grid" style="margin-top: var(--spacing-lg);">
                                <div class="form-group">
                                    <label>Service Address</label>
                                    <input type="text" id="service-address" placeholder="123 Main St, City, State ZIP" oninput="calculateQuality()">
                                </div>
                            </div>
                            <div class="form-grid" style="margin-top: var(--spacing-lg);">
                                <div class="form-group">
                                    <label>Customer Complaint / Reason for Service</label>
                                    <textarea id="customer-complaint" placeholder="Describe the issue..." oninput="calculateQuality()"></textarea>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Equipment Information -->
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Equipment Information</div>
                        </div>
                        <div class="card-body">
                            <div class="form-grid">
                                <div class="form-group">
                                    <label>Unit Type</label>
                                    <select id="unit-type" onchange="updateUnitFields(); calculateQuality();">
                                        <option value="">Select unit type...</option>
                                        <option value="split">Split System</option>
                                        <option value="package">Package Unit</option>
                                        <option value="mini-split">Mini-Split</option>
                                        <option value="heat-pump">Heat Pump</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-grid form-grid-2" style="margin-top: var(--spacing-lg);">
                                <div class="form-group">
                                    <label>Indoor Unit (Model/Serial)</label>
                                    <input type="text" id="indoor-unit" placeholder="Model & Serial">
                                </div>
                                <div class="form-group" id="outdoor-unit-group">
                                    <label>Outdoor Unit (Model/Serial)</label>
                                    <input type="text" id="outdoor-unit" placeholder="Model & Serial">
                                </div>
                            </div>
                            <div class="form-grid form-grid-3" style="margin-top: var(--spacing-lg);">
                                <div class="form-group">
                                    <label>Tonnage</label>
                                    <select id="tonnage">
                                        <option value="">Select...</option>
                                        <option value="1.5">1.5 Ton</option>
                                        <option value="2">2 Ton</option>
                                        <option value="2.5">2.5 Ton</option>
                                        <option value="3">3 Ton</option>
                                        <option value="3.5">3.5 Ton</option>
                                        <option value="4">4 Ton</option>
                                        <option value="5">5 Ton</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Refrigerant Type</label>
                                    <select id="refrigerant-type">
                                        <option value="R410A">R-410A</option>
                                        <option value="R22">R-22</option>
                                        <option value="R454B">R-454B</option>
                                        <option value="R32">R-32</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Filter Size</label>
                                    <input type="text" id="filter-size" placeholder="16x25x1">
                                </div>
                            </div>
                            <div class="form-grid form-grid-2" style="margin-top: var(--spacing-lg);">
                                <div class="form-group">
                                    <label>Metering Device</label>
                                    <select id="metering-device" onchange="calculateDiagnostics()">
                                        <option value="">Unknown</option>
                                        <option value="txv">TXV</option>
                                        <option value="piston">Fixed Orifice / Piston</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>SEER Rating</label>
                                    <input type="number" id="seer-rating" placeholder="14">
                                </div>
                            </div>
                        </div>
                    </div><!-- Cooling Measurements -->
                    <div class="card" id="cooling-measurements">
                        <div class="card-header">
                            <div class="card-title">Diagnostic Measurements (Cooling)</div>
                        </div>
                        <div class="card-body">
                            <div class="card-section">
                                <div class="section-title">Temperature Readings</div>
                                <div class="form-grid form-grid-4">
                                    <div class="form-group">
                                        <label>Outdoor Ambient (¬∞F)</label>
                                        <input type="number" step="0.1" id="outdoor-ambient" oninput="calculateDiagnostics()">
                                    </div>
                                    <div class="form-group">
                                        <label>Indoor Ambient (¬∞F)</label>
                                        <input type="number" step="0.1" id="ambient-temp" oninput="calculateDiagnostics()">
                                    </div>
                                    <div class="form-group">
                                        <label>Return Temp (¬∞F)</label>
                                        <input type="number" step="0.1" id="return-temp" oninput="calculateDiagnostics()">
                                    </div>
                                    <div class="form-group">
                                        <label>Supply Temp (¬∞F)</label>
                                        <input type="number" step="0.1" id="supply-temp" oninput="calculateDiagnostics()">
                                    </div>
                                </div>
                                <div class="form-grid form-grid-2" style="margin-top: var(--spacing-lg);">
                                    <div class="form-group">
                                        <label>Delta-T (Calculated)</label>
                                        <input type="text" id="delta-t" readonly>
                                    </div>
                                    <div class="form-group">
                                        <label>Wet Bulb (¬∞F)</label>
                                        <input type="number" step="0.1" id="wet-bulb" oninput="calculateDiagnostics()">
                                    </div>
                                </div>
                            </div>

                            <div class="card-section">
                                <div class="section-title">Refrigerant Pressures</div>
                                <div class="form-grid form-grid-2">
                                    <div class="form-group">
                                        <label>Suction Pressure (PSI)</label>
                                        <input type="number" step="0.1" id="suction-pressure" oninput="calculateDiagnostics()">
                                    </div>
                                    <div class="form-group">
                                        <label>Suction Line Temp (¬∞F)</label>
                                        <input type="number" step="0.1" id="suction-temp" oninput="calculateDiagnostics()">
                                    </div>
                                    <div class="form-group">
                                        <label>Liquid Pressure (PSI)</label>
                                        <input type="number" step="0.1" id="liquid-pressure" oninput="calculateDiagnostics()">
                                    </div>
                                    <div class="form-group">
                                        <label>Liquid Line Temp (¬∞F)</label>
                                        <input type="number" step="0.1" id="liquid-temp" oninput="calculateDiagnostics()">
                                    </div>
                                </div>
                                <div class="form-grid form-grid-2" style="margin-top: var(--spacing-lg);">
                                    <div class="form-group">
                                        <label>Superheat (Calculated)</label>
                                        <input type="text" id="superheat" readonly>
                                    </div>
                                    <div class="form-group">
                                        <label>Subcool (Calculated)</label>
                                        <input type="text" id="subcool" readonly>
                                    </div>
                                </div>
                            </div>

                            <div class="card-section">
                                <div class="section-title">Electrical</div>
                                <div class="form-grid form-grid-4">
                                    <div class="form-group">
                                        <label>Static Pressure (in w.c.)</label>
                                        <input type="number" step="0.01" id="static-pressure" oninput="calculateDiagnostics()">
                                    </div>
                                    <div class="form-group">
                                        <label>Voltage (V)</label>
                                        <input type="number" step="0.1" id="voltage">
                                    </div>
                                    <div class="form-group">
                                        <label>Amperage (A)</label>
                                        <input type="number" step="0.1" id="amperage">
                                    </div>
                                    <div class="form-group">
                                        <label>RLA Rating</label>
                                        <input type="number" step="0.1" id="rla-rating">
                                    </div>
                                </div>
                            </div>

                            <div class="chart-container">
                                <canvas id="pressure-chart"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- Heating Measurements -->
                    <div class="card hidden" id="heating-measurements">
                        <div class="card-header">
                            <div class="card-title">Diagnostic Measurements (Heating)</div>
                        </div>
                        <div class="card-body">
                            <div class="card-section">
                                <div class="section-title">Temperature Readings</div>
                                <div class="form-grid form-grid-3">
                                    <div class="form-group">
                                        <label>Return Temp (¬∞F)</label>
                                        <input type="number" step="0.1" id="return-temp-heat" oninput="calculateDiagnostics()">
                                    </div>
                                    <div class="form-group">
                                        <label>Supply Temp (¬∞F)</label>
                                        <input type="number" step="0.1" id="supply-temp-heat" oninput="calculateDiagnostics()">
                                    </div>
                                    <div class="form-group">
                                        <label>Temp Rise (Calculated)</label>
                                        <input type="text" id="temp-rise" readonly>
                                    </div>
                                </div>
                            </div>

                            <div class="card-section">
                                <div class="section-title">Gas Furnace</div>
                                <div class="form-grid form-grid-4">
                                    <div class="form-group">
                                        <label>Manifold Pressure (in w.c.)</label>
                                        <input type="number" step="0.01" id="manifold-pressure" oninput="calculateDiagnostics()">
                                    </div>
                                    <div class="form-group">
                                        <label>Voltage (V)</label>
                                        <input type="number" step="0.1" id="voltage-heat">
                                    </div>
                                    <div class="form-group">
                                        <label>Amperage (A)</label>
                                        <input type="number" step="0.1" id="amperage-heat">
                                    </div>
                                    <div class="form-group">
                                        <label>Gas Type</label>
                                        <select id="gas-type">
                                            <option value="natural">Natural Gas</option>
                                            <option value="lp">LP/Propane</option>
                                        </select>
                                    </div>
                                </div>
                            </div>

                            <div class="chart-container">
                                <canvas id="heating-chart"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- Diagnostic Results -->
                    <div id="diagnostic-results" class="hidden"></div>

                    <!-- Photo Gallery -->
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">üì∏ Job Photos</div>
                            <span class="badge badge-info" id="photo-count">0 photos</span>
                        </div>
                        <div class="card-body">
                            <div class="photo-gallery" id="photo-gallery">
                                <label class="photo-upload">
                                    <input type="file" accept="image/*" capture="camera" multiple onchange="handlePhotos(event)" style="display:none">
                                    <span>üì∑</span>
                                    <span>Add Photo</span>
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- Findings -->
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Findings & Work Performed</div>
                        </div>
                        <div class="card-body">
                            <div class="form-group">
                                <label>Findings</label>
                                <textarea id="findings" placeholder="Describe what you found..." oninput="calculateQuality()"></textarea>
                            </div>
                            <div class="form-group" style="margin-top: var(--spacing-lg);">
                                <label>Recommendations</label>
                                <textarea id="recommendations" placeholder="What do you recommend?"></textarea>
                            </div>
                            <div class="form-group" style="margin-top: var(--spacing-lg);">
                                <label>Work Performed</label>
                                <textarea id="work-performed" placeholder="Detail work completed..." oninput="calculateQuality()"></textarea>
                            </div>
                        </div>
                    </div>

                    <!-- Customer Signature -->
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">‚úçÔ∏è Customer Signature</div>
                        </div>
                        <div class="card-body">
                            <div class="form-grid form-grid-2">
                                <div class="form-group">
                                    <label>Customer Name</label>
                                    <input type="text" id="sig-name" placeholder="Customer name" oninput="calculateQuality()">
                                </div>
                                <div class="form-group">
                                    <label>Date</label>
                                    <input type="date" id="sig-date" oninput="calculateQuality()">
                                </div>
                            </div>
                            <canvas id="signature-pad" class="signature-pad" style="margin-top: var(--spacing-lg);"></canvas>
                            <div class="btn-group mt-lg">
                                <button class="btn btn-secondary" onclick="clearSignature()">Clear</button>
                                <button class="btn btn-primary" onclick="saveSignature()">Save Signature</button>
                            </div>
                        </div>
                    </div>

                    <!-- Technician Info -->
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Technician Information</div>
                        </div>
                        <div class="card-body">
                            <div class="form-grid form-grid-2">
                                <div class="form-group">
                                    <label>Technician Name</label>
                                    <input type="text" id="tech-name" value="Mart√≠n Perez">
                                </div>
                                <div class="form-group">
                                    <label>Phone</label>
                                    <input type="tel" id="tech-phone" value="(346)451-0024">
                                </div>
                            </div>
                            <div class="form-group" style="margin-top: var(--spacing-lg);">
                                <label>Email</label>
                                <input type="email" id="tech-email" value="Mperez@villageplumbing.com">
                            </div>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="btn-group">
                        <button class="btn btn-success" onclick="generatePDF()">üìÑ Generate PDF</button>
                        <button class="btn btn-primary" onclick="generateTextReport()">üìã Text Report</button>
                        <button class="btn btn-secondary" onclick="saveData()">üíæ Save</button>
                        <button class="btn btn-danger" onclick="clearForm()">üóëÔ∏è Clear</button>
                    </div>

                    <div id="report-container"></div>
                </div>

                <!-- MATERIALS PAGE -->
                <div id="materials-page" class="page-content hidden">
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Job Information</div>
                        </div>
                        <div class="card-body">
                            <div class="form-grid form-grid-2">
                                <div class="form-group">
                                    <label>Customer/Job Name</label>
                                    <input type="text" id="mat-customer" placeholder="Enter name">
                                </div>
                                <div class="form-group">
                                    <label>Date</label>
                                    <input type="date" id="mat-date">
                                </div>
                            </div>
                            <div class="form-group" style="margin-top: var(--spacing-lg);">
                                <label>Job Address</label>
                                <input type="text" id="mat-address" placeholder="Address">
                            </div>
                            <div class="form-group" style="margin-top: var(--spacing-lg);">
                                <label>Notes</label>
                                <textarea id="mat-notes" placeholder="Special instructions..."></textarea>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Materials Catalog</div>
                            <div class="btn-group">
                                <button class="btn btn-secondary btn-sm" onclick="expandAllCategories()">Expand All</button>
                                <button class="btn btn-secondary btn-sm" onclick="collapseAllCategories()">Collapse All</button>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="form-group">
                                <input type="text" id="material-search" placeholder="üîç Search materials..." oninput="filterMaterials()">
                            </div>
                            <div id="materials-catalog"></div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Selected Materials</div>
                            <span class="badge badge-info" id="selected-materials-count">0 items</span>
                        </div>
                        <div class="card-body">
                            <div id="selected-materials">
                                <div class="status-card info">No materials selected yet.</div>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Technician</div>
                        </div>
                        <div class="card-body">
                            <div class="form-grid form-grid-2">
                                <div class="form-group">
                                    <label>Name</label>
                                    <input type="text" id="mat-tech-name" value="Mart√≠n Perez">
                                </div>
                                <div class="form-group">
                                    <label>Phone</label>
                                    <input type="tel" id="mat-tech-phone" value="(346)451-0024">
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="btn-group">
                        <button class="btn btn-success" onclick="generateMaterialsPDF()">üìÑ Generate PDF</button>
                        <button class="btn btn-primary" onclick="generateMaterialsReport()">üìã Generate List</button>
                        <button class="btn btn-secondary" onclick="saveData()">üíæ Save</button>
                        <button class="btn btn-danger" onclick="clearForm()">üóëÔ∏è Clear</button>
                    </div>

                    <div id="report-container-mat"></div>
                </div><!-- DUCT DESIGN PAGE -->
                <div id="duct-design-page" class="page-content hidden">
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">üèóÔ∏è Duct Design Project</div>
                        </div>
                        <div class="card-body">
                            <div class="form-grid form-grid-2">
                                <div class="form-group">
                                    <label>Project Name</label>
                                    <input type="text" id="duct-project-name" placeholder="Smith Residence">
                                </div>
                                <div class="form-group">
                                    <label>Date</label>
                                    <input type="date" id="duct-project-date">
                                </div>
                            </div>
                            <div class="form-grid form-grid-3" style="margin-top: var(--spacing-lg);">
                                <div class="form-group">
                                    <label>System Tonnage</label>
                                    <select id="duct-tonnage" onchange="calculateSystemCFM()">
                                        <option value="">Select...</option>
                                        <option value="1.5">1.5 Ton</option>
                                        <option value="2">2 Ton</option>
                                        <option value="2.5">2.5 Ton</option>
                                        <option value="3">3 Ton</option>
                                        <option value="3.5">3.5 Ton</option>
                                        <option value="4">4 Ton</option>
                                        <option value="5">5 Ton</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Equipment Location</label>
                                    <select id="duct-equipment-location">
                                        <option value="attic">Attic</option>
                                        <option value="closet">Closet</option>
                                        <option value="basement">Basement</option>
                                        <option value="garage">Garage</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Return Type</label>
                                    <select id="duct-return-type">
                                        <option value="central">Central Return</option>
                                        <option value="distributed">Distributed</option>
                                    </select>
                                </div>
                            </div>
                            <div class="info-box">
                                <div class="info-box-title">System CFM</div>
                                <div class="info-box-content">
                                    <strong>Total: <span id="system-cfm-display">0</span> CFM</strong>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Room-by-Room Design</div>
                            <button class="btn btn-primary btn-sm" onclick="addDuctRoom()">+ Add Room</button>
                        </div>
                        <div class="card-body">
                            <div id="duct-rooms-container">
                                <div class="status-card info">Click "Add Room" to start your design.</div>
                            </div>
                            <div id="duct-totals" class="hidden">
                                <div class="quality-metrics" style="margin-top: var(--spacing-xl); background: var(--bg-tertiary); padding: var(--spacing-lg); border-radius: var(--radius-lg);">
                                    <div class="quality-metric" style="background: var(--bg-secondary);">
                                        <div class="metric-value" style="color: var(--accent-primary);" id="total-branches-cfm">0</div>
                                        <div class="metric-label" style="color: var(--text-tertiary);">Total CFM</div>
                                    </div>
                                    <div class="quality-metric" style="background: var(--bg-secondary);">
                                        <div class="metric-value" style="color: var(--success);" id="cfm-balance">0%</div>
                                        <div class="metric-label" style="color: var(--text-tertiary);">Balance</div>
                                    </div>
                                    <div class="quality-metric" style="background: var(--bg-secondary);">
                                        <div class="metric-value" style="color: var(--info);" id="rooms-designed">0</div>
                                        <div class="metric-label" style="color: var(--text-tertiary);">Rooms</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Trunk & Plenum</div>
                        </div>
                        <div class="card-body">
                            <div class="card-section">
                                <div class="section-title">Main Supply Trunk</div>
                                <div class="form-grid form-grid-3">
                                    <div class="form-group">
                                        <label>Trunk CFM</label>
                                        <input type="text" id="trunk-cfm" readonly>
                                    </div>
                                    <div class="form-group">
                                        <label>Target Velocity</label>
                                        <select id="trunk-velocity" onchange="calculateTrunkSize()">
                                            <option value="700">700 FPM</option>
                                            <option value="800" selected>800 FPM</option>
                                            <option value="900">900 FPM</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label>Recommended Size</label>
                                        <input type="text" id="trunk-size-result" readonly style="color: var(--success); font-weight: 600;">
                                    </div>
                                </div>
                            </div>
                            <div class="card-section">
                                <div class="section-title">Supply Plenum</div>
                                <div class="form-grid form-grid-3">
                                    <div class="form-group">
                                        <label>Length (in)</label>
                                        <input type="number" id="supply-plenum-length" value="24" oninput="calculatePlenumMaterial()">
                                    </div>
                                    <div class="form-group">
                                        <label>Width (in)</label>
                                        <input type="number" id="supply-plenum-width" value="24" oninput="calculatePlenumMaterial()">
                                    </div>
                                    <div class="form-group">
                                        <label>Height (in)</label>
                                        <input type="number" id="supply-plenum-height" value="18" oninput="calculatePlenumMaterial()">
                                    </div>
                                </div>
                            </div>
                            <div class="card-section">
                                <div class="section-title">Return Plenum</div>
                                <div class="form-grid form-grid-3">
                                    <div class="form-group">
                                        <label>Length (in)</label>
                                        <input type="number" id="return-plenum-length" value="26" oninput="calculatePlenumMaterial()">
                                    </div>
                                    <div class="form-group">
                                        <label>Width (in)</label>
                                        <input type="number" id="return-plenum-width" value="26" oninput="calculatePlenumMaterial()">
                                    </div>
                                    <div class="form-group">
                                        <label>Height (in)</label>
                                        <input type="number" id="return-plenum-height" value="20" oninput="calculatePlenumMaterial()">
                                    </div>
                                </div>
                            </div>
                            <div class="info-box">
                                <div class="info-box-title">Duct Board Required</div>
                                <div class="info-box-content">
                                    <strong>Sheets: <span id="duct-board-sheets">0</span></strong> (4√ó8 ft, 1.5" thick)
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card" id="system-schematic-card" style="display: none;">
                        <div class="card-header">
                            <div class="card-title">System Schematic</div>
                        </div>
                        <div class="card-body">
                            <div id="system-schematic" class="duct-tree"></div>
                        </div>
                    </div>

                    <div class="card" id="material-takeoff-card" style="display: none;">
                        <div class="card-header">
                            <div class="card-title">Material Takeoff</div>
                        </div>
                        <div class="card-body">
                            <div id="material-takeoff"></div>
                        </div>
                    </div>

                    <div class="btn-group">
                        <button class="btn btn-success" onclick="generateDuctDesign()" id="generate-design-btn" disabled>üèóÔ∏è Generate Design</button>
                        <button class="btn btn-primary" onclick="exportDuctDesign()">üìÑ Export PDF</button>
                        <button class="btn btn-secondary" onclick="saveDuctDesign()">üíæ Save</button>
                        <button class="btn btn-danger" onclick="clearDuctDesignForm()">üóëÔ∏è Clear</button>
                    </div>
                </div>

                <!-- CFM CALCULATOR PAGE -->
                <div id="cfm-page" class="page-content hidden">
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">üå™Ô∏è CFM Calculators</div>
                        </div>
                        <div class="card-body">
                            <div class="calculator-tabs">
                                <button class="calculator-tab active" onclick="switchCalcTab('tonnage')">By Tonnage</button>
                                <button class="calculator-tab" onclick="switchCalcTab('room')">By Room</button>
                                <button class="calculator-tab" onclick="switchCalcTab('temp')">By Temp/BTU</button>
                            </div>

                            <!-- By Tonnage -->
                            <div class="calculator-section active" id="calc-tonnage">
                                <div class="form-grid form-grid-3">
                                    <div class="form-group">
                                        <label>System Tonnage</label>
                                        <select id="cfm-tonnage" onchange="calculateCFMByTonnage()">
                                            <option value="">Select...</option>
                                            <option value="1.5">1.5 Ton</option>
                                            <option value="2">2 Ton</option>
                                            <option value="2.5">2.5 Ton</option>
                                            <option value="3">3 Ton</option>
                                            <option value="3.5">3.5 Ton</option>
                                            <option value="4">4 Ton</option>
                                            <option value="5">5 Ton</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label>CFM per Ton</label>
                                        <select id="cfm-per-ton" onchange="calculateCFMByTonnage()">
                                            <option value="350">350 (Dehumid)</option>
                                            <option value="400" selected>400 (Standard)</option>
                                            <option value="450">450 (High Eff)</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label>Required CFM</label>
                                        <input type="text" id="cfm-result-tonnage" readonly style="font-weight: 700; color: var(--accent-primary); font-size: 16px;">
                                    </div>
                                </div>
                            </div>

                            <!-- By Room -->
                            <div class="calculator-section" id="calc-room">
                                <div class="form-grid form-grid-2">
                                    <div class="form-group">
                                        <label>Room Type</label>
                                        <select id="room-type-select" onchange="autoSetRoomParams()">
                                            <option value="">Select room type...</option>
                                            <optgroup label="Bedrooms">
                                                <option value="master" data-ach="4">Master Bedroom</option>
                                                <option value="bedroom" data-ach="4">Bedroom</option>
                                            </optgroup>
                                            <optgroup label="Living Spaces">
                                                <option value="living" data-ach="6">Living Room</option>
                                                <option value="dining" data-ach="6">Dining Room</option>
                                                <option value="office" data-ach="5">Office</option>
                                            </optgroup>
                                            <optgroup label="High Activity">
                                                <option value="kitchen" data-ach="8">Kitchen</option>
                                                <option value="bathroom" data-ach="10">Bathroom</option>
                                            </optgroup>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label>ACH (Auto-set)</label>
                                        <input type="number" id="room-ach" value="6" onchange="calculateCFMByRoom()">
                                    </div>
                                </div>
                                <div class="form-grid form-grid-3" style="margin-top: var(--spacing-lg);">
                                    <div class="form-group">
                                        <label>Length (ft)</label>
                                        <select id="room-length" onchange="calculateCFMByRoom()">
                                            <option value="">Select...</option>
                                            <option value="8">8 ft</option>
                                            <option value="10">10 ft</option>
                                            <option value="12">12 ft</option>
                                            <option value="14">14 ft</option>
                                            <option value="16">16 ft</option>
                                            <option value="18">18 ft</option>
                                            // ==================== NAVIGATION ====================
        const Navigation = {
            pages: {
                dashboard: 'Dashboard',
                service: 'Service Call',
                materials: 'Materials',
                'duct-design': 'Duct Design',
                cfm: 'CFM Calculator',
                history: 'History'
            },

            switchPage(page) {
                State.currentPage = page;
                Object.keys(this.pages).forEach(p => {
                    const el = $(`${p}-page`);
                    if (el) el.classList.toggle('hidden', p !== page);
                });
                $('page-title').textContent = this.pages[page];
                this.updateNavItems(page);
                this.closeMobileMenu();
                if (page === 'history') History.refresh();
                if (page === 'dashboard') Dashboard.updateStats();
            },

            updateNavItems(activePage) {
                const navItems = document.querySelectorAll('.nav-item');
                const pageOrder = Object.keys(this.pages);
                navItems.forEach((item, i) => {
                    if (i < pageOrder.length) {
                        item.classList.toggle('active', pageOrder[i] === activePage);
                    }
                });
            },

            toggleMobileMenu() {
                $('sidebar').classList.toggle('mobile-open');
                $('mobile-menu-overlay').classList.toggle('show');
            },

            closeMobileMenu() {
                $('sidebar').classList.remove('mobile-open');
                $('mobile-menu-overlay').classList.remove('show');
            }
        };

        // ==================== DASHBOARD ====================
        const Dashboard = {
            updateStats() {
                const reports = Storage.load(CONFIG.STORAGE_KEY) || [];
                State.savedReports = reports;
                const thisMonth = reports.filter(r => {
                    const d = new Date(r.timestamp);
                    const now = new Date();
                    return d.getMonth() === now.getMonth() && d.getFullYear() === now.getFullYear();
                });
                const avgQuality = reports.length > 0
                    ? reports.reduce((sum, r) => sum + r.quality, 0) / reports.length : 0;

                $('dash-stat-reports').textContent = reports.length;
                $('dash-stat-quality').textContent = `${Math.round(avgQuality)}%`;
                $('dash-stat-total').textContent = reports.length;
                $('dash-stat-month').textContent = thisMonth.length;
            }
        };

        // ==================== SERVICE CALL ====================
        const ServiceCall = {
            setCallType(type) {
                State.callType = type;
                document.querySelectorAll('.mode-option').forEach(el => {
                    if (el.id === 'mode-trouble') {
                        el.classList.toggle('active', type === 'trouble');
                    }
                });
            },

            setSystemMode(mode) {
                State.systemMode = mode;
                $('mode-cooling').classList.toggle('active', mode === 'cooling');
                $('mode-heating').classList.toggle('active', mode === 'heating');
                $('cooling-measurements').classList.toggle('hidden', mode !== 'cooling');
                $('heating-measurements').classList.toggle('hidden', mode !== 'heating');
                Diagnostics.calculate();
            },

            updateUnitFields() {
                const unitType = $('unit-type').value;
                const hideOutdoor = unitType === 'package' || unitType === 'mini-split';
                $('outdoor-unit-group').classList.toggle('hidden', hideOutdoor);
            }
        };

        // ==================== QUALITY ====================
        const Quality = {
            calculate() {
                let score = 0, basicInfo = 0, diagnostics = 0;

                if ($('customer-name').value) basicInfo++;
                if ($('service-date').value) basicInfo++;
                if ($('service-address').value) basicInfo++;
                if ($('customer-complaint').value) basicInfo++;
                if ($('unit-type').value) basicInfo++;
                score += (basicInfo / 5) * 30;

                if (State.systemMode === 'cooling') {
                    if ($('delta-t').value && $('delta-t').value !== 'N/A') diagnostics++;
                    if ($('superheat').value && $('superheat').value !== 'N/A') diagnostics++;
                    if ($('subcool').value && $('subcool').value !== 'N/A') diagnostics++;
                } else {
                    if ($('temp-rise').value && $('temp-rise').value !== 'N/A') diagnostics++;
                    if ($('manifold-pressure').value) diagnostics++;
                    if ($('voltage-heat').value) diagnostics++;
                }
                score += (diagnostics / 3) * 25;

                if ($('findings').value) score += 10;
                if ($('work-performed').value) score += 10;
                score += Math.min(State.photos.length * 3, 15);
                if (State.customerSignature) score += 10;

                this.updateDisplay(Math.round(score), basicInfo, diagnostics);
            },

            updateDisplay(score, basicInfo, diagnostics) {
                $('quality-score-large').textContent = `${score}%`;
                $('metric-basic').textContent = `${basicInfo}/5`;
                $('metric-diagnostics').textContent = `${diagnostics}/3`;
                $('metric-photos').textContent = State.photos.length;
                $('metric-signature').textContent = State.customerSignature ? '‚úì' : '‚úó';

                const badge = $('quality-badge');
                if (score >= 80) {
                    badge.textContent = 'Excellent';
                    badge.style.background = 'rgba(16, 185, 129, 0.3)';
                } else if (score >= 60) {
                    badge.textContent = 'Good';
                    badge.style.background = 'rgba(59, 130, 246, 0.3)';
                } else if (score >= 40) {
                    badge.textContent = 'Fair';
                    badge.style.background = 'rgba(245, 158, 11, 0.3)';
                } else {
                    badge.textContent = 'Incomplete';
                    badge.style.background = 'rgba(239, 68, 68, 0.3)';
                }
            }
        };

        // ==================== DIAGNOSTICS ====================
        const Diagnostics = {
            calculate() {
                State.systemMode === 'cooling' ? this.calculateCooling() : this.calculateHeating();
            },

            getSaturationTemp(pressure) {
                const pressures = Object.keys(R410A_PT).map(Number);
                const closest = Utils.getClosestValue(pressure, pressures);
                return R410A_PT[closest];
            },

            getTargetSuperheat(outdoorTemp) {
                const temps = Object.keys(SUPERHEAT_TARGETS).map(Number);
                const closest = Utils.getClosestValue(outdoorTemp, temps);
                return SUPERHEAT_TARGETS[closest];
            },

            calculateCooling() {
                const returnTemp = parseFloat($('return-temp').value);
                const supplyTemp = parseFloat($('supply-temp').value);
                const suctionPressure = parseFloat($('suction-pressure').value);
                const suctionTemp = parseFloat($('suction-temp').value);
                const liquidPressure = parseFloat($('liquid-pressure').value);
                const liquidTemp = parseFloat($('liquid-temp').value);

                // Delta-T
                if (!isNaN(returnTemp) && !isNaN(supplyTemp)) {
                    const deltaT = returnTemp - supplyTemp;
                    $('delta-t').value = `${deltaT.toFixed(1)}¬∞F`;
                    $('delta-t').classList.toggle('warning', deltaT < 14 || deltaT > 24);
                } else {
                    $('delta-t').value = '';
                }

                // Superheat
                if (!isNaN(suctionPressure) && !isNaN(suctionTemp)) {
                    const satTemp = this.getSaturationTemp(suctionPressure);
                    if (satTemp !== null) {
                        const superheat = suctionTemp - satTemp;
                        $('superheat').value = `${superheat.toFixed(1)}¬∞F`;
                    }
                } else {
                    $('superheat').value = '';
                }

                // Subcool
                if (!isNaN(liquidPressure) && !isNaN(liquidTemp)) {
                    const satTemp = this.getSaturationTemp(liquidPressure);
                    if (satTemp !== null) {
                        const subcool = satTemp - liquidTemp;
                        $('subcool').value = `${subcool.toFixed(1)}¬∞F`;
                    }
                } else {
                    $('subcool').value = '';
                }

                Quality.calculate();
            },

            calculateHeating() {
                const returnTemp = parseFloat($('return-temp-heat').value);
                const supplyTemp = parseFloat($('supply-temp-heat').value);

                if (!isNaN(returnTemp) && !isNaN(supplyTemp)) {
                    const tempRise = supplyTemp - returnTemp;
                    $('temp-rise').value = `${tempRise.toFixed(1)}¬∞F`;
                    $('temp-rise').classList.toggle('warning', tempRise < 35 || tempRise > 65);
                } else {
                    $('temp-rise').value = '';
                }

                Quality.calculate();
            }
        };

        // ==================== PHOTOS ====================
        const Photos = {
            handle(event) {
                Array.from(event.target.files).forEach(file => {
                    const reader = new FileReader();
                    reader.onload = e => {
                        State.photos.push({ data: e.target.result, name: file.name });
                        this.display();
                        Quality.calculate();
                        UI.showToast('Photo added');
                    };
                    reader.readAsDataURL(file);
                });
                event.target.value = '';
            },

            display() {
                const gallery = $('photo-gallery');
                let html = `<label class="photo-upload">
                    <input type="file" accept="image/*" capture="camera" multiple onchange="handlePhotos(event)" style="display:none">
                    <span>üì∑</span><span>Add Photo</span>
                </label>`;

                State.photos.forEach((photo, i) => {
                    html += `<div class="photo-item">
                        <img src="${photo.data}" onclick="viewPhoto(${i})">
                        <div class="photo-item-actions">
                            <button class="photo-btn" onclick="deletePhoto(${i}); event.stopPropagation();">üóëÔ∏è</button>
                        </div>
                    </div>`;
                });

                gallery.innerHTML = html;
                $('photo-count').textContent = `${State.photos.length} photo${State.photos.length !== 1 ? 's' : ''}`;
            },

            view(index) { window.open(State.photos[index].data); },
            delete(index) {
                State.photos.splice(index, 1);
                this.display();
                Quality.calculate();
                UI.showToast('Photo deleted');
            }
        };

        // ==================== SIGNATURE ====================
        const Signature = {
            init() {
                const canvas = $('signature-pad');
                if (!canvas) return;
                State.signaturePad = new SignaturePad(canvas, {
                    backgroundColor: 'rgb(241, 245, 249)',
                    penColor: 'rgb(30, 41, 59)'
                });
                this.resize();
                window.addEventListener('resize', () => this.resize());
            },

            resize() {
                const canvas = $('signature-pad');
                const ratio = Math.max(window.devicePixelRatio || 1, 1);
                canvas.width = canvas.offsetWidth * ratio;
                canvas.height = canvas.offsetHeight * ratio;
                canvas.getContext('2d').scale(ratio, ratio);
            },

            clear() {
                if (State.signaturePad) {
                    State.signaturePad.clear();
                    State.customerSignature = null;
                    Quality.calculate();
                    UI.showToast('Signature cleared');
                }
            },

            save() {
                if (!State.signaturePad || State.signaturePad.isEmpty()) {
                    UI.showToast('Please sign first', 'danger');
                    return;
                }
                State.customerSignature = State.signaturePad.toDataURL();
                Quality.calculate();
                UI.showToast('Signature saved!');
            }
        };

        // ==================== MATERIALS ====================
        const Materials = {
            catalog: {
                electrical: { name: 'Electrical', icon: '‚ö°', items: [
                    { id: 'contactor', name: 'Contactor', sizes: ['2-Pole 30A', '2-Pole 40A'] },
                    { id: 'capacitor', name: 'Run Capacitor', sizes: ['35¬µF', '40¬µF', '45¬µF', '50¬µF'] },
                    { id: 'transformer', name: 'Transformer', sizes: ['24V 40VA', '24V 75VA'] }
                ]},
                ductwork: { name: 'Ductwork', icon: 'üå¨Ô∏è', items: [
                    { id: 'flex-duct', name: 'Flex Duct R6', sizes: ['6"', '7"', '8"', '10"', '12"'], unit: 'bag' },
                    { id: 'duct-board', name: 'Duct Board', sizes: ['4x8 sheet'], unit: 'sheet' },
                    { id: 'register', name: 'Supply Register', sizes: ['4x10', '6x10', '6x12'] }
                ]},
                refrigeration: { name: 'Refrigeration', icon: '‚ùÑÔ∏è', items: [
                    { id: 'r410a', name: 'R-410A', sizes: ['25 lb', '50 lb'], unit: 'cylinder' },
                    { id: 'lineset', name: 'Line Set', sizes: ['15 ft', '25 ft', '50 ft'] }
                ]}
            },

            init() {
                const container = $('materials-catalog');
                let html = '';
                Object.keys(this.catalog).forEach(catKey => {
                    const cat = this.catalog[catKey];
                    State.categoryStates[catKey] = false;
                    html += `<div class="materials-category" id="cat-${catKey}">
                        <div class="category-header" onclick="toggleCategory('${catKey}')">
                            <div class="category-title-group">
                                <span class="category-icon">${cat.icon}</span>
                                <span class="category-name">${cat.name}</span>
                            </div>
                            <div class="category-meta">
                                <span class="category-count">${cat.items.length}</span>
                                <span class="category-selected hidden" id="cat-selected-${catKey}">0</span>
                                <span class="category-arrow">‚ñº</span>
                            </div>
                        </div>
                        <div class="category-items">`;
                    cat.items.forEach(item => {
                        html += `<div class="material-item">
                            <input type="checkbox" id="${catKey}-${item.id}" onchange="toggleMaterial('${catKey}', '${item.id}')">
                            <div class="material-info">
                                <div class="material-name">${item.name}</div>
                                <div class="material-spec">${item.sizes.join(', ')}</div>
                            </div>
                        </div>`;
                    });
                    html += '</div></div>';
                });
                container.innerHTML = html;
            },

            toggleCategory(catKey) {
                $(`cat-${catKey}`).classList.toggle('expanded');
            },

            expandAll() {
                Object.keys(this.catalog).forEach(k => $(`cat-${k}`).classList.add('expanded'));
            },

            collapseAll() {
                Object.keys(this.catalog).forEach(k => $(`cat-${k}`).classList.remove('expanded'));
            },

            toggle(catKey, itemId) {
                const cat = this.catalog[catKey];
                const item = cat.items.find(i => i.id === itemId);
                const cb = $(`${catKey}-${itemId}`);
                if (cb.checked) {
                    State.selectedMaterials.push({
                        catKey, .name, sizes: item.sizes, unit: item.unit || 'ea', quantity: 1, spec: item.sizes[0]
                    });
                } else {
                    State.selectedMaterials = State.selectedMaterials.filter(m => !(m.catKey === catKey && m.name === item.name));
                }
                this.displaySelected();
            },

            displaySelected() {
                const container = $('selected-materials');
                if (State.selectedMaterials.length === 0) {
                    container.innerHTML = '<div class="status-card info">No materials selected yet.</div>';
                    $('selected-materials-count').textContent = '0 items';
                    return;
                }
                let html = '';
                State.selectedMaterials.forEach((item, idx) => {
                    html += `<div class="selected-material">
                        <div class="selected-material-info">
                            <div class="material-name">${item.name}</div>
                            <div class="material-spec">${item.spec}</div>
                        </div>
                        <div class="selected-material-controls">
                            <input type="number" value="${item.quantity}" min="1" onchange="State.selectedMaterials[${idx}].quantity = parseInt(this.value)">
                            <button class="photo-btn" onclick="removeMaterial(${idx})">‚úï</button>
                        </div>
                    </div>`;
                });
                container.innerHTML = html;
                $('selected-materials-count').textContent = `${State.selectedMaterials.length} items`;
            },

            remove(index) {
                State.selectedMaterials.splice(index, 1);
                this.displaySelected();
            },

            filter() {
                const search = $('material-search').value.toLowerCase();
                document.querySelectorAll('.material-item').forEach(item => {
                    const text = item.textContent.toLowerCase();
                    item.style.display = text.includes(search) ? 'flex' : 'none';
                });
            }
        };

        // ==================== CFM CALCULATOR ====================
        const CFMCalculator = {
            switchTab(tab) {
                document.querySelectorAll('.calculator-tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.calculator-section').forEach(s => s.classList.remove('active'));
                event.target.classList.add('active');
                $(`calc-${tab}`).classList.add('active');
            },

            byTonnage() {
                const tonnage = parseFloat($('cfm-tonnage').value);
                const cfmPerTon = parseFloat($('cfm-per-ton').value) || 400;
                if (!isNaN(tonnage)) {
                    const cfm = tonnage * cfmPerTon;
                    $('cfm-result-tonnage').value = `${cfm} CFM`;
                    $('duct-cfm').value = cfm;
                    this.calculateDuctSize();
                }
            },

            byRoom() {
                const length = parseFloat($('room-length').value);
                const width = parseFloat($('room-width').value);
                const height = parseFloat($('room-height').value);
                const ach = parseFloat($('room-ach').value);
                if (!isNaN(length) && !isNaN(width) && !isNaN(height)) {
                    const volume = length * width * height;
                    $('room-volume').value = `${volume} cu ft`;
                    if (!isNaN(ach)) {
                        const cfm = Math.round((volume * ach) / 60);
                        $('cfm-result-room').value = `${cfm} CFM`;
                    }
                }
            },

            byTemp() {
                const btu = parseFloat($('cfm-btu').value);
                const deltaT = parseFloat($('cfm-delta-t').value);
                if (!isNaN(btu) && !isNaN(deltaT) && deltaT !== 0) {
                    const cfm = Math.round(btu / (1.08 * deltaT));
                    $('cfm-result-temp').value = `${cfm} CFM`;
                }
            },

            autoSetRoomParams() {
                const select = $('room-type-select');
                const option = select.options[select.selectedIndex];
                if (option && option.dataset.ach) {
                    $('room-ach').value = option.dataset.ach;
                    this.byRoom();
                }
            },

            calculateDuctSize() {
                const cfm = parseFloat($('duct-cfm').value);
                const velocity = parseFloat($('duct-velocity').value);
                const ductType = $('duct-type').value;

                if (isNaN(cfm) || isNaN(velocity)) {
                    $('duct-size-results').classList.add('hidden');
                    return;
                }

                const area = (cfm * 144) / velocity;
                $('duct-size-results').classList.remove('hidden');

                if (ductType === 'round') {
                    const diameter = 2 * Math.sqrt(area / Math.PI);
                    let std = CONFIG.STANDARD_DUCT_SIZES.find(s => s >= diameter) || CONFIG.STANDARD_DUCT_SIZES[CONFIG.STANDARD_DUCT_SIZES.length - 1];
                    const actualArea = Math.PI * Math.pow(std / 2, 2);
                    const actualVel = Math.round((cfm * 144) / actualArea);

                    $('duct-circle-display').textContent = `${std}"`;
                    $('duct-size-primary').textContent = `${std}" Round Duct`;
                    $('duct-size-secondary').textContent = `${actualVel} FPM actual velocity`;
                    $('rectangular-options').classList.add('hidden');
                } else {
                    $('duct-circle-display').textContent = '‚ñ≠';
                    $('duct-size-primary').textContent = 'Rectangular Options';
                    $('duct-size-secondary').textContent = 'See options below';

                    const sizes = [[8, 10], [8, 12], [10, 12], [10, 14], [12, 14], [12, 16]];
                    let html = '<div style="display: grid; gap: 8px;">';
                    sizes.forEach(([w, h]) => {
                        const a = w * h;
                        const v = Math.round((cfm * 144) / a);
                        if (v >= 400 && v <= 1200) {
                            html += `<div class="selected-material">
                                <div class="selected-material-info">
                                    <div class="material-name">${w}" √ó ${h}"</div>
                                    <div class="material-spec">${v} FPM</div>
                                </div>
                            </div>`;
                        }
                    });
                    html += '</div>';
                    $('rectangular-options').innerHTML = html;
                    $('rectangular-options').classList.remove('hidden');
                }
            }
        };

        // ==================== DUCT DESIGN ====================
        const DuctDesign = {
            calculateSystemCFM() {
                const tonnage = parseFloat($('duct-tonnage').value);
                if (!isNaN(tonnage)) {
                    const cfm = tonnage * CONFIG.CFM_PER_TON;
                    $('system-cfm-display').textContent = cfm;
                    $('trunk-cfm').value = cfm;
                    this.calculateTrunkSize();
                    this.checkReadiness();
                }
            },

            calculateTrunkSize() {
                const cfm = parseFloat($('trunk-cfm').value);
                const velocity = parseFloat($('trunk-velocity').value);
                if (!isNaN(cfm) && !isNaN(velocity)) {
                    const area = (cfm * 144) / velocity;
                    const diameter = 2 * Math.sqrt(area / Math.PI);
                    const std = CONFIG.STANDARD_TRUNK_SIZES.find(s => s >= diameter) || CONFIG.STANDARD_TRUNK_SIZES[CONFIG.STANDARD_TRUNK_SIZES.length - 1];
                    $('trunk-size-result').value = `${std}" Round`;
                }
            },

            calculatePlenumMaterial() {
                const sL = parseFloat($('supply-plenum-length').value) || 0;
                const sW = parseFloat($('supply-plenum-width').value) || 0;
                const sH = parseFloat($('supply-plenum-height').value) || 0;
                const rL = parseFloat($('return-plenum-length').value) || 0;
                const rW = parseFloat($('return-plenum-width').value) || 0;
                const rH = parseFloat($('return-plenum-height').value) || 0;
                const sSF = 2 * ((sL * sW) + (sL * sH) + (sW * sH)) / 144;
                const rSF = 2 * ((rL * rW) + (rL * rH) + (rW * rH)) / 144;
                $('duct-board-sheets').textContent = Math.ceil(((sSF + rSF) * 1.2) / 32);
            },

            addRoom() {
                State.ductDesignRooms.push({ id: Utils.generateId(), name: '', length: '', width: '', height: 8, cfm: 0, ductSize: '', ductLength: 20 });
                this.displayRooms();
            },

            removeRoom(index) {
                State.ductDesignRooms.splice(index, 1);
                this.displayRooms();
            },

            displayRooms() {
                const container = $('duct-rooms-container');
                if (State.ductDesignRooms.length === 0) {
                    container.innerHTML = '<div class="status-card info">Click "Add Room" to start.</div>';
                    $('duct-totals').classList.add('hidden');
                    this.checkReadiness();
                    return;
                }
                let html = '';
                State.ductDesignRooms.forEach((room, i) => {
                    html += `<div class="card" style="margin-bottom: 12px;">
                        <div class="card-header">
                            <div class="card-title">Room ${i + 1}: ${room.name || 'Unnamed'}</div>
                            <button class="btn btn-danger btn-sm" onclick="removeDuctRoom(${i})">Remove</button>
                        </div>
                        <div class="card-body">
                            <div class="form-grid form-grid-4">
                                <div class="form-group">
                                    <label>Name</label>
                                    <input type="text" value="${room.name}" onchange="updateDuctRoom(${i}, 'name', this.value)">
                                </div>
                                <div class="form-group">
                                    <label>Length (ft)</label>
                                    <input type="number" value="${room.length}" onchange="updateDuctRoomDim(${i}, 'length', this.value)">
                                </div>
                                <div class="form-group">
                                    <label>Width (ft)</label>
                                    <input type="number" value="${room.width}" onchange="updateDuctRoomDim(${i}, 'width', this.value)">
                                </div>
                                <div class="form-group">
                                    <label>CFM</label>
                                    <input type="text" value="${room.cfm || '--'}" readonly style="color: var(--accent-primary); font-weight: 600;">
                                </div>
                            </div>
                        </div>
                    </div>`;
                });
                container.innerHTML = html;
                $('duct-totals').classList.remove('hidden');
                this.updateTotals();
                this.checkReadiness();
            },

            updateRoom(index, field, value) {
                State.ductDesignRooms[index][field] = value;
                this.displayRooms();
            },

            updateRoomDim(index, field, value) {
                const room = State.ductDesignRooms[index];
                room[field] = parseFloat(value);
                if (!isNaN(room.length) && !isNaN(room.width) && !isNaN(room.height)) {
                    const volume = room.length * room.width * room.height;
                    room.cfm = Math.round((volume * 6) / 60);
                    const area = (room.cfm * 144) / 700;
                    const diameter = 2 * Math.sqrt(area / Math.PI);
                    room.ductSize = `${CONFIG.STANDARD_DUCT_SIZES.find(s => s >= diameter) || 12}"`;
                }
                this.displayRooms();
            },

            updateTotals() {
                const systemCFM = parseFloat($('system-cfm-display').textContent) || 0;
                const totalCFM = State.ductDesignRooms.reduce((sum, r) => sum + (r.cfm || 0), 0);
                const balance = systemCFM > 0 ? ((totalCFM / systemCFM) * 100).toFixed(1) : 0;
                $('total-branches-cfm').textContent = totalCFM;
                $('cfm-balance').textContent = `${balance}%`;
                $('rooms-designed').textContent = State.ductDesignRooms.length;
            },

            checkReadiness() {
                const tonnage = parseFloat($('duct-tonnage').value);
                const hasRooms = State.ductDesignRooms.length > 0;
                $('generate-design-btn').disabled = !(tonnage && hasRooms);
            },

            generate() {
                $('system-schematic-card').style.display = 'block';
                $('material-takeoff-card').style.display = 'block';
                let schematic = `<div class="duct-trunk">Main Supply: ${$('trunk-size-result').value}</div>`;
                State.ductDesignRooms.forEach(r => {
                    schematic += `<div class="duct-branch">‚îú‚îÄ ${r.name || 'Room'}: ${r.ductSize}, ${r.cfm} CFM</div>`;
                });
                $('system-schematic').innerHTML = schematic;
                $('material-takeoff').innerHTML = '<p style="color: var(--text-secondary);">Material list generated based on room designs.</p>';
                UI.showToast('Design generated!');
            },

            async clear() {
                const ok = await UI.showModal('Clear Design', 'Clear all rooms?');
                if (ok) {
                    State.ductDesignRooms = [];
                    this.displayRooms();
                    $('system-schematic-card').style.display = 'none';
                    $('material-takeoff-card').style.display = 'none';
                }
            }
        };

        // ==================== HISTORY ====================
        const History = {
            refresh() {
                State.savedReports = Storage.load(CONFIG.STORAGE_KEY) || [];
                const container = $('history-list');
                if (State.savedReports.length === 0) {
                    container.innerHTML = '<div class="status-card info">No saved reports.</div>';
                    return;
                }
                let html = '';
                State.savedReports.forEach((r, i) => {
                    html += `<div class="card mb-lg">
                        <div class="card-header">
                            <div class="card-title">${r.customer || 'Report'} - ${r.date}</div>
                            <span class="badge badge-${r.quality >= 80 ? 'success' : 'info'}">${r.quality}%</span>
                        </div>
                        <div class="card-body">
                            <div class="btn-group">
                                <button class="btn btn-primary btn-sm" onclick="loadReport(${i})">Load</button>
                                <button class="btn btn-danger btn-sm" onclick="deleteReport(${i})">Delete</button>
                            </div>
                        </div>
                    </div>`;
                });
                container.innerHTML = html;

                $('stat-total').textContent = State.savedReports.length;
                $('stat-this-month').textContent = State.savedReports.filter(r => {
                    const d = new Date(r.timestamp);
                    const now = new Date();
                    return d.getMonth() === now.getMonth();
                }).length;
                $('stat-avg-quality').textContent = `${Math.round(State.savedReports.reduce((s, r) => s + r.quality, 0) / State.savedReports.length)}%`;
                $('stat-photos').textContent = State.savedReports.reduce((s, r) => s + r.photos.length, 0);
            },

            async delete(index) {
                const ok = await UI.showModal('Delete', 'Delete this report?');
                if (ok) {
                    State.savedReports.splice(index, 1);
                    Storage.save(CONFIG.STORAGE_KEY, State.savedReports);
                    this.refresh();
                }
            }
        };

        // ==================== DATA MANAGER ====================
        const DataManager = {
            save() {
                const report = {
                    id: Utils.generateId(),
                    timestamp: new Date().toISOString(),
                    customer: $('customer-name').value,
                    date: $('service-date').value,
                    callType: State.callType,
                    systemMode: State.systemMode,
                    photos: State.photos,
                    quality: parseInt($('quality-score-large').textContent)
                };
                State.savedReports.push(report);
                Storage.save(CONFIG.STORAGE_KEY, State.savedReports);
                UI.showToast('Saved!');
            },

            load() {
                Navigation.switchPage('history');
            },

            exportAll() {
                if (State.savedReports.length === 0) {
                    UI.showToast('No data', 'warning');
                    return;
                }
                const blob = new Blob([JSON.stringify(State.savedReports, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `field-buddy-${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                UI.showToast('Exported!');
            }
        };

        // ==================== REPORT GENERATOR ====================
        const ReportGenerator = {
            generateText() {
                const report = `SERVICE REPORT\n${'='.repeat(50)}\nCustomer: ${$('customer-name').value}\nDate: ${$('service-date').value}\nAddress: ${$('service-address').value}\n\nFindings:\n${$('findings').value}\n\nRecommendations:\n${$('recommendations').value}\n\nWork Performed:\n${$('work-performed').value}\n\nTechnician: ${$('tech-name').value}\n${$('tech-phone').value}`;
                $('report-container').innerHTML = `<div class="report-output">
                    <div class="report-header">
                        <div class="report-header-title">Service Report</div>
                        <div class="report-header-subtitle">Field Buddy Pro</div>
                    </div>
                    <div class="report-section">
                        <pre style="white-space: pre-wrap; font-size: 12px; color: var(--text-secondary);">${report}</pre>
                    </div>
                    <div class="report-actions">
                        <button class="btn btn-primary btn-sm" onclick="navigator.clipboard.writeText(document.querySelector('pre').textContent); UI.showToast('Copied!')">Copy</button>
                    </div>
                </div>`;
                UI.showToast('Report generated!');
            },

            generatePDF() {
                UI.showToast('PDF generation ready');
            },

            generateMaterialsList() {
                let list = `MATERIALS LIST\n${'='.repeat(50)}\n`;
                State.selectedMaterials.forEach(m => {
                    list += `‚òê ${m.name} - ${m.spec} (${m.quantity})\n`;
                });
                $('report-container-mat').innerHTML = `<div class="report-output">
                    <div class="report-header">
                        <div class="report-header-title">Materials List</div>
                    </div>
                    <div class="report-section">
                        <pre style="white-space: pre-wrap; font-size: 12px;">${list}</pre>
                    </div>
                </div>`;
                UI.showToast('List generated!');
            }
        };

        // ==================== FORM MANAGER ====================
        const FormManager = {
            async clear() {
                const ok = await UI.showModal('Clear Form', 'Clear all data?');
                if (ok) {
                    document.querySelectorAll('input, textarea').forEach(el => {
                        if (!el.id.includes('tech-')) el.value = '';
                    });
                    State.photos = [];
                    State.selectedMaterials = [];
                    Photos.display();
                    Materials.displaySelected();
                    Quality.calculate();
                    UI.showToast('Cleared');
                }
            }
        };

        // ==================== GLOBAL HANDLERS ====================
        window.switchPage = p => Navigation.switchPage(p);
        window.toggleMobileMenu = () => Navigation.toggleMobileMenu();
        window.setCallType = t => ServiceCall.setCallType(t);
        window.setSystemMode = m => ServiceCall.setSystemMode(m);
        window.updateUnitFields = () => ServiceCall.updateUnitFields();
        window.calculateDiagnostics = () => Diagnostics.calculate();
        window.calculateQuality = () => Quality.calculate();
        window.handlePhotos = e => Photos.handle(e);
        window.viewPhoto = i => Photos.view(i);
        window.deletePhoto = i => Photos.delete(i);
        window.clearSignature = () => Signature.clear();
        window.saveSignature = () => Signature.save();
        window.expandAllCategories = () => Materials.expandAll();
        window.collapseAllCategories = () => Materials.collapseAll();
        window.filterMaterials = () => Materials.filter();
        window.toggleCategory = k => Materials.toggleCategory(k);
        window.toggleMaterial = (c, i) => Materials.toggle(c, i);
        window.removeMaterial = i => Materials.remove(i);
        window.switchCalcTab = t => CFMCalculator.switchTab(t);
        window.calculateCFMByTonnage = () => CFMCalculator.byTonnage();
        window.calculateCFMByRoom = () => CFMCalculator.byRoom();
        window.calculateCFMByTemp = () => CFMCalculator.byTemp();
        window.autoSetRoomParams = () => CFMCalculator.autoSetRoomParams();
        window.calculateDuctSize = () => CFMCalculator.calculateDuctSize();
        window.calculateSystemCFM = () => DuctDesign.calculateSystemCFM();
        window.calculateTrunkSize = () => DuctDesign.calculateTrunkSize();
        window.calculatePlenumMaterial = () => DuctDesign.calculatePlenumMaterial();
        window.addDuctRoom = () => DuctDesign.addRoom();
        window.removeDuctRoom = i => DuctDesign.removeRoom(i);
        window.updateDuctRoom = (i, f, v) => DuctDesign.updateRoom(i, f, v);
        window.updateDuctRoomDim = (i, f, v) => DuctDesign.updateRoomDim(i, f, v);
        window.generateDuctDesign = () => DuctDesign.generate();
        window.saveDuctDesign = () => DataManager.save();
        window.clearDuctDesignForm = () => DuctDesign.clear();
        window.exportDuctDesign = () => ReportGenerator.generatePDF();
        window.refreshHistory = () => History.refresh();
        window.loadReport = i => Navigation.switchPage('service');
        window.deleteReport = i => History.delete(i);
        window.saveData = () => DataManager.save();
        window.loadData = () => DataManager.load();
        window.exportAllData = () => DataManager.exportAll();
        window.generateTextReport = () => ReportGenerator.generateText();
        window.generatePDF = () => ReportGenerator.generatePDF();
        window.generateMaterialsReport = () => ReportGenerator.generateMaterialsList();
        window.generateMaterialsPDF = () => ReportGenerator.generatePDF();
        window.clearForm = () => FormManager.clear();
        window.closeModal = r => UI.closeModal(r);

        // ==================== INIT ====================
        window.addEventListener('load', () => {
            const today = new Date().toISOString().split('T')[0];
            ['service-date', 'sig-date', 'mat-date', 'duct-project-date'].forEach(id => {
                const el = $(id);
                if (el) el.value = today;
            });

            Signature.init();
            Materials.init();
            Quality.calculate();
            DuctDesign.displayRooms();
            Dashboard.updateStats();
            State.savedReports = Storage.load(CONFIG.STORAGE_KEY) || [];

           UI.showToast('Field Buddy Pro Ready!', 'success');
        });
    })();
    </script>
</body>
</html>