<!DOCTYPE html>

<html lang="en">

<head>

<meta charset="utf-8">

<meta name="viewport" content="width=device-width, initial-scale=1,
maximum-scale=1, user-scalable=no">

<meta name="description" content="Field Buddy Pro v4.0 - Modern
Premium HVAC Field Service Management">

<meta name="apple-mobile-web-app-capable" content="yes">

<meta name="apple-mobile-web-app-status-bar-style"
content="black-translucent">

<title>Field Buddy Pro v4.0 - Premium Edition</title>

<!-- CDN Libraries -->

<script
src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script
src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js"></script>

<script
src="https://cdn.jsdelivr.net/npm/signature_pad@4.1.7/dist/signature_pad.umd.min.js"></script>

<style>

/* ==================== MODERN DESIGN SYSTEM ==================== */

:root {

/* Dark Theme Colors */

--bg-primary: #0B1121;

--bg-secondary: #151B2D;

--bg-tertiary: #1E2638;

--bg-elevated: #242D42;

/* Accent Colors */

--accent-cyan: #00D9FF;

--accent-cyan-dark: #00A8CC;

--accent-orange: #FF6B35;

--accent-orange-dark: #E85D2F;

--accent-purple: #A855F7;

--accent-green: #10B981;

--accent-yellow: #FCD34D;

/* Status Colors */

--success: #10B981;

--success-glow: rgba(16, 185, 129, 0.3);

--warning: #FCD34D;

--warning-glow: rgba(252, 211, 77, 0.3);

--danger: #EF4444;

--danger-glow: rgba(239, 68, 68, 0.3);

--info: #3B82F6;

--info-glow: rgba(59, 130, 246, 0.3);

/* Text Colors */

--text-primary: #F8FAFC;

--text-secondary: #CBD5E1;

--text-tertiary: #94A3B8;

--text-disabled: #64748B;

/* Glass Effects */

--glass-bg: rgba(30, 38, 56, 0.7);

--glass-border: rgba(255, 255, 255, 0.1);

--glass-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);

/* Shadows */

--shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.5);

--shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.4);

--shadow-md: 0 10px 15px -3px rgba(0, 0, 0, 0.4);

--shadow-lg: 0 20px 25px -5px rgba(0, 0, 0, 0.5);

--shadow-xl: 0 25px 50px -12px rgba(0, 0, 0, 0.6);

/* Gradients */

--gradient-cyan: linear-gradient(135deg, #00D9FF 0%, #00A8CC 100%);

--gradient-orange: linear-gradient(135deg, #FF6B35 0%, #E85D2F 100%);

--gradient-purple: linear-gradient(135deg, #A855F7 0%, #7C3AED 100%);

--gradient-premium: linear-gradient(135deg, #667EEA 0%, #764BA2 100%);

--gradient-dark: linear-gradient(135deg, #1E2638 0%, #0B1121 100%);

/* Spacing */

--spacing-xs: 4px;

--spacing-sm: 8px;

--spacing-md: 12px;

--spacing-lg: 16px;

--spacing-xl: 24px;

--spacing-2xl: 32px;

--spacing-3xl: 48px;

/* Transitions */

--transition-fast: 0.15s cubic-bezier(0.4, 0, 0.2, 1);

--transition: 0.2s cubic-bezier(0.4, 0, 0.2, 1);

--transition-slow: 0.3s cubic-bezier(0.4, 0, 0.2, 1);

/* Border Radius */

--radius-sm: 6px;

--radius: 12px;

--radius-lg: 16px;

--radius-xl: 24px;

}

/* ==================== RESET & BASE ==================== */

* {

margin: 0;

padding: 0;

box-sizing: border-box;

}

body {

font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto,
'Helvetica Neue', Arial, sans-serif;

background: var(--bg-primary);

color: var(--text-primary);

font-size: 14px;

line-height: 1.6;

overflow-x: hidden;

-webkit-font-smoothing: antialiased;

-moz-osx-font-smoothing: grayscale;

}

/* Custom Scrollbar */

::-webkit-scrollbar {

width: 8px;

height: 8px;

}

::-webkit-scrollbar-track {

background: var(--bg-secondary);

}

::-webkit-scrollbar-thumb {

background: var(--bg-elevated);

border-radius: 4px;

}

::-webkit-scrollbar-thumb:hover {

background: var(--accent-cyan-dark);

}

/* ==================== LAYOUT ==================== */

.app-container {

display: flex;

min-height: 100vh;

}

/* Premium Sidebar */

.sidebar {

width: 280px;

background: var(--bg-secondary);

border-right: 1px solid var(--glass-border);

height: 100vh;

position: fixed;

left: 0;

top: 0;

overflow-y: auto;

z-index: 100;

transition: transform var(--transition-slow);

backdrop-filter: blur(10px);

}

.sidebar-header {

padding: var(--spacing-2xl);

border-bottom: 1px solid var(--glass-border);

background: var(--gradient-dark);

}

.sidebar-logo {

display: flex;

align-items: center;

gap: var(--spacing-lg);

}

.sidebar-logo-icon {

width: 48px;

height: 48px;

background: var(--gradient-cyan);

border-radius: var(--radius-lg);

display: flex;

align-items: center;

justify-content: center;

font-size: 24px;

box-shadow: 0 0 20px var(--success-glow);

animation: pulse-glow 2s ease-in-out infinite;

}

@keyframes pulse-glow {

0%, 100% { box-shadow: 0 0 20px var(--success-glow); }

50% { box-shadow: 0 0 30px var(--success-glow), 0 0 40px
var(--success-glow); }

}

.sidebar-logo-text {

flex: 1;

}

.sidebar-title {

font-size: 18px;

font-weight: 700;

background: var(--gradient-cyan);

-webkit-background-clip: text;

-webkit-text-fill-color: transparent;

background-clip: text;

}

.sidebar-version {

font-size: 11px;

color: var(--text-tertiary);

font-weight: 600;

text-transform: uppercase;

letter-spacing: 1px;

}

.sidebar-nav {

padding: var(--spacing-xl) 0;

}

.nav-section {

margin-bottom: var(--spacing-xl);

}

.nav-section-title {

padding: var(--spacing-sm) var(--spacing-xl);

font-size: 11px;

font-weight: 700;

color: var(--text-tertiary);

text-transform: uppercase;

letter-spacing: 1.2px;

}

.nav-item {

display: flex;

align-items: center;

gap: var(--spacing-md);

padding: var(--spacing-md) var(--spacing-xl);

color: var(--text-secondary);

cursor: pointer;

transition: var(--transition);

border-left: 3px solid transparent;

font-size: 14px;

font-weight: 500;

position: relative;

overflow: hidden;

}

.nav-item::before {

content: '';

position: absolute;

left: 0;

top: 0;

height: 100%;

width: 0;

background: var(--gradient-cyan);

opacity: 0.1;

transition: var(--transition);

}

.nav-item:hover {

color: var(--accent-cyan);

background: rgba(0, 217, 255, 0.05);

}

.nav-item:hover::before {

width: 100%;

}

.nav-item.active {

color: var(--accent-cyan);

background: rgba(0, 217, 255, 0.1);

border-left-color: var(--accent-cyan);

box-shadow: inset 0 0 20px rgba(0, 217, 255, 0.1);

}

.nav-icon {

font-size: 20px;

width: 28px;

text-align: center;

filter: drop-shadow(0 0 8px currentColor);

}

/* Main Content Area */

.main-content {

margin-left: 280px;

flex: 1;

min-height: 100vh;

background: var(--bg-primary);

}

/* Premium Header */

.top-header {

background: var(--glass-bg);

backdrop-filter: blur(20px);

border-bottom: 1px solid var(--glass-border);

padding: 0 var(--spacing-2xl);

height: 72px;

display: flex;

align-items: center;

justify-content: space-between;

position: sticky;

top: 0;

z-index: 50;

box-shadow: var(--shadow);

}

.header-left {

display: flex;

align-items: center;

gap: var(--spacing-lg);

}

.menu-toggle {

display: none;

width: 44px;

height: 44px;

background: var(--bg-elevated);

border: 1px solid var(--glass-border);

border-radius: var(--radius);

cursor: pointer;

align-items: center;

justify-content: center;

font-size: 20px;

color: var(--text-primary);

transition: var(--transition);

}

.menu-toggle:hover {

background: var(--accent-cyan);

border-color: var(--accent-cyan);

box-shadow: 0 0 20px var(--success-glow);

}

.header-title {

font-size: 24px;

font-weight: 700;

background: var(--gradient-cyan);

-webkit-background-clip: text;

-webkit-text-fill-color: transparent;

background-clip: text;

text-shadow: 0 0 30px rgba(0, 217, 255, 0.3);

}

.header-actions {

display: flex;

align-items: center;

gap: var(--spacing-lg);

}

.header-user {

display: flex;

align-items: center;

gap: var(--spacing-md);

padding: var(--spacing-sm) var(--spacing-lg);

background: var(--bg-elevated);

border: 1px solid var(--glass-border);

border-radius: var(--radius-lg);

font-size: 14px;

font-weight: 500;

transition: var(--transition);

cursor: pointer;

}

.header-user:hover {

background: var(--bg-tertiary);

border-color: var(--accent-cyan);

box-shadow: 0 0 20px rgba(0, 217, 255, 0.2);

}

.user-avatar {

width: 40px;

height: 40px;

background: var(--gradient-cyan);

border-radius: 50%;

display: flex;

align-items: center;

justify-content: center;

color: white;

font-weight: 700;

font-size: 14px;

box-shadow: 0 0 20px var(--success-glow);

}

.workspace {

padding: var(--spacing-2xl);

max-width: 1600px;

margin: 0 auto;

}

/* ==================== DASHBOARD TILES ==================== */

.dashboard-grid {

display: grid;

grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));

gap: var(--spacing-xl);

margin-bottom: var(--spacing-3xl);

}

.dashboard-tile {

background: var(--glass-bg);

backdrop-filter: blur(20px);

border: 1px solid var(--glass-border);

border-radius: var(--radius-xl);

padding: var(--spacing-2xl);

cursor: pointer;

transition: var(--transition-slow);

position: relative;

overflow: hidden;

min-height: 200px;

display: flex;

flex-direction: column;

box-shadow: var(--shadow);

}

.dashboard-tile::before {

content: '';

position: absolute;

top: 0;

left: 0;

right: 0;

height: 4px;

background: var(--gradient-cyan);

opacity: 0;

transition: var(--transition);

}

.dashboard-tile:hover {

transform: translateY(-8px);

box-shadow: var(--shadow-xl), 0 0 40px rgba(0, 217, 255, 0.3);

border-color: var(--accent-cyan);

}

.dashboard-tile:hover::before {

opacity: 1;

}

.tile-header {

display: flex;

align-items: flex-start;

justify-content: space-between;

margin-bottom: var(--spacing-lg);

}

.tile-icon {

width: 56px;

height: 56px;

border-radius: var(--radius-lg);

display: flex;

align-items: center;

justify-content: center;

font-size: 28px;

background: var(--gradient-cyan);

box-shadow: 0 0 20px var(--success-glow);

animation: float 3s ease-in-out infinite;

}

@keyframes float {

0%, 100% { transform: translateY(0); }

50% { transform: translateY(-10px); }

}

.tile-icon.orange { background: var(--gradient-orange); box-shadow: 0 0
20px rgba(255, 107, 53, 0.4); }

.tile-icon.purple { background: var(--gradient-purple); box-shadow: 0 0
20px rgba(168, 85, 247, 0.4); }

.tile-icon.premium { background: var(--gradient-premium); box-shadow: 0
0 20px rgba(102, 126, 234, 0.4); }

.tile-badge {

padding: 4px 12px;

border-radius: 20px;

font-size: 10px;

font-weight: 700;

text-transform: uppercase;

letter-spacing: 0.5px;

background: var(--gradient-cyan);

color: white;

box-shadow: 0 0 10px var(--success-glow);

}

.tile-badge.pro {

background: var(--gradient-orange);

box-shadow: 0 0 10px rgba(255, 107, 53, 0.4);

}

.tile-badge.premium {

background: var(--gradient-purple);

box-shadow: 0 0 10px rgba(168, 85, 247, 0.4);

}

.tile-content {

flex: 1;

}

.tile-title {

font-size: 20px;

font-weight: 700;

color: var(--text-primary);

margin-bottom: var(--spacing-sm);

}

.tile-description {

font-size: 14px;

color: var(--text-secondary);

line-height: 1.6;

}

.tile-stats {

display: flex;

gap: var(--spacing-lg);

margin-top: var(--spacing-lg);

padding-top: var(--spacing-lg);

border-top: 1px solid var(--glass-border);

}

.tile-stat {

flex: 1;

}

.tile-stat-value {

font-size: 18px;

font-weight: 700;

color: var(--accent-cyan);

display: block;

}

.tile-stat-label {

font-size: 11px;

color: var(--text-tertiary);

text-transform: uppercase;

letter-spacing: 0.5px;

}

/* ==================== CARDS ==================== */

.card {

background: var(--glass-bg);

backdrop-filter: blur(20px);

border: 1px solid var(--glass-border);

border-radius: var(--radius-xl);

margin-bottom: var(--spacing-xl);

box-shadow: var(--shadow);

overflow: hidden;

transition: var(--transition);

}

.card:hover {

box-shadow: var(--shadow-lg);

border-color: rgba(0, 217, 255, 0.3);

}

.card-header {

padding: var(--spacing-xl);

border-bottom: 1px solid var(--glass-border);

display: flex;

align-items: center;

justify-content: space-between;

background: rgba(0, 0, 0, 0.2);

}

.card-title {

font-size: 18px;

font-weight: 700;

color: var(--text-primary);

display: flex;

align-items: center;

gap: var(--spacing-sm);

}

.card-body {

padding: var(--spacing-xl);

}

.card-section {

margin-bottom: var(--spacing-xl);

}

.card-section:last-child {

margin-bottom: 0;

}

.section-title {

font-size: 14px;

font-weight: 700;

color: var(--accent-cyan);

margin-bottom: var(--spacing-md);

text-transform: uppercase;

letter-spacing: 0.5px;

display: flex;

align-items: center;

gap: var(--spacing-sm);

}

.section-title::before {

content: '';

width: 4px;

height: 16px;

background: var(--gradient-cyan);

border-radius: 2px;

}

/* ==================== FORMS ==================== */

.form-grid {

display: grid;

gap: var(--spacing-lg);

}

.form-grid-2 { grid-template-columns: repeat(auto-fit, minmax(250px,
1fr)); }

.form-grid-3 { grid-template-columns: repeat(auto-fit, minmax(200px,
1fr)); }

.form-grid-4 { grid-template-columns: repeat(auto-fit, minmax(180px,
1fr)); }

.form-group {

margin-bottom: 0;

position: relative;

}

label {

display: block;

font-size: 13px;

font-weight: 600;

color: var(--text-secondary);

margin-bottom: var(--spacing-sm);

letter-spacing: 0.3px;

}

.help-icon {

display: inline-flex;

align-items: center;

justify-content: center;

width: 16px;

height: 16px;

background: var(--accent-cyan);

color: var(--bg-primary);

border-radius: 50%;

font-size: 10px;

font-weight: 700;

cursor: help;

margin-left: 4px;

position: relative;

box-shadow: 0 0 10px var(--success-glow);

}

.help-icon:hover::after {

content: attr(data-tooltip);

position: absolute;

bottom: 120%;

left: 50%;

transform: translateX(-50%);

background: var(--bg-elevated);

color: var(--text-primary);

padding: 8px 12px;

border-radius: var(--radius);

font-size: 12px;

font-weight: normal;

white-space: nowrap;

z-index: 1000;

box-shadow: var(--shadow-lg);

border: 1px solid var(--glass-border);

animation: fadeIn 0.2s ease;

}

@keyframes fadeIn {

from { opacity: 0; transform: translateX(-50%) translateY(-5px); }

to { opacity: 1; transform: translateX(-50%) translateY(0); }

}

input, select, textarea {

width: 100%;

padding: var(--spacing-md) var(--spacing-lg);

border: 1px solid var(--glass-border);

border-radius: var(--radius);

font-size: 14px;

font-family: inherit;

background: var(--bg-elevated);

color: var(--text-primary);

transition: var(--transition);

}

input:focus, select:focus, textarea:focus {

outline: none;

border-color: var(--accent-cyan);

box-shadow: 0 0 0 3px rgba(0, 217, 255, 0.2), 0 0 20px rgba(0, 217, 255,
0.3);

background: var(--bg-tertiary);

}

input[readonly] {

background: var(--bg-secondary);

color: var(--text-tertiary);

border-color: var(--bg-elevated);

}

input.warning {

border-color: var(--warning);

background: rgba(252, 211, 77, 0.05);

}

input.error {

border-color: var(--danger);

background: rgba(239, 68, 68, 0.05);

}

textarea {

resize: vertical;

min-height: 100px;

line-height: 1.6;

}

/* ==================== BUTTONS ==================== */

.btn {

display: inline-flex;

align-items: center;

justify-content: center;

gap: var(--spacing-sm);

padding: var(--spacing-md) var(--spacing-xl);

border: none;

border-radius: var(--radius);

font-size: 14px;

font-weight: 600;

cursor: pointer;

transition: var(--transition);

min-height: 44px;

position: relative;

overflow: hidden;

}

.btn::before {

content: '';

position: absolute;

top: 50%;

left: 50%;

width: 0;

height: 0;

border-radius: 50%;

background: rgba(255, 255, 255, 0.2);

transform: translate(-50%, -50%);

transition: width 0.6s, height 0.6s;

}

.btn:active::before {

width: 300px;

height: 300px;

}

.btn:disabled {

opacity: 0.5;

cursor: not-allowed;

}

.btn-primary {

background: var(--gradient-cyan);

color: white;

box-shadow: 0 0 20px var(--success-glow);

}

.btn-primary:hover:not(:disabled) {

box-shadow: 0 0 30px var(--success-glow), 0 0 40px
var(--success-glow);

transform: translateY(-2px);

}

.btn-success {

background: var(--gradient-cyan);

color: white;

box-shadow: 0 0 20px var(--success-glow);

}

.btn-success:hover:not(:disabled) {

box-shadow: 0 0 30px var(--success-glow);

transform: translateY(-2px);

}

.btn-warning {

background: var(--gradient-orange);

color: white;

box-shadow: 0 0 20px rgba(255, 107, 53, 0.4);

}

.btn-warning:hover:not(:disabled) {

box-shadow: 0 0 30px rgba(255, 107, 53, 0.4);

transform: translateY(-2px);

}

.btn-secondary {

background: var(--bg-elevated);

color: var(--text-primary);

border: 1px solid var(--glass-border);

}

.btn-secondary:hover:not(:disabled) {

background: var(--bg-tertiary);

border-color: var(--accent-cyan);

box-shadow: 0 0 20px rgba(0, 217, 255, 0.2);

}

.btn-danger {

background: linear-gradient(135deg, #EF4444 0%, #DC2626 100%);

color: white;

box-shadow: 0 0 20px var(--danger-glow);

}

.btn-danger:hover:not(:disabled) {

box-shadow: 0 0 30px var(--danger-glow);

transform: translateY(-2px);

}

.btn-group {

display: flex;

gap: var(--spacing-sm);

flex-wrap: wrap;

}

.btn-sm {

padding: var(--spacing-sm) var(--spacing-lg);

font-size: 12px;

min-height: 36px;

}

/* ==================== TOGGLE BUTTONS ==================== */

.toggle-group {

display: inline-flex;

background: var(--bg-elevated);

border: 1px solid var(--glass-border);

border-radius: var(--radius);

padding: 4px;

gap: 4px;

}

.toggle-btn {

padding: var(--spacing-sm) var(--spacing-xl);

border: none;

background: transparent;

border-radius: calc(var(--radius) - 2px);

font-size: 13px;

font-weight: 600;

cursor: pointer;

transition: var(--transition);

color: var(--text-secondary);

min-width: 120px;

}

.toggle-btn.active {

background: var(--gradient-cyan);

color: white;

box-shadow: 0 0 20px var(--success-glow);

}

/* ==================== BADGES ==================== */

.badge {

display: inline-flex;

align-items: center;

padding: 6px 12px;

border-radius: 20px;

font-size: 11px;

font-weight: 700;

text-transform: uppercase;

letter-spacing: 0.5px;

box-shadow: var(--shadow);

}

.badge-success {

background: rgba(16, 185, 129, 0.2);

color: var(--success);

border: 1px solid var(--success);

box-shadow: 0 0 10px var(--success-glow);

}

.badge-warning {

background: rgba(252, 211, 77, 0.2);

color: var(--warning);

border: 1px solid var(--warning);

box-shadow: 0 0 10px var(--warning-glow);

}

.badge-danger {

background: rgba(239, 68, 68, 0.2);

color: var(--danger);

border: 1px solid var(--danger);

box-shadow: 0 0 10px var(--danger-glow);

}

.badge-info {

background: rgba(59, 130, 246, 0.2);

color: var(--info);

border: 1px solid var(--info);

box-shadow: 0 0 10px var(--info-glow);

}

/* ==================== QUALITY DASHBOARD ==================== */

.quality-dashboard {

background: var(--gradient-premium);

border-radius: var(--radius-xl);

padding: var(--spacing-2xl);

margin-bottom: var(--spacing-xl);

color: white;

box-shadow: var(--shadow-xl), 0 0 40px rgba(102, 126, 234, 0.4);

position: relative;

overflow: hidden;

}

.quality-dashboard::before {

content: '';

position: absolute;

top: -50%;

right: -50%;

width: 200%;

height: 200%;

background: radial-gradient(circle, rgba(255,255,255,0.1) 0%,
transparent 70%);

animation: rotate 20s linear infinite;

}

@keyframes rotate {

from { transform: rotate(0deg); }

to { transform: rotate(360deg); }

}

.quality-header {

font-size: 20px;

font-weight: 700;

margin-bottom: var(--spacing-lg);

display: flex;

align-items: center;

justify-content: space-between;

position: relative;

z-index: 1;

}

.quality-score-large {

font-size: 64px;

font-weight: 700;

text-align: center;

margin: var(--spacing-xl) 0;

text-shadow: 0 0 40px rgba(255, 255, 255, 0.5);

position: relative;

z-index: 1;

}

.quality-metrics {

display: grid;

grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));

gap: var(--spacing-lg);

margin-top: var(--spacing-xl);

position: relative;

z-index: 1;

}

.quality-metric {

background: rgba(255, 255, 255, 0.1);

backdrop-filter: blur(10px);

border: 1px solid rgba(255, 255, 255, 0.2);

border-radius: var(--radius-lg);

padding: var(--spacing-lg);

text-align: center;

transition: var(--transition);

}

.quality-metric:hover {

background: rgba(255, 255, 255, 0.15);

transform: translateY(-4px);

}

.metric-value {

font-size: 28px;

font-weight: 700;

margin-bottom: 4px;

text-shadow: 0 0 20px rgba(255, 255, 255, 0.5);

}

.metric-label {

font-size: 12px;

opacity: 0.9;

text-transform: uppercase;

letter-spacing: 0.5px;

}

/* ==================== DIAGNOSTIC PANEL ==================== */

.diagnostic-panel {

background: var(--gradient-dark);

border: 1px solid var(--glass-border);

border-radius: var(--radius-xl);

padding: var(--spacing-xl);

margin: var(--spacing-xl) 0;

box-shadow: var(--shadow-lg);

}

.diagnostic-header {

font-size: 20px;

font-weight: 700;

margin-bottom: var(--spacing-lg);

display: flex;

align-items: center;

gap: var(--spacing-sm);

color: var(--accent-cyan);

}

.diagnostic-card {

background: var(--bg-elevated);

border: 1px solid var(--glass-border);

border-radius: var(--radius-lg);

padding: var(--spacing-lg);

margin-bottom: var(--spacing-md);

transition: var(--transition);

}

.diagnostic-card:hover {

border-color: var(--accent-cyan);

box-shadow: 0 0 20px rgba(0, 217, 255, 0.2);

}

.diagnostic-card:last-child {

margin-bottom: 0;

}

.diagnostic-card-header {

display: flex;

align-items: center;

justify-content: space-between;

margin-bottom: var(--spacing-sm);

}

.diagnostic-card-title {

font-weight: 700;

font-size: 16px;

color: var(--text-primary);

}

.diagnostic-recommendations {

margin-top: var(--spacing-md);

padding-top: var(--spacing-md);

border-top: 1px solid var(--glass-border);

}

.diagnostic-recommendations ul {

margin: var(--spacing-sm) 0;

padding-left: var(--spacing-xl);

font-size: 13px;

}

.diagnostic-recommendations li {

margin: var(--spacing-sm) 0;

color: var(--text-secondary);

}

/* ==================== PHOTO GALLERY ==================== */

.photo-gallery {

display: grid;

grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));

gap: var(--spacing-md);

margin-top: var(--spacing-md);

}

.photo-item {

position: relative;

aspect-ratio: 1;

border-radius: var(--radius-lg);

overflow: hidden;

border: 2px solid var(--glass-border);

cursor: pointer;

background: var(--bg-elevated);

transition: var(--transition);

}

.photo-item:hover {

border-color: var(--accent-cyan);

box-shadow: 0 0 20px rgba(0, 217, 255, 0.3);

transform: scale(1.05);

}

.photo-item img {

width: 100%;

height: 100%;

object-fit: cover;

}

.photo-item-actions {

position: absolute;

top: 8px;

right: 8px;

display: flex;

gap: 4px;

opacity: 0;

transition: var(--transition);

}

.photo-item:hover .photo-item-actions {

opacity: 1;

}

.photo-btn {

width: 32px;

height: 32px;

border-radius: var(--radius);

border: none;

background: rgba(0, 0, 0, 0.8);

backdrop-filter: blur(10px);

color: white;

cursor: pointer;

display: flex;

align-items: center;

justify-content: center;

font-size: 14px;

transition: var(--transition);

}

.photo-btn:hover {

background: var(--danger);

box-shadow: 0 0 10px var(--danger-glow);

}

.photo-upload {

aspect-ratio: 1;

border: 2px dashed var(--glass-border);

border-radius: var(--radius-lg);

display: flex;

flex-direction: column;

align-items: center;

justify-content: center;

cursor: pointer;

background: var(--bg-elevated);

transition: var(--transition);

}

.photo-upload:hover {

border-color: var(--accent-cyan);

background: rgba(0, 217, 255, 0.05);

box-shadow: 0 0 20px rgba(0, 217, 255, 0.2);

}

/* ==================== SIGNATURE PAD ==================== */

.signature-pad {

width: 100%;

height: 200px;

border: 2px solid var(--glass-border);

border-radius: var(--radius-lg);

cursor: crosshair;

background: var(--bg-elevated);

transition: var(--transition);

}

.signature-pad:hover {

border-color: var(--accent-cyan);

box-shadow: 0 0 20px rgba(0, 217, 255, 0.2);

}

/* ==================== CHART ==================== */

.chart-container {

height: 300px;

margin: var(--spacing-lg) 0;

position: relative;

background: var(--bg-elevated);

border: 1px solid var(--glass-border);

border-radius: var(--radius-lg);

padding: var(--spacing-lg);

}

/* ==================== CHECKLIST ==================== */

.checklist-item {

display: flex;

align-items: flex-start;

padding: var(--spacing-md);

background: var(--bg-elevated);

border: 1px solid var(--glass-border);

border-radius: var(--radius);

margin-bottom: var(--spacing-sm);

cursor: pointer;

transition: var(--transition);

}

.checklist-item:hover {

border-color: var(--accent-cyan);

background: var(--bg-tertiary);

box-shadow: 0 0 20px rgba(0, 217, 255, 0.1);

}

.checklist-item.checked {

border-color: var(--success);

background: rgba(16, 185, 129, 0.1);

}

input[type="checkbox"] {

width: 20px;

height: 20px;

margin-right: var(--spacing-md);

accent-color: var(--accent-cyan);

cursor: pointer;

flex-shrink: 0;

margin-top: 2px;

}

.checklist-item label {

margin: 0;

cursor: pointer;

font-weight: 400;

font-size: 13px;

line-height: 1.6;

color: var(--text-secondary);

}

/* ==================== MATERIALS CATALOG ==================== */

.materials-category {

margin-bottom: var(--spacing-md);

border: 1px solid var(--glass-border);

border-radius: var(--radius-lg);

overflow: hidden;

background: var(--bg-elevated);

transition: var(--transition);

}

.materials-category:hover {

border-color: var(--accent-cyan);

box-shadow: 0 0 20px rgba(0, 217, 255, 0.1);

}

.category-header {

display: flex;

align-items: center;

justify-content: space-between;

padding: var(--spacing-lg);

background: var(--bg-tertiary);

cursor: pointer;

user-select: none;

transition: var(--transition);

border-bottom: 1px solid var(--glass-border);

}

.category-header:hover {

background: var(--bg-elevated);

}

.category-title-group {

display: flex;

align-items: center;

gap: var(--spacing-md);

}

.category-icon {

font-size: 24px;

filter: drop-shadow(0 0 8px currentColor);

}

.category-name {

font-weight: 700;

font-size: 16px;

color: var(--text-primary);

}

.category-meta {

display: flex;

align-items: center;

gap: var(--spacing-sm);

}

.category-count {

font-size: 11px;

color: var(--text-tertiary);

background: var(--bg-elevated);

padding: 4px 10px;

border-radius: 12px;

font-weight: 600;

border: 1px solid var(--glass-border);

}

.category-selected {

font-size: 11px;

color: white;

background: var(--gradient-cyan);

padding: 4px 10px;

border-radius: 12px;

font-weight: 700;

box-shadow: 0 0 10px var(--success-glow);

}

.category-arrow {

transition: transform 0.3s ease;

color: var(--text-tertiary);

font-size: 16px;

}

.materials-category.expanded .category-arrow {

transform: rotate(180deg);

}

.category-items {

max-height: 0;

overflow: hidden;

transition: max-height 0.3s ease;

}

.materials-category.expanded .category-items {

max-height: 10000px;

}

.material-item {

display: flex;

align-items: center;

padding: var(--spacing-md) var(--spacing-lg);

border-top: 1px solid var(--glass-border);

background: var(--bg-secondary);

transition: var(--transition);

}

.material-item:hover {

background: var(--bg-tertiary);

box-shadow: inset 0 0 20px rgba(0, 217, 255, 0.05);

}

.material-item:first-child {

border-top: none;

}

.material-info {

flex: 1;

margin-left: var(--spacing-sm);

}

.material-name {

font-weight: 600;

font-size: 14px;

color: var(--text-primary);

}

.material-spec {

font-size: 12px;

color: var(--text-tertiary);

margin-top: 2px;

}

/* ==================== SELECTED MATERIALS ==================== */

.selected-material {

display: flex;

align-items: center;

gap: var(--spacing-md);

padding: var(--spacing-md);

background: var(--bg-elevated);

border: 1px solid var(--glass-border);

border-radius: var(--radius);

margin-bottom: var(--spacing-sm);

transition: var(--transition);

}

.selected-material:hover {

border-color: var(--accent-cyan);

box-shadow: 0 0 20px rgba(0, 217, 255, 0.1);

}

.selected-material-info {

flex: 1;

}

.selected-material-controls {

display: flex;

align-items: center;

gap: var(--spacing-sm);

}

.selected-material-controls select,

.selected-material-controls input {

padding: 8px 12px;

font-size: 13px;

border: 1px solid var(--glass-border);

}

.selected-material-controls select {

width: 140px;

}

.selected-material-controls input {

width: 70px;

text-align: center;

}

/* ==================== STATUS CARDS ==================== */

.status-card {

padding: var(--spacing-lg);

border-radius: var(--radius-lg);

border-left: 4px solid;

font-size: 14px;

line-height: 1.6;

margin-bottom: var(--spacing-md);

backdrop-filter: blur(10px);

}

.status-card.success {

background: rgba(16, 185, 129, 0.1);

border-color: var(--success);

color: var(--success);

}

.status-card.warning {

background: rgba(252, 211, 77, 0.1);

border-color: var(--warning);

color: var(--warning);

}

.status-card.danger {

background: rgba(239, 68, 68, 0.1);

border-color: var(--danger);

color: var(--danger);

}

.status-card.info {

background: rgba(59, 130, 246, 0.1);

border-color: var(--info);

color: var(--info);

}

/* ==================== TOAST ==================== */

.toast {

position: fixed;

bottom: 30px;

right: 30px;

background: var(--bg-elevated);

backdrop-filter: blur(20px);

border: 1px solid var(--glass-border);

color: white;

padding: var(--spacing-lg) var(--spacing-xl);

border-radius: var(--radius-lg);

box-shadow: var(--shadow-xl);

z-index: 9999;

font-size: 14px;

font-weight: 600;

opacity: 0;

transform: translateY(20px);

transition: var(--transition);

min-width: 280px;

text-align: center;

}

.toast.show {

opacity: 1;

transform: translateY(0);

}

.toast.success {

background: var(--gradient-cyan);

box-shadow: var(--shadow-xl), 0 0 30px var(--success-glow);

}

.toast.danger {

background: linear-gradient(135deg, #EF4444 0%, #DC2626 100%);

box-shadow: var(--shadow-xl), 0 0 30px var(--danger-glow);

}

.toast.warning {

background: var(--gradient-orange);

box-shadow: var(--shadow-xl), 0 0 30px rgba(255, 107, 53, 0.4);

}

/* ==================== MODAL ==================== */

.modal-overlay {

position: fixed;

top: 0;

left: 0;

right: 0;

bottom: 0;

background: rgba(0, 0, 0, 0.8);

backdrop-filter: blur(10px);

display: none;

align-items: center;

justify-content: center;

z-index: 10000;

padding: var(--spacing-xl);

animation: fadeIn 0.3s ease;

}

.modal-overlay.show {

display: flex;

}

.modal {

background: var(--bg-secondary);

border: 1px solid var(--glass-border);

border-radius: var(--radius-xl);

padding: var(--spacing-2xl);

max-width: 500px;

width: 100%;

box-shadow: var(--shadow-xl);

animation: slideUp 0.3s ease;

}

@keyframes slideUp {

from { opacity: 0; transform: translateY(20px); }

to { opacity: 1; transform: translateY(0); }

}

.modal-title {

font-size: 24px;

font-weight: 700;

margin-bottom: var(--spacing-md);

color: var(--text-primary);

}

.modal-content {

color: var(--text-secondary);

margin-bottom: var(--spacing-xl);

line-height: 1.6;

font-size: 14px;

}

.modal-actions {

display: flex;

gap: var(--spacing-sm);

justify-content: flex-end;

}

/* ==================== DUCT DESIGN TREE ==================== */

.duct-tree {

font-family: 'Courier New', monospace;

font-size: 12px;

background: var(--bg-elevated);

padding: var(--spacing-lg);

border-radius: var(--radius-lg);

border: 1px solid var(--glass-border);

line-height: 1.8;

overflow-x: auto;

color: var(--text-secondary);

}

.duct-branch {

margin-left: 20px;

padding: 4px 0;

color: var(--text-tertiary);

}

.duct-trunk {

font-weight: 700;

color: var(--accent-cyan);

text-shadow: 0 0 10px var(--success-glow);

}

/* ==================== INFO BOX ==================== */

.info-box {

background: var(--bg-elevated);

border: 1px solid var(--glass-border);

border-radius: var(--radius-lg);

padding: var(--spacing-lg);

margin: var(--spacing-md) 0;

}

.info-box-title {

font-weight: 700;

font-size: 14px;

color: var(--accent-cyan);

margin-bottom: var(--spacing-sm);

}

.info-box-content {

font-size: 13px;

color: var(--text-secondary);

line-height: 1.6;

}

/* ==================== UTILITIES ==================== */

.hidden { display: none !important; }

.mt-lg { margin-top: var(--spacing-lg); }

.mb-lg { margin-bottom: var(--spacing-lg); }

/* ==================== MOBILE MENU ==================== */

.mobile-menu-overlay {

display: none;

position: fixed;

top: 0;

left: 0;

right: 0;

bottom: 0;

background: rgba(0, 0, 0, 0.8);

backdrop-filter: blur(10px);

z-index: 99;

opacity: 0;

transition: opacity 0.3s ease;

}

.mobile-menu-overlay.show {

display: block;

opacity: 1;

}

/* ==================== RESPONSIVE ==================== */

@media (max-width: 1024px) {

.sidebar {

transform: translateX(-100%);

}

.sidebar.mobile-open {

transform: translateX(0);

box-shadow: var(--shadow-xl);

}

.main-content {

margin-left: 0;

}

.menu-toggle {

display: flex;

}

.form-grid-2,

.form-grid-3,

.form-grid-4 {

grid-template-columns: 1fr;

}

.quality-metrics {

grid-template-columns: repeat(2, 1fr);

}

.dashboard-grid {

grid-template-columns: 1fr;

}

}

@media (max-width: 768px) {

.workspace {

padding: var(--spacing-lg);

}

.top-header {

padding: 0 var(--spacing-lg);

height: 64px;

}

.header-title {

font-size: 18px;

}

.quality-metrics {

grid-template-columns: 1fr;

}

.photo-gallery {

grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));

}

.tile-stats {

flex-direction: column;

}

}

</style>

</head>

<body>

<div class="app-container">

<!-- MOBILE MENU OVERLAY -->

<div class="mobile-menu-overlay" id="mobile-menu-overlay"
onclick="toggleMobileMenu()"></div>

<!-- PREMIUM SIDEBAR -->

<aside class="sidebar" id="sidebar">

<div class="sidebar-header">

<div class="sidebar-logo">

<div class="sidebar-logo-icon">üîß</div>

<div class="sidebar-logo-text">

<div class="sidebar-title">Field Buddy Pro</div>

<div class="sidebar-version">v4.0 Premium</div>

</div>

</div>

</div>

<nav class="sidebar-nav">

<div class="nav-section">

<div class="nav-section-title">Navigation</div>

<div class="nav-item active" onclick="switchPage('dashboard')">

<span class="nav-icon">üè†</span>

<span>Dashboard</span>

</div>

<div class="nav-item" onclick="switchPage('service')">

<span class="nav-icon">üìã</span>

<span>Service Calls</span>

</div>

<div class="nav-item" onclick="switchPage('materials')">

<span class="nav-icon">üì¶</span>

<span>Materials</span>

</div>

<div class="nav-item" onclick="switchPage('duct-design')">

<span class="nav-icon">üèóÔ∏è</span>

<span>Pro Duct Design</span>

</div>

<div class="nav-item" onclick="switchPage('cfm')">

<span class="nav-icon">üå™Ô∏è</span>

<span>CFM Calculator</span>

</div>

<div class="nav-item" onclick="switchPage('history')">

<span class="nav-icon">üìä</span>

<span>History & Reports</span>

</div>

</div>

<div class="nav-section">

<div class="nav-section-title">Tools</div>

<div class="nav-item" onclick="saveData()">

<span class="nav-icon">üíæ</span>

<span>Save Progress</span>

</div>

<div class="nav-item" onclick="loadData()">

<span class="nav-icon">üì•</span>

<span>Load Saved Data</span>

</div>

<div class="nav-item" onclick="exportAllData()">

<span class="nav-icon">üì§</span>

<span>Export All Data</span>

</div>

</div>

</nav>

</aside>

<!-- MAIN CONTENT -->

<main class="main-content">

<!-- PREMIUM HEADER -->

<header class="top-header">

<div class="header-left">

<button class="menu-toggle"
onclick="toggleMobileMenu()">‚ò∞</button>

<div class="header-title" id="page-title">Dashboard</div>

</div>

<div class="header-actions">

<div class="header-user">

<div class="user-avatar">MP</div>

<span id="header-tech-name">Mart√≠n Perez</span>

</div>

</div>

</header>

<!-- WORKSPACE -->

<div class="workspace">

<!-- ==================== DASHBOARD PAGE ==================== -->

<div id="dashboard-page" class="page-content">

<div style="margin-bottom: var(--spacing-2xl);">

<h1 style="font-size: 32px; font-weight: 700; margin-bottom:
var(--spacing-sm); background: var(--gradient-cyan);
-webkit-background-clip: text; -webkit-text-fill-color: transparent;
background-clip: text;">

Welcome Back, Mart√≠n! üëã

</h1>

<p style="color: var(--text-secondary); font-size: 16px;">

Your professional HVAC field service management system

</p>

</div>

<div class="dashboard-grid">

<!-- Service Calls Tile -->

<div class="dashboard-tile" onclick="switchPage('service')">

<div class="tile-header">

<div class="tile-icon">üìã</div>

<div class="tile-badge premium">Advanced</div>

</div>

<div class="tile-content">

<div class="tile-title">Service Calls</div>

<div class="tile-description">

Complete diagnostic system with refrigerant calculations, temperature
analysis, and professional reporting

</div>

<div class="tile-stats">

<div class="tile-stat">

<span class="tile-stat-value" id="dash-stat-reports">0</span>

<span class="tile-stat-label">Reports</span>

</div>

<div class="tile-stat">

<span class="tile-stat-value" id="dash-stat-quality">0%</span>

<span class="tile-stat-label">Avg Quality</span>

</div>

</div>

</div>

</div>

<!-- Materials Tile -->

<div class="dashboard-tile" onclick="switchPage('materials')">

<div class="tile-header">

<div class="tile-icon orange">üì¶</div>

<div class="tile-badge pro">Pro</div>

</div>

<div class="tile-content">

<div class="tile-title">Materials Catalog</div>

<div class="tile-description">

Comprehensive 2025 materials database with instant lookup and
professional takeoff lists

</div>

<div class="tile-stats">

<div class="tile-stat">

<span class="tile-stat-value">1000+</span>

<span class="tile-stat-label">Items</span>

</div>

<div class="tile-stat">

<span class="tile-stat-value">12</span>

<span class="tile-stat-label">Categories</span>

</div>

</div>

</div>

</div>

<!-- Duct Design Tile -->

<div class="dashboard-tile" onclick="switchPage('duct-design')">

<div class="tile-header">

<div class="tile-icon purple">üèóÔ∏è</div>

<div class="tile-badge">Premium</div>

</div>

<div class="tile-content">

<div class="tile-title">Pro Duct Design</div>

<div class="tile-description">

ACCA Manual D compliant duct system design with CFM calculations and
material takeoffs

</div>

<div class="tile-stats">

<div class="tile-stat">

<span class="tile-stat-value">‚úì</span>

<span class="tile-stat-label">ACCA Compliant</span>

</div>

<div class="tile-stat">

<span class="tile-stat-value">Auto</span>

<span class="tile-stat-label">Material List</span>

</div>

</div>

</div>

</div>

<!-- CFM Calculator Tile -->

<div class="dashboard-tile" onclick="switchPage('cfm')">

<div class="tile-header">

<div class="tile-icon premium">üå™Ô∏è</div>

<div class="tile-badge">Essential</div>

</div>

<div class="tile-content">

<div class="tile-title">CFM & Duct Sizing</div>

<div class="tile-description">

Professional airflow and duct sizing calculators with multiple
calculation methods

</div>

<div class="tile-stats">

<div class="tile-stat">

<span class="tile-stat-value">4</span>

<span class="tile-stat-label">Calculators</span>

</div>

<div class="tile-stat">

<span class="tile-stat-value">Instant</span>

<span class="tile-stat-label">Results</span>

</div>

</div>

</div>

</div>

<!-- History Tile -->

<div class="dashboard-tile" onclick="switchPage('history')">

<div class="tile-header">

<div class="tile-icon orange">üìä</div>

<div class="tile-badge pro">Pro</div>

</div>

<div class="tile-content">

<div class="tile-title">History & Reports</div>

<div class="tile-description">

Access all saved reports, track statistics, and manage your service
history

</div>

<div class="tile-stats">

<div class="tile-stat">

<span class="tile-stat-value" id="dash-stat-total">0</span>

<span class="tile-stat-label">Total</span>

</div>

<div class="tile-stat">

<span class="tile-stat-value" id="dash-stat-month">0</span>

<span class="tile-stat-label">This Month</span>

</div>

</div>

</div>

</div>

<!-- Quick Actions Tile -->

<div class="dashboard-tile" style="background:
var(--gradient-premium);">

<div class="tile-header">

<div class="tile-icon" style="background:
rgba(255,255,255,0.2);">‚ö°</div>

</div>

<div class="tile-content">

<div class="tile-title" style="color: white;">Quick
Actions</div>

<div class="tile-description" style="color: rgba(255,255,255,0.9);
margin-bottom: var(--spacing-lg);">

Common tasks and shortcuts

</div>

<div style="display: flex; flex-direction: column; gap:
var(--spacing-sm);">

<button class="btn btn-secondary" onclick="switchPage('service')"
style="justify-content: flex-start;">

<span>üÜï</span> New Service Call

</button>

<button class="btn btn-secondary"
onclick="switchPage('materials')" style="justify-content:
flex-start;">

<span>üìù</span> Create Material List

</button>

<button class="btn btn-secondary" onclick="saveData()"
style="justify-content: flex-start;">

<span>üíæ</span> Save Progress

</button>

</div>

</div>

</div>

</div>

</div><!-- SERVICE CALL PAGE -->

<div id="service-page" class="page-content hidden">

<!-- Quality Dashboard -->

<div class="quality-dashboard" id="quality-dashboard">

<div class="quality-header">

<span>üìä Report Quality Score</span>

<span id="quality-badge" class="badge badge-info">In
Progress</span>

</div>

<div class="quality-score-large"
id="quality-score-large">0%</div>

<div class="quality-metrics">

<div class="quality-metric">

<div class="metric-value" id="metric-basic">0/5</div>

<div class="metric-label">Basic Info</div>

</div>

<div class="quality-metric">

<div class="metric-value" id="metric-diagnostics">0/3</div>

<div class="metric-label">Diagnostics</div>

</div>

<div class="quality-metric">

<div class="metric-value" id="metric-photos">0</div>

<div class="metric-label">Photos</div>

</div>

<div class="quality-metric">

<div class="metric-value" id="metric-signature">‚úó</div>

<div class="metric-label">Signature</div>

</div>

</div>

</div>

<!-- System Mode Selector -->

<div class="card">

<div class="card-header">

<div class="card-title">System Mode</div>

<div class="toggle-group">

<button class="toggle-btn active" id="mode-cooling"
onclick="setSystemMode('cooling')">

‚ùÑÔ∏è Cooling

</button>

<button class="toggle-btn" id="mode-heating"
onclick="setSystemMode('heating')">

üî• Heating

</button>

</div>

</div>

</div>

<!-- Job Information -->

<div class="card">

<div class="card-header">

<div class="card-title">Job Information</div>

</div>

<div class="card-body">

<div class="card-section">

<label>Call Type</label>

<div class="toggle-group">

<button class="toggle-btn active" id="call-trouble"
onclick="setCallType('trouble')">

Trouble Call

</button>

<button class="toggle-btn" id="call-maintenance"
onclick="setCallType('maintenance')">

Maintenance

</button>

</div>

</div>

<div class="form-grid form-grid-2">

<div class="form-group">

<label>Customer Name</label>

<input type="text" id="customer-name" placeholder="Enter customer
name" oninput="calculateQuality()">

</div>

<div class="form-group">

<label>Date</label>

<input type="date" id="service-date"
oninput="calculateQuality()">

</div>

</div>

<div class="form-grid">

<div class="form-group">

<label>Service Address</label>

<input type="text" id="service-address" placeholder="123 Main St,
City, State ZIP" oninput="calculateQuality()">

</div>

</div>

<div class="form-grid">

<div class="form-group">

<label>Customer Complaint / Reason for Service</label>

<textarea id="customer-complaint" placeholder="Describe the issue or
maintenance reason..." oninput="calculateQuality()"></textarea>

</div>

</div>

</div>

</div>

<!-- Equipment Information -->

<div class="card">

<div class="card-header">

<div class="card-title">Equipment Information</div>

</div>

<div class="card-body">

<div class="form-grid">

<div class="form-group">

<label>Unit Type</label>

<select id="unit-type" onchange="updateUnitFields();
calculateQuality();">

<option value="">Select unit type...</option>

<option value="split">Split System</option>

<option value="package">Package Unit</option>

<option value="mini-split">Mini-Split</option>

<option value="heat-pump">Heat Pump</option>

</select>

</div>

</div>

<div class="form-grid form-grid-2">

<div class="form-group">

<label>Indoor Unit (Model/Serial)</label>

<input type="text" id="indoor-unit" placeholder="Model & Serial
Number">

</div>

<div class="form-group" id="outdoor-unit-group">

<label>Outdoor Unit (Model/Serial)</label>

<input type="text" id="outdoor-unit" placeholder="Model & Serial
Number">

</div>

</div>

<div class="form-grid form-grid-3">

<div class="form-group">

<label>Tonnage</label>

<select id="tonnage">

<option value="">Select...</option>

<option value="1.5">1.5 Ton</option>

<option value="2">2 Ton</option>

<option value="2.5">2.5 Ton</option>

<option value="3">3 Ton</option>

<option value="3.5">3.5 Ton</option>

<option value="4">4 Ton</option>

<option value="5">5 Ton</option>

</select>

</div>

<div class="form-group">

<label>

Refrigerant Type

<span class="help-icon" data-tooltip="R-410A is most common in
modern systems">?</span>

</label>

<select id="refrigerant-type">

<option value="R410A">R-410A</option>

<option value="R22">R-22</option>

<option value="R454B">R-454B</option>

<option value="R32">R-32</option>

</select>

</div>

<div class="form-group">

<label>Filter Size</label>

<input type="text" id="filter-size" placeholder="e.g., 16x25x1">

</div>

</div>

<div class="form-grid form-grid-2">

<div class="form-group">

<label>

Metering Device

<span class="help-icon" data-tooltip="TXV adjusts automatically,
Fixed Orifice (piston) does not">?</span>

</label>

<select id="metering-device" onchange="calculateDiagnostics()">

<option value="">Unknown</option>

<option value="txv">TXV (Thermostatic Expansion Valve)</option>

<option value="piston">Fixed Orifice / Piston</option>

</select>

</div>

<div class="form-group">

<label>SEER Rating</label>

<input type="number" id="seer-rating" placeholder="e.g., 14">

</div>

</div>

</div>

</div>

<!-- Cooling Measurements -->

<div class="card" id="cooling-measurements">

<div class="card-header">

<div class="card-title">Diagnostic Measurements (Cooling
Mode)</div>

</div>

<div class="card-body">

<div class="card-section">

<div class="section-title">Temperature Readings</div>

<div class="form-grid form-grid-4">

<div class="form-group">

<label>

Outdoor Ambient (¬∞F)

<span class="help-icon" data-tooltip="Temperature outside near
condensing unit">?</span>

</label>

<input type="number" step="0.1" id="outdoor-ambient"
oninput="calculateDiagnostics()">

</div>

<div class="form-group">

<label>

Ambient Temp (¬∞F)

<span class="help-icon" data-tooltip="Temperature inside near return
air">?</span>

</label>

<input type="number" step="0.1" id="ambient-temp"
oninput="calculateDiagnostics()">

</div>

<div class="form-group">

<label>Return Temp (¬∞F)</label>

<input type="number" step="0.1" id="return-temp"
oninput="calculateDiagnostics()">

</div>

<div class="form-group">

<label>Supply Temp (¬∞F)</label>

<input type="number" step="0.1" id="supply-temp"
oninput="calculateDiagnostics()">

</div>

</div>

<div class="form-grid form-grid-2">

<div class="form-group">

<label>

Delta-T (Calculated)

<span class="help-icon" data-tooltip="Should be 16-22¬∞F for proper
cooling">?</span>

</label>

<input type="text" id="delta-t" readonly>

</div>

<div class="form-group">

<label>

Wet Bulb Temperature (¬∞F)

<span class="help-icon" data-tooltip="Used for accurate charge
verification">?</span>

</label>

<input type="number" step="0.1" id="wet-bulb"
oninput="calculateDiagnostics()">

</div>

</div>

</div>

<div class="card-section">

<div class="section-title">Refrigerant Pressures &
Temperatures</div>

<div class="form-grid form-grid-2">

<div class="form-group">

<label>Suction Pressure (PSI)</label>

<input type="number" step="0.1" id="suction-pressure"
oninput="calculateDiagnostics()">

</div>

<div class="form-group">

<label>Suction Line Temp (¬∞F)</label>

<input type="number" step="0.1" id="suction-temp"
oninput="calculateDiagnostics()">

</div>

<div class="form-group">

<label>Liquid Pressure (PSI)</label>

<input type="number" step="0.1" id="liquid-pressure"
oninput="calculateDiagnostics()">

</div>

<div class="form-group">

<label>Liquid Line Temp (¬∞F)</label>

<input type="number" step="0.1" id="liquid-temp"
oninput="calculateDiagnostics()">

</div>

</div>

<div class="form-grid form-grid-2">

<div class="form-group">

<label>

Superheat (Calculated)

<span class="help-icon" data-tooltip="TXV: 8-15¬∞F | Fixed: 5-25¬∞F
(varies with outdoor temp)">?</span>

</label>

<input type="text" id="superheat" readonly>

</div>

<div class="form-group">

<label>

Subcool (Calculated)

<span class="help-icon" data-tooltip="Should be 8-12¬∞F for most
systems">?</span>

</label>

<input type="text" id="subcool" readonly>

</div>

</div>

</div>

<div class="card-section">

<div class="section-title">Airflow & Electrical</div>

<div class="form-grid form-grid-4">

<div class="form-group">

<label>

Static Pressure (in w.c.)

<span class="help-icon" data-tooltip="Total ESP should be ‚â§0.50 for
residential">?</span>

</label>

<input type="number" step="0.01" id="static-pressure"
oninput="calculateDiagnostics()">

</div>

<div class="form-group">

<label>Voltage (V)</label>

<input type="number" step="0.1" id="voltage">

</div>

<div class="form-group">

<label>

Amperage (A)

<span class="help-icon" data-tooltip="Compressor running
amps">?</span>

</label>

<input type="number" step="0.1" id="amperage">

</div>

<div class="form-group">

<label>

RLA/FLA Rating

<span class="help-icon" data-tooltip="From equipment
nameplate">?</span>

</label>

<input type="number" step="0.1" id="rla-rating"
placeholder="Nameplate">

</div>

</div>

</div>

<!-- Pressure Chart -->

<div class="chart-container">

<canvas id="pressure-chart"></canvas>

</div>

</div>

</div>

<!-- Heating Measurements -->

<div class="card hidden" id="heating-measurements">

<div class="card-header">

<div class="card-title">Diagnostic Measurements (Heating
Mode)</div>

</div>

<div class="card-body">

<div class="card-section">

<div class="section-title">Temperature Readings</div>

<div class="form-grid form-grid-3">

<div class="form-group">

<label>Return Temp (¬∞F)</label>

<input type="number" step="0.1" id="return-temp-heat"
oninput="calculateDiagnostics()">

</div>

<div class="form-group">

<label>Supply Temp (¬∞F)</label>

<input type="number" step="0.1" id="supply-temp-heat"
oninput="calculateDiagnostics()">

</div>

<div class="form-group">

<label>

Temp Rise (Calculated)

<span class="help-icon" data-tooltip="Should be 35-65¬∞F for gas
furnaces">?</span>

</label>

<input type="text" id="temp-rise" readonly>

</div>

</div>

</div>

<div class="card-section">

<div class="section-title">Gas Furnace / Heat Measurements</div>

<div class="form-grid form-grid-4">

<div class="form-group">

<label>

Manifold Pressure (in w.c.)

<span class="help-icon" data-tooltip="Natural gas: 3.3-3.8 | LP:
10-11">?</span>

</label>

<input type="number" step="0.01" id="manifold-pressure"
oninput="calculateDiagnostics()">

</div>

<div class="form-group">

<label>Voltage (V)</label>

<input type="number" step="0.1" id="voltage-heat">

</div>

<div class="form-group">

<label>Amperage (A)</label>

<input type="number" step="0.1" id="amperage-heat">

</div>

<div class="form-group">

<label>

Gas Type

</label>

<select id="gas-type">

<option value="natural">Natural Gas</option>

<option value="lp">LP/Propane</option>

</select>

</div>

</div>

</div>

<!-- Temperature Rise Chart -->

<div class="chart-container">

<canvas id="heating-chart"></canvas>

</div>

</div>

</div>

<!-- Diagnostic Results -->

<div id="diagnostic-results" class="hidden"></div>

<!-- Photo Gallery -->

<div class="card">

<div class="card-header">

<div class="card-title">üì∏ Job Photos</div>

<span class="badge badge-info" id="photo-count">0 photos</span>

</div>

<div class="card-body">

<div class="photo-gallery" id="photo-gallery">

<label class="photo-upload">

<input type="file" accept="image/*" capture="camera" multiple
onchange="handlePhotos(event)" style="display:none">

<span style="font-size: 32px;">üì∑</span>

<span>Add Photo</span>

</label>

</div>

</div>

</div>

<!-- Cooling Checklist -->

<div class="card" id="cooling-checklist">

<div class="card-header">

<div class="card-title">Cooling Mode Inspection Checklist</div>

<span class="badge badge-info"
id="cooling-checklist-count">0/35</span>

</div>

<div class="card-body">

<div class="card-section">

<div class="section-title">Air Filter & Indoor Unit</div>

<div class="checklist-item">

<input type="checkbox" id="cool-check-filter"
onchange="updateCheckbox(this)">

<label for="cool-check-filter">Air filter inspected/replaced (check
size & MERV rating)</label>

</div>

<div class="checklist-item">

<input type="checkbox" id="cool-check-evap-coil"
onchange="updateCheckbox(this)">

<label for="cool-check-evap-coil">Evaporator coil inspected for
dirt/debris/restrictions</label>

</div>

<div class="checklist-item">

<input type="checkbox" id="cool-check-blower"
onchange="updateCheckbox(this)">

<label for="cool-check-blower">Blower wheel/motor inspected (clean,
proper rotation)</label>

</div>

<div class="checklist-item">

<input type="checkbox" id="cool-check-blower-amp"
onchange="updateCheckbox(this)">

<label for="cool-check-blower-amp">Blower motor amperage
checked</label>

</div>

<div class="checklist-item">

<input type="checkbox" id="cool-check-drain-pan"
onchange="updateCheckbox(this)">

<label for="cool-check-drain-pan">Drain pan inspected (clean, no
standing water)</label>

</div>

</div>

<div class="card-section">

<div class="section-title">Condensate System</div>

<div class="checklist-item">

<input type="checkbox" id="cool-check-drain-line"
onchange="updateCheckbox(this)">

<label for="cool-check-drain-line">Condensate drain line
cleared/flushed</label>

</div>

<div class="checklist-item">

<input type="checkbox" id="cool-check-ptrap"
onchange="updateCheckbox(this)">

<label for="cool-check-ptrap">P-trap inspected and water level
checked</label>

</div>

<div class="checklist-item">

<input type="checkbox" id="cool-check-float"
onchange="updateCheckbox(this)">

<label for="cool-check-float">Float switch/safety switch
tested</label>

</div>

<div class="checklist-item">

<input type="checkbox" id="cool-check-pump"
onchange="updateCheckbox(this)">

<label for="cool-check-pump">Condensate pump operation verified (if
applicable)</label>

</div>

</div>

<div class="card-section">

<div class="section-title">Outdoor Condensing Unit</div>

<div class="checklist-item">

<input type="checkbox" id="cool-check-condenser-coil"
onchange="updateCheckbox(this)">

<label for="cool-check-condenser-coil">Condenser coil cleaned (check
fin condition)</label>

</div>

<div class="checklist-item">

<input type="checkbox" id="cool-check-fan-motor"
onchange="updateCheckbox(this)">

<label for="cool-check-fan-motor">Condenser fan motor operation
checked</label>

</div>

<div class="checklist-item">

<input type="checkbox" id="cool-check-fan-blade"
onchange="updateCheckbox(this)">

<label for="cool-check-fan-blade">Fan blade inspected (no
damage/proper clearance)</label>

</div>

<div class="checklist-item">

<input type="checkbox" id="cool-check-cabinet"
onchange="updateCheckbox(this)">

<label for="cool-check-cabinet">Cabinet/housing inspected for
damage/debris</label>

</div>

<div class="checklist-item">

<input type="checkbox" id="cool-check-clearance"
onchange="updateCheckbox(this)">

<label for="cool-check-clearance">Airflow clearance verified (24"
minimum all sides)</label>

</div>

</div>

<div class="card-section">

<div class="section-title">Electrical Components</div>

<div class="checklist-item">

<input type="checkbox" id="cool-check-contactor"
onchange="updateCheckbox(this)">

<label for="cool-check-contactor">Contactor inspected (pitting,
burning, proper operation)</label>

</div>

<div class="checklist-item">

<input type="checkbox" id="cool-check-capacitor"
onchange="updateCheckbox(this)">

<label for="cool-check-capacitor">Capacitor(s) tested with meter (¬µF
reading within spec)</label>

</div>

<div class="checklist-item">

<input type="checkbox" id="cool-check-disconnect"
onchange="updateCheckbox(this)">

<label for="cool-check-disconnect">Disconnect switch inspected and
cycled</label>

</div>

<div class="checklist-item">

<input type="checkbox" id="cool-check-wiring"
onchange="updateCheckbox(this)">

<label for="cool-check-wiring">All wiring connections tightened and
inspected</label>

</div>

<div class="checklist-item">

<input type="checkbox" id="cool-check-voltage"
onchange="updateCheckbox(this)">

<label for="cool-check-voltage">Supply voltage checked (¬±10% of
rated voltage)</label>

</div>

<div class="checklist-item">

<input type="checkbox" id="cool-check-compressor-amp"
onchange="updateCheckbox(this)">

<label for="cool-check-compressor-amp">Compressor amperage checked
(within nameplate specs)</label>

</div>

</div>

<div class="card-section">

<div class="section-title">Refrigerant System</div>

<div class="checklist-item">

<input type="checkbox" id="cool-check-pressures"
onchange="updateCheckbox(this)">

<label for="cool-check-pressures">Operating pressures verified
(superheat/subcool)</label>

</div>

<div class="checklist-item">

<input type="checkbox" id="cool-check-lineset"
onchange="updateCheckbox(this)">

<label for="cool-check-lineset">Line set insulation inspected (no
deterioration)</label>

</div>

<div class="checklist-item">

<input type="checkbox" id="cool-check-leak"
onchange="updateCheckbox(this)">

<label for="cool-check-leak">System leak checked (visual/electronic
detector)</label>

</div>

<div class="checklist-item">

<input type="checkbox" id="cool-check-txv"
onchange="updateCheckbox(this)">

<label for="cool-check-txv">TXV/metering device operation
verified</label>

</div>

</div>

<div class="card-section">

<div class="section-title">Thermostat & Controls</div>

<div class="checklist-item">

<input type="checkbox" id="cool-check-tstat"
onchange="updateCheckbox(this)">

<label for="cool-check-tstat">Thermostat calibration/operation
verified</label>

</div>

<div class="checklist-item">

<input type="checkbox" id="cool-check-tstat-wiring"
onchange="updateCheckbox(this)">

<label for="cool-check-tstat-wiring">Thermostat wiring connections
checked</label>

</div>

<div class="checklist-item">

<input type="checkbox" id="cool-check-cycle"
onchange="updateCheckbox(this)">

<label for="cool-check-cycle">System cycling tested (on/off
operation normal)</label>

</div>

</div>

</div>

</div>

<!-- Heating Checklist -->

<div class="card hidden" id="heating-checklist">

<div class="card-header">

<div class="card-title">Heating Mode Inspection Checklist</div>

<span class="badge badge-info"
id="heating-checklist-count">0/40</span>

</div>

<div class="card-body">

<div class="card-section">

<div class="section-title">Air Filter & Airflow</div>

<div class="checklist-item">

<input type="checkbox" id="heat-check-filter"
onchange="updateCheckbox(this)">

<label for="heat-check-filter">Air filter inspected/replaced (check
size & MERV rating)</label>

</div>

<div class="checklist-item">

<input type="checkbox" id="heat-check-blower"
onchange="updateCheckbox(this)">

<label for="heat-check-blower">Blower assembly cleaned and
inspected</label>

</div>

<div class="checklist-item">

<input type="checkbox" id="heat-check-blower-motor"
onchange="updateCheckbox(this)">

<label for="heat-check-blower-motor">Blower motor operation/amperage
checked</label>

</div>

<div class="checklist-item">

<input type="checkbox" id="heat-check-static"
onchange="updateCheckbox(this)">

<label for="heat-check-static">Static pressure measured (supply &
return)</label>

</div>

</div>

<div class="card-section">

<div class="section-title">Heat Exchanger & Combustion</div>

<div class="checklist-item">

<input type="checkbox" id="heat-check-exchanger"
onchange="updateCheckbox(this)">

<label for="heat-check-exchanger">Heat exchanger visually inspected
(cracks, rust, deterioration)</label>

</div>

<div class="checklist-item">

<input type="checkbox" id="heat-check-burners"
onchange="updateCheckbox(this)">

<label for="heat-check-burners">Burners cleaned and inspected (flame
pattern checked)</label>

</div>

<div class="checklist-item">

<input type="checkbox" id="heat-check-flame-sensor"
onchange="updateCheckbox(this)">

<label for="heat-check-flame-sensor">Flame sensor cleaned and tested
(microamp reading)</label>

</div>

<div class="checklist-item">

<input type="checkbox" id="heat-check-igniter"
onchange="updateCheckbox(this)">

<label for="heat-check-igniter">Hot surface igniter/ignition system
inspected</label>

</div>

<div class="checklist-item">

<input type="checkbox" id="heat-check-burner-box"
onchange="updateCheckbox(this)">

<label for="heat-check-burner-box">Burner box/combustion chamber
cleaned</label>

</div>

</div>

<div class="card-section">

<div class="section-title">Gas System (if applicable)</div>

<div class="checklist-item">

<input type="checkbox" id="heat-check-gas-valve"
onchange="updateCheckbox(this)">

<label for="heat-check-gas-valve">Gas valve operation
verified</label>

</div>

<div class="checklist-item">

<input type="checkbox" id="heat-check-manifold"
onchange="updateCheckbox(this)">

<label for="heat-check-manifold">Manifold gas pressure measured
(3.3-3.8" w.c.)</label>

</div>

<div class="checklist-item">

<input type="checkbox" id="heat-check-gas-line"
onchange="updateCheckbox(this)">

<label for="heat-check-gas-line">Gas line connections leak checked
(soap test)</label>

</div>

<div class="checklist-item">

<input type="checkbox" id="heat-check-gas-supply"
onchange="updateCheckbox(this)">

<label for="heat-check-gas-supply">Inlet gas pressure checked
(incoming supply)</label>

</div>

</div>

<div class="card-section">

<div class="section-title">Venting & Exhaust</div>

<div class="checklist-item">

<input type="checkbox" id="heat-check-flue"
onchange="updateCheckbox(this)">

<label for="heat-check-flue">Flue pipe/vent system inspected (no
obstructions/damage)</label>

</div>

<div class="checklist-item">

<input type="checkbox" id="heat-check-inducer"
onchange="updateCheckbox(this)">

<label for="heat-check-inducer">Inducer motor operation and amperage
checked</label>

</div>

<div class="checklist-item">

<input type="checkbox" id="heat-check-pressure-switch"
onchange="updateCheckbox(this)">

<label for="heat-check-pressure-switch">Pressure switch(es) tested
and verified</label>

</div>

<div class="checklist-item">

<input type="checkbox" id="heat-check-condensate-trap"
onchange="updateCheckbox(this)">

<label for="heat-check-condensate-trap">Condensate trap cleaned
(90%+ furnaces)</label>

</div>

<div class="checklist-item">

<input type="checkbox" id="heat-check-co"
onchange="updateCheckbox(this)">

<label for="heat-check-co">Carbon monoxide levels tested (ambient &
flue)</label>

</div>

</div>

<div class="card-section">

<div class="section-title">Safety Controls</div>

<div class="checklist-item">

<input type="checkbox" id="heat-check-rollout"
onchange="updateCheckbox(this)">

<label for="heat-check-rollout">Rollout switches inspected and
tested</label>

</div>

<div class="checklist-item">

<input type="checkbox" id="heat-check-limit"
onchange="updateCheckbox(this)">

<label for="heat-check-limit">High limit switch(es) tested</label>

</div>

<div class="checklist-item">

<input type="checkbox" id="heat-check-safeties"
onchange="updateCheckbox(this)">

<label for="heat-check-safeties">All safety interlocks verified
operational</label>

</div>

<div class="checklist-item">

<input type="checkbox" id="heat-check-sequence"
onchange="updateCheckbox(this)">

<label for="heat-check-sequence">Ignition sequence timing verified
(proper lockout)</label>

</div>

</div>

<div class="card-section">

<div class="section-title">Electrical & Wiring</div>

<div class="checklist-item">

<input type="checkbox" id="heat-check-wiring"
onchange="updateCheckbox(this)">

<label for="heat-check-wiring">All electrical connections
tightened</label>

</div>

<div class="checklist-item">

<input type="checkbox" id="heat-check-voltage"
onchange="updateCheckbox(this)">

<label for="heat-check-voltage">Supply voltage checked (115V or 230V
¬±10%)</label>

</div>

<div class="checklist-item">

<input type="checkbox" id="heat-check-transformer"
onchange="updateCheckbox(this)">

<label for="heat-check-transformer">Control transformer voltage
checked (24V AC)</label>

</div>

<div class="checklist-item">

<input type="checkbox" id="heat-check-disconnect"
onchange="updateCheckbox(this)">

<label for="heat-check-disconnect">Disconnect/service switch
inspected</label>

</div>

</div>

<div class="card-section">

<div class="section-title">Thermostat & Controls</div>

<div class="checklist-item">

<input type="checkbox" id="heat-check-tstat"
onchange="updateCheckbox(this)">

<label for="heat-check-tstat">Thermostat calibration/operation
verified</label>

</div>

<div class="checklist-item">

<input type="checkbox" id="heat-check-tstat-wiring"
onchange="updateCheckbox(this)">

<label for="heat-check-tstat-wiring">Thermostat wiring connections
checked</label>

</div>

<div class="checklist-item">

<input type="checkbox" id="heat-check-cycle"
onchange="updateCheckbox(this)">

<label for="heat-check-cycle">Heating cycle tested (ignition to
shutdown)</label>

</div>

<div class="checklist-item">

<input type="checkbox" id="heat-check-fan-delay"
onchange="updateCheckbox(this)">

<label for="heat-check-fan-delay">Fan on/off delay times
verified</label>

</div>

</div>

</div>

</div>

<!-- Findings & Work Performed -->

<div class="card">

<div class="card-header">

<div class="card-title">Findings & Work Performed</div>

</div>

<div class="card-body">

<div class="card-section">

<div class="form-group">

<label>Findings</label>

<textarea id="findings" placeholder="Describe what you found during
the service call..." oninput="calculateQuality()"></textarea>

</div>

</div>

<div class="card-section">

<div class="form-group">

<label>Recommendations</label>

<textarea id="recommendations" placeholder="What do you recommend to
the customer?"></textarea>

</div>

</div>

<div class="card-section">

<div class="form-group">

<label>Work Performed</label>

<textarea id="work-performed" placeholder="Detail the work you
completed..." oninput="calculateQuality()"></textarea>

</div>

</div>

</div>

</div>

<!-- Customer Signature -->

<div class="card">

<div class="card-header">

<div class="card-title">‚úçÔ∏è Customer Signature</div>

</div>

<div class="card-body">

<div class="form-grid form-grid-2">

<div class="form-group">

<label>Customer Name</label>

<input type="text" id="sig-name" placeholder="Customer name"
oninput="calculateQuality()">

</div>

<div class="form-group">

<label>Date</label>

<input type="date" id="sig-date" oninput="calculateQuality()">

</div>

</div>

<canvas id="signature-pad" class="signature-pad"></canvas>

<div class="btn-group mt-lg">

<button class="btn btn-secondary"
onclick="clearSignature()">Clear</button>

<button class="btn btn-primary" onclick="saveSignature()">Save
Signature</button>

</div>

</div>

</div>

<!-- Technician Info -->

<div class="card">

<div class="card-header">

<div class="card-title">Technician Information</div>

</div>

<div class="card-body">

<div class="form-grid form-grid-2">

<div class="form-group">

<label>Technician Name</label>

<input type="text" id="tech-name" value="Mart√≠n Perez">

</div>

<div class="form-group">

<label>Contact Phone</label>

<input type="tel" id="tech-phone" value="(346)451-0024">

</div>

</div>

<div class="form-grid">

<div class="form-group">

<label>Email Address</label>

<input type="email" id="tech-email"
value="Mperez@villageplumbing.com">

</div>

</div>

</div>

</div>

<!-- Action Buttons -->

<div class="btn-group">

<button class="btn btn-success" onclick="generatePDF()">üìÑ
Generate PDF</button>

<button class="btn btn-primary" onclick="generateTextReport()">üìã
Text Report</button>

<button class="btn btn-secondary" onclick="saveData()">üíæ Save
Progress</button>

<button class="btn btn-danger" onclick="clearForm()">üóëÔ∏è Clear
Form</button>

</div>

<!-- Report Preview -->

<div id="report-container"></div>

</div>

<!-- MATERIALS PAGE -->

<div id="materials-page" class="page-content hidden">

<div class="card">

<div class="card-header">

<div class="card-title">Job Information</div>

</div>

<div class="card-body">

<div class="form-grid form-grid-2">

<div class="form-group">

<label>Customer/Job Name</label>

<input type="text" id="mat-customer" placeholder="Enter customer
or job name">

</div>

<div class="form-group">

<label>Date</label>

<input type="date" id="mat-date">

</div>

</div>

<div class="form-grid">

<div class="form-group">

<label>Job Address</label>

<input type="text" id="mat-address" placeholder="123 Main St,
City, State ZIP">

</div>

</div>

<div class="form-grid">

<div class="form-group">

<label>Job Notes</label>

<textarea id="mat-notes" placeholder="Special instructions, access
codes, etc."></textarea>

</div>

</div>

</div>

</div>

<!-- Materials Catalog -->

<div class="card">

<div class="card-header">

<div class="card-title">Materials Catalog (2025 Complete
Edition)</div>

<div class="btn-group">

<button class="btn btn-secondary"
onclick="expandAllCategories()">Expand All</button>

<button class="btn btn-secondary"
onclick="collapseAllCategories()">Collapse All</button>

</div>

</div>

<div class="card-body">

<div class="form-group">

<input type="text" id="material-search" placeholder="üîç Search
materials..." oninput="filterMaterials()">

</div>

<div id="materials-catalog"></div>

</div>

</div>

<!-- Selected Materials -->

<div class="card">

<div class="card-header">

<div class="card-title">Selected Materials</div>

<span class="badge badge-info" id="selected-materials-count">0
items</span>

</div>

<div class="card-body">

<div id="selected-materials">

<div class="status-card info">

‚ÑπÔ∏è No materials selected yet. Use the catalog above to add items.

</div>

</div>

</div>

</div>

<!-- Technician Info -->

<div class="card">

<div class="card-header">

<div class="card-title">Technician Information</div>

</div>

<div class="card-body">

<div class="form-grid form-grid-2">

<div class="form-group">

<label>Technician Name</label>

<input type="text" id="mat-tech-name" value="Mart√≠n Perez">

</div>

<div class="form-group">

<label>Contact Phone</label>

<input type="tel" id="mat-tech-phone" value="(346)451-0024">

</div>

</div>

<div class="form-grid">

<div class="form-group">

<label>Email Address</label>

<input type="email" id="mat-tech-email"
value="Mperez@villageplumbing.com">

</div>

</div>

</div>

</div>

<!-- Action Buttons -->

<div class="btn-group">

<button class="btn btn-success"
onclick="generateMaterialsPDF()">üìÑ Generate PDF</button>

<button class="btn btn-primary"
onclick="generateMaterialsReport()">üìã Generate List</button>

<button class="btn btn-secondary" onclick="saveData()">üíæ Save
Progress</button>

<button class="btn btn-danger" onclick="clearForm()">üóëÔ∏è Clear
Form</button>

</div>

<!-- Report Preview -->

<div id="report-container-mat"></div>

</div>

<!-- DUCT DESIGN PAGE -->

<div id="duct-design-page" class="page-content hidden">

<!-- Project Info -->

<div class="card">

<div class="card-header">

<div class="card-title">üèóÔ∏è Professional Duct Design Project</div>

</div>

<div class="card-body">

<div class="form-grid form-grid-2">

<div class="form-group">

<label>Project Name</label>

<input type="text" id="duct-project-name" placeholder="Smith
Residence">

</div>

<div class="form-group">

<label>Date</label>

<input type="date" id="duct-project-date">

</div>

</div>

<div class="form-grid form-grid-3">

<div class="form-group">

<label>

System Tonnage

<span class="help-icon" data-tooltip="Equipment capacity
rating">?</span>

</label>

<select id="duct-tonnage" onchange="calculateSystemCFM()">

<option value="">Select...</option>

<option value="1.5">1.5 Ton</option>

<option value="2">2 Ton</option>

<option value="2.5">2.5 Ton</option>

<option value="3">3 Ton</option>

<option value="3.5">3.5 Ton</option>

<option value="4">4 Ton</option>

<option value="5">5 Ton</option>

</select>

</div>

<div class="form-group">

<label>

Equipment Location

<span class="help-icon" data-tooltip="Where the air handler is
installed">?</span>

</label>

<select id="duct-equipment-location">

<option value="attic">Attic</option>

<option value="closet">Closet</option>

<option value="basement">Basement</option>

<option value="garage">Garage</option>

</select>

</div>

<div class="form-group">

<label>

Return Type

<span class="help-icon" data-tooltip="Central = 1 return |
Distributed = multiple returns">?</span>

</label>

<select id="duct-return-type">

<option value="central">Central Return</option>

<option value="distributed">Distributed Returns</option>

</select>

</div>

</div>

<div class="form-grid">

<div class="form-group">

<label>Known Airflow Issues</label>

<textarea id="duct-airflow-issues" placeholder="e.g., Master bedroom
too hot, poor circulation in living room"></textarea>

</div>

</div>

<div class="info-box">

<div class="info-box-title">System CFM Calculation</div>

<div class="info-box-content">

<strong>Total System CFM: <span
id="system-cfm-display">0</span></strong> (Tonnage √ó 400 CFM/ton)

</div>

</div>

</div>

</div>

<!-- Room-by-Room Design -->

<div class="card">

<div class="card-header">

<div class="card-title">Room-by-Room Airflow Design</div>

<button class="btn btn-primary" onclick="addDuctRoom()">+ Add
Room</button>

</div>

<div class="card-body">

<div id="duct-rooms-container">

<div class="status-card info">

‚ÑπÔ∏è Click "Add Room" to start your duct design. Input room details to
calculate CFM requirements and duct sizing.

</div>

</div>

<div id="duct-totals" class="hidden">

<div class="quality-metrics" style="margin-top:
var(--spacing-xl);">

<div class="quality-metric" style="background: var(--bg-elevated);
border: 1px solid var(--glass-border);">

<div class="metric-value" style="color: var(--accent-cyan);"
id="total-branches-cfm">0</div>

<div class="metric-label">Total Branch CFM</div>

</div>

<div class="quality-metric" style="background: var(--bg-elevated);
border: 1px solid var(--glass-border);">

<div class="metric-value" style="color: var(--success);"
id="cfm-balance">0%</div>

<div class="metric-label">System Balance</div>

</div>

<div class="quality-metric" style="background: var(--bg-elevated);
border: 1px solid var(--glass-border);">

<div class="metric-value" style="color: var(--info);"
id="rooms-designed">0</div>

<div class="metric-label">Rooms Designed</div>

</div>

</div>

</div>

</div>

</div>

<!-- Trunk & Plenum Design -->

<div class="card">

<div class="card-header">

<div class="card-title">Main Trunk & Plenum Specifications</div>

</div>

<div class="card-body">

<div class="card-section">

<div class="section-title">Main Supply Trunk</div>

<div class="form-grid form-grid-3">

<div class="form-group">

<label>

Trunk CFM

<span class="help-icon" data-tooltip="Total system CFM for main
trunk sizing">?</span>

</label>

<input type="text" id="trunk-cfm" readonly>

</div>

<div class="form-group">

<label>

Target Velocity (FPM)

<span class="help-icon" data-tooltip="700-900 FPM for main
trunks">?</span>

</label>

<select id="trunk-velocity" onchange="calculateTrunkSize()">

<option value="700">700 FPM (Quiet)</option>

<option value="800" selected>800 FPM (Standard)</option>

<option value="900">900 FPM (Maximum)</option>

</select>

</div>

<div class="form-group">

<label>Recommended Size</label>

<input type="text" id="trunk-size-result" readonly
style="font-weight: 600; color: var(--success);">

</div>

</div>

</div>

<div class="card-section">

<div class="section-title">Supply Plenum (Custom Duct Board)</div>

<div class="form-grid form-grid-3">

<div class="form-group">

<label>Length (inches)</label>

<input type="number" id="supply-plenum-length" value="24"
oninput="calculatePlenumMaterial()">

</div>

<div class="form-group">

<label>Width (inches)</label>

<input type="number" id="supply-plenum-width" value="24"
oninput="calculatePlenumMaterial()">

</div>

<div class="form-group">

<label>Height (inches)</label>

<input type="number" id="supply-plenum-height" value="18"
oninput="calculatePlenumMaterial()">

</div>

</div>

</div>

<div class="card-section">

<div class="section-title">Return Plenum (Custom Duct Board)</div>

<div class="form-grid form-grid-3">

<div class="form-group">

<label>Length (inches)</label>

<input type="number" id="return-plenum-length" value="26"
oninput="calculatePlenumMaterial()">

</div>

<div class="form-group">

<label>Width (inches)</label>

<input type="number" id="return-plenum-width" value="26"
oninput="calculatePlenumMaterial()">

</div>

<div class="form-group">

<label>Height (inches)</label>

<input type="number" id="return-plenum-height" value="20"
oninput="calculatePlenumMaterial()">

</div>

</div>

</div>

<div class="info-box">

<div class="info-box-title">Duct Board Required</div>

<div class="info-box-content">

<strong>Total Sheets Needed: <span
id="duct-board-sheets">0</span></strong> (4√ó8 sheets, 1.5"
thick, includes 20% waste)

</div>

</div>

</div>

</div>

<!-- System Schematic -->

<div class="card" id="system-schematic-card" style="display:
none;">

<div class="card-header">

<div class="card-title">System Schematic</div>

</div>

<div class="card-body">

<div id="system-schematic" class="duct-tree"></div>

</div>

</div>

<!-- Material Takeoff -->

<div class="card" id="material-takeoff-card" style="display:
none;">

<div class="card-header">

<div class="card-title">Complete Material Takeoff</div>

</div>

<div class="card-body">

<div id="material-takeoff"></div>

</div>

</div>

<!-- Generate Design -->

<div class="btn-group">

<button class="btn btn-success" onclick="generateDuctDesign()"
id="generate-design-btn" disabled>

üèóÔ∏è Generate Complete Design

</button>

<button class="btn btn-primary" onclick="exportDuctDesign()">üìÑ
Export PDF</button>

<button class="btn btn-secondary" onclick="saveDuctDesign()">üíæ
Save Design</button>

<button class="btn btn-danger" onclick="clearDuctDesignForm()">üóëÔ∏è
Clear All</button>

</div>

<!-- Design Report Container -->

<div id="duct-design-report-container"></div>

</div><!-- CFM CALCULATOR PAGE -->

<div id="cfm-page" class="page-content hidden">

<!-- CFM Calculators -->

<div class="card">

<div class="card-header">

<div class="card-title">üå™Ô∏è CFM Calculators</div>

</div>

<div class="card-body">

<!-- By Tonnage -->

<div class="card-section">

<div class="section-title">Calculate CFM by System Tonnage</div>

<div class="form-grid form-grid-3">

<div class="form-group">

<label>System Tonnage</label>

<select id="cfm-tonnage" onchange="calculateCFMByTonnage()">

<option value="">Select...</option>

<option value="1.5">1.5 Ton</option>

<option value="2">2 Ton</option>

<option value="2.5">2.5 Ton</option>

<option value="3">3 Ton</option>

<option value="3.5">3.5 Ton</option>

<option value="4">4 Ton</option>

<option value="5">5 Ton</option>

</select>

</div>

<div class="form-group">

<label>CFM per Ton (Standard: 400)</label>

<input type="number" id="cfm-per-ton" value="400"
onchange="calculateCFMByTonnage()">

</div>

<div class="form-group">

<label>Required CFM</label>

<input type="text" id="cfm-result-tonnage" readonly
style="font-weight: 600; font-size: 18px; color:
var(--accent-cyan);">

</div>

</div>

</div>

<!-- By Temperature -->

<div class="card-section">

<div class="section-title">Calculate CFM by Temperature &
BTU</div>

<p style="font-size: 12px; color: var(--text-tertiary);
margin-bottom: 12px;">

Formula: CFM = BTU √∑ (1.08 √ó ŒîT)

</p>

<div class="form-grid form-grid-3">

<div class="form-group">

<label>BTU/hr (Tonnage √ó 12,000)</label>

<input type="number" id="cfm-btu" placeholder="e.g., 36000"
onchange="calculateCFMByTemp()">

</div>

<div class="form-group">

<label>Temperature Difference (¬∞F)</label>

<input type="number" step="0.1" id="cfm-delta-t"
placeholder="e.g., 20" onchange="calculateCFMByTemp()">

</div>

<div class="form-group">

<label>Required CFM</label>

<input type="text" id="cfm-result-temp" readonly
style="font-weight: 600; font-size: 18px; color:
var(--accent-cyan);">

</div>

</div>

</div>

<!-- By Room Size -->

<div class="card-section">

<div class="section-title">Calculate CFM by Room Size (ACH
Method)</div>

<p style="font-size: 12px; color: var(--text-tertiary);
margin-bottom: 12px;">

Formula: CFM = (Room Volume √ó Air Changes per Hour) √∑ 60

</p>

<div class="form-grid form-grid-4">

<div class="form-group">

<label>Length (ft)</label>

<input type="number" id="room-length" placeholder="e.g., 12"
onchange="calculateCFMByRoom()">

</div>

<div class="form-group">

<label>Width (ft)</label>

<input type="number" id="room-width" placeholder="e.g., 10"
onchange="calculateCFMByRoom()">

</div>

<div class="form-group">

<label>Height (ft)</label>

<input type="number" id="room-height" value="8"
onchange="calculateCFMByRoom()">

</div>

<div class="form-group">

<label>Air Changes/Hour</label>

<select id="room-ach" onchange="calculateCFMByRoom()">

<option value="4">4 (Bedroom)</option>

<option value="6" selected>6 (Living Room)</option>

<option value="8">8 (Kitchen)</option>

<option value="10">10 (Bathroom)</option>

</select>

</div>

</div>

<div class="form-grid form-grid-2">

<div class="form-group">

<label>Room Volume (cu ft)</label>

<input type="text" id="room-volume" readonly>

</div>

<div class="form-group">

<label>Required CFM</label>

<input type="text" id="cfm-result-room" readonly
style="font-weight: 600; font-size: 18px; color:
var(--accent-cyan);">

</div>

</div>

</div>

</div>

</div>

<!-- Duct Sizing Calculator -->

<div class="card">

<div class="card-header">

<div class="card-title">üìè Duct Sizing Calculator</div>

</div>

<div class="card-body">

<!-- Input Parameters -->

<div class="card-section">

<div class="section-title">Input Parameters</div>

<div class="form-grid form-grid-3">

<div class="form-group">

<label>Airflow (CFM)</label>

<input type="number" id="duct-cfm" placeholder="e.g., 1200"
onchange="calculateDuctSize()">

</div>

<div class="form-group">

<label>Target Velocity (FPM)</label>

<select id="duct-velocity" onchange="calculateDuctSize()">

<option value="600">600 (Residential Supply)</option>

<option value="700" selected>700 (Standard)</option>

<option value="800">800 (Commercial)</option>

<option value="900">900 (High Velocity)</option>

<option value="500">500 (Return Air)</option>

</select>

</div>

<div class="form-group">

<label>Duct Type</label>

<select id="duct-type" onchange="calculateDuctSize()">

<option value="round">Round</option>

<option value="rectangular">Rectangular</option>

</select>

</div>

</div>

</div>

<!-- Round Duct Results -->

<div class="card-section" id="round-duct-results">

<div class="section-title">Round Duct Sizing</div>

<div class="form-grid form-grid-3">

<div class="form-group">

<label>Required Diameter (inches)</label>

<input type="text" id="round-diameter-calc" readonly
style="font-weight: 600; color: var(--accent-cyan);">

</div>

<div class="form-group">

<label>Recommended Standard Size</label>

<input type="text" id="round-diameter-standard" readonly
style="font-weight: 600; color: var(--success);">

</div>

<div class="form-group">

<label>Actual Velocity (FPM)</label>

<input type="text" id="round-velocity-actual" readonly>

</div>

</div>

<div class="form-grid">

<div class="form-group">

<label>Cross-Sectional Area (sq in)</label>

<input type="text" id="round-area" readonly>

</div>

</div>

</div>

<!-- Rectangular Duct Results -->

<div class="card-section hidden" id="rectangular-duct-results">

<div class="section-title">Rectangular Duct Sizing Options</div>

<div id="rectangular-options"></div>

</div>

<!-- Velocity Chart -->

<div class="chart-container">

<canvas id="velocity-chart"></canvas>

</div>

</div>

</div>

<!-- Quick Reference -->

<div class="card">

<div class="card-header">

<div class="card-title">üìö Quick Reference Guide</div>

</div>

<div class="card-body">

<div class="form-grid form-grid-2">

<div>

<div class="section-title">Standard CFM Guidelines</div>

<ul style="font-size: 13px; line-height: 1.8; color:
var(--text-secondary);">

<li><strong>Residential Cooling:</strong> 400 CFM per ton</li>

<li><strong>High Efficiency:</strong> 450 CFM per ton</li>

<li><strong>Dehumidification:</strong> 350 CFM per ton</li>

<li><strong>Heating (Gas):</strong> Temperature rise
40-70¬∞F</li>

<li><strong>Heat Pump:</strong> 400-450 CFM per ton</li>

</ul>

</div>

<div>

<div class="section-title">Recommended Velocities (FPM)</div>

<ul style="font-size: 13px; line-height: 1.8; color:
var(--text-secondary);">

<li><strong>Main Supply Trunk:</strong> 700-900</li>

<li><strong>Branch Ducts:</strong> 500-700</li>

<li><strong>Residential Supply:</strong> 600-800</li>

<li><strong>Return Air:</strong> 500-600</li>

<li><strong>Maximum (noise):</strong> 900</li>

</ul>

</div>

</div>

<div class="section-title mt-lg">Standard Round Duct Sizes
(inches)</div>

<div style="display: flex; gap: 8px; flex-wrap: wrap; font-size:
13px;">

<span class="badge badge-info">4"</span>

<span class="badge badge-info">5"</span>

<span class="badge badge-info">6"</span>

<span class="badge badge-info">7"</span>

<span class="badge badge-info">8"</span>

<span class="badge badge-info">9"</span>

<span class="badge badge-info">10"</span>

<span class="badge badge-info">12"</span>

<span class="badge badge-info">14"</span>

<span class="badge badge-info">16"</span>

<span class="badge badge-info">18"</span>

<span class="badge badge-info">20"</span>

</div>

<div class="section-title mt-lg">Common Rectangular Duct Sizes
(inches)</div>

<div style="display: flex; gap: 8px; flex-wrap: wrap; font-size:
13px;">

<span class="badge badge-info">6x8</span>

<span class="badge badge-info">6x10</span>

<span class="badge badge-info">6x12</span>

<span class="badge badge-info">8x10</span>

<span class="badge badge-info">8x12</span>

<span class="badge badge-info">10x12</span>

<span class="badge badge-info">10x14</span>

<span class="badge badge-info">12x14</span>

<span class="badge badge-info">12x16</span>

<span class="badge badge-info">14x16</span>

<span class="badge badge-info">16x20</span>

<span class="badge badge-info">18x24</span>

</div>

</div>

</div>

<!-- Report Container -->

<div id="duct-report-container"></div>

</div>

<!-- HISTORY PAGE -->

<div id="history-page" class="page-content hidden">

<div class="card">

<div class="card-header">

<div class="card-title">üìä Saved Reports & History</div>

<button class="btn btn-primary"
onclick="refreshHistory()">Refresh</button>

</div>

<div class="card-body">

<div id="history-list">

<div class="status-card info">

‚ÑπÔ∏è No saved reports yet. Complete a service call and save your progress
to see history here.

</div>

</div>

</div>

</div>

<!-- Statistics -->

<div class="card">

<div class="card-header">

<div class="card-title">üìà Statistics</div>

</div>

<div class="card-body">

<div class="quality-metrics">

<div class="quality-metric" style="background: var(--bg-elevated);
border: 1px solid var(--glass-border);">

<div class="metric-value" style="color: var(--accent-cyan);"
id="stat-total">0</div>

<div class="metric-label">Total Reports</div>

</div>

<div class="quality-metric" style="background: var(--bg-elevated);
border: 1px solid var(--glass-border);">

<div class="metric-value" style="color: var(--accent-orange);"
id="stat-this-month">0</div>

<div class="metric-label">This Month</div>

</div>

<div class="quality-metric" style="background: var(--bg-elevated);
border: 1px solid var(--glass-border);">

<div class="metric-value" style="color: var(--success);"
id="stat-avg-quality">0%</div>

<div class="metric-label">Avg Quality</div>

</div>

<div class="quality-metric" style="background: var(--bg-elevated);
border: 1px solid var(--glass-border);">

<div class="metric-value" style="color: var(--info);"
id="stat-photos">0</div>

<div class="metric-label">Total Photos</div>

</div>

</div>

</div>

</div>

</div>

</div>

</main>

</div>

<!-- TOAST NOTIFICATION -->

<div class="toast" id="toast"></div>

<!-- MODAL -->

<div class="modal-overlay" id="modal-overlay">

<div class="modal">

<div class="modal-title" id="modal-title">Confirm Action</div>

<div class="modal-content" id="modal-content">Are you
sure?</div>

<div class="modal-actions">

<button class="btn btn-secondary"
onclick="closeModal(false)">Cancel</button>

<button class="btn btn-primary"
onclick="closeModal(true)">Confirm</button>

</div>

</div>

</div>

<script>
// ==================== FIELD BUDDY PRO v4.0 - OPTIMIZED JAVASCRIPT ====================
// Clean, modular architecture with improved performance and maintainability

(function() {
    'use strict';

    // ==================== CONFIGURATION & CONSTANTS ====================
    const CONFIG = {
        STORAGE_KEY: 'fieldBuddyReports',
        DUCT_DESIGN_KEY: 'lastDuctDesign',
        TOAST_DURATION: 3000,
        CFM_PER_TON: 400,
        STANDARD_DUCT_SIZES: [4, 5, 6, 7, 8, 9, 10, 12, 14, 16, 18, 20, 22, 24],
        STANDARD_TRUNK_SIZES: [10, 12, 14, 16, 18, 20, 22, 24]
    };

    // R410A Pressure-Temperature Chart
    const R410A_PT = {
        43: 0, 57: 10, 73: 20, 92: 30, 114: 40, 117: 41, 121: 42, 125: 43,
        140: 50, 169: 60, 201: 70, 237: 80, 278: 90, 323: 100, 330: 102,
        335: 103, 338: 104, 347: 105, 373: 110, 400: 115, 428: 120,
        460: 125, 493: 130, 528: 135, 565: 140
    };

    // Fixed Orifice Superheat Targets
    const SUPERHEAT_TARGETS = {
        65: 25, 70: 23, 75: 21, 80: 18, 85: 15, 90: 12, 95: 10, 100: 8, 105: 6
    };

    // ==================== STATE MANAGEMENT ====================
    const State = {
        currentPage: 'dashboard',
        callType: 'trouble',
        systemMode: 'cooling',
        selectedMaterials: [],
        diagnosticResults: [],
        categoryStates: {},
        photos: [],
        signaturePad: null,
        customerSignature: null,
        charts: { pressure: null, heating: null, velocity: null },
        savedReports: [],
        ductDesignRooms: [],
        currentDuctDesign: null
    };

    // ==================== UTILITY FUNCTIONS ====================
    const Utils = {
        $(id) {
            return document.getElementById(id);
        },

        debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        },

        formatNumber(num, decimals = 1) {
            return isNaN(num) ? '' : num.toFixed(decimals);
        },

        escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        },

        generateId() {
            return Date.now() + Math.random().toString(36).substr(2, 9);
        },

        getClosestValue(target, values) {
            return values.reduce((prev, curr) =>
                Math.abs(curr - target) < Math.abs(prev - target) ? curr : prev
            );
        }
    };

    // ==================== STORAGE SERVICE ====================
    const Storage = {
        save(key, data) {
            try {
                localStorage.setItem(key, JSON.stringify(data));
                return true;
            } catch (e) {
                console.error('Storage save error:', e);
                return false;
            }
        },

        load(key) {
            try {
                const data = localStorage.getItem(key);
                return data ? JSON.parse(data) : null;
            } catch (e) {
                console.error('Storage load error:', e);
                return null;
            }
        },

        remove(key) {
            localStorage.removeItem(key);
        }
    };

    // ==================== UI SERVICE ====================
    const UI = {
        showToast(message, type = 'success') {
            const toast = Utils.$('toast');
            toast.textContent = message;
            toast.className = `toast show ${type}`;
            setTimeout(() => toast.classList.remove('show'), CONFIG.TOAST_DURATION);
        },

        showModal(title, content) {
            return new Promise(resolve => {
                Utils.$('modal-title').textContent = title;
                Utils.$('modal-content').textContent = content;
                Utils.$('modal-overlay').classList.add('show');
                window._modalResolve = resolve;
            });
        },

        closeModal(result) {
            Utils.$('modal-overlay').classList.remove('show');
            if (window._modalResolve) {
                window._modalResolve(result);
                window._modalResolve = null;
            }
        },

        toggleClass(element, className, condition) {
            if (typeof element === 'string') element = Utils.$(element);
            if (element) element.classList.toggle(className, condition);
        },

        updateBadge(elementId, text, className) {
            const el = Utils.$(elementId);
            if (el) {
                el.textContent = text;
                if (className) el.className = `badge ${className}`;
            }
        }
    };

    // ==================== NAVIGATION ====================
    const Navigation = {
        pages: {
            dashboard: 'Dashboard',
            service: 'Service Call',
            materials: 'Materials',
            'duct-design': 'Pro Duct Design',
            cfm: 'CFM Calculator',
            history: 'History & Reports'
        },

        switchPage(page) {
            State.currentPage = page;
            
            // Hide all pages
            Object.keys(this.pages).forEach(p => {
                UI.toggleClass(`${p}-page`, 'hidden', p !== page);
            });

            // Update title and nav
            Utils.$('page-title').textContent = this.pages[page];
            this.updateNavItems(page);
            this.closeMobileMenu();

            // Page-specific actions
            if (page === 'history') History.refresh();
            if (page === 'dashboard') Dashboard.updateStats();
        },

        updateNavItems(activePage) {
            const navItems = document.querySelectorAll('.nav-item');
            const pageOrder = Object.keys(this.pages);
            navItems.forEach((item, index) => {
                item.classList.toggle('active', pageOrder[index] === activePage);
            });
        },

        toggleMobileMenu() {
            const sidebar = Utils.$('sidebar');
            const overlay = Utils.$('mobile-menu-overlay');
            sidebar.classList.toggle('mobile-open');
            overlay.classList.toggle('show');
        },

        closeMobileMenu() {
            Utils.$('sidebar').classList.remove('mobile-open');
            Utils.$('mobile-menu-overlay').classList.remove('show');
        }
    };

    // ==================== DASHBOARD ====================
    const Dashboard = {
        updateStats() {
            const reports = Storage.load(CONFIG.STORAGE_KEY) || [];
            State.savedReports = reports;

            const thisMonth = reports.filter(r => {
                const d = new Date(r.timestamp);
                const now = new Date();
                return d.getMonth() === now.getMonth() && d.getFullYear() === now.getFullYear();
            });

            const avgQuality = reports.length > 0
                ? reports.reduce((sum, r) => sum + r.quality, 0) / reports.length
                : 0;

            Utils.$('dash-stat-reports').textContent = reports.length;
            Utils.$('dash-stat-quality').textContent = `${Math.round(avgQuality)}%`;
            Utils.$('dash-stat-total').textContent = reports.length;
            Utils.$('dash-stat-month').textContent = thisMonth.length;
        }
    };

    // ==================== SERVICE CALL ====================
    const ServiceCall = {
        setCallType(type) {
            State.callType = type;
            UI.toggleClass('call-trouble', 'active', type === 'trouble');
            UI.toggleClass('call-maintenance', 'active', type === 'maintenance');
        },

        setSystemMode(mode) {
            State.systemMode = mode;
            UI.toggleClass('mode-cooling', 'active', mode === 'cooling');
            UI.toggleClass('mode-heating', 'active', mode === 'heating');
            UI.toggleClass('cooling-measurements', 'hidden', mode !== 'cooling');
            UI.toggleClass('heating-measurements', 'hidden', mode !== 'heating');
            UI.toggleClass('cooling-checklist', 'hidden', mode !== 'cooling');
            UI.toggleClass('heating-checklist', 'hidden', mode !== 'heating');
            Diagnostics.calculate();
        },

        updateUnitFields() {
            const unitType = Utils.$('unit-type').value;
            const hideOutdoor = unitType === 'package' || unitType === 'mini-split';
            UI.toggleClass('outdoor-unit-group', 'hidden', hideOutdoor);
        },

        updateCheckbox(checkbox) {
            const item = checkbox.closest('.checklist-item');
            item.classList.toggle('checked', checkbox.checked);
            this.updateChecklistCount();
        },

        updateChecklistCount() {
            const mode = State.systemMode;
            const selector = `#${mode}-checklist input[type="checkbox"]`;
            const total = document.querySelectorAll(selector).length;
            const checked = document.querySelectorAll(`${selector}:checked`).length;
            Utils.$(`${mode}-checklist-count`).textContent = `${checked}/${total}`;
            Quality.calculate();
        }
    };  // ==================== QUALITY SCORE ====================
    const Quality = {
        calculate() {
            let score = 0;
            let basicInfo = 0;
            let diagnostics = 0;

            // Basic info (30%)
            if (Utils.$('customer-name').value) basicInfo++;
            if (Utils.$('service-date').value) basicInfo++;
            if (Utils.$('service-address').value) basicInfo++;
            if (Utils.$('customer-complaint').value) basicInfo++;
            if (Utils.$('unit-type').value) basicInfo++;
            score += (basicInfo / 5) * 30;

            // Diagnostics (25%)
            if (State.systemMode === 'cooling') {
                if (Utils.$('delta-t').value && Utils.$('delta-t').value !== 'N/A') diagnostics++;
                if (Utils.$('superheat').value && Utils.$('superheat').value !== 'N/A') diagnostics++;
                if (Utils.$('subcool').value && Utils.$('subcool').value !== 'N/A') diagnostics++;
            } else {
                if (Utils.$('temp-rise').value && Utils.$('temp-rise').value !== 'N/A') diagnostics++;
                if (Utils.$('manifold-pressure').value) diagnostics++;
                if (Utils.$('voltage-heat').value) diagnostics++;
            }
            score += (diagnostics / 3) * 25;

            // Additional fields
            if (Utils.$('findings').value) score += 10;
            if (Utils.$('work-performed').value) score += 10;
            score += Math.min(State.photos.length * 3, 15);
            if (State.customerSignature) score += 10;

            this.updateDisplay(Math.round(score), basicInfo, diagnostics);
        },

        updateDisplay(score, basicInfo, diagnostics) {
            Utils.$('quality-score-large').textContent = `${score}%`;
            Utils.$('metric-basic').textContent = `${basicInfo}/5`;
            Utils.$('metric-diagnostics').textContent = `${diagnostics}/3`;
            Utils.$('metric-photos').textContent = State.photos.length;
            Utils.$('metric-signature').textContent = State.customerSignature ? '‚úì' : '‚úó';

            if (score >= 80) {
                UI.updateBadge('quality-badge', 'Excellent', 'badge-success');
            } else if (score >= 60) {
                UI.updateBadge('quality-badge', 'Good', 'badge-info');
            } else if (score >= 40) {
                UI.updateBadge('quality-badge', 'Fair', 'badge-warning');
            } else {
                UI.updateBadge('quality-badge', 'Incomplete', 'badge-danger');
            }
        }
    };

    // ==================== DIAGNOSTICS ====================
    const Diagnostics = {
        calculate() {
            State.systemMode === 'cooling' ? this.calculateCooling() : this.calculateHeating();
        },

        getSaturationTemp(pressure) {
            const pressures = Object.keys(R410A_PT).map(Number);
            const closest = Utils.getClosestValue(pressure, pressures);
            return R410A_PT[closest];
        },

        getTargetSuperheat(outdoorTemp) {
            const temps = Object.keys(SUPERHEAT_TARGETS).map(Number);
            const closest = Utils.getClosestValue(outdoorTemp, temps);
            return SUPERHEAT_TARGETS[closest];
        },

        calculateCooling() {
            const values = {
                outdoorAmbient: parseFloat(Utils.$('outdoor-ambient').value),
                returnTemp: parseFloat(Utils.$('return-temp').value),
                supplyTemp: parseFloat(Utils.$('supply-temp').value),
                suctionPressure: parseFloat(Utils.$('suction-pressure').value),
                suctionTemp: parseFloat(Utils.$('suction-temp').value),
                liquidPressure: parseFloat(Utils.$('liquid-pressure').value),
                liquidTemp: parseFloat(Utils.$('liquid-temp').value),
                meteringDevice: Utils.$('metering-device').value
            };

            // Delta-T
            if (!isNaN(values.returnTemp) && !isNaN(values.supplyTemp)) {
                const deltaT = values.returnTemp - values.supplyTemp;
                Utils.$('delta-t').value = `${deltaT.toFixed(1)}¬∞F`;
                this.setFieldWarning('delta-t', deltaT < 14 || deltaT > 24);
            } else {
                Utils.$('delta-t').value = '';
            }

            // Superheat
            if (!isNaN(values.suctionPressure) && !isNaN(values.suctionTemp)) {
                const satTemp = this.getSaturationTemp(values.suctionPressure);
                if (satTemp !== null) {
                    const superheat = values.suctionTemp - satTemp;
                    Utils.$('superheat').value = `${superheat.toFixed(1)}¬∞F`;
                    
                    let isWarning = false;
                    if (values.meteringDevice === 'txv') {
                        isWarning = superheat < 8 || superheat > 15;
                    } else if (values.meteringDevice === 'piston' && !isNaN(values.outdoorAmbient)) {
                        const target = this.getTargetSuperheat(values.outdoorAmbient);
                        isWarning = Math.abs(superheat - target) > 5;
                    }
                    this.setFieldWarning('superheat', isWarning);
                }
            } else {
                Utils.$('superheat').value = '';
            }

            // Subcool
            if (!isNaN(values.liquidPressure) && !isNaN(values.liquidTemp)) {
                const satTemp = this.getSaturationTemp(values.liquidPressure);
                if (satTemp !== null) {
                    const subcool = satTemp - values.liquidTemp;
                    Utils.$('subcool').value = `${subcool.toFixed(1)}¬∞F`;
                    this.setFieldWarning('subcool', subcool < 8 || subcool > 12);
                }
            } else {
                Utils.$('subcool').value = '';
            }

            this.runAnalysis();
            Charts.updatePressure();
            Quality.calculate();
        },

        calculateHeating() {
            const returnTemp = parseFloat(Utils.$('return-temp-heat').value);
            const supplyTemp = parseFloat(Utils.$('supply-temp-heat').value);
            const manifoldPressure = parseFloat(Utils.$('manifold-pressure').value);
            const gasType = Utils.$('gas-type').value;

            // Temperature Rise
            if (!isNaN(returnTemp) && !isNaN(supplyTemp)) {
                const tempRise = supplyTemp - returnTemp;
                Utils.$('temp-rise').value = `${tempRise.toFixed(1)}¬∞F`;
                this.setFieldWarning('temp-rise', tempRise < 35 || tempRise > 65);
            } else {
                Utils.$('temp-rise').value = '';
            }

            // Manifold Pressure
            if (!isNaN(manifoldPressure)) {
                const isNatural = gasType === 'natural';
                const min = isNatural ? 3.3 : 10;
                const max = isNatural ? 3.8 : 11;
                this.setFieldWarning('manifold-pressure', manifoldPressure < min || manifoldPressure > max);
            }

            this.runAnalysis();
            Charts.updateHeating();
            Quality.calculate();
        },

        setFieldWarning(fieldId, isWarning) {
            const field = Utils.$(fieldId);
            if (field) field.classList.toggle('warning', isWarning);
        },

        runAnalysis() {
            State.diagnosticResults = [];
            
            if (State.systemMode === 'cooling') {
                this.analyzeCooling();
            } else {
                this.analyzeHeating();
            }
            
            this.displayResults();
        },

        analyzeCooling() {
            const deltaT = parseFloat(Utils.$('delta-t').value);
            const superheat = parseFloat(Utils.$('superheat').value);
            const subcool = parseFloat(Utils.$('subcool').value);
            const staticPressure = parseFloat(Utils.$('static-pressure').value);
            const meteringDevice = Utils.$('metering-device').value;
            const outdoorAmbient = parseFloat(Utils.$('outdoor-ambient').value);
            const rlaRating = parseFloat(Utils.$('rla-rating').value);
            const amperage = parseFloat(Utils.$('amperage').value);

            // Delta-T Analysis
            if (!isNaN(deltaT)) {
                if (deltaT < 14) {
                    State.diagnosticResults.push({
                        severity: 'danger',
                        title: 'Low Delta-T Detected - Insufficient Cooling',
                        message: `Delta-T is ${deltaT.toFixed(1)}¬∞F (Expected: 16-22¬∞F)`,
                        recommendations: [
                            'Check and replace air filter immediately',
                            'Inspect evaporator coil for dirt/restrictions',
                            'Verify blower motor operation and speed settings',
                            'Check for closed or blocked supply vents',
                            'Measure total external static pressure',
                            'Verify ductwork is properly sized'
                        ]
                    });
                } else if (deltaT >= 16 && deltaT <= 22) {
                    State.diagnosticResults.push({
                        severity: 'success',
                        title: 'Delta-T in Optimal Range',
                        message: `Delta-T is ${deltaT.toFixed(1)}¬∞F - Airflow is within specifications`
                    });
                } else if (deltaT > 24) {
                    State.diagnosticResults.push({
                        severity: 'danger',
                        title: 'High Delta-T - Severe Airflow Restriction',
                        message: `Delta-T is ${deltaT.toFixed(1)}¬∞F (Expected: 16-22¬∞F)`,
                        recommendations: [
                            'CRITICAL: Replace air filter immediately',
                            'Inspect ductwork for collapsed/crushed sections',
                            'Check blower speed - may be set too low',
                            'Verify return air pathway is adequate',
                            'Check for undersized ductwork',
                            'Measure ESP - likely exceeding 0.50 in w.c.'
                        ]
                    });
                }
            }

            // Static Pressure Analysis
            if (!isNaN(staticPressure)) {
                if (staticPressure > 0.7) {
                    State.diagnosticResults.push({
                        severity: 'danger',
                        title: 'Excessive Static Pressure - System Stress',
                        message: `Static pressure is ${staticPressure.toFixed(2)} in w.c. (Max: 0.50 for residential)`,
                        recommendations: [
                            'URGENT: Replace filter and verify improvement',
                            'Inspect ductwork for restrictions/damage',
                            'Verify proper duct sizing using Manual D',
                            'Check for closed dampers in trunk lines',
                            'Consider duct system redesign if oversized equipment',
                            'Monitor blower motor amperage - may be overloaded'
                        ]
                    });
                } else if (staticPressure <= 0.5) {
                    State.diagnosticResults.push({
                        severity: 'success',
                        title: 'Static Pressure Acceptable',
                        message: `Static pressure is ${staticPressure.toFixed(2)} in w.c. - within specifications`
                    });
                }
            }

            // Charge Analysis
            if (!isNaN(superheat) && !isNaN(subcool)) {
                this.analyzeCharge(superheat, subcool, meteringDevice, outdoorAmbient);
            }

            // Amperage Analysis
            if (!isNaN(amperage) && !isNaN(rlaRating)) {
                const percent = (amperage / rlaRating) * 100;
                if (percent > 110) {
                    State.diagnosticResults.push({
                        severity: 'danger',
                        title: 'Compressor Drawing Excessive Current',
                        message: `Running at ${percent.toFixed(0)}% of RLA (${amperage.toFixed(1)}A / ${rlaRating.toFixed(1)}A rated)`,
                        recommendations: [
                            'Check supply voltage - low voltage increases amperage',
                            'Verify capacitor is within spec',
                            'Check for refrigerant overcharge',
                            'Inspect for restricted airflow (high head pressure)',
                            'Monitor compressor for overheating',
                            'May indicate failing compressor'
                        ]
                    });
                }
            }
        },

        analyzeCharge(superheat, subcool, meteringDevice, outdoorAmbient) {
            if (meteringDevice === 'txv') {
                if (superheat > 20 && subcool < 8) {
                    State.diagnosticResults.push({
                        severity: 'danger',
                        title: 'System Undercharged - Refrigerant Loss Detected',
                        message: `Superheat: ${superheat.toFixed(1)}¬∞F, Subcool: ${subcool.toFixed(1)}¬∞F`,
                        recommendations: [
                            'Perform thorough leak detection on evaporator coil',
                            'Check all brazed joints for leaks',
                            'Inspect line set connections at both ends',
                            'Check service valve cores for leaks',
                            'Verify filter drier is not restricted',
                            'After leak repair, evacuate and recharge by weight',
                            'Verify charge using subcooling method (target: 8-12¬∞F)'
                        ]
                    });
                } else if (superheat < 5 && subcool > 15) {
                    State.diagnosticResults.push({
                        severity: 'warning',
                        title: 'System May Be Overcharged',
                        message: `Superheat: ${superheat.toFixed(1)}¬∞F, Subcool: ${subcool.toFixed(1)}¬∞F`,
                        recommendations: [
                            'Verify charge was not added incorrectly',
                            'Check for non-condensables in system',
                            'Ensure condenser has adequate airflow',
                            'Verify condenser coil is clean',
                            'Consider recovering excess refrigerant',
                            'Re-verify charge using manufacturer specs'
                        ]
                    });
                } else if (superheat >= 8 && superheat <= 15 && subcool >= 8 && subcool <= 12) {
                    State.diagnosticResults.push({
                        severity: 'success',
                        title: 'Refrigerant Charge Correct (TXV System)',
                        message: `Superheat: ${superheat.toFixed(1)}¬∞F, Subcool: ${subcool.toFixed(1)}¬∞F - within TXV system specifications`
                    });
                } else if (superheat > 25 && subcool >= 8) {
                    State.diagnosticResults.push({
                        severity: 'danger',
                        title: 'TXV Malfunction Suspected',
                        message: `High superheat (${superheat.toFixed(1)}¬∞F) with normal subcool indicates TXV not opening properly`,
                        recommendations: [
                            'Check TXV sensing bulb placement and contact',
                            'Verify bulb is properly insulated',
                            'Inspect for kinked liquid line before TXV',
                            'Check for clogged filter drier or strainer',
                            'Verify TXV is correct tonnage for system',
                            'Consider TXV replacement if other checks pass'
                        ]
                    });
                }
            } else if (meteringDevice === 'piston' && !isNaN(outdoorAmbient)) {
                const targetSH = this.getTargetSuperheat(outdoorAmbient);
                const diff = Math.abs(superheat - targetSH);
                
                if (diff > 5) {
                    const isLow = superheat > targetSH;
                    State.diagnosticResults.push({
                        severity: 'warning',
                        title: `Refrigerant Charge ${isLow ? 'Low' : 'High'} (Fixed Orifice System)`,
                        message: `Superheat: ${superheat.toFixed(1)}¬∞F (Target: ${targetSH}¬∞F at ${outdoorAmbient}¬∞F outdoor) | Subcool: ${subcool.toFixed(1)}¬∞F`,
                        recommendations: isLow ? [
                            'Perform leak check before adding refrigerant',
                            'Use superheat method for charge verification',
                            'Add refrigerant in small increments',
                            'Monitor both superheat and subcool while charging',
                            'Target superheat varies with outdoor temperature',
                            'Re-check after system stabilizes (15-20 minutes)'
                        ] : [
                            'Verify outdoor ambient temperature is correct',
                            'Check for restricted airflow across evaporator',
                            'Consider recovering small amount of refrigerant',
                            'Monitor head pressure - may be elevated',
                            'Re-verify charge using manufacturer chart'
                        ]
                    });
                } else {
                    State.diagnosticResults.push({
                        severity: 'success',
                        title: 'Refrigerant Charge Correct (Fixed Orifice)',
                        message: `Superheat: ${superheat.toFixed(1)}¬∞F (Target: ${targetSH}¬∞F at ${outdoorAmbient}¬∞F outdoor) - charge is accurate`
                    });
                }
            }
        },

        analyzeHeating() {
            const tempRise = parseFloat(Utils.$('temp-rise').value);
            const manifoldPressure = parseFloat(Utils.$('manifold-pressure').value);
            const gasType = Utils.$('gas-type').value;

            if (!isNaN(tempRise)) {
                if (tempRise < 35) {
                    State.diagnosticResults.push({
                        severity: 'danger',
                        title: 'Low Temperature Rise - Insufficient Heating',
                        message: `Temp rise is ${tempRise.toFixed(1)}¬∞F (Expected: 35-65¬∞F)`,
                        recommendations: [
                            'Check gas input - verify manifold pressure',
                            'Inspect burners for proper flame pattern',
                            'Check for excessive airflow (blower speed too high)',
                            'Verify all burners are igniting',
                            'Check gas valve for proper operation',
                            'Verify orifice size matches gas type'
                        ]
                    });
                } else if (tempRise > 65) {
                    State.diagnosticResults.push({
                        severity: 'danger',
                        title: 'High Temperature Rise - Airflow Restriction',
                        message: `Temp rise is ${tempRise.toFixed(1)}¬∞F (Expected: 35-65¬∞F)`,
                        recommendations: [
                            'CRITICAL: Check airflow restriction immediately',
                            'Replace air filter',
                            'Verify blower speed is correct',
                            'Inspect heat exchanger for restrictions',
                            'Check limit switches - may be cycling',
                            'High temp rise can crack heat exchanger'
                        ]
                    });
                } else {
                    State.diagnosticResults.push({
                        severity: 'success',
                        title: 'Temperature Rise in Range',
                        message: `Temp rise is ${tempRise.toFixed(1)}¬∞F - heating output is correct`
                    });
                }
            }

            if (!isNaN(manifoldPressure)) {
                const isNatural = gasType === 'natural';
                const min = isNatural ? 3.3 : 10;
                const max = isNatural ? 3.8 : 11;
                const gasName = isNatural ? 'Natural Gas' : 'LP/Propane';

                if (manifoldPressure < min || manifoldPressure > max) {
                    State.diagnosticResults.push({
                        severity: 'warning',
                        title: `Manifold Pressure Out of Range (${gasName})`,
                        message: `Manifold pressure is ${manifoldPressure.toFixed(2)} in w.c. (Expected: ${min}-${max})`,
                        recommendations: isNatural ? [
                            'Adjust gas valve regulator',
                            'Check incoming gas supply pressure',
                            'Verify regulator is not failed',
                            'Ensure proper orifice size installed',
                            'Consult furnace specifications'
                        ] : [
                            'Adjust gas valve regulator for LP operation',
                            'Verify LP orifices are installed (smaller than NG)',
                            'Check LP supply tank pressure',
                            'Ensure conversion kit was properly installed',
                            'Consult manufacturer LP conversion specs'
                        ]
                    });
                } else {
                    State.diagnosticResults.push({
                        severity: 'success',
                        title: `Manifold Pressure Correct (${gasName})`,
                        message: `Manifold pressure is ${manifoldPressure.toFixed(2)} in w.c.`
                    });
                }
            }
        },

        displayResults() {
            const container = Utils.$('diagnostic-results');
            
            if (State.diagnosticResults.length === 0) {
                container.classList.add('hidden');
                return;
            }

            container.classList.remove('hidden');
            
            let html = '<div class="diagnostic-panel">';
            html += '<div class="diagnostic-header">üéØ Master Tech Diagnostic Analysis</div>';
            
            State.diagnosticResults.forEach(result => {
                html += '<div class="diagnostic-card">';
                html += '<div class="diagnostic-card-header">';
                html += `<div class="diagnostic-card-title">${result.title}</div>`;
                html += `<span class="badge badge-${result.severity}">${result.severity}</span>`;
                html += '</div>';
                html += `<p style="margin-bottom: 8px; color: var(--text-secondary);">${result.message}</p>`;
                
                if (result.recommendations && result.recommendations.length > 0) {
                    html += '<div class="diagnostic-recommendations">';
                    html += '<strong style="font-size: 12px; color: var(--text-primary);">Recommended Actions:</strong>';
                    html += '<ul>';
                    result.recommendations.forEach(rec => {
                        html += `<li>${rec}</li>`;
                    });
                    html += '</ul>';
                    html += '</div>';
                }
                html += '</div>';
            });
            
            html += '</div>';
            container.innerHTML = html;
        }
    };

    // ==================== CHARTS ====================
    const Charts = {
        updatePressure() {
            const ctx = Utils.$('pressure-chart');
            if (!ctx) return;

            const suction = parseFloat(Utils.$('suction-pressure').value) || 0;
            const liquid = parseFloat(Utils.$('liquid-pressure').value) || 0;

            if (State.charts.pressure) {
                State.charts.pressure.data.datasets[0].data = [suction, liquid];
                State.charts.pressure.update();
            } else {
                State.charts.pressure = new Chart(ctx.getContext('2d'), {
                    type: 'bar',
                    data: {
                        labels: ['Suction', 'Liquid'],
                        datasets: [{
                            label: 'Pressure (PSI)',
                            data: [suction, liquid],
                            backgroundColor: ['rgba(0,217,255,0.2)', 'rgba(255,107,53,0.2)'],
                            borderColor: ['rgb(0,217,255)', 'rgb(255,107,53)'],
                            borderWidth: 2
                        }]
                    },
                    options: this.getChartOptions('Refrigerant Pressures', 'Pressure (PSI)')
                });
            }
        },

        updateHeating() {
            const ctx = Utils.$('heating-chart');
            if (!ctx) return;

            const returnTemp = parseFloat(Utils.$('return-temp-heat').value) || 0;
            const supplyTemp = parseFloat(Utils.$('supply-temp-heat').value) || 0;

            if (State.charts.heating) {
                State.charts.heating.data.datasets[0].data = [returnTemp, supplyTemp];
                State.charts.heating.update();
            } else {
                State.charts.heating = new Chart(ctx.getContext('2d'), {
                    type: 'bar',
                    data: {
                        labels: ['Return', 'Supply'],
                        datasets: [{
                            label: 'Temperature (¬∞F)',
                            data: [returnTemp, supplyTemp],
                            backgroundColor: ['rgba(59,130,246,0.2)', 'rgba(255,107,53,0.2)'],
                            borderColor: ['rgb(59,130,246)', 'rgb(255,107,53)'],
                            borderWidth: 2
                        }]
                    },
                    options: this.getChartOptions('Air Temperatures', 'Temperature (¬∞F)')
                });
            }
        },

        updateVelocity(cfm) {
            const ctx = Utils.$('velocity-chart');
            if (!ctx) return;

            const sizes = [6, 7, 8, 9, 10, 12, 14, 16];
            const velocities = sizes.map(d => {
                const area = Math.PI * Math.pow(d / 2, 2);
                return (cfm * 144) / area;
            });

            if (State.charts.velocity) {
                State.charts.velocity.data.labels = sizes.map(s => `${s}"`);
                State.charts.velocity.data.datasets[0].data = velocities;
                State.charts.velocity.update();
            } else {
                State.charts.velocity = new Chart(ctx.getContext('2d'), {
                    type: 'line',
                    data: {
                        labels: sizes.map(s => `${s}"`),
                        datasets: [{
                            label: 'Velocity (FPM)',
                            data: velocities,
                            borderColor: 'rgb(0, 217, 255)',
                            backgroundColor: 'rgba(0, 217, 255, 0.1)',
                            tension: 0.4,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: { display: true, text: 'Velocity (FPM)', color: '#CBD5E1' },
                                ticks: { color: '#CBD5E1' },
                                grid: { color: 'rgba(203, 213, 225, 0.1)' }
                            },
                            x: {
                                title: { display: true, text: 'Round Duct Diameter', color: '#CBD5E1' },
                                ticks: { color: '#CBD5E1' },
                                grid: { color: 'rgba(203, 213, 225, 0.1)' }
                            }
                        },
                        plugins: {
                            title: { display: true, text: `Velocity vs Duct Size (${cfm} CFM)`, color: '#F8FAFC' },
                            legend: { labels: { color: '#CBD5E1' } }
                        }
                    }
                });
            }
        },

        getChartOptions(title, yAxisLabel) {
            return {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        title: { display: true, text: yAxisLabel, color: '#CBD5E1' },
                        ticks: { color: '#CBD5E1' },
                        grid: { color: 'rgba(203, 213, 225, 0.1)' }
                    },
                    x: {
                        ticks: { color: '#CBD5E1' },
                        grid: { color: 'rgba(203, 213, 225, 0.1)' }
                    }
                },
                plugins: {
                    title: { display: true, text: title, color: '#F8FAFC' },
                    legend: { display: false }
                }
            };
        }
    };

    // ==================== PHOTOS ====================
    const Photos = {
        handle(event) {
            Array.from(event.target.files).forEach(file => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    State.photos.push({
                        data: e.target.result,
                        name: file.name,
                        timestamp: new Date().toISOString()
                    });
                    this.display();
                    Quality.calculate();
                    UI.showToast(`Photo "${file.name}" added`);
                };
                reader.readAsDataURL(file);
            });
            event.target.value = '';
        },

        display() {
            const gallery = Utils.$('photo-gallery');
            let html = `<label class="photo-upload">
                <input type="file" accept="image/*" capture="camera" multiple onchange="handlePhotos(event)" style="display:none">
                <span style="font-size: 32px;">üì∑</span>
                <span>Add Photo</span>
            </label>`;

            State.photos.forEach((photo, i) => {
                html += `<div class="photo-item">
                    <img src="${photo.data}" onclick="viewPhoto(${i})">
                    <div class="photo-item-actions">
                        <button class="photo-btn" onclick="deletePhoto(${i}); event.stopPropagation();">üóëÔ∏è</button>
                    </div>
                </div>`;
            });

            gallery.innerHTML = html;
            Utils.$('photo-count').textContent = `${State.photos.length} photo${State.photos.length !== 1 ? 's' : ''}`;
        },

        view(index) {
            window.open(State.photos[index].data);
        },

        delete(index) {
            State.photos.splice(index, 1);
            this.display();
            Quality.calculate();
            UI.showToast('Photo deleted');
        }
    };

    // ==================== SIGNATURE ====================
    const Signature = {
        init() {
            const canvas = Utils.$('signature-pad');
            if (!canvas) return;

            State.signaturePad = new SignaturePad(canvas, {
                backgroundColor: 'rgb(30, 38, 56)',
                penColor: 'rgb(0, 217, 255)'
            });

            const resize = () => {
                const ratio = Math.max(window.devicePixelRatio || 1, 1);
                canvas.width = canvas.offsetWidth * ratio;
                canvas.height = canvas.offsetHeight * ratio;
                canvas.getContext('2d').scale(ratio, ratio);
                
                if (State.customerSignature) {
                    const img = new Image();
                    img.onload = () => State.signaturePad.fromDataURL(State.customerSignature);
                    img.src = State.customerSignature;
                }
            };

            window.addEventListener('resize', resize);
            resize();
        },

        clear() {
            if (State.signaturePad) {
                State.signaturePad.clear();
                State.customerSignature = null;
                Quality.calculate();
                UI.showToast('Signature cleared');}
        },

        save() {
            if (!State.signaturePad || State.signaturePad.isEmpty()) {
                UI.showToast('Please provide a signature first', 'danger');
                return;
            }
            State.customerSignature = State.signaturePad.toDataURL();
            Quality.calculate();
            UI.showToast('Signature saved!');
        }
    };

    // ==================== MATERIALS CATALOG ====================
    const Materials = {
        catalog: {
            equipment: {
                name: 'Equipment',
                icon: 'üè†',
                items: [
                    { id: 'furnace-gas', name: 'Gas Furnace', sizes: ['40K BTU', '60K BTU', '80K BTU', '100K BTU', '120K BTU'] },
                    { id: 'furnace-electric', name: 'Electric Furnace', sizes: ['10kW', '15kW', '20kW', '25kW'] },
                    { id: 'ac-unit', name: 'Air Conditioner', sizes: ['1.5 Ton', '2 Ton', '2.5 Ton', '3 Ton', '3.5 Ton', '4 Ton', '5 Ton'] },
                    { id: 'heat-pump', name: 'Heat Pump', sizes: ['2 Ton', '2.5 Ton', '3 Ton', '3.5 Ton', '4 Ton', '5 Ton'] },
                    { id: 'evap-coil', name: 'Evaporator Coil', sizes: ['2 Ton', '2.5 Ton', '3 Ton', '3.5 Ton', '4 Ton', '5 Ton'] },
                    { id: 'air-handler', name: 'Air Handler', sizes: ['2 Ton', '2.5 Ton', '3 Ton', '3.5 Ton', '4 Ton'] },
                    { id: 'package-unit', name: 'Package Unit', sizes: ['2 Ton', '3 Ton', '4 Ton', '5 Ton'] },
                    { id: 'minisplit', name: 'Mini-Split System', sizes: ['9K BTU', '12K BTU', '18K BTU', '24K BTU', '36K BTU'] }
                ]
            },
            electrical: {
                name: 'Electrical Components',
                icon: '‚ö°',
                items: [
                    { id: 'contactor', name: 'Contactor', sizes: ['1-Pole 30A', '2-Pole 30A', '2-Pole 40A', '3-Pole 30A', '3-Pole 40A'] },
                    { id: 'capacitor-single', name: 'Run Capacitor (Single)', sizes: ['5¬µF', '7.5¬µF', '10¬µF', '15¬µF', '20¬µF', '25¬µF', '30¬µF', '35¬µF', '40¬µF', '45¬µF', '50¬µF', '60¬µF'] },
                    { id: 'capacitor-dual', name: 'Dual Run Capacitor', sizes: ['35/5¬µF', '40/5¬µF', '45/5¬µF', '50/5¬µF', '55/5¬µF', '60/5¬µF'] },
                    { id: 'hard-start', name: 'Hard Start Kit', sizes: ['1-2 Ton', '2-3 Ton', '3-5 Ton'] },
                    { id: 'transformer', name: 'Control Transformer', sizes: ['24V 40VA', '24V 75VA', '24V 100VA'] },
                    { id: 'disconnect-30', name: 'Disconnect Box (30A)', sizes: ['30A Non-Fused', '30A Fused'] },
                    { id: 'disconnect-60', name: 'Disconnect Box (60A)', sizes: ['60A Non-Fused', '60A Fused'] },
                    { id: 'whip', name: 'Electrical Whip', sizes: ['3 ft', '6 ft', '10 ft'] },
                    { id: 'wire-lv', name: 'Low Voltage Wire (18ga)', sizes: ['18/2', '18/3', '18/5', '18/8'], unit: 'ft' },
                    { id: 'wire-hv', name: 'High Voltage Wire', sizes: ['14/2', '12/2', '10/2', '10/3', '8/2', '8/3'], unit: 'ft' }
                ]
            },
            controls: {
                name: 'Controls & Thermostats',
                icon: 'üå°Ô∏è',
                items: [
                    { id: 'tstat-smart', name: 'WiFi Smart Thermostat', sizes: ['Nest', 'Ecobee', 'Honeywell T9'] },
                    { id: 'tstat-programmable', name: 'Programmable Thermostat', sizes: ['5-2 Day', '7 Day'] },
                    { id: 'tstat-nonprog', name: 'Non-Programmable Thermostat', sizes: ['Digital', 'Mercury Free'] },
                    { id: 'zone-control-panel', name: 'Zone Control Panel', sizes: ['2 Zone', '3 Zone', '4 Zone', '6 Zone'] },
                    { id: 'zone-damper', name: 'Zone Damper', sizes: ['6" Round', '8" Round', '10" Round', '6x10 Rect'] }
                ]
            },
            ductwork: {
                name: 'Ductwork & Distribution',
                icon: 'üå¨Ô∏è',
                items: [
                    { id: 'flex-duct-insulated', name: 'Flex Duct (Insulated R6)', sizes: ['4"', '5"', '6"', '7"', '8"', '10"', '12"', '14"', '16"'], unit: '25ft bag' },
                    { id: 'duct-board', name: 'Duct Board (1.5" thick)', sizes: ['4x8 sheet'], unit: 'sheet' },
                    { id: 'starting-collar', name: 'Starting Collar', sizes: ['4"', '5"', '6"', '7"', '8"', '10"', '12"'], unit: 'ea' },
                    { id: 'register', name: 'Supply Register', sizes: ['4x10', '4x12', '6x10', '6x12', '8x10', '10x10', '12x12'] },
                    { id: 'grille', name: 'Return Grille', sizes: ['10x10', '12x12', '14x14', '16x16', '20x20', '24x24'] },
                    { id: 'diffuser', name: 'Ceiling Diffuser', sizes: ['6" Round', '8" Round', '10" Round', '12" Round'] },
                    { id: 'damper-manual', name: 'Manual Balancing Damper', sizes: ['4"', '6"', '8"', '10"', '12"'] },
                    { id: 'boot-register', name: 'Register Boot', sizes: ['4"', '6"', '8"', '10"'], unit: 'ea' }
                ]
            },
            refrigeration: {
                name: 'Refrigeration',
                icon: '‚ùÑÔ∏è',
                items: [
                    { id: 'lineset-small', name: 'Line Set (1.5-2.5 Ton)', sizes: ['15 ft', '25 ft', '35 ft', '50 ft'], spec: '1/4" x 3/8"' },
                    { id: 'lineset-medium', name: 'Line Set (3-3.5 Ton)', sizes: ['15 ft', '25 ft', '35 ft', '50 ft'], spec: '3/8" x 3/4"' },
                    { id: 'lineset-large', name: 'Line Set (4-5 Ton)', sizes: ['15 ft', '25 ft', '35 ft', '50 ft'], spec: '3/8" x 7/8"' },
                    { id: 'r410a', name: 'R-410A Refrigerant', sizes: ['25 lb', '50 lb'], unit: 'cylinder' },
                    { id: 'r22', name: 'R-22 Refrigerant', sizes: ['30 lb'], unit: 'cylinder' },
                    { id: 'txv', name: 'TXV (Expansion Valve)', sizes: ['2 Ton', '2.5 Ton', '3 Ton', '3.5 Ton', '4 Ton', '5 Ton'] },
                    { id: 'filter-drier', name: 'Filter Drier', sizes: ['1/2"', '5/8"', '3/4"'] }
                ]
            },
            drainage: {
                name: 'Condensate Management',
                icon: 'üíß',
                items: [
                    { id: 'condensate-pump', name: 'Condensate Pump', sizes: ['Standard', 'Heavy Duty'] },
                    { id: 'drain-pan-primary', name: 'Drain Pan (Primary)', sizes: ['24x24', '30x30', '36x36'] },
                    { id: 'drain-pan-secondary', name: 'Drain Pan (Secondary)', sizes: ['24x24', '30x30', '36x36'] },
                    { id: 'ptrap', name: 'P-Trap', sizes: ['3/4"', '1"'] },
                    { id: 'float-switch', name: 'Float Switch', sizes: ['Standard'] }
                ]
            },
            insulation: {
                name: 'Insulation & Sealants',
                icon: 'üß±',
                items: [
                    { id: 'pipe-insulation-foam', name: 'Foam Pipe Insulation', sizes: ['1/4"', '3/8"', '1/2"', '5/8"', '3/4"', '7/8"'], unit: 'ft' },
                    { id: 'mastic', name: 'Duct Mastic', sizes: ['1 Gallon', '5 Gallon'] },
                    { id: 'foil-tape', name: 'Foil Tape', sizes: ['2"', '3"'], unit: 'roll' },
                    { id: 'mesh-tape', name: 'Mesh Tape (for mastic)', sizes: ['2"', '3"'], unit: 'roll' }
                ]
            },
            accessories: {
                name: 'Accessories & Misc',
                icon: 'üõ†Ô∏è',
                items: [
                    { id: 'condenser-pad', name: 'Condenser Pad', sizes: ['24x24', '30x30', '36x36'] },
                    { id: 'vibration-isolator', name: 'Vibration Isolators', sizes: ['Standard'], unit: 'set' },
                    { id: 'line-hide', name: 'Line Set Cover', sizes: ['3"', '4"', '6"'], unit: 'ft' },
                    { id: 'cleaning-coil', name: 'Coil Cleaner', sizes: ['Aerosol', '1 Gallon'] }
                ]
            }
        },

        init() {
            const container = Utils.$('materials-catalog');
            let html = '';

            Object.keys(this.catalog).forEach(catKey => {
                const category = this.catalog[catKey];
                State.categoryStates[catKey] = false;

                html += `<div class="materials-category" id="cat-${catKey}" data-category="${catKey}">
                    <div class="category-header" onclick="toggleCategory('${catKey}')">
                        <div class="category-title-group">
                            <span class="category-icon">${category.icon}</span>
                            <span class="category-name">${category.name}</span>
                        </div>
                        <div class="category-meta">
                            <span class="category-count">${category.items.length} items</span>
                            <span class="category-selected hidden" id="cat-selected-${catKey}">0 selected</span>
                            <span class="category-arrow">‚ñº</span>
                        </div>
                    </div>
                    <div class="category-items">`;

                category.items.forEach(item => {
                    const itemId = `${catKey}-${item.id}`;
                    const sizeDisplay = item.spec || item.sizes.slice(0, 3).join(', ') + (item.sizes.length > 3 ? ' +more' : '');
                    
                    html += `<div class="material-item" data-search="${item.name.toLowerCase()} ${category.name.toLowerCase()}">
                        <input type="checkbox" id="${itemId}" onchange="toggleMaterial('${catKey}', '${item.id}')">
                        <div class="material-info">
                            <div class="material-name">${item.name}</div>
                            <div class="material-spec">${sizeDisplay}</div>
                        </div>
                    </div>`;
                });

                html += '</div></div>';
            });

            container.innerHTML = html;
        },

        toggleCategory(catKey) {
            const cat = Utils.$(`cat-${catKey}`);
            cat.classList.toggle('expanded');
            State.categoryStates[catKey] = !State.categoryStates[catKey];
        },

        expandAll() {
            Object.keys(this.catalog).forEach(catKey => {
                Utils.$(`cat-${catKey}`).classList.add('expanded');
                State.categoryStates[catKey] = true;
            });
            UI.showToast('All categories expanded');
        },

        collapseAll() {
            Object.keys(this.catalog).forEach(catKey => {
                Utils.$(`cat-${catKey}`).classList.remove('expanded');
                State.categoryStates[catKey] = false;
            });
            UI.showToast('All categories collapsed');
        },

        filter() {
            const search = Utils.$('material-search').value.toLowerCase();
            const items = document.querySelectorAll('.material-item');
            const visibleCategories = {};

            if (search) {
                items.forEach(item => {
                    const searchText = item.dataset.search || '';
                    const isMatch = searchText.includes(search);
                    item.style.display = isMatch ? 'flex' : 'none';
                    
                    if (isMatch) {
                        const catKey = item.closest('.materials-category').dataset.category;
                        visibleCategories[catKey] = true;
                    }
                });

                Object.keys(this.catalog).forEach(catKey => {
                    const cat = Utils.$(`cat-${catKey}`);
                    if (visibleCategories[catKey]) {
                        cat.classList.add('expanded');
                        cat.style.display = 'block';
                    } else {
                        cat.style.display = 'none';
                    }
                });
            } else {
                items.forEach(item => item.style.display = 'flex');
                Object.keys(this.catalog).forEach(catKey => {
                    const cat = Utils.$(`cat-${catKey}`);
                    cat.style.display = 'block';
                    if (!State.categoryStates[catKey]) {
                        cat.classList.remove('expanded');
                    }
                });
            }
        },

        toggle(catKey, itemId) {
            const category = this.catalog[catKey];
            const item = category.items.find(i => i.id === itemId);
            const checkbox = Utils.$(`${catKey}-${itemId}`);

            if (checkbox.checked) {
                State.selectedMaterials.push({
                    catKey,
                    catName: category.name,
                    name: item.name,
                    spec: item.spec || item.sizes[0],
                    sizes: item.sizes,
                    unit: item.unit || 'ea',
                    quantity: 1
                });
            } else {
                State.selectedMaterials = State.selectedMaterials.filter(
                    m => !(m.catKey === catKey && m.name === item.name)
                );
            }

            this.updateCategoryCount(catKey);
            this.displaySelected();
        },

        updateCategoryCount(catKey) {
            const count = State.selectedMaterials.filter(m => m.catKey === catKey).length;
            const badge = Utils.$(`cat-selected-${catKey}`);
            
            if (count > 0) {
                badge.textContent = `${count} selected`;
                badge.classList.remove('hidden');
            } else {
                badge.classList.add('hidden');
            }
        },

        displaySelected() {
            const container = Utils.$('selected-materials');
            
            if (State.selectedMaterials.length === 0) {
                container.innerHTML = '<div class="status-card info">‚ÑπÔ∏è No materials selected yet. Use the catalog above to add items.</div>';
                Utils.$('selected-materials-count').textContent = '0 items';
                return;
            }

            let html = '';
            State.selectedMaterials.forEach((item, idx) => {
                html += `<div class="selected-material">
                    <div class="selected-material-info">
                        <div class="material-name">${item.name}</div>
                        <div class="material-spec">${item.spec}</div>
                    </div>
                    <div class="selected-material-controls">`;
                
                if (item.sizes.length > 1) {
                    html += `<select onchange="State.selectedMaterials[${idx}].spec = this.value">`;
                    item.sizes.forEach(size => {
                        html += `<option value="${size}" ${item.spec === size ? 'selected' : ''}>${size}</option>`;
                    });
                    html += '</select>';
                }
                
                html += `<input type="number" value="${item.quantity}" min="1" onchange="State.selectedMaterials[${idx}].quantity = parseInt(this.value); Materials.displaySelected();">
                    <span>${item.unit}</span>
                    <button class="photo-btn" onclick="removeMaterial(${idx})">‚úï</button>
                    </div>
                </div>`;
            });

            container.innerHTML = html;
            Utils.$('selected-materials-count').textContent = `${State.selectedMaterials.length} item${State.selectedMaterials.length !== 1 ? 's' : ''}`;
        },

        remove(index) {
            const item = State.selectedMaterials[index];
            const category = this.catalog[item.catKey];
            const catalogItem = category.items.find(i => i.name === item.name);
            
            if (catalogItem) {
                const checkbox = Utils.$(`${item.catKey}-${catalogItem.id}`);
                if (checkbox) checkbox.checked = false;
            }

            State.selectedMaterials.splice(index, 1);
            this.updateCategoryCount(item.catKey);
            this.displaySelected();
            UI.showToast('Material removed');
        }
    };// ==================== DUCT DESIGN ====================
    const DuctDesign = {
        calculateSystemCFM() {
            const tonnage = parseFloat(Utils.$('duct-tonnage').value);
            
            if (!isNaN(tonnage)) {
                const systemCFM = tonnage * CONFIG.CFM_PER_TON;
                Utils.$('system-cfm-display').textContent = systemCFM;
                Utils.$('trunk-cfm').value = systemCFM;
                this.calculateTrunkSize();
                this.checkReadiness();
            } else {
                Utils.$('system-cfm-display').textContent = '0';
                Utils.$('trunk-cfm').value = '';
            }
        },

        addRoom() {
            State.ductDesignRooms.push({
                id: Utils.generateId(),
                name: '',
                length: '',
                width: '',
                height: 8,
                cfm: 0,
                ductSize: '',
                ductLength: 20,
                registerSize: '',
                location: ''
            });
            this.displayRooms();
            UI.showToast('Room added');
        },

        removeRoom(index) {
            State.ductDesignRooms.splice(index, 1);
            this.displayRooms();
            UI.showToast('Room removed');
        },

        displayRooms() {
            const container = Utils.$('duct-rooms-container');
            
            if (State.ductDesignRooms.length === 0) {
                container.innerHTML = '<div class="status-card info">‚ÑπÔ∏è Click "Add Room" to start your duct design.</div>';
                Utils.$('duct-totals').classList.add('hidden');
                this.checkReadiness();
                return;
            }

            let html = '';
            State.ductDesignRooms.forEach((room, index) => {
                html += `<div class="card" style="margin-bottom: 16px;">
                    <div class="card-header">
                        <div class="card-title">Room ${index + 1}: ${room.name || 'Unnamed'}</div>
                        <button class="btn btn-danger btn-sm" onclick="removeDuctRoom(${index})">Remove</button>
                    </div>
                    <div class="card-body">
                        <div class="form-grid form-grid-2">
                            <div class="form-group">
                                <label>Room Name</label>
                                <input type="text" value="${room.name}" onchange="updateDuctRoom(${index}, 'name', this.value)" placeholder="e.g., Master Bedroom">
                            </div>
                            <div class="form-group">
                                <label>Register Location</label>
                                <input type="text" value="${room.location}" onchange="updateDuctRoom(${index}, 'location', this.value)" placeholder="e.g., SW corner wall">
                            </div>
                        </div>
                        <div class="form-grid form-grid-4">
                            <div class="form-group">
                                <label>Length (ft)</label>
                                <input type="number" value="${room.length}" onchange="updateDuctRoomDimension(${index}, 'length', this.value)" placeholder="12">
                            </div>
                            <div class="form-group">
                                <label>Width (ft)</label>
                                <input type="number" value="${room.width}" onchange="updateDuctRoomDimension(${index}, 'width', this.value)" placeholder="10">
                            </div>
                            <div class="form-group">
                                <label>Height (ft)</label>
                                <input type="number" value="${room.height}" onchange="updateDuctRoomDimension(${index}, 'height', this.value)" placeholder="8">
                            </div>
                            <div class="form-group">
                                <label>Duct Length (ft)</label>
                                <input type="number" value="${room.ductLength}" onchange="updateDuctRoom(${index}, 'ductLength', parseFloat(this.value))">
                            </div>
                        </div>
                        <div class="form-grid form-grid-3">
                            <div class="form-group">
                                <label>Required CFM</label>
                                <input type="text" value="${room.cfm ? room.cfm + ' CFM' : ''}" readonly style="font-weight: 600; color: var(--accent-cyan);">
                            </div>
                            <div class="form-group">
                                <label>Recommended Duct Size</label>
                                <input type="text" value="${room.ductSize}" readonly style="font-weight: 600; color: var(--success);">
                            </div>
                            <div class="form-group">
                                <label>Register Size</label>
                                <input type="text" value="${room.registerSize || ''}" readonly>
                            </div>
                        </div>
                    </div>
                </div>`;
            });

            container.innerHTML = html;
            Utils.$('duct-totals').classList.remove('hidden');
            this.updateTotals();
            this.checkReadiness();
        },

        updateRoom(index, field, value) {
            State.ductDesignRooms[index][field] = value;
            this.displayRooms();
        },

        updateRoomDimension(index, field, value) {
            State.ductDesignRooms[index][field] = parseFloat(value);
            this.calculateRoomCFM(index);
        },

        calculateRoomCFM(index) {
            const room = State.ductDesignRooms[index];
            const { length, width, height } = room;

            if (!isNaN(length) && !isNaN(width) && !isNaN(height)) {
                const volume = length * width * height;
                const ach = 6;
                const cfm = Math.round((volume * ach) / 60);
                room.cfm = cfm;

                // Calculate duct size
                const area = (cfm * 144) / 700;
                const diameter = 2 * Math.sqrt(area / Math.PI);
                const standardDiameter = CONFIG.STANDARD_DUCT_SIZES.find(size => size >= diameter) || 
                    CONFIG.STANDARD_DUCT_SIZES[CONFIG.STANDARD_DUCT_SIZES.length - 1];
                room.ductSize = `${standardDiameter}" Round Flex`;

                // Determine register size
                if (cfm < 75) room.registerSize = '4x10';
                else if (cfm < 125) room.registerSize = '4x12 or 6x10';
                else if (cfm < 175) room.registerSize = '6x12';
                else if (cfm < 225) room.registerSize = '8x10';
                else room.registerSize = '8x12 or 10x10';

                this.displayRooms();
            }
        },

        updateTotals() {
            const systemCFM = parseFloat(Utils.$('system-cfm-display').textContent) || 0;
            const totalBranchCFM = State.ductDesignRooms.reduce((sum, room) => sum + (room.cfm || 0), 0);
            const balance = systemCFM > 0 ? ((totalBranchCFM / systemCFM) * 100).toFixed(1) : 0;

            Utils.$('total-branches-cfm').textContent = totalBranchCFM;
            Utils.$('cfm-balance').textContent = `${balance}%`;
            Utils.$('rooms-designed').textContent = State.ductDesignRooms.length;

            const balanceEl = Utils.$('cfm-balance');
            const numBalance = parseFloat(balance);
            
            if (numBalance >= 95 && numBalance <= 105) {
                balanceEl.style.color = 'var(--success)';
            } else if (numBalance >= 90 && numBalance <= 110) {
                balanceEl.style.color = 'var(--warning)';
            } else {
                balanceEl.style.color = 'var(--danger)';
            }
        },

        calculateTrunkSize() {
            const cfm = parseFloat(Utils.$('trunk-cfm').value);
            const velocity = parseFloat(Utils.$('trunk-velocity').value);

            if (!isNaN(cfm) && !isNaN(velocity)) {
                const area = (cfm * 144) / velocity;
                const diameter = 2 * Math.sqrt(area / Math.PI);
                const standardDiameter = CONFIG.STANDARD_TRUNK_SIZES.find(size => size >= diameter) || 
                    CONFIG.STANDARD_TRUNK_SIZES[CONFIG.STANDARD_TRUNK_SIZES.length - 1];
                Utils.$('trunk-size-result').value = `${standardDiameter}" Round Flex`;
            }
        },

        calculatePlenumMaterial() {
            const supplyL = parseFloat(Utils.$('supply-plenum-length').value) || 0;
            const supplyW = parseFloat(Utils.$('supply-plenum-width').value) || 0;
            const supplyH = parseFloat(Utils.$('supply-plenum-height').value) || 0;
            const returnL = parseFloat(Utils.$('return-plenum-length').value) || 0;
            const returnW = parseFloat(Utils.$('return-plenum-width').value) || 0;
            const returnH = parseFloat(Utils.$('return-plenum-height').value) || 0;

            const supplySF = 2 * ((supplyL * supplyW) + (supplyL * supplyH) + (supplyW * supplyH)) / 144;
            const returnSF = 2 * ((returnL * returnW) + (returnL * returnH) + (returnW * returnH)) / 144;
            const sheets = Math.ceil(((supplySF + returnSF) * 1.2) / 32);

            Utils.$('duct-board-sheets').textContent = sheets;
        },

        checkReadiness() {
            const tonnage = parseFloat(Utils.$('duct-tonnage').value);
            const hasRooms = State.ductDesignRooms.length > 0;
            const roomsComplete = State.ductDesignRooms.every(room => room.cfm > 0);
            Utils.$('generate-design-btn').disabled = !(tonnage && hasRooms && roomsComplete);
        },

        generate() {
            if (State.ductDesignRooms.length === 0) {
                UI.showToast('Add rooms before generating design', 'warning');
                return;
            }

            const projectName = Utils.$('duct-project-name').value || 'Untitled Project';
            const tonnage = parseFloat(Utils.$('duct-tonnage').value);
            const systemCFM = tonnage * CONFIG.CFM_PER_TON;
            const equipmentLocation = Utils.$('duct-equipment-location').value;
            const returnType = Utils.$('duct-return-type').value;
            const trunkSize = Utils.$('trunk-size-result').value;

            // Generate schematic
            let schematic = '<div class="duct-trunk">Main Supply Trunk</div>';
            schematic += `<div class="duct-branch">‚îú‚îÄ ${trunkSize} from plenum, ${systemCFM} CFM total</div>`;

            State.ductDesignRooms.forEach((room, index) => {
                const prefix = index === State.ductDesignRooms.length - 1 ? '‚îî‚îÄ' : '‚îú‚îÄ';
                schematic += `<div class="duct-branch">${prefix} ${room.name || 'Room ' + (index + 1)}: ${room.ductSize}, ${room.cfm} CFM, ${room.ductLength} ft${room.location ? ', ' + room.location : ''}</div>`;
            });

            schematic += '<br><div class="duct-trunk">Return Air System</div>';
            if (returnType === 'central') {
                const returnGrilleSize = systemCFM < 800 ? '14x14' : systemCFM < 1200 ? '16x20' : systemCFM < 1600 ? '20x20' : '24x24';
                schematic += `<div class="duct-branch">‚îî‚îÄ Central return: ${trunkSize}, ${systemCFM} CFM, ${returnGrilleSize} grille</div>`;
            } else {
                schematic += '<div class="duct-branch">‚îú‚îÄ Distributed returns in bedrooms and living spaces</div>';
                schematic += `<div class="duct-branch">‚îî‚îÄ Main return trunk: ${trunkSize}, ${systemCFM} CFM</div>`;
            }

            Utils.$('system-schematic').innerHTML = schematic;
            Utils.$('system-schematic-card').style.display = 'block';

            // Generate material takeoff
            this.generateMaterialTakeoff(systemCFM);

            State.currentDuctDesign = {
                projectName,
                tonnage,
                systemCFM,
                equipmentLocation,
                returnType,
                rooms: State.ductDesignRooms,
                schematic
            };

            UI.showToast('Professional duct design generated!', 'success');
            Utils.$('system-schematic-card').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        },

        generateMaterialTakeoff(systemCFM) {
            let html = '';

            // Flex duct
            const ductSizes = {};
            State.ductDesignRooms.forEach(room => {
                const size = room.ductSize.split('"')[0];
                if (!ductSizes[size]) ductSizes[size] = 0;
                ductSizes[size] += room.ductLength;
            });

            html += '<div class="card-section"><div class="section-title">Flexible Duct (Insulated R-6)</div><ul style="font-size: 13px; line-height: 1.8; color: var(--text-secondary);">';
            Object.keys(ductSizes).sort((a, b) => parseInt(a) - parseInt(b)).forEach(size => {
                const feet = ductSizes[size];
                const bags = Math.ceil((feet * 1.1) / 25);
                html += `<li><strong>${size}" diameter:</strong> ${feet} ft needed, order <strong>${bags} bags</strong> (25 ft each)</li>`;
            });
            html += '</ul></div>';

            // Starting collars
            const collarCounts = {};
            State.ductDesignRooms.forEach(room => {
                const size = room.ductSize.split('"')[0];
                if (!collarCounts[size]) collarCounts[size] = 0;
                collarCounts[size]++;
            });

            html += '<div class="card-section"><div class="section-title">Starting Collars</div><ul style="font-size: 13px; line-height: 1.8; color: var(--text-secondary);">';
            Object.keys(collarCounts).sort((a, b) => parseInt(a) - parseInt(b)).forEach(size => {
                html += `<li><strong>${size}" collar:</strong> ${collarCounts[size]} pieces</li>`;
            });
            html += '</ul></div>';

            // Plenums
            const sheets = Utils.$('duct-board-sheets').textContent;
            html += '<div class="card-section"><div class="section-title">Plenums (Custom Duct Board)</div>';
            html += '<ul style="font-size: 13px; line-height: 1.8; color: var(--text-secondary);">';
            html += `<li><strong>Supply Plenum:</strong> ${Utils.$('supply-plenum-length').value}√ó${Utils.$('supply-plenum-width').value}√ó${Utils.$('supply-plenum-height').value} inches</li>`;
            html += `<li><strong>Return Plenum:</strong> ${Utils.$('return-plenum-length').value}√ó${Utils.$('return-plenum-width').value}√ó${Utils.$('return-plenum-height').value} inches</li>`;
            html += `<li><strong>Duct Board:</strong> ${sheets} sheets (4√ó8 ft, 1.5" thick)</li>`;
            html += '</ul></div>';

            // Registers
            const registerSizes = {};
            State.ductDesignRooms.forEach(room => {
                const size = room.registerSize.split(' ')[0];
                if (!registerSizes[size]) registerSizes[size] = 0;
                registerSizes[size]++;
            });

            html += '<div class="card-section"><div class="section-title">Registers & Grilles</div><ul style="font-size: 13px; line-height: 1.8; color: var(--text-secondary);">';
            Object.keys(registerSizes).forEach(size => {
                html += `<li><strong>${size}</strong> supply register: ${registerSizes[size]} pieces</li>`;
            });
            const returnGrilleSize = systemCFM < 800 ? '14x14' : systemCFM < 1200 ? '16x20' : systemCFM < 1600 ? '20x20' : '24x24';
            html += `<li><strong>${returnGrilleSize}</strong> return grille: 1 piece</li>`;
            html += '</ul></div>';

            // Additional materials
            html += '<div class="card-section"><div class="section-title">Additional Materials</div><ul style="font-size: 13px; line-height: 1.8; color: var(--text-secondary);">';
            html += '<li>Mastic and mesh tape: 1 gallon + 1 roll</li>';
            html += '<li>Foil tape (3"): 2 rolls</li>';
            html += '<li>Adjustable duct straps: 2 boxes</li>';
            html += '</ul></div>';

            Utils.$('material-takeoff').innerHTML = html;
            Utils.$('material-takeoff-card').style.display = 'block';
        },

        save() {
            if (!State.currentDuctDesign) {
                UI.showToast('Generate design first', 'warning');
                return;
            }
            Storage.save(CONFIG.DUCT_DESIGN_KEY, {
                ...State.currentDuctDesign,
                timestamp: new Date().toISOString()
            });
            UI.showToast('Duct design saved!', 'success');
        },

        async clear() {
            const confirmed = await UI.showModal('Clear Duct Design', 'Are you sure you want to clear all rooms?');
            if (confirmed) {
                State.ductDesignRooms = [];
                State.currentDuctDesign = null;
                this.displayRooms();
                Utils.$('system-schematic-card').style.display = 'none';
                Utils.$('material-takeoff-card').style.display = 'none';
                Utils.$('duct-project-name').value = '';
                Utils.$('duct-tonnage').value = '';
                Utils.$('system-cfm-display').textContent = '0';
                UI.showToast('Duct design cleared');
            }
        }
    };

    // ==================== CFM CALCULATORS ====================
    const CFMCalculator = {
        byTonnage() {
            const tonnage = parseFloat(Utils.$('cfm-tonnage').value);
            const cfmPerTon = parseFloat(Utils.$('cfm-per-ton').value) || CONFIG.CFM_PER_TON;

            if (!isNaN(tonnage)) {
                const cfm = tonnage * cfmPerTon;
                Utils.$('cfm-result-tonnage').value = `${cfm.toFixed(0)} CFM`;
                Utils.$('duct-cfm').value = cfm.toFixed(0);
                this.calculateDuctSize();
            } else {
                Utils.$('cfm-result-tonnage').value = '';
            }
        },

        byTemp() {
            const btu = parseFloat(Utils.$('cfm-btu').value);
            const deltaT = parseFloat(Utils.$('cfm-delta-t').value);

            if (!isNaN(btu) && !isNaN(deltaT) && deltaT !== 0) {
                const cfm = btu / (1.08 * deltaT);
                Utils.$('cfm-result-temp').value = `${cfm.toFixed(0)} CFM`;
            } else {
                Utils.$('cfm-result-temp').value = '';
            }
        },

        byRoom() {
            const length = parseFloat(Utils.$('room-length').value);
            const width = parseFloat(Utils.$('room-width').value);
            const height = parseFloat(Utils.$('room-height').value);
            const ach = parseFloat(Utils.$('room-ach').value);

            if (!isNaN(length) && !isNaN(width) && !isNaN(height)) {
                const volume = length * width * height;
                Utils.$('room-volume').value = `${volume.toFixed(0)} cu ft`;

                if (!isNaN(ach)) {
                    const cfm = (volume * ach) / 60;
                    Utils.$('cfm-result-room').value = `${cfm.toFixed(0)} CFM`;
                }
            } else {
                Utils.$('room-volume').value = '';
                Utils.$('cfm-result-room').value = '';
            }
        },

        calculateDuctSize() {
            const cfm = parseFloat(Utils.$('duct-cfm').value);
            const velocity = parseFloat(Utils.$('duct-velocity').value);
            const ductType = Utils.$('duct-type').value;

            if (isNaN(cfm) || isNaN(velocity)) return;

            const area = (cfm * 144) / velocity;

            if (ductType === 'round') {
                this.calculateRoundDuct(cfm, velocity, area);
                Utils.$('round-duct-results').classList.remove('hidden');
                Utils.$('rectangular-duct-results').classList.add('hidden');
            } else {
                this.calculateRectangularDuct(cfm, velocity);
                Utils.$('round-duct-results').classList.add('hidden');
                Utils.$('rectangular-duct-results').classList.remove('hidden');
            }

            Charts.updateVelocity(cfm);
        },

        calculateRoundDuct(cfm, targetVelocity, area) {
            const diameter = 2 * Math.sqrt(area / Math.PI);
            let standardDiameter = CONFIG.STANDARD_DUCT_SIZES.find(size => size >= diameter);
            if (!standardDiameter) standardDiameter = CONFIG.STANDARD_DUCT_SIZES[CONFIG.STANDARD_DUCT_SIZES.length - 1];

            const standardArea = Math.PI * Math.pow(standardDiameter / 2, 2);
            const actualVelocity = (cfm * 144) / standardArea;

            Utils.$('round-diameter-calc').value = `${diameter.toFixed(2)}"`;
            Utils.$('round-diameter-standard').value = `${standardDiameter}"`;
            Utils.$('round-velocity-actual').value = `${actualVelocity.toFixed(0)} FPM`;
            Utils.$('round-area').value = `${standardArea.toFixed(1)} sq in`;
        },

        calculateRectangularDuct(cfm, targetVelocity) {
            const commonSizes = [
                [6, 8], [6, 10], [6, 12], [8, 10], [8, 12], [8, 14],
                [10, 12], [10, 14], [10, 16], [12, 14], [12, 16], [12, 18],
                [14, 16], [14, 18], [14, 20], [16, 18], [16, 20], [16, 24],
                [18, 24], [20, 24], [24, 24]
            ];

            const options = commonSizes.map(([width, height]) => {
                const ductArea = width * height;
                const velocity = (cfm * 144) / ductArea;
                return {
                    width, height,
                    area: ductArea,
                    velocity: velocity.toFixed(0),
                    suitable: velocity >= targetVelocity * 0.8 && velocity <= targetVelocity * 1.2
                };
            }).filter(opt => opt.velocity >= 400 && opt.velocity <= 1500)
              .sort((a, b) => Math.abs(parseFloat(a.velocity) - targetVelocity) - Math.abs(parseFloat(b.velocity) - targetVelocity));

            let html = '<div style="display: grid; gap: 12px;">';
            options.slice(0, 6).forEach(opt => {
                const badgeClass = opt.suitable ? 'badge-success' : 'badge-info';
                html += `<div class="selected-material">
                    <div class="selected-material-info">
                        <div class="material-name">${opt.width}" √ó ${opt.height}"</div>
                        <div class="material-spec">Area: ${opt.area} sq in</div>
                    </div>
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <span class="badge ${badgeClass}">${opt.velocity} FPM</span>
                        ${opt.suitable ? '<span style="color: var(--success); font-weight: 600;">‚úì Recommended</span>' : ''}
                    </div>
                </div>`;
            });
            html += '</div>';

            Utils.$('rectangular-options').innerHTML = html;
        }
    };

    // ==================== HISTORY ====================
    const History = {
        refresh() {
            State.savedReports = Storage.load(CONFIG.STORAGE_KEY) || [];
            const container = Utils.$('history-list');

            if (State.savedReports.length === 0) {
                container.innerHTML = '<div class="status-card info">‚ÑπÔ∏è No saved reports yet.</div>';
                this.updateStats([], 0, 0);
                return;
            }

            State.savedReports.sort((a, b) => b.timestamp.localeCompare(a.timestamp));

            let html = '';
            State.savedReports.forEach((report, index) => {
                const date = new Date(report.timestamp);
                const qualityClass = report.quality >= 80 ? 'success' : report.quality >= 60 ? 'info' : 'warning';

                html += `<div class="card mb-lg">
                    <div class="card-header">
                        <div class="card-title">${report.customer || 'Unnamed'} - ${report.date}</div>
                        <span class="badge badge-${qualityClass}">${report.quality}%</span>
                    </div>
                    <div class="card-body">
                        <p style="color: var(--text-secondary);"><strong>Type:</strong> ${report.callType} | <strong>Mode:</strong> ${report.systemMode}</p>
                        <p style="color: var(--text-secondary);"><strong>Photos:</strong> ${report.photos.length} | <strong>Saved:</strong> ${date.toLocaleString()}</p>
                        <div class="btn-group mt-lg">
                            <button class="btn btn-primary" onclick="loadReport(${index})">Load</button>
                            <button class="btn btn-danger" onclick="deleteReport(${index})">Delete</button>
                        </div>
                    </div>
                </div>`;
            });

            container.innerHTML = html;

            const thisMonth = State.savedReports.filter(r => {
                const d = new Date(r.timestamp);
                const now = new Date();
                return d.getMonth() === now.getMonth() && d.getFullYear() === now.getFullYear();
            });

            const avgQuality = State.savedReports.reduce((sum, r) => sum + r.quality, 0) / State.savedReports.length;
            const totalPhotos = State.savedReports.reduce((sum, r) => sum + r.photos.length, 0);

            this.updateStats(thisMonth, avgQuality, totalPhotos);
        },

        updateStats(thisMonth, avgQuality, totalPhotos) {
            Utils.$('stat-total').textContent = State.savedReports.length;
            Utils.$('stat-this-month').textContent = thisMonth.length || 0;
            Utils.$('stat-avg-quality').textContent = `${Math.round(avgQuality || 0)}%`;
            Utils.$('stat-photos').textContent = totalPhotos || 0;
        },

        load(index) {
            const report = State.savedReports[index];
            
            // Populate form fields
            Utils.$('customer-name').value = report.customer || '';
            Utils.$('service-date').value = report.date || '';
            Utils.$('service-address').value = report.data.address || '';
            Utils.$('customer-complaint').value = report.data.complaint || '';
            Utils.$('unit-type').value = report.data.unitType || '';
            Utils.$('indoor-unit').value = report.data.indoorUnit || '';
            Utils.$('outdoor-unit').value = report.data.outdoorUnit || '';
            Utils.$('tonnage').value = report.data.tonnage || '';
            Utils.$('refrigerant-type').value = report.data.refrigerant || 'R410A';
            Utils.$('filter-size').value = report.data.filterSize || '';
            Utils.$('metering-device').value = report.data.meteringDevice || '';
            Utils.$('seer-rating').value = report.data.seerRating || '';

            if (report.systemMode === 'cooling') {
                Utils.$('outdoor-ambient').value = report.data.outdoorAmbient || '';
                Utils.$('ambient-temp').value = report.data.ambientTemp || '';
                Utils.$('return-temp').value = report.data.returnTemp || '';
                Utils.$('supply-temp').value = report.data.supplyTemp || '';
                Utils.$('wet-bulb').value = report.data.wetBulb || '';
                Utils.$('suction-pressure').value = report.data.suctionPressure || '';
                Utils.$('suction-temp').value = report.data.suctionTemp || '';
                Utils.$('liquid-pressure').value = report.data.liquidPressure || '';
                Utils.$('liquid-temp').value = report.data.liquidTemp || '';
                Utils.$('static-pressure').value = report.data.staticPressure || '';
                Utils.$('voltage').value = report.data.voltage || '';
                Utils.$('amperage').value = report.data.amperage || '';
                Utils.$('rla-rating').value = report.data.rlaRating || '';
            } else {
                Utils.$('return-temp-heat').value = report.data.returnTempHeat || '';
                Utils.$('supply-temp-heat').value = report.data.supplyTempHeat || '';
                Utils.$('manifold-pressure').value = report.data.manifoldPressure || '';
                Utils.$('voltage-heat').value = report.data.voltageHeat || '';
                Utils.$('amperage-heat').value = report.data.amperageHeat || '';
                Utils.$('gas-type').value = report.data.gasType || 'natural';}

            Utils.$('findings').value = report.data.findings || '';
            Utils.$('recommendations').value = report.data.recommendations || '';
            Utils.$('work-performed').value = report.data.workPerformed || '';
            Utils.$('sig-name').value = report.data.sigName || '';
            Utils.$('sig-date').value = report.data.sigDate || '';

            State.customerSignature = report.data.signature;
            if (State.customerSignature && State.signaturePad) {
                const img = new Image();
                img.onload = () => State.signaturePad.fromDataURL(State.customerSignature);
                img.src = State.customerSignature;
            }

            State.photos = report.photos || [];
            Photos.display();

            ServiceCall.setCallType(report.callType);
            ServiceCall.setSystemMode(report.systemMode);
            Diagnostics.calculate();
            Quality.calculate();

            Navigation.switchPage('service');
            UI.showToast('Report loaded successfully!', 'success');
        },

        async delete(index) {
            const confirmed = await UI.showModal('Delete Report', 'Are you sure? This cannot be undone.');
            if (!confirmed) return;

            State.savedReports.splice(index, 1);
            Storage.save(CONFIG.STORAGE_KEY, State.savedReports);
            this.refresh();
            UI.showToast('Report deleted', 'success');
        }
    };

    // ==================== DATA PERSISTENCE ====================
    const DataManager = {
        save() {
            const report = {
                id: Utils.generateId(),
                timestamp: new Date().toISOString(),
                customer: Utils.$('customer-name').value,
                date: Utils.$('service-date').value,
                callType: State.callType,
                systemMode: State.systemMode,
                data: {
                    address: Utils.$('service-address').value,
                    complaint: Utils.$('customer-complaint').value,
                    unitType: Utils.$('unit-type').value,
                    indoorUnit: Utils.$('indoor-unit').value,
                    outdoorUnit: Utils.$('outdoor-unit').value,
                    tonnage: Utils.$('tonnage').value,
                    refrigerant: Utils.$('refrigerant-type').value,
                    filterSize: Utils.$('filter-size').value,
                    meteringDevice: Utils.$('metering-device').value,
                    seerRating: Utils.$('seer-rating').value,
                    outdoorAmbient: Utils.$('outdoor-ambient').value,
                    ambientTemp: Utils.$('ambient-temp').value,
                    returnTemp: Utils.$('return-temp').value,
                    supplyTemp: Utils.$('supply-temp').value,
                    deltaT: Utils.$('delta-t').value,
                    wetBulb: Utils.$('wet-bulb').value,
                    suctionPressure: Utils.$('suction-pressure').value,
                    suctionTemp: Utils.$('suction-temp').value,
                    superheat: Utils.$('superheat').value,
                    liquidPressure: Utils.$('liquid-pressure').value,
                    liquidTemp: Utils.$('liquid-temp').value,
                    subcool: Utils.$('subcool').value,
                    staticPressure: Utils.$('static-pressure').value,
                    voltage: Utils.$('voltage').value,
                    amperage: Utils.$('amperage').value,
                    rlaRating: Utils.$('rla-rating').value,
                    returnTempHeat: Utils.$('return-temp-heat').value,
                    supplyTempHeat: Utils.$('supply-temp-heat').value,
                    tempRise: Utils.$('temp-rise').value,
                    manifoldPressure: Utils.$('manifold-pressure').value,
                    voltageHeat: Utils.$('voltage-heat').value,
                    amperageHeat: Utils.$('amperage-heat').value,
                    gasType: Utils.$('gas-type').value,
                    findings: Utils.$('findings').value,
                    recommendations: Utils.$('recommendations').value,
                    workPerformed: Utils.$('work-performed').value,
                    sigName: Utils.$('sig-name').value,
                    sigDate: Utils.$('sig-date').value,
                    signature: State.customerSignature,
                    techName: Utils.$('tech-name').value,
                    techPhone: Utils.$('tech-phone').value,
                    techEmail: Utils.$('tech-email').value
                },
                photos: State.photos,
                diagnostics: State.diagnosticResults,
                quality: parseInt(Utils.$('quality-score-large').textContent)
            };

            State.savedReports.push(report);
            Storage.save(CONFIG.STORAGE_KEY, State.savedReports);
            UI.showToast('Progress saved successfully!', 'success');
        },

        load() {
            const stored = Storage.load(CONFIG.STORAGE_KEY);
            if (stored) {
                State.savedReports = stored;
                UI.showToast(`Loaded ${stored.length} saved report(s)`, 'info');
                Navigation.switchPage('history');
            } else {
                UI.showToast('No saved data found', 'warning');
            }
        },

        exportAll() {
            if (State.savedReports.length === 0) {
                UI.showToast('No data to export', 'warning');
                return;
            }

            const dataStr = JSON.stringify(State.savedReports, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `field-buddy-export-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            URL.revokeObjectURL(url);
            UI.showToast('Data exported successfully!', 'success');
        }
    };

    // ==================== REPORT GENERATION ====================
    const ReportGenerator = {
        generateText() {
            const customer = Utils.$('customer-name').value || 'N/A';
            const date = Utils.$('service-date').value || new Date().toISOString().split('T')[0];
            const address = Utils.$('service-address').value || 'N/A';
            const complaint = Utils.$('customer-complaint').value || 'N/A';
            const tech = Utils.$('tech-name').value;
            const techPhone = Utils.$('tech-phone').value;
            const techEmail = Utils.$('tech-email').value;

            let report = `‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
‚ïë       FIELD BUDDY PRO - SERVICE REPORT v4.0 PREMIUM        ‚ïë
‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù

JOB INFORMATION
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
Customer: ${customer}
Date: ${date}
Address: ${address}
Call Type: ${State.callType === 'trouble' ? 'Trouble Call' : 'Maintenance'}
System Mode: ${State.systemMode === 'cooling' ? 'Cooling' : 'Heating'}

Customer Complaint:
${complaint}

EQUIPMENT INFORMATION
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
Unit Type: ${Utils.$('unit-type').value || 'N/A'}
Indoor Unit: ${Utils.$('indoor-unit').value || 'N/A'}
Outdoor Unit: ${Utils.$('outdoor-unit').value || 'N/A'}
Tonnage: ${Utils.$('tonnage').value || 'N/A'} Ton
Refrigerant: ${Utils.$('refrigerant-type').value}
Filter Size: ${Utils.$('filter-size').value || 'N/A'}
Metering Device: ${Utils.$('metering-device').value || 'Not Specified'}
SEER Rating: ${Utils.$('seer-rating').value || 'N/A'}

`;

            if (State.systemMode === 'cooling') {
                report += `COOLING MEASUREMENTS
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
Outdoor Ambient: ${Utils.$('outdoor-ambient').value || 'N/A'}¬∞F
Indoor Ambient: ${Utils.$('ambient-temp').value || 'N/A'}¬∞F
Return Air Temp: ${Utils.$('return-temp').value || 'N/A'}¬∞F
Supply Air Temp: ${Utils.$('supply-temp').value || 'N/A'}¬∞F
Delta-T: ${Utils.$('delta-t').value || 'N/A'}
Wet Bulb: ${Utils.$('wet-bulb').value || 'N/A'}¬∞F

Suction Pressure: ${Utils.$('suction-pressure').value || 'N/A'} PSI
Suction Line Temp: ${Utils.$('suction-temp').value || 'N/A'}¬∞F
Superheat: ${Utils.$('superheat').value || 'N/A'}

Liquid Pressure: ${Utils.$('liquid-pressure').value || 'N/A'} PSI
Liquid Line Temp: ${Utils.$('liquid-temp').value || 'N/A'}¬∞F
Subcool: ${Utils.$('subcool').value || 'N/A'}

Static Pressure: ${Utils.$('static-pressure').value || 'N/A'} in w.c.
Supply Voltage: ${Utils.$('voltage').value || 'N/A'} V
Compressor Amperage: ${Utils.$('amperage').value || 'N/A'} A
RLA Rating: ${Utils.$('rla-rating').value || 'N/A'} A

`;
            } else {
                report += `HEATING MEASUREMENTS
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
Return Air Temp: ${Utils.$('return-temp-heat').value || 'N/A'}¬∞F
Supply Air Temp: ${Utils.$('supply-temp-heat').value || 'N/A'}¬∞F
Temperature Rise: ${Utils.$('temp-rise').value || 'N/A'}

Gas Type: ${Utils.$('gas-type').value === 'natural' ? 'Natural Gas' : 'LP/Propane'}
Manifold Pressure: ${Utils.$('manifold-pressure').value || 'N/A'} in w.c.
Supply Voltage: ${Utils.$('voltage-heat').value || 'N/A'} V
Amperage: ${Utils.$('amperage-heat').value || 'N/A'} A

`;
            }

            if (State.diagnosticResults.length > 0) {
                report += `DIAGNOSTIC ANALYSIS
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
`;
                State.diagnosticResults.forEach(result => {
                    report += `${result.title}\nSeverity: ${result.severity.toUpperCase()}\n${result.message}\n`;
                    if (result.recommendations && result.recommendations.length > 0) {
                        report += 'Recommended Actions:\n';
                        result.recommendations.forEach(rec => {
                            report += `  ‚Ä¢ ${rec}\n`;
                        });
                    }
                    report += '\n';
                });
            }

            report += `FINDINGS & RECOMMENDATIONS
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
Findings:
${Utils.$('findings').value || 'N/A'}

Recommendations:
${Utils.$('recommendations').value || 'N/A'}

Work Performed:
${Utils.$('work-performed').value || 'N/A'}

`;

            if (State.photos.length > 0) {
                report += `JOB PHOTOS
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
${State.photos.length} photo(s) attached

`;
            }

            if (State.customerSignature) {
                report += `CUSTOMER SIGNATURE
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
Customer: ${Utils.$('sig-name').value || 'N/A'}
Date: ${Utils.$('sig-date').value || date}
[Digital signature on file]

`;
            }

            report += `TECHNICIAN INFORMATION
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
Technician: ${tech}
Phone: ${techPhone}
Email: ${techEmail}

Generated: ${new Date().toLocaleString()}
Quality Score: ${Utils.$('quality-score-large').textContent}

‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
Field Buddy Pro v4.0 Premium - Professional HVAC Service
`;

            this.displayTextReport(report);
            UI.showToast('Text report generated!');
        },

        displayTextReport(text) {
            const container = Utils.$('report-container');
            container.innerHTML = `<div class="card mt-lg">
                <div class="card-header"><div class="card-title">üìÑ Generated Report</div></div>
                <div class="card-body">
                    <div class="status-card success">‚úì Report ready to copy or print</div>
                    <pre style="background:var(--bg-elevated);padding:15px;border-radius:var(--radius-lg);overflow-x:auto;font-size:11px;line-height:1.4;font-family:monospace;color:var(--text-secondary);border:1px solid var(--glass-border);">${text}</pre>
                    <div class="btn-group mt-lg">
                        <button class="btn btn-primary" onclick="copyToClipboard()">üìã Copy to Clipboard</button>
                        <button class="btn btn-secondary" onclick="printReport()">üñ®Ô∏è Print</button>
                    </div>
                </div>
            </div>`;
            container.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        },

        copyToClipboard() {
            const text = document.querySelector('pre').textContent;
            navigator.clipboard.writeText(text).then(() => {
                UI.showToast('‚úì Copied to clipboard!');
            }).catch(() => {
                UI.showToast('Failed to copy', 'danger');
            });
        },

        print() {
            const text = document.querySelector('pre').textContent;
            const w = window.open('', '_blank');
            w.document.write(`<html><head><title>Service Report</title><style>body{font-family:monospace;font-size:12px;line-height:1.4;margin:0.5in;white-space:pre-wrap;}</style></head><body>${text}</body></html>`);
            w.document.close();
            setTimeout(() => {
                w.print();
                w.close();
            }, 250);
        },

        generatePDF() {
            try {
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF();

                pdf.setFontSize(16);
                pdf.setFont(undefined, 'bold');
                pdf.text('Village Plumbing - Service Report', 105, 20, { align: 'center' });

                pdf.setFontSize(10);
                pdf.setFont(undefined, 'normal');
                pdf.text('Field Buddy Pro v4.0 Premium Edition', 105, 27, { align: 'center' });

                this.generateText();
                const textReport = document.querySelector('pre').textContent;

                pdf.setFontSize(8);
                const lines = pdf.splitTextToSize(textReport, 180);
                let y = 35;

                lines.forEach(line => {
                    if (y > 280) {
                        pdf.addPage();
                        y = 20;
                    }
                    pdf.text(line, 15, y);
                    y += 4;
                });

                if (State.photos.length > 0) {
                    pdf.addPage();
                    pdf.setFontSize(12);
                    pdf.setFont(undefined, 'bold');
                    pdf.text('Job Photos', 105, 20, { align: 'center' });

                    let pY = 30, pX = 15;
                    State.photos.forEach((photo, i) => {
                        if (pY > 200) {
                            pdf.addPage();
                            pY = 20;
                        }
                        try {
                            pdf.addImage(photo.data, 'JPEG', pX, pY, 80, 60);
                        } catch (e) {
                            console.error('Error adding photo:', e);
                        }
                        pX = (i % 2 === 0) ? 115 : 15;
                        if (i % 2 === 1) pY += 75;
                    });
                }

                if (State.customerSignature) {
                    pdf.addPage();
                    pdf.setFontSize(12);
                    pdf.setFont(undefined, 'bold');
                    pdf.text('Customer Signature', 105, 20, { align: 'center' });
                    pdf.addImage(State.customerSignature, 'PNG', 40, 30, 130, 50);
                }

                pdf.save(`service-report-${new Date().toISOString().split('T')[0]}.pdf`);
                UI.showToast('PDF generated successfully!');
            } catch (e) {
                console.error('PDF generation error:', e);
                UI.showToast('Error generating PDF', 'danger');
            }
        },

        generateMaterialsList() {
            const customer = Utils.$('mat-customer').value || 'N/A';
            const date = Utils.$('mat-date').value || new Date().toISOString().split('T')[0];
            const address = Utils.$('mat-address').value || 'N/A';
            const notes = Utils.$('mat-notes').value || 'N/A';
            const tech = Utils.$('mat-tech-name').value;

            let report = `‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
‚ïë       FIELD BUDDY PRO - MATERIALS LIST v4.0 PREMIUM        ‚ïë
‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù

JOB INFORMATION
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
Customer/Job: ${customer}
Date: ${date}
Address: ${address}
Notes: ${notes}

MATERIALS NEEDED
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
`;

            if (State.selectedMaterials.length === 0) {
                report += 'No materials added to list.\n\n';
            } else {
                const grouped = {};
                State.selectedMaterials.forEach(item => {
                    if (!grouped[item.catName]) grouped[item.catName] = [];
                    grouped[item.catName].push(item);
                });

                Object.keys(grouped).forEach(category => {
                    report += `${category}:\n${'‚îÄ'.repeat(60)}\n`;
                    grouped[category].forEach(item => {
                        report += `‚òê ${item.name}\n   Spec: ${item.spec}\n   Quantity: ${item.quantity} ${item.unit}\n\n`;
                    });
                    report += '\n';
                });

                const totalQty = State.selectedMaterials.reduce((sum, m) => sum + m.quantity, 0);
                report += `${'‚ïê'.repeat(60)}\nTOTAL ITEMS: ${totalQty}\nTOTAL LINE ITEMS: ${State.selectedMaterials.length}\n${'‚ïê'.repeat(60)}\n`;
            }

            report += `
TECHNICIAN: ${tech}
Generated: ${new Date().toLocaleString()}
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
Field Buddy Pro v4.0 Premium
`;

            const container = Utils.$('report-container-mat');
            container.innerHTML = `<div class="card mt-lg">
                <div class="card-header"><div class="card-title">üìÑ Materials List Generated</div></div>
                <div class="card-body">
                    <div class="status-card success">‚úì List ready to copy or print</div>
                    <pre style="background:var(--bg-elevated);padding:15px;border-radius:var(--radius-lg);overflow-x:auto;font-size:11px;line-height:1.4;font-family:monospace;color:var(--text-secondary);border:1px solid var(--glass-border);">${report}</pre>
                    <div class="btn-group mt-lg">
                        <button class="btn btn-primary" onclick="copyToClipboard()">üìã Copy</button>
                        <button class="btn btn-secondary" onclick="printReport()">üñ®Ô∏è Print</button>
                    </div>
                </div>
            </div>`;
            container.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            UI.showToast('Materials list generated!');
        }
    };

    // ==================== FORM MANAGEMENT ====================
    const FormManager = {
        async clear() {
            const confirmed = await UI.showModal('Clear Form', 'Are you sure you want to clear all data?');
            if (!confirmed) return;

            document.querySelectorAll('input, select, textarea').forEach(el => {
                if (el.type === 'checkbox') {
                    el.checked = false;
                    const item = el.closest('.checklist-item');
                    if (item) item.classList.remove('checked');
                } else if (el.id.includes('tech-') || el.id.includes('mat-tech-')) {
                    // Keep tech info
                } else if (el.type === 'date') {
                    el.value = new Date().toISOString().split('T')[0];
                } else {
                    el.value = '';
                }
            });

            State.photos = [];
            State.selectedMaterials = [];
            State.customerSignature = null;
            State.diagnosticResults = [];

            Photos.display();
            Materials.displaySelected();
            if (State.signaturePad) State.signaturePad.clear();

            Utils.$('diagnostic-results').classList.add('hidden');
            Utils.$('report-container').innerHTML = '';
            Utils.$('report-container-mat').innerHTML = '';

            Object.keys(Materials.catalog).forEach(catKey => {
                Materials.updateCategoryCount(catKey);
            });

            Quality.calculate();
            UI.showToast('Form cleared successfully');
        }
    };

    // ==================== GLOBAL EVENT HANDLERS ====================
    // Map internal functions to global scope for HTML onclick handlers
    window.switchPage = (page) => Navigation.switchPage(page);
    window.toggleMobileMenu = () => Navigation.toggleMobileMenu();
    window.setCallType = (type) => ServiceCall.setCallType(type);
    window.setSystemMode = (mode) => ServiceCall.setSystemMode(mode);
    window.updateUnitFields = () => ServiceCall.updateUnitFields();
    window.updateCheckbox = (cb) => ServiceCall.updateCheckbox(cb);
    window.calculateDiagnostics = () => Diagnostics.calculate();
    window.calculateQuality = () => Quality.calculate();
    window.handlePhotos = (e) => Photos.handle(e);
    window.viewPhoto = (i) => Photos.view(i);
    window.deletePhoto = (i) => Photos.delete(i);
    window.clearSignature = () => Signature.clear();
    window.saveSignature = () => Signature.save();
    window.expandAllCategories = () => Materials.expandAll();
    window.collapseAllCategories = () => Materials.collapseAll();
    window.filterMaterials = () => Materials.filter();
    window.toggleCategory = (key) => Materials.toggleCategory(key);
    window.toggleMaterial = (cat, id) => Materials.toggle(cat, id);
    window.removeMaterial = (i) => Materials.remove(i);
    window.calculateSystemCFM = () => DuctDesign.calculateSystemCFM();
    window.addDuctRoom = () => DuctDesign.addRoom();
    window.removeDuctRoom = (i) => DuctDesign.removeRoom(i);
    window.updateDuctRoom = (i, f, v) => DuctDesign.updateRoom(i, f, v);
    window.updateDuctRoomDimension = (i, f, v) => DuctDesign.updateRoomDimension(i, f, v);
    window.calculateTrunkSize = () => DuctDesign.calculateTrunkSize();
    window.calculatePlenumMaterial = () => DuctDesign.calculatePlenumMaterial();
    window.generateDuctDesign = () => DuctDesign.generate();
    window.saveDuctDesign = () => DuctDesign.save();
    window.clearDuctDesignForm = () => DuctDesign.clear();
    window.exportDuctDesign = () => DuctDesign.generate();
    window.calculateCFMByTonnage = () => CFMCalculator.byTonnage();
    window.calculateCFMByTemp = () => CFMCalculator.byTemp();
    window.calculateCFMByRoom = () => CFMCalculator.byRoom();
    window.calculateDuctSize = () => CFMCalculator.calculateDuctSize();
    window.refreshHistory = () => History.refresh();
    window.loadReport = (i) => History.load(i);
    window.deleteReport = (i) => History.delete(i);
    window.saveData = () => DataManager.save();
    window.loadData = () => DataManager.load();
    window.exportAllData = () => DataManager.exportAll();
    window.generateTextReport = () => ReportGenerator.generateText();
    window.generatePDF = () => ReportGenerator.generatePDF();
    window.generateMaterialsReport = () => ReportGenerator.generateMaterialsList();
    window.generateMaterialsPDF = () => ReportGenerator.generatePDF();
    window.copyToClipboard = () => ReportGenerator.copyToClipboard();
    window.printReport = () => ReportGenerator.print();
    window.clearForm = () => FormManager.clear();
    window.closeModal = (result) => UI.closeModal(result);

    // ==================== INITIALIZATION ====================
    window.addEventListener('load', () => {
        // Set default dates
        const today = new Date().toISOString().split('T')[0];
        ['service-date', 'sig-date', 'mat-date', 'duct-project-date'].forEach(id => {
            const el = Utils.$(id);
            if (el) el.value = today;
        });

        // Initialize components
        Signature.init();
        Materials.init();
        Quality.calculate();
        DuctDesign.displayRooms();
        Dashboard.updateStats();

        // Load saved reports
        State.savedReports = Storage.load(CONFIG.STORAGE_KEY) || [];

        // Console branding
        console.log('%cüîß Field Buddy Pro v4.0 Premium', 'color: #00D9FF; font-size: 20px; font-weight: bold;');
        console.log('%c‚ú® Optimized JavaScript Architecture', 'color: #10B981; font-size: 14px;');

        UI.showToast('Field Buddy Pro v4.0 Premium Ready!', 'success');
    });

})();
</script>

</body>

</html>