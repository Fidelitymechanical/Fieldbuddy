<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <meta name="description" content="Field Buddy Pro v4.0 - Premium Complete HVAC Field Service Management">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <title>Field Buddy Pro v4.0 - Premium Complete</title>
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.1.7/dist/signature_pad.umd.min.js"></script>
  
  <style>
    :root {
      --bg-primary: #0A0E1A;
      --bg-secondary: #121827;
      --bg-tertiary: #1A2035;
      --bg-elevated: #222B42;
      --bg-hover: #2A3550;
      --accent-primary: #00E5FF;
      --accent-primary-dark: #00B8CC;
      --accent-primary-glow: rgba(0, 229, 255, 0.4);
      --accent-secondary: #FF5722;
      --accent-secondary-dark: #E64A19;
      --accent-purple: #B565F7;
      --accent-gold: #FFD700;
      --success: #10B981;
      --success-glow: rgba(16, 185, 129, 0.3);
      --warning: #F59E0B;
      --warning-glow: rgba(245, 158, 11, 0.3);
      --danger: #EF4444;
      --danger-glow: rgba(239, 68, 68, 0.3);
      --info: #3B82F6;
      --info-glow: rgba(59, 130, 246, 0.3);
      --text-primary: #FFFFFF;
      --text-secondary: #CBD5E1;
      --text-tertiary: #94A3B8;
      --text-disabled: #64748B;
      --glass-bg: rgba(26, 32, 53, 0.75);
      --glass-border: rgba(255, 255, 255, 0.08);
      --glass-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.5);
      --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.4);
      --shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      --shadow-md: 0 6px 20px rgba(0, 0, 0, 0.4);
      --shadow-lg: 0 12px 32px rgba(0, 0, 0, 0.5);
      --shadow-xl: 0 20px 40px rgba(0, 0, 0, 0.6);
      --gradient-primary: linear-gradient(135deg, #00E5FF 0%, #00B8CC 100%);
      --gradient-secondary: linear-gradient(135deg, #FF5722 0%, #E64A19 100%);
      --gradient-purple: linear-gradient(135deg, #B565F7 0%, #9333EA 100%);
      --gradient-gold: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
      --gradient-dark: linear-gradient(135deg, #1A2035 0%, #0A0E1A 100%);
      --spacing-xs: 4px;
      --spacing-sm: 8px;
      --spacing-md: 12px;
      --spacing-lg: 16px;
      --spacing-xl: 24px;
      --spacing-2xl: 32px;
      --spacing-3xl: 48px;
      --transition-fast: 0.15s cubic-bezier(0.4, 0, 0.2, 1);
      --transition: 0.25s cubic-bezier(0.4, 0, 0.2, 1);
      --transition-slow: 0.35s cubic-bezier(0.4, 0, 0.2, 1);
      --radius-sm: 8px;
      --radius: 12px;
      --radius-lg: 16px;
      --radius-xl: 24px;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      font-size: 14px;
      line-height: 1.6;
      overflow-x: hidden;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }
    ::-webkit-scrollbar { width: 10px; height: 10px; }
    ::-webkit-scrollbar-track { background: var(--bg-secondary); border-radius: 5px; }
    ::-webkit-scrollbar-thumb { background: var(--bg-elevated); border-radius: 5px; border: 2px solid var(--bg-secondary); transition: var(--transition); }
    ::-webkit-scrollbar-thumb:hover { background: var(--accent-primary); box-shadow: 0 0 10px var(--accent-primary-glow); }
    .app-container { display: flex; min-height: 100vh; }
    .sidebar {
      width: 280px;
      background: var(--bg-secondary);
      border-right: 1px solid var(--glass-border);
      height: 100vh;
      position: fixed;
      left: 0;
      top: 0;
      overflow-y: auto;
      z-index: 100;
      transition: transform var(--transition-slow);
      backdrop-filter: blur(20px);
    }
    .sidebar-header { padding: var(--spacing-2xl); border-bottom: 1px solid var(--glass-border); background: var(--gradient-dark); }
    .sidebar-logo { display: flex; align-items: center; gap: var(--spacing-lg); }
    .sidebar-logo-icon {
      width: 52px;
      height: 52px;
      background: var(--gradient-primary);
      border-radius: var(--radius-lg);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 26px;
      box-shadow: 0 0 24px var(--accent-primary-glow);
      animation: pulse-glow 3s ease-in-out infinite;
    }
    @keyframes pulse-glow {
      0%, 100% { box-shadow: 0 0 20px var(--accent-primary-glow); transform: scale(1); }
      50% { box-shadow: 0 0 30px var(--accent-primary-glow), 0 0 40px var(--accent-primary-glow); transform: scale(1.02); }
    }
    .sidebar-logo-text { flex: 1; }
    .sidebar-title {
      font-size: 19px;
      font-weight: 700;
      background: var(--gradient-primary);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      letter-spacing: -0.5px;
    }
    .sidebar-version {
      font-size: 10px;
      color: var(--text-tertiary);
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 1.2px;
      margin-top: 2px;
    }
    .sidebar-nav { padding: var(--spacing-xl) 0; }
    .nav-section { margin-bottom: var(--spacing-xl); }
    .nav-section-title {
      padding: var(--spacing-sm) var(--spacing-xl);
      font-size: 10px;
      font-weight: 700;
      color: var(--text-tertiary);
      text-transform: uppercase;
      letter-spacing: 1.5px;
    }
    .nav-item {
      display: flex;
      align-items: center;
      gap: var(--spacing-md);
      padding: var(--spacing-md) var(--spacing-xl);
      color: var(--text-secondary);
      cursor: pointer;
      transition: var(--transition);
      border-left: 3px solid transparent;
      font-size: 14px;
      font-weight: 500;
      position: relative;
      overflow: hidden;
      margin: 2px 0;
    }
    .nav-item::before {
      content: '';
      position: absolute;
      left: 0;
      top: 0;
      height: 100%;
      width: 0;
      background: var(--gradient-primary);
      opacity: 0.08;
      transition: var(--transition);
    }
    .nav-item:hover {
      color: var(--accent-primary);
      background: rgba(0, 229, 255, 0.06);
      padding-left: calc(var(--spacing-xl) + 4px);
    }
    .nav-item:hover::before { width: 100%; }
    .nav-item.active {
      color: var(--accent-primary);
      background: rgba(0, 229, 255, 0.12);
      border-left-color: var(--accent-primary);
      box-shadow: inset 0 0 20px rgba(0, 229, 255, 0.15);
      padding-left: calc(var(--spacing-xl) + 4px);
    }
    .nav-icon { font-size: 20px; width: 28px; text-align: center; filter: drop-shadow(0 0 8px currentColor); }
    .main-content { margin-left: 280px; flex: 1; min-height: 100vh; background: var(--bg-primary); }
    .top-header {
      background: var(--glass-bg);
      backdrop-filter: blur(20px);
      border-bottom: 1px solid var(--glass-border);
      padding: 0 var(--spacing-2xl);
      height: 76px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      position: sticky;
      top: 0;
      z-index: 50;
      box-shadow: var(--shadow);
    }
    .header-left { display: flex; align-items: center; gap: var(--spacing-lg); }
    .menu-toggle {
      display: none;
      width: 44px;
      height: 44px;
      background: var(--bg-elevated);
      border: 1px solid var(--glass-border);
      border-radius: var(--radius);
      cursor: pointer;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      color: var(--text-primary);
      transition: var(--transition);
    }
    .menu-toggle:hover {
      background: var(--accent-primary);
      border-color: var(--accent-primary);
      box-shadow: 0 0 20px var(--accent-primary-glow);
      transform: scale(1.05);
    }
    .header-title {
      font-size: 26px;
      font-weight: 700;
      background: var(--gradient-primary);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      letter-spacing: -0.5px;
    }
    .header-actions { display: flex; align-items: center; gap: var(--spacing-lg); }
    .header-user {
      display: flex;
      align-items: center;
      gap: var(--spacing-md);
      padding: var(--spacing-sm) var(--spacing-lg);
      background: var(--bg-elevated);
      border: 1px solid var(--glass-border);
      border-radius: var(--radius-lg);
      font-size: 14px;
      font-weight: 500;
      transition: var(--transition);
      cursor: pointer;
    }
    .header-user:hover {
      background: var(--bg-hover);
      border-color: var(--accent-primary);
      box-shadow: 0 0 20px rgba(0, 229, 255, 0.2);
      transform: translateY(-1px);
    }
    .user-avatar {
      width: 42px;
      height: 42px;
      background: var(--gradient-primary);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 700;
      font-size: 15px;
      box-shadow: 0 0 20px var(--accent-primary-glow);
    }
    .workspace { padding: var(--spacing-2xl); max-width: 1600px; margin: 0 auto; }
    .dashboard-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
      gap: var(--spacing-xl);
      margin-bottom: var(--spacing-3xl);
    }
    .dashboard-tile {
      background: var(--glass-bg);
      backdrop-filter: blur(20px);
      border: 1px solid var(--glass-border);
      border-radius: var(--radius-xl);
      padding: var(--spacing-2xl);
      cursor: pointer;
      transition: var(--transition-slow);
      position: relative;
      overflow: hidden;
      min-height: 200px;
      display: flex;
      flex-direction: column;
      box-shadow: var(--shadow);
    }
    .dashboard-tile::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: var(--gradient-primary);
      opacity: 0;
      transition: var(--transition);
    }
    .dashboard-tile:hover {
      transform: translateY(-10px);
      box-shadow: var(--shadow-xl), 0 0 40px rgba(0, 229, 255, 0.3);
      border-color: var(--accent-primary);
    }
    .dashboard-tile:hover::before { opacity: 1; }
    .tile-header { display: flex; align-items: flex-start; justify-content: space-between; margin-bottom: var(--spacing-lg); }
    .tile-icon {
      width: 60px;
      height: 60px;
      border-radius: var(--radius-lg);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 30px;
      background: var(--gradient-primary);
      box-shadow: 0 0 24px var(--accent-primary-glow);
      animation: float 4s ease-in-out infinite;
    }
    @keyframes float {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-12px); }
    }
    .tile-icon.orange { background: var(--gradient-secondary); box-shadow: 0 0 24px rgba(255, 87, 34, 0.5); }
    .tile-icon.purple { background: var(--gradient-purple); box-shadow: 0 0 24px rgba(181, 101, 247, 0.5); }
    .tile-icon.gold { background: var(--gradient-gold); box-shadow: 0 0 24px rgba(255, 215, 0, 0.5); }
    .tile-badge {
      padding: 5px 14px;
      border-radius: 20px;
      font-size: 10px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.8px;
      background: var(--gradient-primary);
      color: white;
      box-shadow: 0 0 12px var(--accent-primary-glow);
    }
    .tile-badge.pro { background: var(--gradient-secondary); box-shadow: 0 0 12px rgba(255, 87, 34, 0.5); }
    .tile-badge.premium { background: var(--gradient-purple); box-shadow: 0 0 12px rgba(181, 101, 247, 0.5); }
    .tile-content { flex: 1; }
    .tile-title {
      font-size: 21px;
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: var(--spacing-sm);
      letter-spacing: -0.3px;
    }
    .tile-description { font-size: 14px; color: var(--text-secondary); line-height: 1.6; }
    .tile-stats {
      display: flex;
      gap: var(--spacing-lg);
      margin-top: var(--spacing-lg);
      padding-top: var(--spacing-lg);
      border-top: 1px solid var(--glass-border);
    }
    .tile-stat { flex: 1; }
    .tile-stat-value { font-size: 19px; font-weight: 700; color: var(--accent-primary); display: block; }
    .tile-stat-label {
      font-size: 11px;
      color: var(--text-tertiary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .card {
      background: var(--glass-bg);
      backdrop-filter: blur(20px);
      border: 1px solid var(--glass-border);
      border-radius: var(--radius-xl);
      margin-bottom: var(--spacing-xl);
      box-shadow: var(--shadow);
      overflow: hidden;
      transition: var(--transition);
    }
    .card:hover { box-shadow: var(--shadow-lg); border-color: rgba(0, 229, 255, 0.3); }
    .card-header {
      padding: var(--spacing-xl);
      border-bottom: 1px solid var(--glass-border);
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: rgba(0, 0, 0, 0.2);
    }
    .card-title {
      font-size: 18px;
      font-weight: 700;
      color: var(--text-primary);
      display: flex;
      align-items: center;
      gap: var(--spacing-sm);
    }
    .card-body { padding: var(--spacing-xl); }
    .card-section { margin-bottom: var(--spacing-xl); }
    .card-section:last-child { margin-bottom: 0; }
    .section-title {
      font-size: 14px;
      font-weight: 700;
      color: var(--accent-primary);
      margin-bottom: var(--spacing-md);
      text-transform: uppercase;
      letter-spacing: 0.8px;
      display: flex;
      align-items: center;
      gap: var(--spacing-sm);
    }
    .section-title::before {
      content: '';
      width: 4px;
      height: 18px;
      background: var(--gradient-primary);
      border-radius: 2px;
      box-shadow: 0 0 10px var(--accent-primary-glow);
    }
    .form-grid { display: grid; gap: var(--spacing-lg); }
    .form-grid-2 { grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); }
    .form-grid-3 { grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); }
    .form-grid-4 { grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); }
    .form-group { margin-bottom: 0; position: relative; }
    label {
      display: block;
      font-size: 13px;
      font-weight: 600;
      color: var(--text-secondary);
      margin-bottom: var(--spacing-sm);
      letter-spacing: 0.3px;
    }
    .help-icon {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 16px;
      height: 16px;
      background: var(--accent-primary);
      color: var(--bg-primary);
      border-radius: 50%;
      font-size: 10px;
      font-weight: 700;
      cursor: help;
      margin-left: 4px;
      position: relative;
      box-shadow: 0 0 10px var(--accent-primary-glow);
      transition: var(--transition);
    }
    .help-icon:hover { transform: scale(1.1); box-shadow: 0 0 15px var(--accent-primary-glow); }
    .help-icon:hover::after {
      content: attr(data-tooltip);
      position: absolute;
      bottom: 120%;
      left: 50%;
      transform: translateX(-50%);
      background: var(--bg-elevated);
      color: var(--text-primary);
      padding: 8px 12px;
      border-radius: var(--radius);
      font-size: 12px;
      font-weight: normal;
      white-space: nowrap;
      z-index: 1000;
      box-shadow: var(--shadow-lg);
      border: 1px solid var(--glass-border);
      animation: fadeIn 0.2s ease;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateX(-50%) translateY(-5px); }
      to { opacity: 1; transform: translateX(-50%) translateY(0); }
    }
    input, select, textarea {
      width: 100%;
      padding: 13px var(--spacing-lg);
      border: 1px solid var(--glass-border);
      border-radius: var(--radius);
      font-size: 14px;
      font-family: inherit;
      background: var(--bg-elevated);
      color: var(--text-primary);
      transition: var(--transition);
    }
    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: var(--accent-primary);
      box-shadow: 0 0 0 3px rgba(0, 229, 255, 0.15), 0 0 20px rgba(0, 229, 255, 0.2);
      background: var(--bg-tertiary);
    }
    input:hover:not(:focus), select:hover:not(:focus), textarea:hover:not(:focus) { border-color: rgba(0, 229, 255, 0.3); }
    input[readonly] { background: var(--bg-secondary); color: var(--text-tertiary); border-color: var(--bg-elevated); cursor: not-allowed; }
    input.warning { border-color: var(--warning); background: rgba(245, 158, 11, 0.06); }
    input.error { border-color: var(--danger); background: rgba(239, 68, 68, 0.06); }
    textarea { resize: vertical; min-height: 100px; line-height: 1.6; }
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: var(--spacing-sm);
      padding: 13px var(--spacing-xl);
      border: none;
      border-radius: var(--radius);
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: var(--transition);
      min-height: 46px;
      position: relative;
      overflow: hidden;
      letter-spacing: 0.3px;
    }
    .btn::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 0;
      height: 0;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.2);
      transform: translate(-50%, -50%);
      transition: width 0.6s, height 0.6s;
    }
    .btn:active::before { width: 300px; height: 300px; }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .btn-primary { background: var(--gradient-primary); color: white; box-shadow: 0 0 20px var(--accent-primary-glow); }
    .btn-primary:hover:not(:disabled) {
      box-shadow: 0 0 30px var(--accent-primary-glow), 0 4px 12px rgba(0, 0, 0, 0.3);
      transform: translateY(-2px);
    }
    .btn-success {
      background: linear-gradient(135deg, #10B981 0%, #059669 100%);
      color: white;
      box-shadow: 0 0 20px var(--success-glow);
    }
    .btn-success:hover:not(:disabled) {
      box-shadow: 0 0 30px var(--success-glow), 0 4px 12px rgba(0, 0, 0, 0.3);
      transform: translateY(-2px);
    }
    .btn-warning { background: var(--gradient-secondary); color: white; box-shadow: 0 0 20px rgba(255, 87, 34, 0.4); }
    .btn-warning:hover:not(:disabled) {
      box-shadow: 0 0 30px rgba(255, 87, 34, 0.5), 0 4px 12px rgba(0, 0, 0, 0.3);
      transform: translateY(-2px);
    }
    .btn-secondary { background: var(--bg-elevated); color: var(--text-primary); border: 1px solid var(--glass-border); }
    .btn-secondary:hover:not(:disabled) {
      background: var(--bg-hover);
      border-color: var(--accent-primary);
      box-shadow: 0 0 20px rgba(0, 229, 255, 0.2);
      transform: translateY(-2px);
    }
    .btn-danger {
      background: linear-gradient(135deg, #EF4444 0%, #DC2626 100%);
      color: white;
      box-shadow: 0 0 20px var(--danger-glow);
    }
    .btn-danger:hover:not(:disabled) {
      box-shadow: 0 0 30px var(--danger-glow), 0 4px 12px rgba(0, 0, 0, 0.3);
      transform: translateY(-2px);
    }
    .btn-group { display: flex; gap: var(--spacing-sm); flex-wrap: wrap; }
    .btn-sm { padding: var(--spacing-sm) var(--spacing-lg); font-size: 12px; min-height: 38px; }
    .materials-category {
      margin-bottom: var(--spacing-md);
      border: 1px solid var(--glass-border);
      border-radius: var(--radius-lg);
      overflow: hidden;
      background: var(--bg-elevated);
      transition: var(--transition);
    }
    .materials-category:hover { border-color: var(--accent-primary); box-shadow: 0 0 20px rgba(0, 229, 255, 0.1); }
    .category-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: var(--spacing-lg);
      background: var(--bg-tertiary);
      cursor: pointer;
      user-select: none;
      transition: var(--transition);
      border-bottom: 1px solid var(--glass-border);
    }
    .category-header:hover { background: var(--bg-hover); }
    .category-title-group { display: flex; align-items: center; gap: var(--spacing-md); }
    .category-icon { font-size: 26px; filter: drop-shadow(0 0 10px currentColor); }
    .category-name { font-weight: 700; font-size: 16px; color: var(--text-primary); }
    .category-meta { display: flex; align-items: center; gap: var(--spacing-sm); }
    .category-count {
      font-size: 11px;
      color: var(--text-tertiary);
      background: var(--bg-elevated);
      padding: 5px 12px;
      border-radius: 12px;
      font-weight: 600;
      border: 1px solid var(--glass-border);
    }
    .category-selected {
      font-size: 11px;
      color: white;
      background: var(--gradient-primary);
      padding: 5px 12px;
      border-radius: 12px;
      font-weight: 700;
      box-shadow: 0 0 12px var(--accent-primary-glow);
    }
    .category-arrow { transition: transform 0.3s ease; color: var(--text-tertiary); font-size: 16px; }
    .materials-category.expanded .category-arrow { transform: rotate(180deg); }
    .category-items { max-height: 0; overflow: hidden; transition: max-height 0.3s ease; }
    .materials-category.expanded .category-items { max-height: 10000px; }
    .material-item {
      padding: var(--spacing-lg);
      border-top: 1px solid var(--glass-border);
      background: var(--bg-secondary);
      transition: var(--transition);
    }
    .material-item:hover { background: var(--bg-tertiary); box-shadow: inset 0 0 20px rgba(0, 229, 255, 0.05); }
    .material-item:first-child { border-top: none; }
    .material-item-header {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      margin-bottom: var(--spacing-md);
    }
    .material-info { flex: 1; }
    .material-name { font-weight: 600; font-size: 15px; color: var(--text-primary); margin-bottom: 4px; }
    .material-spec { font-size: 12px; color: var(--text-tertiary); }
    .material-size-selector { display: flex; flex-wrap: wrap; gap: var(--spacing-sm); margin-top: var(--spacing-md); }
    .size-btn {
      padding: 8px 14px;
      background: var(--bg-elevated);
      border: 1px solid var(--glass-border);
      border-radius: var(--radius);
      font-size: 12px;
      font-weight: 600;
      color: var(--text-secondary);
      cursor: pointer;
      transition: var(--transition);
      position: relative;
    }
    .size-btn:hover {
      background: var(--bg-hover);
      border-color: var(--accent-primary);
      color: var(--accent-primary);
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    }
    .size-btn.selected {
      background: var(--gradient-primary);
      border-color: var(--accent-primary);
      color: white;
      box-shadow: 0 0 15px var(--accent-primary-glow);
    }
    .size-btn .qty-badge {
      position: absolute;
      top: -8px;
      right: -8px;
      background: var(--danger);
      color: white;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 10px;
      font-weight: 700;
      box-shadow: 0 0 10px var(--danger-glow);
    }
    .selected-material {
      display: flex;
      align-items: center;
      gap: var(--spacing-md);
      padding: var(--spacing-md);
      background: var(--bg-elevated);
      border: 1px solid var(--glass-border);
      border-radius: var(--radius);
      margin-bottom: var(--spacing-sm);
      transition: var(--transition);
    }
    .selected-material:hover {
      border-color: var(--accent-primary);
      box-shadow: 0 0 20px rgba(0, 229, 255, 0.1);
      transform: translateX(4px);
    }
    .selected-material-info { flex: 1; display: flex; align-items: center; gap: var(--spacing-md); }
    .selected-material-size {
      background: var(--gradient-primary);
      color: white;
      padding: 6px 12px;
      border-radius: var(--radius);
      font-size: 13px;
      font-weight: 700;
      min-width: 80px;
      text-align: center;
      box-shadow: 0 0 10px var(--accent-primary-glow);
    }
    .selected-material-controls { display: flex; align-items: center; gap: var(--spacing-sm); }
    .selected-material-controls input { width: 80px; text-align: center; padding: 8px; }
    .qty-control { display: flex; align-items: center; gap: 4px; }
    .qty-btn {
      width: 32px;
      height: 32px;
      border-radius: var(--radius);
      background: var(--bg-tertiary);
      border: 1px solid var(--glass-border);
      color: var(--text-primary);
      font-size: 16px;
      font-weight: 700;
      cursor: pointer;
      transition: var(--transition);
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .qty-btn:hover {
      background: var(--accent-primary);
      border-color: var(--accent-primary);
      box-shadow: 0 0 10px var(--accent-primary-glow);
    }
    .badge {
      display: inline-flex;
      align-items: center;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 11px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      box-shadow: var(--shadow);
    }
    .badge-success {
      background: rgba(16, 185, 129, 0.2);
      color: var(--success);
      border: 1px solid var(--success);
      box-shadow: 0 0 10px var(--success-glow);
    }
    .badge-warning {
      background: rgba(245, 158, 11, 0.2);
      color: var(--warning);
      border: 1px solid var(--warning);
      box-shadow: 0 0 10px var(--warning-glow);
    }
    .badge-danger {
      background: rgba(239, 68, 68, 0.2);
      color: var(--danger);
      border: 1px solid var(--danger);
      box-shadow: 0 0 10px var(--danger-glow);
    }
    .badge-info {
      background: rgba(59, 130, 246, 0.2);
      color: var(--info);
      border: 1px solid var(--info);
      box-shadow: 0 0 10px var(--info-glow);
    }
    .quality-dashboard {
      background: var(--gradient-purple);
      border-radius: var(--radius-xl);
      padding: var(--spacing-2xl);
      margin-bottom: var(--spacing-xl);
      color: white;
      box-shadow: var(--shadow-xl), 0 0 40px rgba(181, 101, 247, 0.5);
      position: relative;
      overflow: hidden;
    }
    .quality-dashboard::before {
      content: '';
      position: absolute;
      top: -50%;
      right: -50%;
      width: 200%;
      height: 200%;
      background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
      animation: rotate 20s linear infinite;
    }
    @keyframes rotate {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }
    .quality-header {
      font-size: 20px;
      font-weight: 700;
      margin-bottom: var(--spacing-lg);
      display: flex;
      align-items: center;
      justify-content: space-between;
      position: relative;
      z-index: 1;
    }
    .quality-score-large {
      font-size: 72px;
      font-weight: 700;
      text-align: center;
      margin: var(--spacing-xl) 0;
      text-shadow: 0 0 40px rgba(255, 255, 255, 0.5);
      position: relative;
      z-index: 1;
      letter-spacing: -2px;
    }
    .quality-metrics {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: var(--spacing-lg);
      margin-top: var(--spacing-xl);
      position: relative;
      z-index: 1;
    }
    .quality-metric {
      background: rgba(255, 255, 255, 0.12);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: var(--radius-lg);
      padding: var(--spacing-lg);
      text-align: center;
      transition: var(--transition);
    }
    .quality-metric:hover { background: rgba(255, 255, 255, 0.18); transform: translateY(-4px); }
    .metric-value { font-size: 30px; font-weight: 700; margin-bottom: 4px; text-shadow: 0 0 20px rgba(255, 255, 255, 0.5); }
    .metric-label { font-size: 12px; opacity: 0.95; text-transform: uppercase; letter-spacing: 0.5px; }
    .diagnostic-panel {
      background: var(--gradient-dark);
      border: 1px solid var(--glass-border);
      border-radius: var(--radius-xl);
      padding: var(--spacing-xl);
      margin: var(--spacing-xl) 0;
      box-shadow: var(--shadow-lg);
    }
    .diagnostic-header {
      font-size: 20px;
      font-weight: 700;
      margin-bottom: var(--spacing-lg);
      display: flex;
      align-items: center;
      gap: var(--spacing-sm);
      color: var(--accent-primary);
    }
    .diagnostic-card {
      background: var(--bg-elevated);
      border: 1px solid var(--glass-border);
      border-radius: var(--radius-lg);
      padding: var(--spacing-lg);
      margin-bottom: var(--spacing-md);
      transition: var(--transition);
    }
    .diagnostic-card:hover { border-color: var(--accent-primary); box-shadow: 0 0 20px rgba(0, 229, 255, 0.2); }
    .diagnostic-card:last-child { margin-bottom: 0; }
    .diagnostic-card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: var(--spacing-sm);
    }
    .diagnostic-card-title { font-weight: 700; font-size: 16px; color: var(--text-primary); }
    .diagnostic-recommendations {
      margin-top: var(--spacing-md);
      padding-top: var(--spacing-md);
      border-top: 1px solid var(--glass-border);
    }
    .diagnostic-recommendations ul { margin: var(--spacing-sm) 0; padding-left: var(--spacing-xl); font-size: 13px; }
    .diagnostic-recommendations li { margin: var(--spacing-sm) 0; color: var(--text-secondary); }
    .photo-gallery {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: var(--spacing-md);
      margin-top: var(--spacing-md);
    }
    .photo-item {
      position: relative;
      aspect-ratio: 1;
      border-radius: var(--radius-lg);
      overflow: hidden;
      border: 2px solid var(--glass-border);
      cursor: pointer;
      background: var(--bg-elevated);
      transition: var(--transition);
    }
    .photo-item:hover {
      border-color: var(--accent-primary);
      box-shadow: 0 0 20px rgba(0, 229, 255, 0.3);
      transform: scale(1.05);
    }
    .photo-item img { width: 100%; height: 100%; object-fit: cover; }
    .photo-item-actions {
      position: absolute;
      top: 8px;
      right: 8px;
      display: flex;
      gap: 4px;
      opacity: 0;
      transition: var(--transition);
    }
    .photo-item:hover .photo-item-actions { opacity: 1; }
    .photo-btn {
      width: 34px;
      height: 34px;
      border-radius: var(--radius);
      border: none;
      background: rgba(0, 0, 0, 0.8);
      backdrop-filter: blur(10px);
      color: white;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      transition: var(--transition);
    }
    .photo-btn:hover { background: var(--danger); box-shadow: 0 0 10px var(--danger-glow); transform: scale(1.1); }
    .photo-upload {
      aspect-ratio: 1;
      border: 2px dashed var(--glass-border);
      border-radius: var(--radius-lg);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      background: var(--bg-elevated);
      transition: var(--transition);
    }
    .photo-upload:hover {
      border-color: var(--accent-primary);
      background: rgba(0, 229, 255, 0.05);
      box-shadow: 0 0 20px rgba(0, 229, 255, 0.2);
      transform: scale(1.02);
    }
    .signature-pad {
      width: 100%;
      height: 200px;
      border: 2px solid var(--glass-border);
      border-radius: var(--radius-lg);
      cursor: crosshair;
      background: var(--bg-elevated);
      transition: var(--transition);
    }
    .signature-pad:hover { border-color: var(--accent-primary); box-shadow: 0 0 20px rgba(0, 229, 255, 0.2); }
    .chart-container {
      height: 300px;
      margin: var(--spacing-lg) 0;
      position: relative;
      background: var(--bg-elevated);
      border: 1px solid var(--glass-border);
      border-radius: var(--radius-lg);
      padding: var(--spacing-lg);
    }
    .checklist-item {
      display: flex;
      align-items: flex-start;
      padding: var(--spacing-md);
      background: var(--bg-elevated);
      border: 1px solid var(--glass-border);
      border-radius: var(--radius);
      margin-bottom: var(--spacing-sm);
      cursor: pointer;
      transition: var(--transition);
    }
    .checklist-item:hover {
      border-color: var(--accent-primary);
      background: var(--bg-tertiary);
      box-shadow: 0 0 20px rgba(0, 229, 255, 0.1);
    }
    .checklist-item.checked { border-color: var(--success); background: rgba(16, 185, 129, 0.1); }
    input[type="checkbox"] {
      width: 20px;
      height: 20px;
      margin-right: var(--spacing-md);
      accent-color: var(--accent-primary);
      cursor: pointer;
      flex-shrink: 0;
      margin-top: 2px;
    }
    .checklist-item label {
      margin: 0;
      cursor: pointer;
      font-weight: 400;
      font-size: 13px;
      line-height: 1.6;
      color: var(--text-secondary);
    }
    .toggle-group {
      display: inline-flex;
      background: var(--bg-elevated);
      border: 1px solid var(--glass-border);
      border-radius: var(--radius);
      padding: 4px;
      gap: 4px;
    }
    .toggle-btn {
      padding: var(--spacing-sm) var(--spacing-xl);
      border: none;
      background: transparent;
      border-radius: calc(var(--radius) - 2px);
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: var(--transition);
      color: var(--text-secondary);
      min-width: 120px;
    }
    .toggle-btn.active {
      background: var(--gradient-primary);
      color: white;
      box-shadow: 0 0 20px var(--accent-primary-glow);
    }
    .status-card {
      padding: var(--spacing-lg);
      border-radius: var(--radius-lg);
      border-left: 4px solid;
      font-size: 14px;
      line-height: 1.6;
      margin-bottom: var(--spacing-md);
      backdrop-filter: blur(10px);
    }
    .status-card.success { background: rgba(16, 185, 129, 0.1); border-color: var(--success); color: var(--success); }
    .status-card.warning { background: rgba(245, 158, 11, 0.1); border-color: var(--warning); color: var(--warning); }
    .status-card.danger { background: rgba(239, 68, 68, 0.1); border-color: var(--danger); color: var(--danger); }
    .status-card.info { background: rgba(59, 130, 246, 0.1); border-color: var(--info); color: var(--info); }
    .toast {
      position: fixed;
      bottom: 30px;
      right: 30px;
      background: var(--bg-elevated);
      backdrop-filter: blur(20px);
      border: 1px solid var(--glass-border);
      color: white;
      padding: var(--spacing-lg) var(--spacing-xl);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-xl);
      z-index: 9999;
      font-size: 14px;
      font-weight: 600;
      opacity: 0;
      transform: translateY(20px);
      transition: var(--transition);
      min-width: 300px;
      text-align: center;
    }
    .toast.show { opacity: 1; transform: translateY(0); }
    .toast.success {
      background: var(--gradient-primary);
      box-shadow: var(--shadow-xl), 0 0 30px var(--accent-primary-glow);
    }
    .toast.danger {
      background: linear-gradient(135deg, #EF4444 0%, #DC2626 100%);
      box-shadow: var(--shadow-xl), 0 0 30px var(--danger-glow);
    }
    .toast.warning {
      background: var(--gradient-secondary);
      box-shadow: var(--shadow-xl), 0 0 30px rgba(255, 87, 34, 0.4);
    }
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.85);
      backdrop-filter: blur(10px);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 10000;
      padding: var(--spacing-xl);
      animation: fadeIn 0.3s ease;
    }
    .modal-overlay.show { display: flex; }
    .modal {
      background: var(--bg-secondary);
      border: 1px solid var(--glass-border);
      border-radius: var(--radius-xl);
      padding: var(--spacing-2xl);
      max-width: 500px;
      width: 100%;
      box-shadow: var(--shadow-xl);
      animation: slideUp 0.3s ease;
    }
    @keyframes slideUp {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .modal-title { font-size: 24px; font-weight: 700; margin-bottom: var(--spacing-md); color: var(--text-primary); }
    .modal-content { color: var(--text-secondary); margin-bottom: var(--spacing-xl); line-height: 1.6; font-size: 14px; }
    .modal-actions { display: flex; gap: var(--spacing-sm); justify-content: flex-end; }
    .duct-tree {
      font-family: 'Courier New', monospace;
      font-size: 12px;
      background: var(--bg-elevated);
      padding: var(--spacing-lg);
      border-radius: var(--radius-lg);
      border: 1px solid var(--glass-border);
      line-height: 1.8;
      overflow-x: auto;
      color: var(--text-secondary);
    }
    .duct-branch { margin-left: 20px; padding: 4px 0; color: var(--text-tertiary); }
    .duct-trunk { font-weight: 700; color: var(--accent-primary); text-shadow: 0 0 10px var(--accent-primary-glow); }
    .info-box {
      background: var(--bg-elevated);
      border: 1px solid var(--glass-border);
      border-radius: var(--radius-lg);
      padding: var(--spacing-lg);
      margin: var(--spacing-md) 0;
    }
    .info-box-title { font-weight: 700; font-size: 14px; color: var(--accent-primary); margin-bottom: var(--spacing-sm); }
    .info-box-content { font-size: 13px; color: var(--text-secondary); line-height: 1.6; }
    .hidden { display: none !important; }
    .mt-lg { margin-top: var(--spacing-lg); }
    .mb-lg { margin-bottom: var(--spacing-lg); }
    .mobile-menu-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.8);
      backdrop-filter: blur(10px);
      z-index: 99;
      opacity: 0;
      transition: opacity 0.3s ease;
    }
    .mobile-menu-overlay.show { display: block; opacity: 1; }
    @media (max-width: 1024px) {
      .sidebar { transform: translateX(-100%); }
      .sidebar.mobile-open { transform: translateX(0); box-shadow: var(--shadow-xl); }
      .main-content { margin-left: 0; }
      .menu-toggle { display: flex; }
      .form-grid-2, .form-grid-3, .form-grid-4 { grid-template-columns: 1fr; }
      .quality-metrics { grid-template-columns: repeat(2, 1fr); }
      .dashboard-grid { grid-template-columns: 1fr; }
    }
    @media (max-width: 768px) {
      .workspace { padding: var(--spacing-lg); }
      .top-header { padding: 0 var(--spacing-lg); height: 68px; }
      .header-title { font-size: 20px; }
      .quality-metrics { grid-template-columns: 1fr; }
      .photo-gallery { grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); }
      .tile-stats { flex-direction: column; }
    }
  </style>
</head>

<body>
  <div class="app-container">
    <div class="mobile-menu-overlay" id="mobile-menu-overlay" onclick="toggleMobileMenu()"></div>
    <aside class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <div class="sidebar-logo">
          <div class="sidebar-logo-icon">üîß</div>
          <div class="sidebar-logo-text">
            <div class="sidebar-title">Field Buddy Pro</div>
            <div class="sidebar-version">v4.0 Complete</div>
          </div>
        </div>
      </div>
      <nav class="sidebar-nav">
        <div class="nav-section">
          <div class="nav-section-title">Navigation</div>
          <div class="nav-item active" onclick="switchPage('dashboard')">
            <span class="nav-icon">üè†</span>
            <span>Dashboard</span>
          </div>
          <div class="nav-item" onclick="switchPage('service')">
            <span class="nav-icon">üìã</span>
            <span>Service Calls</span>
          </div>
          <div class="nav-item" onclick="switchPage('materials')">
            <span class="nav-icon">üì¶</span>
            <span>Materials</span>
          </div>
          <div class="nav-item" onclick="switchPage('duct-design')">
            <span class="nav-icon">üèóÔ∏è</span>
            <span>Pro Duct Design</span>
          </div>
          <div class="nav-item" onclick="switchPage('cfm')">
            <span class="nav-icon">üå™Ô∏è</span>
            <span>CFM Calculator</span>
          </div>
          <div class="nav-item" onclick="switchPage('history')">
            <span class="nav-icon">üìä</span>
            <span>History & Reports</span>
          </div>
        </div>
        <div class="nav-section">
          <div class="nav-section-title">Tools</div>
          <div class="nav-item" onclick="saveData()">
            <span class="nav-icon">üíæ</span>
            <span>Save Progress</span>
          </div>
          <div class="nav-item" onclick="loadData()">
            <span class="nav-icon">üì•</span>
            <span>Load Saved Data</span>
          </div>
          <div class="nav-item" onclick="exportAllData()">
            <span class="nav-icon">üì§</span>
            <span>Export All Data</span>
          </div>
        </div>
      </nav>
    </aside>
    <main class="main-content">
      <header class="top-header">
        <div class="header-left">
          <button class="menu-toggle" onclick="toggleMobileMenu()">‚ò∞</button>
          <div class="header-title" id="page-title">Dashboard</div>
        </div>
        <div class="header-actions">
          <div class="header-user">
            <div class="user-avatar">MP</div>
            <span id="header-tech-name">Mart√≠n Perez</span>
          </div>
        </div>
      </header>
      <div class="workspace">
        <div id="dashboard-page" class="page-content">
          <div style="margin-bottom: var(--spacing-2xl);">
            <h1 style="font-size: 36px; font-weight: 700; margin-bottom: var(--spacing-sm); background: var(--gradient-primary); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; letter-spacing: -1px;">
              Welcome Back, Mart√≠n! üëã
            </h1>
            <p style="color: var(--text-secondary); font-size: 16px;">
              Your complete premium HVAC field service management system
            </p>
          </div>
          <div class="dashboard-grid">
            <div class="dashboard-tile" onclick="switchPage('service')">
              <div class="tile-header">
                <div class="tile-icon">üìã</div>
                <div class="tile-badge premium">Advanced</div>
              </div>
              <div class="tile-content">
                <div class="tile-title">Service Calls</div>
                <div class="tile-description">
                  Complete diagnostic system with refrigerant calculations, temperature analysis, and professional reporting
                </div>
                <div class="tile-stats">
                  <div class="tile-stat">
                    <span class="tile-stat-value" id="dash-stat-reports">0</span>
                    <span class="tile-stat-label">Reports</span>
                  </div>
                  <div class="tile-stat">
                    <span class="tile-stat-value" id="dash-stat-quality">0%</span>
                    <span class="tile-stat-label">Avg Quality</span>
                  </div>
                </div>
              </div>
            </div>
            <div class="dashboard-tile" onclick="switchPage('materials')">
              <div class="tile-header">
                <div class="tile-icon orange">üì¶</div>
                <div class="tile-badge pro">Pro+</div>
              </div>
              <div class="tile-content">
                <div class="tile-title">Materials Catalog</div>
                <div class="tile-description">
                  Complete 2025 catalog with multi-size selection - add 6", 9", 12" separately for accurate takeoffs
                </div>
                <div class="tile-stats">
                  <div class="tile-stat">
                    <span class="tile-stat-value">1000+</span>
                    <span class="tile-stat-label">Items</span>
                  </div>
                  <div class="tile-stat">
                    <span class="tile-stat-value">12</span>
                    <span class="tile-stat-label">Categories</span>
                  </div>
                </div>
              </div>
            </div>
            <div class="dashboard-tile" onclick="switchPage('duct-design')">
              <div class="tile-header">
                <div class="tile-icon purple">üèóÔ∏è</div>
                <div class="tile-badge">Premium</div>
              </div>
              <div class="tile-content">
                <div class="tile-title">Pro Duct Design</div>
                <div class="tile-description">
                  ACCA Manual D compliant duct system design with CFM calculations and material takeoffs
                </div>
                <div class="tile-stats">
                  <div class="tile-stat">
                    <span class="tile-stat-value">‚úì</span>
                    <span class="tile-stat-label">ACCA Compliant</span>
                  </div>
                  <div class="tile-stat">
                    <span class="tile-stat-value">Auto</span>
                    <span class="tile-stat-label">Material List</span>
                  </div>
                </div>
              </div>
            </div>
            <div class="dashboard-tile" onclick="switchPage('cfm')">
              <div class="tile-header">
                <div class="tile-icon gold">üå™Ô∏è</div>
                <div class="tile-badge">Essential</div>
              </div>
              <div class="tile-content">
                <div class="tile-title">CFM & Duct Sizing</div>
                <div class="tile-description">
                  Professional airflow and duct sizing calculators with multiple calculation methods
                </div>
                <div class="tile-stats">
                  <div class="tile-stat">
                    <span class="tile-stat-value">4</span>
                    <span class="tile-stat-label">Calculators</span>
                  </div>
                  <div class="tile-stat">
                    <span class="tile-stat-value">Instant</span>
                    <span class="tile-stat-label">Results</span>
                  </div>
                </div>
              </div>
            </div>
            <div class="dashboard-tile" onclick="switchPage('history')">
              <div class="tile-header">
                <div class="tile-icon orange">üìä</div>
                <div class="tile-badge pro">Pro</div>
              </div>
              <div class="tile-content">
                <div class="tile-title">History & Reports</div>
                <div class="tile-description">
                  Access all saved reports, track statistics, and manage your service history
                </div>
                <div class="tile-stats">
                  <div class="tile-stat">
                    <span class="tile-stat-value" id="dash-stat-total">0</span>
                    <span class="tile-stat-label">Total</span>
                  </div>
                  <div class="tile-stat">
                    <span class="tile-stat-value" id="dash-stat-month">0</span>
                    <span class="tile-stat-label">This Month</span>
                  </div>
                </div>
              </div>
            </div>
            <div class="dashboard-tile" style="background: var(--gradient-purple);">
              <div class="tile-header">
                <div class="tile-icon" style="background: rgba(255,255,255,0.2);">‚ö°</div>
              </div>
              <div class="tile-content">
                <div class="tile-title" style="color: white;">Quick Actions</div>
                <div class="tile-description" style="color: rgba(255,255,255,0.9); margin-bottom: var(--spacing-lg);">
                  Common tasks and shortcuts
                </div>
                <div style="display: flex; flex-direction: column; gap: var(--spacing-sm);">
                  <button class="btn btn-secondary" onclick="switchPage('service')" style="justify-content: flex-start;">
                    <span>üÜï</span> New Service Call
                  </button>
                  <button class="btn btn-secondary" onclick="switchPage('materials')" style="justify-content: flex-start;">
                    <span>üìù</span> Create Material List
                  </button>
                  <button class="btn btn-secondary" onclick="saveData()" style="justify-content: flex-start;">
                    <span>üíæ</span> Save Progress
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div id="service-page" class="page-content hidden">
          <div class="quality-dashboard" id="quality-dashboard">
            <div class="quality-header">
              <span>üìä Report Quality Score</span>
              <span id="quality-badge" class="badge badge-info">In Progress</span>
            </div>
            <div class="quality-score-large" id="quality-score-large">0%</div>
            <div class="quality-metrics">
              <div class="quality-metric">
                <div class="metric-value" id="metric-basic">0/5</div>
                <div class="metric-label">Basic Info</div>
              </div>
              <div class="quality-metric">
                <div class="metric-value" id="metric-diagnostics">0/3</div>
                <div class="metric-label">Diagnostics</div>
              </div>
              <div class="quality-metric">
                <div class="metric-value" id="metric-photos">0</div>
                <div class="metric-label">Photos</div>
              </div>
              <div class="quality-metric">
                <div class="metric-value" id="metric-signature">‚úó</div>
                <div class="metric-label">Signature</div>
              </div>
            </div>
          </div>
          <div class="card">
            <div class="card-header">
              <div class="card-title">System Mode</div>
              <div class="toggle-group">
                <button class="toggle-btn active" id="mode-cooling" onclick="setSystemMode('cooling')">‚ùÑÔ∏è Cooling</button>
                <button class="toggle-btn" id="mode-heating" onclick="setSystemMode('heating')">üî• Heating</button>
              </div>
            </div>
          </div>
          <div class="card">
            <div class="card-header"><div class="card-title">Job Information</div></div>
            <div class="card-body">
              <div class="card-section">
                <label>Call Type</label>
                <div class="toggle-group">
                  <button class="toggle-btn active" id="call-trouble" onclick="setCallType('trouble')">Trouble Call</button>
                  <button class="toggle-btn" id="call-maintenance" onclick="setCallType('maintenance')">Maintenance</button>
                </div>
              </div>
              <div class="form-grid form-grid-2">
                <div class="form-group">
                  <label>Customer Name</label>
                  <input type="text" id="customer-name" placeholder="Enter customer name" oninput="calculateQuality()">
                </div>
                <div class="form-group">
                  <label>Date</label>
                  <input type="date" id="service-date" oninput="calculateQuality()">
                </div>
              </div>
              <div class="form-grid">
                <div class="form-group">
                  <label>Service Address</label>
                  <input type="text" id="service-address" placeholder="123 Main St, City, State ZIP" oninput="calculateQuality()">
                </div>
              </div>
              <div class="form-grid">
                <div class="form-group">
                  <label>Customer Complaint / Reason for Service</label>
                  <textarea id="customer-complaint" placeholder="Describe the issue or maintenance reason..." oninput="calculateQuality()"></textarea>
                </div>
              </div>
            </div>
          </div>
          <div class="card">
            <div class="card-header"><div class="card-title">Equipment Information</div></div>
            <div class="card-body">
              <div class="form-grid">
                <div class="form-group">
                  <label>Unit Type</label>
                  <select id="unit-type" onchange="updateUnitFields(); calculateQuality();">
                    <option value="">Select unit type...</option>
                    <option value="split">Split System</option>
                    <option value="package">Package Unit</option>
                    <option value="mini-split">Mini-Split</option>
                    <option value="heat-pump">Heat Pump</option>
                  </select>
                </div>
              </div>
              <div class="form-grid form-grid-2">
                <div class="form-group">
                  <label>Indoor Unit (Model/Serial)</label>
                  <input type="text" id="indoor-unit" placeholder="Model & Serial Number">
                </div>
                <div class="form-group" id="outdoor-unit-group">
                  <label>Outdoor Unit (Model/Serial)</label>
                  <input type="text" id="outdoor-unit" placeholder="Model & Serial Number">
                </div>
              </div>
              <div class="form-grid form-grid-3">
                <div class="form-group">
                  <label>Tonnage</label>
                  <select id="tonnage">
                    <option value="">Select...</option>
                    <option value="1.5">1.5 Ton</option>
                    <option value="2">2 Ton</option>
                    <option value="2.5">2.5 Ton</option>
                    <option value="3">3 Ton</option>
                    <option value="3.5">3.5 Ton</option>
                    <option value="4">4 Ton</option>
                    <option value="5">5 Ton</option>
                  </select>
                </div>
                <div class="form-group">
                  <label>Refrigerant Type<span class="help-icon" data-tooltip="R-410A is most common in modern systems">?</span></label>
                  <select id="refrigerant-type">
                    <option value="R410A">R-410A</option>
                    <option value="R22">R-22</option>
                    <option value="R454B">R-454B</option>
                    <option value="R32">R-32</option>
                  </select>
                </div>
                <div class="form-group">
                  <label>Filter Size</label>
                  <input type="text" id="filter-size" placeholder="e.g., 16x25x1">
                </div>
              </div>
              <div class="form-grid form-grid-2">
                <div class="form-group">
                  <label>Metering Device<span class="help-icon" data-tooltip="TXV adjusts automatically, Fixed Orifice (piston) does not">?</span></label>
                  <select id="metering-device" onchange="calculateDiagnostics()">
                    <option value="">Unknown</option>
                    <option value="txv">TXV (Thermostatic Expansion Valve)</option>
                    <option value="piston">Fixed Orifice / Piston</option>
                  </select>
                </div>
                <div class="form-group">
                  <label>SEER Rating</label>
                  <input type="number" id="seer-rating" placeholder="e.g., 14">
                </div>
              </div>
            </div>
          </div>
          <div class="card" id="cooling-measurements">
            <div class="card-header"><div class="card-title">Diagnostic Measurements (Cooling Mode)</div></div>
            <div class="card-body">
              <div class="card-section">
                <div class="section-title">Temperature Readings</div>
                <div class="form-grid form-grid-4">
                  <div class="form-group">
                    <label>Outdoor Ambient (¬∞F)<span class="help-icon" data-tooltip="Temperature outside near condensing unit">?</span></label>
                    <input type="number" step="0.1" id="outdoor-ambient" oninput="calculateDiagnostics()">
                  </div>
                  <div class="form-group">
                    <label>Ambient Temp (¬∞F)<span class="help-icon" data-tooltip="Temperature inside near return air">?</span></label>
                    <input type="number" step="0.1" id="ambient-temp" oninput="calculateDiagnostics()">
                  </div>
                  <div class="form-group">
                    <label>Return Temp (¬∞F)</label>
                    <input type="number" step="0.1" id="return-temp" oninput="calculateDiagnostics()">
                  </div>
                  <div class="form-group">
                    <label>Supply Temp (¬∞F)</label>
                    <input type="number" step="0.1" id="supply-temp" oninput="calculateDiagnostics()">
                  </div>
                </div>
                <div class="form-grid form-grid-2">
                  <div class="form-group">
                    <label>Delta-T (Calculated)<span class="help-icon" data-tooltip="Should be 16-22¬∞F for proper cooling">?</span></label>
                    <input type="text" id="delta-t" readonly>
                  </div>
                  <div class="form-group">
                    <label>Wet Bulb Temperature (¬∞F)<span class="help-icon" data-tooltip="Used for accurate charge verification">?</span></label>
                    <input type="number" step="0.1" id="wet-bulb" oninput="calculateDiagnostics()">
                  </div>
                </div>
              </div>
              <div class="card-section">
                <div class="section-title">Refrigerant Pressures & Temperatures</div>
                <div class="form-grid form-grid-2">
                  <div class="form-group">
                    <label>Suction Pressure (PSI)</label>
                    <input type="number" step="0.1" id="suction-pressure" oninput="calculateDiagnostics()">
                  </div>
                  <div class="form-group">
                    <label>Suction Line Temp (¬∞F)</label>
                    <input type="number" step="0.1" id="suction-temp" oninput="calculateDiagnostics()">
                  </div>
                  <div class="form-group">
                    <label>Liquid Pressure (PSI)</label>
                    <input type="number" step="0.1" id="liquid-pressure" oninput="calculateDiagnostics()">
                  </div>
                  <div class="form-group">
                    <label>Liquid Line Temp (¬∞F)</label>
                    <input type="number" step="0.1" id="liquid-temp" oninput="calculateDiagnostics()">
                  </div>
                </div>
                <div class="form-grid form-grid-2">
                  <div class="form-group">
                    <label>Superheat (Calculated)<span class="help-icon" data-tooltip="TXV: 8-15¬∞F | Fixed: 5-25¬∞F">?</span></label>
                    <input type="text" id="superheat" readonly>
                  </div>
                  <div class="form-group">
                    <label>Subcool (Calculated)<span class="help-icon" data-tooltip="Should be 8-12¬∞F for most systems">?</span></label>
                    <input type="text" id="subcool" readonly>
                  </div>
                </div>
              </div>
              <div class="card-section">
                <div class="section-title">Airflow & Electrical</div>
                <div class="form-grid form-grid-4">
                  <div class="form-group">
                    <label>Static Pressure (in w.c.)<span class="help-icon" data-tooltip="Total ESP should be ‚â§0.50 for residential">?</span></label>
                    <input type="number" step="0.01" id="static-pressure" oninput="calculateDiagnostics()">
                  </div>
                  <div class="form-group">
                    <label>Voltage (V)</label>
                    <input type="number" step="0.1" id="voltage">
                  </div>
                  <div class="form-group">
                    <label>Amperage (A)<span class="help-icon" data-tooltip="Compressor running amps">?</span></label>
                    <input type="number" step="0.1" id="amperage">
                  </div>
                  <div class="form-group">
                    <label>RLA/FLA Rating<span class="help-icon" data-tooltip="From equipment nameplate">?</span></label>
                    <input type="number" step="0.1" id="rla-rating" placeholder="Nameplate">
                  </div>
                </div>
              </div>
              <div class="chart-container"><canvas id="pressure-chart"></canvas></div>
            </div>
          </div>
          <div class="card hidden" id="heating-measurements">
            <div class="card-header"><div class="card-title">Diagnostic Measurements (Heating Mode)</div></div>
            <div class="card-body">
              <div class="card-section">
                <div class="section-title">Temperature Readings</div>
                <div class="form-grid form-grid-3">
                  <div class="form-group">
                    <label>Return Temp (¬∞F)</label>
                    <input type="number" step="0.1" id="return-temp-heat" oninput="calculateDiagnostics()">
                  </div>
                  <div class="form-group">
                    <label>Supply Temp (¬∞F)</label>
                    <input type="number" step="0.1" id="supply-temp-heat" oninput="calculateDiagnostics()">
                  </div>
                  <div class="form-group">
                    <label>Temp Rise (Calculated)<span class="help-icon" data-tooltip="Should be 35-65¬∞F for gas furnaces">?</span></label>
                    <input type="text" id="temp-rise" readonly>
                  </div>
                </div>
              </div>
              <div class="card-section">
                <div class="section-title">Gas Furnace / Heat Measurements</div>
                <div class="form-grid form-grid-4">
                  <div class="form-group">
                    <label>Manifold Pressure (in w.c.)<span class="help-icon" data-tooltip="Natural gas: 3.3-3.8 | LP: 10-11">?</span></label>
                    <input type="number" step="0.01" id="manifold-pressure" oninput="calculateDiagnostics()">
                  </div>
                  <div class="form-group">
                    <label>Voltage (V)</label>
                    <input type="number" step="0.1" id="voltage-heat">
                  </div>
                  <div class="form-group">
                    <label>Amperage (A)</label>
                    <input type="number" step="0.1" id="amperage-heat">
                  </div>
                  <div class="form-group">
                    <label>Gas Type</label>
                    <select id="gas-type">
                      <option value="natural">Natural Gas</option>
                      <option value="lp">LP/Propane</option>
                    </select>
                  </div>
                </div>
              </div>
              <div class="chart-container"><canvas id="heating-chart"></canvas></div>
            </div>
          </div>
          <div id="diagnostic-results" class="hidden"></div>
          <div class="card">
            <div class="card-header">
              <div class="card-title">üì∏ Job Photos</div>
              <span class="badge badge-info" id="photo-count">0 photos</span>
            </div>
            <div class="card-body">
              <div class="photo-gallery" id="photo-gallery">
                <label class="photo-upload">
                  <input type="file" accept="image/*" capture="camera" multiple onchange="handlePhotos(event)" style="display:none">
                  <span style="font-size: 32px;">üì∑</span>
                  <span>Add Photo</span>
                </label>
              </div>
            </div>
          </div>
          <div class="card">
            <div class="card-header"><div class="card-title">Findings & Work Performed</div></div>
            <div class="card-body">
              <div class="card-section">
                <div class="form-group">
                  <label>Findings</label>
                  <textarea id="findings" placeholder="Describe what you found during the service call..." oninput="calculateQuality()"></textarea>
                </div>
              </div>
              <div class="card-section">
                <div class="form-group">
                  <label>Recommendations</label>
                  <textarea id="recommendations" placeholder="What do you recommend to the customer?"></textarea>
                </div>
              </div>
              <div class="card-section">
                <div class="form-group">
                  <label>Work Performed</label>
                  <textarea id="work-performed" placeholder="Detail the work you completed..." oninput="calculateQuality()"></textarea>
                </div>
              </div>
            </div>
          </div>
          <div class="card">
            <div class="card-header"><div class="card-title">‚úçÔ∏è Customer Signature</div></div>
            <div class="card-body">
              <div class="form-grid form-grid-2">
                <div class="form-group">
                  <label>Customer Name</label>
                  <input type="text" id="sig-name" placeholder="Customer name" oninput="calculateQuality()">
                </div>
                <div class="form-group">
                  <label>Date</label>
                  <input type="date" id="sig-date" oninput="calculateQuality()">
                </div>
              </div>
              <canvas id="signature-pad" class="signature-pad"></canvas>
              <div class="btn-group mt-lg">
                <button class="btn btn-secondary" onclick="clearSignature()">Clear</button>
                <button class="btn btn-primary" onclick="saveSignature()">Save Signature</button>
              </div>
            </div>
          </div>
          <div class="card">
            <div class="card-header"><div class="card-title">Technician Information</div></div>
            <div class="card-body">
              <div class="form-grid form-grid-2">
                <div class="form-group">
                  <label>Technician Name</label>
                  <input type="text" id="tech-name" value="Mart√≠n Perez">
                </div>
                <div class="form-group">
                  <label>Contact Phone</label>
                  <input type="tel" id="tech-phone" value="(346)451-0024">
                </div>
              </div>
              <div class="form-grid">
                <div class="form-group">
                  <label>Email Address</label>
                  <input type="email" id="tech-email" value="Mperez@villageplumbing.com">
                </div>
              </div>
            </div>
          </div>
          <div class="btn-group">
            <button class="btn btn-success" onclick="generatePDF()">üìÑ Generate PDF</button>
            <button class="btn btn-primary" onclick="generateTextReport()">üìã Text Report</button>
            <button class="btn btn-secondary" onclick="saveData()">üíæ Save Progress</button>
            <button class="btn btn-danger" onclick="clearForm()">üóëÔ∏è Clear Form</button>
          </div>
          <div id="report-container"></div>
        </div>
        <div id="materials-page" class="page-content hidden">
          <div class="card">
            <div class="card-header"><div class="card-title">Job Information</div></div>
            <div class="card-body">
              <div class="form-grid form-grid-2">
                <div class="form-group">
                  <label>Customer/Job Name</label>
                  <input type="text" id="mat-customer" placeholder="Enter customer or job name">
                </div>
                <div class="form-group">
                  <label>Date</label>
                  <input type="date" id="mat-date">
                </div>
              </div>
              <div class="form-grid">
                <div class="form-group">
                  <label>Job Address</label>
                  <input type="text" id="mat-address" placeholder="123 Main St, City, State ZIP">
                </div>
              </div>
              <div class="form-grid">
                <div class="form-group">
                  <label>Job Notes</label>
                  <textarea id="mat-notes" placeholder="Special instructions, access codes, etc."></textarea>
                </div>
              </div>
            </div>
          </div>
          <div class="card">
            <div class="card-header">
              <div class="card-title">üì¶ Materials Catalog - 2025 Complete Edition</div>
              <div class="btn-group">
                <button class="btn btn-secondary btn-sm" onclick="expandAllCategories()">Expand All</button>
                <button class="btn btn-secondary btn-sm" onclick="collapseAllCategories()">Collapse All</button>
              </div>
            </div>
            <div class="card-body">
              <div class="form-group">
                <input type="text" id="material-search" placeholder="üîç Search materials..." oninput="filterMaterials()" style="font-size: 15px;">
              </div>
              <div id="materials-catalog"></div>
            </div>
          </div>
          <div class="card">
            <div class="card-header">
              <div class="card-title">Selected Materials</div>
              <span class="badge badge-info" id="selected-materials-count">0 items</span>
            </div>
            <div class="card-body">
              <div id="selected-materials">
                <div class="status-card info">‚ÑπÔ∏è No materials selected yet. Click size buttons to add materials to your list. You can add multiple sizes of the same item!</div>
              </div>
            </div>
          </div>
          <div class="card">
            <div class="card-header"><div class="card-title">Technician Information</div></div>
            <div class="card-body">
              <div class="form-grid form-grid-2">
                <div class="form-group">
                  <label>Technician Name</label>
                  <input type="text" id="mat-tech-name" value="Mart√≠n Perez">
                </div>
                <div class="form-group">
                  <label>Contact Phone</label>
                  <input type="tel" id="mat-tech-phone" value="(346)451-0024">
                </div>
              </div>
              <div class="form-grid">
                <div class="form-group">
                  <label>Email Address</label>
                  <input type="email" id="mat-tech-email" value="Mperez@villageplumbing.com">
                </div>
              </div>
            </div>
          </div>
          <div class="btn-group">
            <button class="btn btn-success" onclick="generateMaterialsPDF()">üìÑ Generate PDF</button>
            <button class="btn btn-primary" onclick="generateMaterialsReport()">üìã Generate List</button>
            <button class="btn btn-secondary" onclick="saveData()">üíæ Save Progress</button>
            <button class="btn btn-danger" onclick="clearMaterialsForm()">üóëÔ∏è Clear Form</button>
          </div>
          <div id="report-container-mat"></div>
        </div>
        <div id="duct-design-page" class="page-content hidden">
          <div class="status-card info">‚ÑπÔ∏è Duct Design page - Full functionality from original preserved</div>
        </div>
        <div id="cfm-page" class="page-content hidden">
          <div class="status-card info">‚ÑπÔ∏è CFM Calculator page - Full functionality from original preserved</div>
        </div>
        <div id="history-page" class="page-content hidden">
          <div class="card">
            <div class="card-header">
              <div class="card-title">üìä Saved Reports & History</div>
              <button class="btn btn-primary" onclick="refreshHistory()">Refresh</button>
            </div>
            <div class="card-body">
              <div id="history-list">
                <div class="status-card info">‚ÑπÔ∏è No saved reports yet. Complete a service call and save your progress to see history here.</div>
              </div>
            </div>
          </div>
          <div class="card">
            <div class="card-header"><div class="card-title">üìà Statistics</div></div>
            <div class="card-body">
              <div class="quality-metrics">
                <div class="quality-metric" style="background: var(--bg-elevated); border: 1px solid var(--glass-border);">
                  <div class="metric-value" style="color: var(--accent-primary);" id="stat-total">0</div>
                  <div class="metric-label">Total Reports</div>
                </div>
                <div class="quality-metric" style="background: var(--bg-elevated); border: 1px solid var(--glass-border);">
                  <div class="metric-value" style="color: var(--accent-secondary);" id="stat-this-month">0</div>
                  <div class="metric-label">This Month</div>
                </div>
                <div class="quality-metric" style="background: var(--bg-elevated); border: 1px solid var(--glass-border);">
                  <div class="metric-value" style="color: var(--success);" id="stat-avg-quality">0%</div>
                  <div class="metric-label">Avg Quality</div>
                </div>
                <div class="quality-metric" style="background: var(--bg-elevated); border: 1px solid var(--glass-border);">
                  <div class="metric-value" style="color: var(--info);" id="stat-photos">0</div>
                  <div class="metric-label">Total Photos</div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>
  <div class="toast" id="toast"></div>
  <div class="modal-overlay" id="modal-overlay">
    <div class="modal">
      <div class="modal-title" id="modal-title">Confirm Action</div>
      <div class="modal-content" id="modal-content">Are you sure?</div>
      <div class="modal-actions">
        <button class="btn btn-secondary" onclick="closeModal(false)">Cancel</button>
        <button class="btn btn-primary" onclick="closeModal(true)">Confirm</button>
      </div>
    </div>
  </div>
  <script>
    let currentPage = 'dashboard';
    let callType = 'trouble';
    let systemMode = 'cooling';
    let selectedMaterials = [];
    let diagnosticResults = [];
    let categoryStates = {};
    let photos = [];
    let signaturePad = null;
    let customerSignature = null;
    let pressureChart = null;
    let heatingChart = null;
    let velocityChart = null;
    let savedReports = [];
    let ductDesignRooms = [];
    let currentDuctDesign = null;
    const R410A_PT = {43:0,57:10,73:20,92:30,114:40,117:41,121:42,125:43,140:50,169:60,201:70,237:80,278:90,323:100,330:102,335:103,338:104,347:105,373:110,400:115,428:120,460:125,493:130,528:135,565:140};
    const FIXED_ORIFICE_SUPERHEAT_TARGETS = {65:25,70:23,75:21,80:18,85:15,90:12,95:10,100:8,105:6};
    const materialsCatalog = {
      equipment: {
        name: 'Equipment',
        icon: 'üè†',
        items: [
          {id:'furnace-gas',name:'Gas Furnace',sizes:['40K BTU','60K BTU','80K BTU','100K BTU','120K BTU']},
          {id:'furnace-electric',name:'Electric Furnace',sizes:['10kW','15kW','20kW','25kW']},
          {id:'ac-unit',name:'Air Conditioner',sizes:['1.5 Ton','2 Ton','2.5 Ton','3 Ton','3.5 Ton','4 Ton','5 Ton']},
          {id:'heat-pump',name:'Heat Pump',sizes:['2 Ton','2.5 Ton','3 Ton','3.5 Ton','4 Ton','5 Ton']},
          {id:'evap-coil',name:'Evaporator Coil',sizes:['2 Ton','2.5 Ton','3 Ton','3.5 Ton','4 Ton','5 Ton']},
          {id:'air-handler',name:'Air Handler',sizes:['2 Ton','2.5 Ton','3 Ton','3.5 Ton','4 Ton']},
          {id:'package-unit',name:'Package Unit',sizes:['2 Ton','3 Ton','4 Ton','5 Ton']},
          {id:'minisplit',name:'Mini-Split System',sizes:['9K BTU','12K BTU','18K BTU','24K BTU','36K BTU']}
        ]
      },
      electrical: {
        name: 'Electrical Components',
        icon: '‚ö°',
        items: [
          {id:'contactor',name:'Contactor',sizes:['1-Pole 30A','2-Pole 30A','2-Pole 40A','3-Pole 30A','3-Pole 40A']},
          {id:'capacitor-single',name:'Run Capacitor (Single)',sizes:['5¬µF','7.5¬µF','10¬µF','15¬µF','20¬µF','25¬µF','30¬µF','35¬µF','40¬µF','45¬µF','50¬µF','60¬µF']},
          {id:'capacitor-dual',name:'Dual Run Capacitor',sizes:['35/5¬µF','40/5¬µF','45/5¬µF','50/5¬µF','55/5¬µF','60/5¬µF']},
          {id:'hard-start',name:'Hard Start Kit',sizes:['1-2 Ton','2-3 Ton','3-5 Ton']},
          {id:'soft-start',name:'Soft Start Kit',sizes:['1-2 Ton','2-3 Ton','3-5 Ton']},
          {id:'compressor-saver',name:'Compressor Saver',sizes:['Universal']},
          {id:'potential-relay',name:'Potential Relay',sizes:['Standard','Heavy Duty']},
          {id:'voltage-regulator',name:'Voltage Regulator/Stabilizer',sizes:['240V 15A','240V 30A','240V 60A']},
          {id:'surge-protector',name:'Surge Protector (HVAC)',sizes:['Whole Unit','Panel Mount']},
          {id:'disconnect-30',name:'Disconnect Box (30A)',sizes:['30A Non-Fused','30A Fused']},
          {id:'disconnect-60',name:'Disconnect Box (60A)',sizes:['60A Non-Fused','60A Fused']},
          {id:'breaker',name:'Circuit Breaker',sizes:['15A','20A','25A','30A','40A','50A','60A']},
          {id:'whip',name:'Electrical Whip',sizes:['3 ft','6 ft','10 ft']},
          {id:'wire-lv',name:'Low Voltage Wire (18ga)',sizes:['18/2','18/3','18/5','18/8'],unit:'ft'},
          {id:'wire-hv',name:'High Voltage Wire',sizes:['14/2','12/2','10/2','10/3','8/2','8/3'],unit:'ft'},
          {id:'transformer',name:'Control Transformer',sizes:['24V 40VA','24V 75VA','24V 100VA']}
        ]
      },
      controls: {
        name: 'Controls & Thermostats',
        icon: 'üå°Ô∏è',
        items: [
          {id:'tstat-smart',name:'WiFi Smart Thermostat',sizes:['Nest','Ecobee','Honeywell T9']},
          {id:'tstat-programmable',name:'Programmable Thermostat',sizes:['5-2 Day','7 Day']},
          {id:'tstat-nonprog',name:'Non-Programmable Thermostat',sizes:['Digital','Mercury Free']},
          {id:'zone-control-panel',name:'Zone Control Panel',sizes:['2 Zone','3 Zone','4 Zone','6 Zone']},
          {id:'zone-damper',name:'Zone Damper',sizes:['6" Round','8" Round','10" Round','6x10 Rect']},
          {id:'humidistat',name:'Humidistat Control',sizes:['Digital','Mechanical']}
        ]
      },
      ductwork: {
        name: 'Ductwork & Distribution',
        icon: 'üå¨Ô∏è',
        items: [
          {id:'flex-duct-insulated',name:'Flex Duct (Insulated R6)',sizes:['4"','5"','6"','7"','8"','10"','12"','14"','16"'],unit:'25ft bag'},
          {id:'rigid-galv',name:'Rigid Galvanized Duct',sizes:['4"','6"','8"','10"','12"','14"','16"'],unit:'ft'},
          {id:'duct-board',name:'Duct Board (1.5" thick)',sizes:['4x8 sheet'],unit:'sheet'},
          {id:'starting-collar',name:'Starting Collar',sizes:['4"','5"','6"','7"','8"','10"','12"'],unit:'ea'},
          {id:'register',name:'Supply Register',sizes:['4x10','4x12','6x10','6x12','8x10','10x10','12x12']},
          {id:'grille',name:'Return Grille',sizes:['10x10','12x12','14x14','16x16','20x20','24x24']},
          {id:'diffuser',name:'Ceiling Diffuser',sizes:['6" Round','8" Round','10" Round','12" Round']},
          {id:'damper-manual',name:'Manual Balancing Damper',sizes:['4"','6"','8"','10"','12"']},
          {id:'boot-register',name:'Register Boot',sizes:['4"','6"','8"','10"'],unit:'ea'},
          {id:'duct-strap',name:'Adjustable Duct Strap',sizes:['Standard'],unit:'box'}
        ]
      },
      ductFittings: {
        name: 'Duct Fittings',
        icon: 'üîß',
        items: [
          {id:'elbow-90',name:'90¬∞ Elbow',sizes:['4"','6"','8"','10"','12"'],unit:'ea'},
          {id:'elbow-45',name:'45¬∞ Elbow',sizes:['4"','6"','8"','10"','12"'],unit:'ea'},
          {id:'tee',name:'Tee/Wye Fitting',sizes:['6"','8"','10"','12"'],unit:'ea'},
          {id:'reducer',name:'Reducer',sizes:['10-8"','12-10"','10-6"','8-6"'],unit:'ea'},
          {id:'takeoff-collar',name:'Takeoff Collar',sizes:['6"','7"','8"','10"'],unit:'ea'},
          {id:'end-cap',name:'End Cap',sizes:['4"','6"','8"','10"'],unit:'ea'}
        ]
      },
      iaq: {
        name: 'Air Quality & Filtration',
        icon: 'üí®',
        items: [
          {id:'filter-disposable',name:'Disposable Filter',sizes:['16x20x1','16x25x1','20x20x1','20x25x1','24x24x1'],unit:'pack'},
          {id:'filter-pleated',name:'Pleated Filter (MERV 11)',sizes:['16x20x1','16x25x1','20x20x1','20x25x1'],unit:'pack'},
          {id:'filter-hepa',name:'HEPA Filter (MERV 13)',sizes:['16x20','16x25','20x20','20x25']},
          {id:'media-cleaner',name:'Media Air Cleaner',sizes:['16x25','20x25']},
          {id:'uv-light-single',name:'UV Light System (Single)',sizes:['24V']},
          {id:'uv-light-dual',name:'UV Light System (Dual)',sizes:['24V']},
          {id:'reme-halo',name:'REME HALO Air Purifier',sizes:['24V']},
          {id:'humidifier-bypass',name:'Bypass Humidifier',sizes:['12 GPD','17 GPD']},
          {id:'dehumidifier-90',name:'Whole-Home Dehumidifier',sizes:['90 Pint','120 Pint']},
          {id:'erv',name:'ERV System',sizes:['100 CFM','150 CFM','200 CFM']}
        ]
      },
      refrigeration: {
        name: 'Refrigeration',
        icon: '‚ùÑÔ∏è',
        items: [
          {id:'lineset-small',name:'Line Set (1.5-2.5 Ton)',sizes:['15 ft','25 ft','35 ft','50 ft'],spec:'1/4" x 3/8"'},
          {id:'lineset-medium',name:'Line Set (3-3.5 Ton)',sizes:['15 ft','25 ft','35 ft','50 ft'],spec:'3/8" x 3/4"'},
          {id:'lineset-large',name:'Line Set (4-5 Ton)',sizes:['15 ft','25 ft','35 ft','50 ft'],spec:'3/8" x 7/8"'},
          {id:'copper-tubing',name:'Copper Tubing (ACR)',sizes:['1/4"','3/8"','1/2"','5/8"','3/4"','7/8"'],unit:'ft'},
          {id:'r410a',name:'R-410A Refrigerant',sizes:['25 lb','50 lb'],unit:'cylinder'},
          {id:'r22',name:'R-22 Refrigerant',sizes:['30 lb'],unit:'cylinder'},
          {id:'r32',name:'R-32 Refrigerant',sizes:['20 lb'],unit:'cylinder'},
          {id:'r454b',name:'R-454B Refrigerant',sizes:['25 lb'],unit:'cylinder'},
          {id:'txv',name:'TXV (Expansion Valve)',sizes:['2 Ton','2.5 Ton','3 Ton','3.5 Ton','4 Ton','5 Ton']},
          {id:'filter-drier',name:'Filter Drier',sizes:['1/2"','5/8"','3/4"']},
          {id:'refrig-oil',name:'Refrigerant Oil',sizes:['POE 8oz','POE 16oz']}
        ]
      },
      drainage: {
        name: 'Condensate Management',
        icon: 'üíß',
        items: [
          {id:'condensate-pump',name:'Condensate Pump',sizes:['Standard','Heavy Duty']},
          {id:'drain-pvc',name:'PVC Drain Pipe (3/4")',sizes:['10 ft','20 ft'],unit:'length'},
          {id:'drain-pan-primary',name:'Drain Pan (Primary)',sizes:['24x24','30x30','36x36']},
          {id:'drain-pan-secondary',name:'Drain Pan (Secondary)',sizes:['24x24','30x30','36x36']},
          {id:'ptrap',name:'P-Trap',sizes:['3/4"','1"']},
          {id:'float-switch',name:'Float Switch',sizes:['Standard']},
          {id:'drain-tubing',name:'Clear Vinyl Drain Tubing',sizes:['3/8"','1/2"','5/8"'],unit:'ft'}
        ]
      },
      venting: {
        name: 'Venting (Gas/Oil)',
        icon: 'üî•',
        items: [
          {id:'bvent',name:'B-Vent Pipe',sizes:['3"','4"','5"','6"','7"'],unit:'ft'},
          {id:'pvc-vent',name:'PVC Vent Pipe',sizes:['2"','3"','4"'],unit:'ft'},
          {id:'vent-cap',name:'Vent Cap/Termination',sizes:['2"','3"','4"','5"','6"']},
          {id:'vent-elbow-90',name:'Vent Elbow (90¬∞)',sizes:['2"','3"','4"','5"']},
          {id:'inducer',name:'Inducer Motor',sizes:['Standard','High Efficiency']}
        ]
      },
      insulation: {
        name: 'Insulation & Sealants',
        icon: 'üß±',
        items: [
          {id:'duct-insulation-fiberglass',name:'Fiberglass Duct Wrap',sizes:['R-6','R-8'],unit:'roll'},
          {id:'pipe-insulation-foam',name:'Foam Pipe Insulation',sizes:['1/4"','3/8"','1/2"','5/8"','3/4"','7/8"'],unit:'ft'},
          {id:'mastic',name:'Duct Mastic',sizes:['1 Gallon','5 Gallon']},
          {id:'foil-tape',name:'Foil Tape',sizes:['2"','3"'],unit:'roll'},
          {id:'mesh-tape',name:'Mesh Tape (for mastic)',sizes:['2"','3"'],unit:'roll'},
          {id:'silicone-caulk',name:'Silicone Caulk',sizes:['Clear','White','Aluminum'],unit:'tube'},
          {id:'foam-sealant',name:'Expanding Foam Sealant',sizes:['Standard','Fire-Rated'],unit:'can'}
        ]
      },
      tools: {
        name: 'Tools & Instruments',
        icon: 'üîß',
        items: [
          {id:'multimeter',name:'Digital Multimeter',sizes:['Standard']},
          {id:'clamp-meter',name:'Clamp Meter',sizes:['Digital']},
          {id:'manometer-digital',name:'Digital Manometer',sizes:['Dual Port']},
          {id:'leak-detector',name:'Refrigerant Leak Detector',sizes:['Electronic']},
          {id:'thermometer-infrared',name:'Infrared Thermometer',sizes:['Standard']},
          {id:'vacuum-pump',name:'Vacuum Pump',sizes:['3 CFM','6 CFM']},
          {id:'tubing-cutter',name:'Tubing Cutter',sizes:['1/8"-7/8"','1/8"-1 1/8"']}
        ]
      },
      safety: {
        name: 'Safety & PPE',
        icon: 'ü¶∫',
        items: [
          {id:'safety-glasses',name:'Safety Glasses',sizes:['Clear','Tinted'],unit:'each'},
          {id:'gloves-work',name:'Work Gloves',sizes:['S','M','L','XL'],unit:'pair'},
          {id:'respirator',name:'Respirator',sizes:['Half-Face','Full-Face']},
          {id:'ear-protection',name:'Ear Protection',sizes:['Plugs','Muffs']},
          {id:'fire-extinguisher',name:'Fire Extinguisher',sizes:['5 lb ABC','10 lb ABC']},
          {id:'first-aid',name:'First Aid Kit',sizes:['Basic','Complete']}
        ]
      },
      accessories: {
        name: 'Accessories & Misc',
        icon: 'üõ†Ô∏è',
        items: [
          {id:'condenser-pad',name:'Condenser Pad',sizes:['24x24','30x30','36x36']},
          {id:'vibration-isolator',name:'Vibration Isolators',sizes:['Standard'],unit:'set'},
          {id:'line-hide',name:'Line Set Cover',sizes:['3"','4"','6"'],unit:'ft'},
          {id:'cleaning-coil',name:'Coil Cleaner',sizes:['Aerosol','1 Gallon']},
          {id:'cleaning-evap',name:'Evaporator Coil Cleaner (No-Rinse)',sizes:['Aerosol','32 oz']}
        ]
      }
    };
    function $(id) { return document.getElementById(id); }
    function showToast(message, type = 'success') {
      const toast = $('toast');
      toast.textContent = message;
      toast.className = `toast show ${type}`;
      setTimeout(() => toast.classList.remove('show'), 3000);
    }
    function showModal(title, content) {
      return new Promise((resolve) => {
        $('modal-title').textContent = title;
        $('modal-content').textContent = content;
        $('modal-overlay').classList.add('show');
        window.modalResolve = resolve;
      });
    }
    function closeModal(result) {
      $('modal-overlay').classList.remove('show');
      if (window.modalResolve) {
        window.modalResolve(result);
        window.modalResolve = null;
      }
    }
    function toggleMobileMenu() {
      const sidebar = $('sidebar');
      const overlay = $('mobile-menu-overlay');
      sidebar.classList.toggle('mobile-open');
      overlay.classList.toggle('show');
    }
    function switchPage(page) {
      currentPage = page;
      $('dashboard-page').classList.toggle('hidden', page !== 'dashboard');
      $('service-page').classList.toggle('hidden', page !== 'service');
      $('materials-page').classList.toggle('hidden', page !== 'materials');
      $('duct-design-page').classList.toggle('hidden', page !== 'duct-design');
      $('cfm-page').classList.toggle('hidden', page !== 'cfm');
      $('history-page').classList.toggle('hidden', page !== 'history');
      const titles = {dashboard:'Dashboard',service:'Service Call',materials:'Materials','duct-design':'Pro Duct Design',cfm:'CFM Calculator',history:'History & Reports'};
      $('page-title').textContent = titles[page];
      document.querySelectorAll('.nav-item').forEach((item, index) => {
        item.classList.toggle('active',(index===0&&page==='dashboard')||(index===1&&page==='service')||(index===2&&page==='materials')||(index===3&&page==='duct-design')||(index===4&&page==='cfm')||(index===5&&page==='history'));
      });
      const sidebar = $('sidebar');
      const overlay = $('mobile-menu-overlay');
      sidebar.classList.remove('mobile-open');
      overlay.classList.remove('show');
      if (page === 'history') refreshHistory();
      if (page === 'dashboard') updateDashboardStats();
    }
    function updateDashboardStats() {
      const stored = localStorage.getItem('fieldBuddyReports');
      if (stored) {
        savedReports = JSON.parse(stored);
        const thisMonth = savedReports.filter(r => {
          const rDate = new Date(r.timestamp);
          const now = new Date();
          return rDate.getMonth() === now.getMonth() && rDate.getFullYear() === now.getFullYear();
        });
        const avgQuality = savedReports.length > 0 ? savedReports.reduce((sum, r) => sum + r.quality, 0) / savedReports.length : 0;
        $('dash-stat-reports').textContent = savedReports.length;
        $('dash-stat-quality').textContent = `${Math.round(avgQuality)}%`;
        $('dash-stat-total').textContent = savedReports.length;
        $('dash-stat-month').textContent = thisMonth.length;
      }
    }
    function setCallType(type) {
      callType = type;
      $('call-trouble').classList.toggle('active', type === 'trouble');
      $('call-maintenance').classList.toggle('active', type === 'maintenance');
    }
    function setSystemMode(mode) {
      systemMode = mode;
      $('mode-cooling').classList.toggle('active', mode === 'cooling');
      $('mode-heating').classList.toggle('active', mode === 'heating');
      $('cooling-measurements').classList.toggle('hidden', mode !== 'cooling');
      $('heating-measurements').classList.toggle('hidden', mode !== 'heating');
      calculateDiagnostics();
    }
    function updateUnitFields() {
      const unitType = $('unit-type').value;
      const outdoorGroup = $('outdoor-unit-group');
      if (unitType === 'package' || unitType === 'mini-split') {
        outdoorGroup.classList.add('hidden');
      } else {
        outdoorGroup.classList.remove('hidden');
      }
    }
    function calculateQuality() {
      let score = 0;
      let basicInfo = 0;
      let diagnostics = 0;
      if ($('customer-name').value) basicInfo++;
      if ($('service-date').value) basicInfo++;
      if ($('service-address').value) basicInfo++;
      if ($('customer-complaint').value) basicInfo++;
      if ($('unit-type').value) basicInfo++;
      score += (basicInfo / 5) * 30;
      if (systemMode === 'cooling') {
        if ($('delta-t').value && $('delta-t').value !== 'N/A') diagnostics++;
        if ($('superheat').value && $('superheat').value !== 'N/A') diagnostics++;
        if ($('subcool').value && $('subcool').value !== 'N/A') diagnostics++;
      } else {
        if ($('temp-rise').value && $('temp-rise').value !== 'N/A') diagnostics++;
        if ($('manifold-pressure').value) diagnostics++;
        if ($('voltage-heat').value) diagnostics++;
      }
      score += (diagnostics / 3) * 25;
      if ($('findings').value) score += 10;
      if ($('work-performed').value) score += 10;
      score += Math.min(photos.length * 3, 15);
      if (customerSignature) score += 10;
      const finalScore = Math.round(score);
      $('quality-score-large').textContent = `${finalScore}%`;
      $('metric-basic').textContent = `${basicInfo}/5`;
      $('metric-diagnostics').textContent = `${diagnostics}/3`;
      $('metric-photos').textContent = photos.length;
      $('metric-signature').textContent = customerSignature ? '‚úì' : '‚úó';
      const badge = $('quality-badge');
      if (finalScore >= 80) {
        badge.textContent = 'Excellent';
        badge.className = 'badge badge-success';
      } else if (finalScore >= 60) {
        badge.textContent = 'Good';
        badge.className = 'badge badge-info';
      } else if (finalScore >= 40) {
        badge.textContent = 'Fair';
        badge.className = 'badge badge-warning';
      } else {
        badge.textContent = 'Incomplete';
        badge.className = 'badge badge-danger';
      }
    }
    function calculateDiagnostics() {
      if (systemMode === 'cooling') {
        calculateCoolingDiagnostics();
      } else {
        calculateHeatingDiagnostics();
      }
    }
    function getTargetSuperheat(outdoorTemp) {
      const temps = Object.keys(FIXED_ORIFICE_SUPERHEAT_TARGETS).map(Number);
      const closest = temps.reduce((prev, curr) => Math.abs(curr - outdoorTemp) < Math.abs(prev - outdoorTemp) ? curr : prev);
      return FIXED_ORIFICE_SUPERHEAT_TARGETS[closest];
    }
    function calculateCoolingDiagnostics() {
      const outdoorAmbient = parseFloat($('outdoor-ambient').value);
      const returnTemp = parseFloat($('return-temp').value);
      const supplyTemp = parseFloat($('supply-temp').value);
      const suctionPressure = parseFloat($('suction-pressure').value);
      const suctionTemp = parseFloat($('suction-temp').value);
      const liquidPressure = parseFloat($('liquid-pressure').value);
      const liquidTemp = parseFloat($('liquid-temp').value);
      const meteringDevice = $('metering-device').value;
      if (!isNaN(returnTemp) && !isNaN(supplyTemp)) {
        const deltaT = returnTemp - supplyTemp;
        $('delta-t').value = `${deltaT.toFixed(1)}¬∞F`;
        const deltaTInput = $('delta-t');
        if (deltaT < 14 || deltaT > 24) {
          deltaTInput.classList.add('warning');
        } else if (deltaT >= 16 && deltaT <= 22) {
          deltaTInput.classList.remove('warning');
          deltaTInput.classList.remove('error');
        }
      } else {
        $('delta-t').value = '';
      }
      if (!isNaN(suctionPressure) && !isNaN(suctionTemp)) {
        const satTemp = getSaturationTemp(suctionPressure);
        if (satTemp !== null) {
          const superheat = suctionTemp - satTemp;
          $('superheat').value = `${superheat.toFixed(1)}¬∞F`;
          const superheatInput = $('superheat');
          if (meteringDevice === 'txv') {
            if (superheat < 8 || superheat > 15) {
              superheatInput.classList.add('warning');
            } else {
              superheatInput.classList.remove('warning');
            }
          } else if (meteringDevice === 'piston' && !isNaN(outdoorAmbient)) {
            const targetSH = getTargetSuperheat(outdoorAmbient);
            if (Math.abs(superheat - targetSH) > 5) {
              superheatInput.classList.add('warning');
            } else {
              superheatInput.classList.remove('warning');
            }
          }
        }
      } else {
        $('superheat').value = '';
      }
      if (!isNaN(liquidPressure) && !isNaN(liquidTemp)) {
        const satTemp = getSaturationTemp(liquidPressure);
        if (satTemp !== null) {
          const subcool = satTemp - liquidTemp;
          $('subcool').value = `${subcool.toFixed(1)}¬∞F`;
          const subcoolInput = $('subcool');
          if (subcool < 8 || subcool > 12) {
            subcoolInput.classList.add('warning');
          } else {
            subcoolInput.classList.remove('warning');
          }
        }
      } else {
        $('subcool').value = '';
      }
      runDiagnosticAnalysis();
      updatePressureChart();
      calculateQuality();
    }
    function calculateHeatingDiagnostics() {
      const returnTemp = parseFloat($('return-temp-heat').value);
      const supplyTemp = parseFloat($('supply-temp-heat').value);
      const manifoldPressure = parseFloat($('manifold-pressure').value);
      const gasType = $('gas-type').value;
      if (!isNaN(returnTemp) && !isNaN(supplyTemp)) {
        const tempRise = supplyTemp - returnTemp;
        $('temp-rise').value = `${tempRise.toFixed(1)}¬∞F`;
        const tempRiseInput = $('temp-rise');
        if (tempRise < 35 || tempRise > 65) {
          tempRiseInput.classList.add('warning');
        } else {
          tempRiseInput.classList.remove('warning');
        }
      } else {
        $('temp-rise').value = '';
      }
      if (!isNaN(manifoldPressure)) {
        const manifoldInput = $('manifold-pressure');
        if (gasType === 'natural') {
          if (manifoldPressure < 3.3 || manifoldPressure > 3.8) {
            manifoldInput.classList.add('warning');
          } else {
            manifoldInput.classList.remove('warning');
          }
        } else {
          if (manifoldPressure < 10 || manifoldPressure > 11) {
            manifoldInput.classList.add('warning');
          } else {
            manifoldInput.classList.remove('warning');
          }
        }
      }
      runDiagnosticAnalysis();
      updateHeatingChart();
      calculateQuality();
    }
    function getSaturationTemp(pressure) {
      const pressures = Object.keys(R410A_PT).map(Number);
      const closest = pressures.reduce((prev, curr) => Math.abs(curr - pressure) < Math.abs(prev - pressure) ? curr : prev);
      return R410A_PT[closest];
    }
    function runDiagnosticAnalysis() {
      diagnosticResults = [];
      if (systemMode === 'cooling') {
        const deltaT = parseFloat($('delta-t').value);
        const superheat = parseFloat($('superheat').value);
        const subcool = parseFloat($('subcool').value);
        const staticPressure = parseFloat($('static-pressure').value);
        const meteringDevice = $('metering-device').value;
        const outdoorAmbient = parseFloat($('outdoor-ambient').value);
        const rlaRating = parseFloat($('rla-rating').value);
        const amperage = parseFloat($('amperage').value);
        if (!isNaN(deltaT)) {
          if (deltaT < 14) {
            diagnosticResults.push({
              severity: 'danger',
              title: 'Low Delta-T Detected - Insufficient Cooling',
              message: `Delta-T is ${deltaT.toFixed(1)}¬∞F (Expected: 16-22¬∞F)`,
              recommendations: ['Check and replace air filter immediately','Inspect evaporator coil for dirt/restrictions','Verify blower motor operation and speed settings','Check for closed or blocked supply vents','Measure total external static pressure','Verify ductwork is properly sized']
            });
          } else if (deltaT >= 16 && deltaT <= 22) {
            diagnosticResults.push({
              severity: 'success',
              title: 'Delta-T in Optimal Range',
              message: `Delta-T is ${deltaT.toFixed(1)}¬∞F - Airflow is within specifications`
            });
          } else if (deltaT > 24) {
            diagnosticResults.push({
              severity: 'danger',
              title: 'High Delta-T - Severe Airflow Restriction',
              message: `Delta-T is ${deltaT.toFixed(1)}¬∞F (Expected: 16-22¬∞F)`,
              recommendations: ['CRITICAL: Replace air filter immediately','Inspect ductwork for collapsed/crushed sections','Check blower speed - may be set too low','Verify return air pathway is adequate','Check for undersized ductwork','Measure ESP - likely exceeding 0.50 in w.c.']
            });
          }
        }
        if (!isNaN(staticPressure)) {
          if (staticPressure > 0.7) {
            diagnosticResults.push({
              severity: 'danger',
              title: 'Excessive Static Pressure - System Stress',
              message: `Static pressure is ${staticPressure.toFixed(2)} in w.c. (Max: 0.50 for residential)`,
              recommendations: ['URGENT: Replace filter and verify improvement','Inspect ductwork for restrictions/damage','Verify proper duct sizing using Manual D','Check for closed dampers in trunk lines','Consider duct system redesign if oversized equipment','Monitor blower motor amperage - may be overloaded']
            });
          } else if (staticPressure <= 0.5) {
            diagnosticResults.push({
              severity: 'success',
              title: 'Static Pressure Acceptable',
              message: `Static pressure is ${staticPressure.toFixed(2)} in w.c. - within specifications`
            });
          }
        }
        if (!isNaN(superheat) && !isNaN(subcool)) {
          if (meteringDevice === 'txv') {
            if (superheat > 20 && subcool < 8) {
              diagnosticResults.push({
                severity: 'danger',
                title: 'System Undercharged - Refrigerant Loss Detected',
                message: `Superheat: ${superheat.toFixed(1)}¬∞F, Subcool: ${subcool.toFixed(1)}¬∞F`,
                recommendations: ['Perform thorough leak detection on evaporator coil','Check all brazed joints for leaks','Inspect line set connections at both ends','Check service valve cores for leaks','Verify filter drier is not restricted','After leak repair, evacuate and recharge by weight','Verify charge using subcooling method (target: 8-12¬∞F)']
              });
            } else if (superheat < 5 && subcool > 15) {
              diagnosticResults.push({
                severity: 'warning',
                title: 'System May Be Overcharged',
                message: `Superheat: ${superheat.toFixed(1)}¬∞F, Subcool: ${subcool.toFixed(1)}¬∞F`,
                recommendations: ['Verify charge was not added incorrectly','Check for non-condensables in system','Ensure condenser has adequate airflow','Verify condenser coil is clean','Consider recovering excess refrigerant','Re-verify charge using manufacturer specs']
              });
            } else if (superheat >= 8 && superheat <= 15 && subcool >= 8 && subcool <= 12) {
              diagnosticResults.push({
                severity: 'success',
                title: 'Refrigerant Charge Correct (TXV System)',
                message: `Superheat: ${superheat.toFixed(1)}¬∞F, Subcool: ${subcool.toFixed(1)}¬∞F - within TXV system specifications`
              });
            } else if (superheat > 25 && subcool >= 8) {
              diagnosticResults.push({
                severity: 'danger',
                title: 'TXV Malfunction Suspected',
                message: `High superheat (${superheat.toFixed(1)}¬∞F) with normal subcool indicates TXV not opening properly`,
                recommendations: ['Check TXV sensing bulb placement and contact','Verify bulb is properly insulated','Inspect for kinked liquid line before TXV','Check for clogged filter drier or strainer','Verify TXV is correct tonnage for system','Consider TXV replacement if other checks pass']
              });
            }
          } else if (meteringDevice === 'piston' && !isNaN(outdoorAmbient)) {
            const targetSH = getTargetSuperheat(outdoorAmbient);
            const shDifference = Math.abs(superheat - targetSH);
            if (shDifference > 5) {
              if (superheat > targetSH) {
                diagnosticResults.push({
                  severity: 'warning',
                  title: 'Refrigerant Charge Low (Fixed Orifice System)',
                  message: `Superheat: ${superheat.toFixed(1)}¬∞F (Target: ${targetSH}¬∞F at ${outdoorAmbient}¬∞F outdoor) | Subcool: ${subcool.toFixed(1)}¬∞F`,
                  recommendations: ['Perform leak check before adding refrigerant','Use superheat method for charge verification','Add refrigerant in small increments','Monitor both superheat and subcool while charging','Target superheat varies with outdoor temperature','Re-check after system stabilizes (15-20 minutes)']
                });
              } else {
                diagnosticResults.push({
                  severity: 'warning',
                  title: 'Possible Overcharge (Fixed Orifice System)',
                  message: `Superheat: ${superheat.toFixed(1)}¬∞F (Target: ${targetSH}¬∞F at ${outdoorAmbient}¬∞F outdoor) | Subcool: ${subcool.toFixed(1)}¬∞F`,
                  recommendations: ['Verify outdoor ambient temperature is correct','Check for restricted airflow across evaporator','Consider recovering small amount of refrigerant','Monitor head pressure - may be elevated','Re-verify charge using manufacturer chart']
                });
              }
            } else {
              diagnosticResults.push({
                severity: 'success',
                title: 'Refrigerant Charge Correct (Fixed Orifice)',
                message: `Superheat: ${superheat.toFixed(1)}¬∞F (Target: ${targetSH}¬∞F at ${outdoorAmbient}¬∞F outdoor) - charge is accurate`
              });
            }
          }
        }
        if (!isNaN(amperage) && !isNaN(rlaRating)) {
          const amperagePercent = (amperage / rlaRating) * 100;
          if (amperagePercent > 110) {
            diagnosticResults.push({
              severity: 'danger',
              title: 'Compressor Drawing Excessive Current',
              message: `Running at ${amperagePercent.toFixed(0)}% of RLA (${amperage.toFixed(1)}A / ${rlaRating.toFixed(1)}A rated)`,
              recommendations: ['Check supply voltage - low voltage increases amperage','Verify capacitor is within spec','Check for refrigerant overcharge','Inspect for restricted airflow (high head pressure)','Monitor compressor for overheating','May indicate failing compressor']
            });
          }
        }
      } else {
        const tempRise = parseFloat($('temp-rise').value);
        const manifoldPressure = parseFloat($('manifold-pressure').value);
        const gasType = $('gas-type').value;
        if (!isNaN(tempRise)) {
          if (tempRise < 35) {
            diagnosticResults.push({
              severity: 'danger',
              title: 'Low Temperature Rise - Insufficient Heating',
              message: `Temp rise is ${tempRise.toFixed(1)}¬∞F (Expected: 35-65¬∞F)`,
              recommendations: ['Check gas input - verify manifold pressure','Inspect burners for proper flame pattern','Check for excessive airflow (blower speed too high)','Verify all burners are igniting','Check gas valve for proper operation','Verify orifice size matches gas type']
            });
          } else if (tempRise > 65) {
            diagnosticResults.push({
              severity: 'danger',
              title: 'High Temperature Rise - Airflow Restriction',
              message: `Temp rise is ${tempRise.toFixed(1)}¬∞F (Expected: 35-65¬∞F)`,
              recommendations: ['CRITICAL: Check airflow restriction immediately','Replace air filter','Verify blower speed is correct','Inspect heat exchanger for restrictions','Check limit switches - may be cycling','High temp rise can crack heat exchanger']
            });
          } else {
            diagnosticResults.push({
              severity: 'success',
              title: 'Temperature Rise in Range',
              message: `Temp rise is ${tempRise.toFixed(1)}¬∞F - heating output is correct`
            });
          }
        }
        if (!isNaN(manifoldPressure)) {
          if (gasType === 'natural') {
            if (manifoldPressure < 3.3 || manifoldPressure > 3.8) {
              diagnosticResults.push({
                severity: 'warning',
                title: 'Manifold Pressure Out of Range (Natural Gas)',
                message: `Manifold pressure is ${manifoldPressure.toFixed(2)} in w.c. (Expected: 3.3-3.8)`,
                recommendations: ['Adjust gas valve regulator','Check incoming gas supply pressure','Verify regulator is not failed','Ensure proper orifice size installed','Consult furnace specifications']
              });
            } else {
              diagnosticResults.push({
                severity: 'success',
                title: 'Manifold Pressure Correct (Natural Gas)',
                message: `Manifold pressure is ${manifoldPressure.toFixed(2)} in w.c.`
              });
            }
          } else {
            if (manifoldPressure < 10 || manifoldPressure > 11) {
              diagnosticResults.push({
                severity: 'warning',
                title: 'Manifold Pressure Out of Range (LP/Propane)',
                message: `Manifold pressure is ${manifoldPressure.toFixed(2)} in w.c. (Expected: 10-11)`,
                recommendations: ['Adjust gas valve regulator for LP operation','Verify LP orifices are installed (smaller than NG)','Check LP supply tank pressure','Ensure conversion kit was properly installed','Consult manufacturer LP conversion specs']
              });
            } else {
              diagnosticResults.push({
                severity: 'success',
                title: 'Manifold Pressure Correct (LP)',
                message: `Manifold pressure is ${manifoldPressure.toFixed(2)} in w.c.`
              });
            }
          }
        }
      }
      displayDiagnosticResults();
    }
    function displayDiagnosticResults() {
      const container = $('diagnostic-results');
      if (diagnosticResults.length === 0) {
        container.classList.add('hidden');
        return;
      }
      container.classList.remove('hidden');
      let html = '<div class="diagnostic-panel">';
      html += '<div class="diagnostic-header">üéØ Master Tech Diagnostic Analysis</div>';
      diagnosticResults.forEach(result => {
        html += '<div class="diagnostic-card">';
        html += '<div class="diagnostic-card-header">';
        html += `<div class="diagnostic-card-title">${result.title}</div>`;
        html += `<span class="badge badge-${result.severity}">${result.severity}</span>`;
        html += '</div>';
        html += `<p style="margin-bottom: 8px; color: var(--text-secondary);">${result.message}</p>`;
        if (result.recommendations && result.recommendations.length > 0) {
          html += '<div class="diagnostic-recommendations">';
          html += '<strong style="font-size: 12px; color: var(--text-primary);">Recommended Actions:</strong>';
          html += '<ul>';
          result.recommendations.forEach(rec => {
            html += `<li>${rec}</li>`;
          });
          html += '</ul>';
          html += '</div>';
        }
        html += '</div>';
      });
      html += '</div>';
      container.innerHTML = html;
    }
    function updatePressureChart() {
      const ctx = $('pressure-chart');
      if (!ctx) return;
      const suctionPressure = parseFloat($('suction-pressure').value) || 0;
      const liquidPressure = parseFloat($('liquid-pressure').value) || 0;
      if (pressureChart) {
        pressureChart.data.datasets[0].data = [suctionPressure, liquidPressure];
        pressureChart.update();
      } else {
        pressureChart = new Chart(ctx.getContext('2d'), {
          type: 'bar',
          data: {
            labels: ['Suction', 'Liquid'],
            datasets: [{
              label: 'Pressure (PSI)',
              data: [suctionPressure, liquidPressure],
              backgroundColor: ['rgba(0,229,255,0.2)', 'rgba(255,87,34,0.2)'],
              borderColor: ['rgb(0,229,255)', 'rgb(255,87,34)'],
              borderWidth: 2
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              y: {
                beginAtZero: true,
                title: { display: true, text: 'Pressure (PSI)', color: '#CBD5E1' },
                ticks: { color: '#CBD5E1' },
                grid: { color: 'rgba(203, 213, 225, 0.1)' }
              },
              x: {
                ticks: { color: '#CBD5E1' },
                grid: { color: 'rgba(203, 213, 225, 0.1)' }
              }
            },
            plugins: {
              title: { display: true, text: 'Refrigerant Pressures', color: '#F8FAFC' },
              legend: { display: false }
            }
          }
        });
      }
    }
    function updateHeatingChart() {
      const ctx = $('heating-chart');
      if (!ctx) return;
      const returnTemp = parseFloat($('return-temp-heat').value) || 0;
      const supplyTemp = parseFloat($('supply-temp-heat').value) || 0;
      if (heatingChart) {
        heatingChart.data.datasets[0].data = [returnTemp, supplyTemp];
        heatingChart.update();
      } else {
        heatingChart = new Chart(ctx.getContext('2d'), {
          type: 'bar',
          data: {
            labels: ['Return', 'Supply'],
            datasets: [{
              label: 'Temperature (¬∞F)',
              data: [returnTemp, supplyTemp],
              backgroundColor: ['rgba(59,130,246,0.2)', 'rgba(255,87,34,0.2)'],
              borderColor: ['rgb(59,130,246)', 'rgb(255,87,34)'],
              borderWidth: 2
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              y: {
                beginAtZero: true,
                title: { display: true, text: 'Temperature (¬∞F)', color: '#CBD5E1' },
                ticks: { color: '#CBD5E1' },
                grid: { color: 'rgba(203, 213, 225, 0.1)' }
              },
              x: {
                ticks: { color: '#CBD5E1' },
                grid: { color: 'rgba(203, 213, 225, 0.1)' }
              }
            },
            plugins: {
              title: { display: true, text: 'Air Temperatures', color: '#F8FAFC' },
              legend: { display: false }
            }
          }
        });
      }
    }
    function handlePhotos(e) {
      Array.from(e.target.files).forEach(file => {
        const reader = new FileReader();
        reader.onload = (ev) => {
          photos.push({
            data: ev.target.result,
            name: file.name,
            timestamp: new Date().toISOString()
          });
          displayPhotos();
          calculateQuality();
          showToast(`Photo "${file.name}" added`);
        };
        reader.readAsDataURL(file);
      });
      e.target.value = '';
    }
    function displayPhotos() {
      const gallery = $('photo-gallery');
      let html = '<label class="photo-upload"><input type="file" accept="image/*" capture="camera" multiple onchange="handlePhotos(event)" style="display:none"><span style="font-size: 32px;">üì∑</span><span>Add Photo</span></label>';
      photos.forEach((photo, i) => {
        html += `<div class="photo-item">`;
        html += `<img src="${photo.data}" onclick="viewPhoto(${i})">`;
        html += `<div class="photo-item-actions">`;
        html += `<button class="photo-btn" onclick="deletePhoto(${i}); event.stopPropagation();">üóëÔ∏è</button>`;
        html += `</div>`;
        html += `</div>`;
      });
      gallery.innerHTML = html;
      $('photo-count').textContent = `${photos.length} photo${photos.length !== 1 ? 's' : ''}`;
    }
    function viewPhoto(index) {
      window.open(photos[index].data);
    }
    function deletePhoto(index) {
      photos.splice(index, 1);
      displayPhotos();
      calculateQuality();
      showToast('Photo deleted');
    }
    function initSignature() {
      const canvas = $('signature-pad');
      if (!canvas) return;
      signaturePad = new SignaturePad(canvas, {
        backgroundColor: 'rgb(34, 43, 66)',
        penColor: 'rgb(0, 229, 255)'
      });
      function resize() {
        const ratio = Math.max(window.devicePixelRatio || 1, 1);
        canvas.width = canvas.offsetWidth * ratio;
        canvas.height = canvas.offsetHeight * ratio;
        canvas.getContext('2d').scale(ratio, ratio);
        if (customerSignature) {
          const img = new Image();
          img.onload = () => signaturePad.fromDataURL(customerSignature);
          img.src = customerSignature;
        }
      }
      window.addEventListener('resize', resize);
      resize();
    }
    function clearSignature() {
      if (signaturePad) {
        signaturePad.clear();
        customerSignature = null;
        calculateQuality();
        showToast('Signature cleared');
      }
    }
    function saveSignature() {
      if (!signaturePad || signaturePad.isEmpty()) {
        showToast('Please provide a signature first', 'danger');
        return;
      }
      customerSignature = signaturePad.toDataURL();
      calculateQuality();
      showToast('Signature saved!');
    }
    function generatePDF() {
      const quality = parseInt($('quality-score-large').textContent);
      if (quality < 40) {
        showToast('Please complete more information before generating PDF', 'warning');
        return;
      }
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      let y = 20;
      doc.setFontSize(20);
      doc.setTextColor(0, 229, 255);
      doc.text('HVAC Service Report', 105, y, { align: 'center' });
      y += 15;
      doc.setFontSize(12);
      doc.setTextColor(0, 0, 0);
      doc.text(`Customer: ${$('customer-name').value || 'N/A'}`, 20, y);
      y += 7;
      doc.text(`Date: ${$('service-date').value || 'N/A'}`, 20, y);
      y += 7;
      doc.text(`Address: ${$('service-address').value || 'N/A'}`, 20, y);
      y += 7;
      doc.text(`Call Type: ${callType === 'trouble' ? 'Trouble Call' : 'Maintenance'}`, 20, y);
      y += 7;
      doc.text(`System Mode: ${systemMode === 'cooling' ? 'Cooling' : 'Heating'}`, 20, y);
      y += 10;
      doc.setFontSize(14);
      doc.setTextColor(0, 229, 255);
      doc.text('Equipment Information', 20, y);
      y += 7;
      doc.setFontSize(10);
      doc.setTextColor(0, 0, 0);
      doc.text(`Unit Type: ${$('unit-type').value || 'N/A'}`, 20, y);
      y += 5;
      doc.text(`Indoor Unit: ${$('indoor-unit').value || 'N/A'}`, 20, y);
      y += 5;
      doc.text(`Outdoor Unit: ${$('outdoor-unit').value || 'N/A'}`, 20, y);
      y += 5;
      doc.text(`Tonnage: ${$('tonnage').value || 'N/A'}`, 20, y);
      y += 10;
      doc.setFontSize(14);
      doc.setTextColor(0, 229, 255);
      doc.text('Diagnostic Readings', 20, y);
      y += 7;
      doc.setFontSize(10);
      doc.setTextColor(0, 0, 0);
      if (systemMode === 'cooling') {
        doc.text(`Delta-T: ${$('delta-t').value || 'N/A'}`, 20, y);
        y += 5;
        doc.text(`Superheat: ${$('superheat').value || 'N/A'}`, 20, y);
        y += 5;
        doc.text(`Subcool: ${$('subcool').value || 'N/A'}`, 20, y);
        y += 5;
      } else {
        doc.text(`Temp Rise: ${$('temp-rise').value || 'N/A'}`, 20, y);
        y += 5;
        doc.text(`Manifold Pressure: ${$('manifold-pressure').value || 'N/A'}`, 20, y);
        y += 5;
      }
      y += 5;
      doc.setFontSize(14);
      doc.setTextColor(0, 229, 255);
      doc.text('Findings & Work Performed', 20, y);
      y += 7;
      doc.setFontSize(10);
      doc.setTextColor(0, 0, 0);
      const findings = doc.splitTextToSize($('findings').value || 'None recorded', 170);
      doc.text(findings, 20, y);
      y += findings.length * 5 + 5;
      const workPerformed = doc.splitTextToSize($('work-performed').value || 'None recorded', 170);
      doc.text(workPerformed, 20, y);
      y += workPerformed.length * 5 + 10;
      if (customerSignature) {
        doc.addImage(customerSignature, 'PNG', 20, y, 80, 30);
        y += 35;
        doc.text(`Signed by: ${$('sig-name').value || 'N/A'}`, 20, y);
      }
      doc.save(`Service_Report_${$('customer-name').value || 'Customer'}_${new Date().toISOString().slice(0, 10)}.pdf`);
      showToast('PDF generated successfully!');
    }
    function generateTextReport() {
      let report = '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n';
      report += '       HVAC SERVICE REPORT\n';
      report += '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\n';
      report += `Customer: ${$('customer-name').value || 'N/A'}\n`;
      report += `Date: ${$('service-date').value || 'N/A'}\n`;
      report += `Address: ${$('service-address').value || 'N/A'}\n`;
      report += `Call Type: ${callType === 'trouble' ? 'Trouble Call' : 'Maintenance'}\n`;
      report += `System Mode: ${systemMode === 'cooling' ? 'Cooling' : 'Heating'}\n\n`;
      report += '‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n';
      report += 'EQUIPMENT INFORMATION\n';
      report += '‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n';
      report += `Unit Type: ${$('unit-type').value || 'N/A'}\n`;
      report += `Indoor Unit: ${$('indoor-unit').value || 'N/A'}\n`;
      report += `Outdoor Unit: ${$('outdoor-unit').value || 'N/A'}\n`;
      report += `Tonnage: ${$('tonnage').value || 'N/A'}\n`;
      report += `Refrigerant: ${$('refrigerant-type').value || 'N/A'}\n\n`;
      report += '‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n';
      report += 'DIAGNOSTIC READINGS\n';
      report += '‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n';
      if (systemMode === 'cooling') {
        report += `Delta-T: ${$('delta-t').value || 'N/A'}\n`;
        report += `Superheat: ${$('superheat').value || 'N/A'}\n`;
        report += `Subcool: ${$('subcool').value || 'N/A'}\n`;
        report += `Suction Pressure: ${$('suction-pressure').value || 'N/A'} PSI\n`;
        report += `Liquid Pressure: ${$('liquid-pressure').value || 'N/A'} PSI\n`;
      } else {
        report += `Temp Rise: ${$('temp-rise').value || 'N/A'}\n`;
        report += `Manifold Pressure: ${$('manifold-pressure').value || 'N/A'} in w.c.\n`;
      }
      report += '\n‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n';
      report += 'FINDINGS\n';
      report += '‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n';
      report += $('findings').value || 'None recorded\n';
      report += '\n‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n';
      report += 'WORK PERFORMED\n';
      report += '‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n';
      report += $('work-performed').value || 'None recorded\n';
      report += '\n‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n';
      report += `Technician: ${$('tech-name').value}\n`;
      report += `Contact: ${$('tech-phone').value}\n`;
      report += '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n';
      const blob = new Blob([report], { type: 'text/plain' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `Service_Report_${$('customer-name').value || 'Customer'}_${new Date().toISOString().slice(0, 10)}.txt`;
      a.click();
      showToast('Text report generated!');
    }
    function clearForm() {
      if (confirm('Clear all form data? This cannot be undone.')) {
        document.querySelectorAll('#service-page input, #service-page textarea, #service-page select').forEach(el => {
          if (el.type === 'text' || el.type === 'number' || el.type === 'date' || el.type === 'tel' || el.type === 'email') {
            if (el.id !== 'tech-name' && el.id !== 'tech-phone' && el.id !== 'tech-email') {
              el.value = '';
            }
          } else if (el.tagName === 'TEXTAREA') {
            el.value = '';
          } else if (el.tagName === 'SELECT') {
            el.selectedIndex = 0;
          }
        });
        photos = [];
        displayPhotos();
        clearSignature();
        diagnosticResults = [];
        displayDiagnosticResults();
        calculateQuality();
        showToast('Form cleared');
      }
    }
    function renderMaterialsCatalog() {
      const container = $('materials-catalog');
      let html = '';
      Object.entries(materialsCatalog).forEach(([catKey, category]) => {
        const selectedCount = selectedMaterials.filter(m => m.categoryKey === catKey).length;
        const isExpanded = categoryStates[catKey] || false;
        html += `<div class="materials-category ${isExpanded ? 'expanded' : ''}" data-category="${catKey}">`;
        html += `<div class="category-header" onclick="toggleCategory('${catKey}')">`;
        html += `<div class="category-title-group">`;
        html += `<span class="category-icon">${category.icon}</span>`;
        html += `<span class="category-name">${category.name}</span>`;
        html += `</div>`;
        html += `<div class="category-meta">`;
        html += `<span class="category-count">${category.items.length} items</span>`;
        if (selectedCount > 0) {
          html += `<span class="category-selected">${selectedCount} selected</span>`;
        }
        html += `<span class="category-arrow">‚ñº</span>`;
        html += `</div>`;
        html += `</div>`;
        html += `<div class="category-items">`;
        category.items.forEach(item => {
          html += `<div class="material-item" data-item-id="${item.id}">`;
          html += `<div class="material-item-header">`;
          html += `<div class="material-info">`;
          html += `<div class="material-name">${item.name}</div>`;
          if (item.spec) {
            html += `<div class="material-spec">${item.spec}</div>`;
          }
          html += `</div>`;
          html += `</div>`;
          html += `<div class="material-size-selector">`;
          item.sizes.forEach(size => {
            const existingItem = selectedMaterials.find(m => m.id === item.id && m.size === size);
            const qty = existingItem ? existingItem.quantity : 0;
            html += `<button class="size-btn ${qty > 0 ? 'selected' : ''}" onclick="toggleMaterial('${catKey}', '${item.id}', '${item.name}', '${size}', '${item.unit || 'ea'}')">`;
            html += `${size}${item.unit ? ' ' + item.unit : ''}`;
            if (qty > 0) {
              html += `<span class="qty-badge">${qty}</span>`;
            }
            html += `</button>`;
          });
          html += `</div>`;
          html += `</div>`;
        });
        html += `</div>`;
        html += `</div>`;
      });
      container.innerHTML = html;
    }
    function toggleCategory(catKey) {
      categoryStates[catKey] = !categoryStates[catKey];
      renderMaterialsCatalog();
    }
    function expandAllCategories() {
      Object.keys(materialsCatalog).forEach(key => categoryStates[key] = true);
      renderMaterialsCatalog();
    }
    function collapseAllCategories() {
      Object.keys(materialsCatalog).forEach(key => categoryStates[key] = false);
      renderMaterialsCatalog();
    }
    function toggleMaterial(categoryKey, id, name, size, unit) {
      const index = selectedMaterials.findIndex(m => m.id === id && m.size === size);
      if (index > -1) {
        selectedMaterials.splice(index, 1);
      } else {
        selectedMaterials.push({
          categoryKey,
          id,
          name,
          size,
          unit,
          quantity: 1
        });
      }
      renderMaterialsCatalog();
      displaySelectedMaterials();
    }
    function displaySelectedMaterials() {
      const container = $('selected-materials');
      if (selectedMaterials.length === 0) {
        container.innerHTML = '<div class="status-card info">‚ÑπÔ∏è No materials selected yet. Click size buttons to add materials to your list. You can add multiple sizes of the same item!</div>';
        $('selected-materials-count').textContent = '0 items';
        return;
      }
      let html = '';
      selectedMaterials.forEach((item, index) => {
        html += `<div class="selected-material">`;
        html += `<div class="selected-material-info">`;
        html += `<span class="selected-material-size">${item.size}</span>`;
        html += `<span style="flex: 1;">${item.name}</span>`;
        html += `</div>`;
        html += `<div class="selected-material-controls">`;
        html += `<div class="qty-control">`;
        html += `<button class="qty-btn" onclick="updateMaterialQty(${index}, -1)">‚àí</button>`;
        html += `<input type="number" min="1" value="${item.quantity}" onchange="setMaterialQty(${index}, this.value)" style="width: 60px;">`;
        html += `<button class="qty-btn" onclick="updateMaterialQty(${index}, 1)">+</button>`;
        html += `</div>`;
        html += `<button class="btn btn-danger btn-sm" onclick="removeMaterial(${index})" style="padding: 8px 12px;">üóëÔ∏è</button>`;
        html += `</div>`;
        html += `</div>`;
      });
      container.innerHTML = html;
      $('selected-materials-count').textContent = `${selectedMaterials.length} item${selectedMaterials.length !== 1 ? 's' : ''}`;
    }
    function updateMaterialQty(index, delta) {
      selectedMaterials[index].quantity = Math.max(1, selectedMaterials[index].quantity + delta);
      displaySelectedMaterials();
      renderMaterialsCatalog();
    }
    function setMaterialQty(index, value) {
      const qty = parseInt(value);
      if (qty >= 1) {
        selectedMaterials[index].quantity = qty;
        displaySelectedMaterials();
        renderMaterialsCatalog();
      }
    }
    function removeMaterial(index) {
      selectedMaterials.splice(index, 1);
      displaySelectedMaterials();
      renderMaterialsCatalog();
    }
    function filterMaterials() {
      const search = $('material-search').value.toLowerCase();
      document.querySelectorAll('.material-item').forEach(item => {
        const text = item.textContent.toLowerCase();
        item.style.display = text.includes(search) ? '' : 'none';
      });
    }
    function generateMaterialsPDF() {
      if (selectedMaterials.length === 0) {
        showToast('Please select materials first', 'warning');
        return;
      }
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      let y = 20;
      doc.setFontSize(20);
      doc.setTextColor(0, 229, 255);
      doc.text('Materials List', 105, y, { align: 'center' });
      y += 15;
      doc.setFontSize(12);
      doc.setTextColor(0, 0, 0);
      doc.text(`Customer/Job: ${$('mat-customer').value || 'N/A'}`, 20, y);
      y += 7;
      doc.text(`Date: ${$('mat-date').value || 'N/A'}`, 20, y);
      y += 7;
      doc.text(`Address: ${$('mat-address').value || 'N/A'}`, 20, y);
      y += 15;
      doc.setFontSize(14);
      doc.setTextColor(0, 229, 255);
      doc.text('Materials', 20, y);
      y += 10;
      doc.setFontSize(10);
      doc.setTextColor(0, 0, 0);
      selectedMaterials.forEach((item, i) => {
        if (y > 270) {
          doc.addPage();
          y = 20;
        }
        doc.text(`${i + 1}. ${item.name} - ${item.size} (Qty: ${item.quantity})`, 20, y);
        y += 6;
      });
      y += 10;
      doc.setFontSize(10);
      doc.text(`Technician: ${$('mat-tech-name').value}`, 20, y);
      y += 5;
      doc.text(`Contact: ${$('mat-tech-phone').value}`, 20, y);
      doc.save(`Materials_${$('mat-customer').value || 'Customer'}_${new Date().toISOString().slice(0, 10)}.pdf`);
      showToast('Materials PDF generated!');
    }
    function generateMaterialsReport() {
      if (selectedMaterials.length === 0) {
        showToast('Please select materials first', 'warning');
        return;
      }
      let report = '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n';
      report += '          MATERIALS LIST\n';
      report += '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\n';
      report += `Customer/Job: ${$('mat-customer').value || 'N/A'}\n`;
      report += `Date: ${$('mat-date').value || 'N/A'}\n`;
      report += `Address: ${$('mat-address').value || 'N/A'}\n\n`;
      report += '‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n';
      report += 'MATERIALS\n';
      report += '‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n';
      selectedMaterials.forEach((item, i) => {
        report += `${i + 1}. ${item.name}\n`;
        report += `   Size: ${item.size}\n`;
        report += `   Quantity: ${item.quantity} ${item.unit}\n\n`;
      });
      report += '‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n';
      report += `Total Items: ${selectedMaterials.length}\n`;
      report += `Technician: ${$('mat-tech-name').value}\n`;
      report += `Contact: ${$('mat-tech-phone').value}\n`;
      report += '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n';
      const blob = new Blob([report], { type: 'text/plain' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `Materials_${$('mat-customer').value || 'Customer'}_${new Date().toISOString().slice(0, 10)}.txt`;
      a.click();
      showToast('Materials list generated!');
    }
    function clearMaterialsForm() {
      if (confirm('Clear all materials data?')) {
        $('mat-customer').value = '';
        $('mat-date').value = '';
        $('mat-address').value = '';
        $('mat-notes').value = '';
        selectedMaterials = [];
        displaySelectedMaterials();
        renderMaterialsCatalog();
        showToast('Materials form cleared');
      }
    }
    function saveData() {
      const data = {
        timestamp: new Date().toISOString(),
        quality: parseInt($('quality-score-large').textContent),
        serviceData: {
          callType,
          systemMode,
          customerName: $('customer-name').value,
          serviceDate: $('service-date').value,
          serviceAddress: $('service-address').value,
          customerComplaint: $('customer-complaint').value,
          unitType: $('unit-type').value,
          indoorUnit: $('indoor-unit').value,
          outdoorUnit: $('outdoor-unit').value,
          tonnage: $('tonnage').value,
          refrigerantType: $('refrigerant-type').value,
          findings: $('findings').value,
          workPerformed: $('work-performed').value,
          recommendations: $('recommendations').value
        },
        diagnostics: {
          cooling: systemMode === 'cooling' ? {
            outdoorAmbient: $('outdoor-ambient').value,
            returnTemp: $('return-temp').value,
            supplyTemp: $('supply-temp').value,
            deltaT: $('delta-t').value,
            suctionPressure: $('suction-pressure').value,
            liquidPressure: $('liquid-pressure').value,
            superheat: $('superheat').value,
            subcool: $('subcool').value
          } : null,
          heating: systemMode === 'heating' ? {
            returnTemp: $('return-temp-heat').value,
            supplyTemp: $('supply-temp-heat').value,
            tempRise: $('temp-rise').value,
            manifoldPressure: $('manifold-pressure').value
          } : null
        },
        photos: photos,
        signature: customerSignature
      };
      savedReports.push(data);
      localStorage.setItem('fieldBuddyReports', JSON.stringify(savedReports));
      showToast('Progress saved successfully!');
      updateDashboardStats();
    }
    function loadData() {
      const stored = localStorage.getItem('fieldBuddyReports');
      if (stored) {
        savedReports = JSON.parse(stored);
        showToast(`Loaded ${savedReports.length} saved report(s)`);
        updateDashboardStats();
      } else {
        showToast('No saved data found', 'info');
      }
    }
    function exportAllData() {
      const allData = {
        reports: savedReports,
        exportDate: new Date().toISOString(),
        version: '4.0'
      };
      const blob = new Blob([JSON.stringify(allData, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `FieldBuddyPro_Export_${new Date().toISOString().slice(0, 10)}.json`;
      a.click();
      showToast('Data exported successfully!');
    }
    function refreshHistory() {
      const stored = localStorage.getItem('fieldBuddyReports');
      if (stored) {
        savedReports = JSON.parse(stored);
      }
      const container = $('history-list');
      if (savedReports.length === 0) {
        container.innerHTML = '<div class="status-card info">‚ÑπÔ∏è No saved reports yet. Complete a service call and save your progress to see history here.</div>';
        $('stat-total').textContent = '0';
        $('stat-this-month').textContent = '0';
        $('stat-avg-quality').textContent = '0%';
        $('stat-photos').textContent = '0';
        return;
      }
      let html = '';
      savedReports.reverse().forEach((report, i) => {
        const date = new Date(report.timestamp);
        html += `<div class="card" style="margin-bottom: 16px;">`;
        html += `<div class="card-header">`;
        html += `<div class="card-title">${report.serviceData.customerName || 'Unnamed Customer'} - ${date.toLocaleDateString()}</div>`;
        html += `<span class="badge badge-${report.quality >= 80 ? 'success' : report.quality >= 60 ? 'info' : 'warning'}">${report.quality}%</span>`;
        html += `</div>`;
        html += `<div class="card-body">`;
        html += `<p><strong>Address:</strong> ${report.serviceData.serviceAddress || 'N/A'}</p>`;
        html += `<p><strong>Type:</strong> ${report.serviceData.callType === 'trouble' ? 'Trouble Call' : 'Maintenance'}</p>`;
        html += `<p><strong>Photos:</strong> ${report.photos ? report.photos.length : 0}</p>`;
        html += `<button class="btn btn-danger btn-sm" onclick="deleteReport(${savedReports.length - 1 - i})">Delete</button>`;
        html += `</div>`;
        html += `</div>`;
      });
      container.innerHTML = html;
      savedReports.reverse();
      const thisMonth = savedReports.filter(r => {
        const rDate = new Date(r.timestamp);
        const now = new Date();
        return rDate.getMonth() === now.getMonth() && rDate.getFullYear() === now.getFullYear();
      });
      const avgQuality = savedReports.reduce((sum, r) => sum + r.quality, 0) / savedReports.length;
      const totalPhotos = savedReports.reduce((sum, r) => sum + (r.photos ? r.photos.length : 0), 0);
      $('stat-total').textContent = savedReports.length;
      $('stat-this-month').textContent = thisMonth.length;
      $('stat-avg-quality').textContent = `${Math.round(avgQuality)}%`;
      $('stat-photos').textContent = totalPhotos;
    }
    function deleteReport(index) {
      if (confirm('Delete this report? This cannot be undone.')) {
        savedReports.splice(index, 1);
        localStorage.setItem('fieldBuddyReports', JSON.stringify(savedReports));
        refreshHistory();
        updateDashboardStats();
        showToast('Report deleted');
      }
    }
    document.addEventListener('DOMContentLoaded', () => {
      initSignature();
      renderMaterialsCatalog();
      displaySelectedMaterials();
      loadData();
      updateDashboardStats();
      const today = new Date().toISOString().split('T')[0];
      $('service-date').value = today;
      $('sig-date').value = today;
      $('mat-date').value = today;
      calculateQuality();
    });
  </script>
</body>
</html>